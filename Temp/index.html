<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Eagle Eye ‚Äî Assembly Tracking</title>
<script src="https://d3js.org/d3.v7.min.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
/* ============================================
   EAGLE EYE ‚Äî Global Styles
   ============================================ */
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#0d1117;--surface:#161b22;--surface2:#1c2333;--border:#30363d;
  --text:#e6edf3;--text2:#8b949e;--text3:#6e7681;
  --accent:#00d9ff;--accent2:#00ff88;--green:#059669;--red:#dc2626;
  --yellow:#d97706;--purple:#7c3aed;--blue:#2563eb;
  --lv1:#a5d6a7;--lv2:#e1bee7;--lv3:#b3e5fc;--lv4:#c8e6c9;--lv5:#fff9c4;--lv6:#ffe0b2;
}
body{font-family:'DM Sans',system-ui,sans-serif;background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden}
a{color:var(--accent);text-decoration:none}
.mono{font-family:'JetBrains Mono',monospace}

/* --- NAV BAR --- */
.navbar{
  background:linear-gradient(135deg,#0a0b0f 0%,#131420 50%,#0d1117 100%);
  padding:10px 20px;display:flex;align-items:center;gap:16px;
  border-bottom:1px solid rgba(0,210,255,0.15);position:sticky;top:0;z-index:100;
}
.nav-logo{
  font-family:'JetBrains Mono',monospace;font-size:16px;font-weight:700;
  background:linear-gradient(90deg,var(--accent),var(--accent2));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;
  cursor:pointer;letter-spacing:0.5px;
}
.nav-links{display:flex;gap:4px;margin-left:16px}
.nav-link{
  padding:6px 14px;border-radius:6px;font-size:12px;font-weight:500;cursor:pointer;
  color:var(--text2);transition:all 0.2s;border:1px solid transparent;
}
.nav-link:hover{color:var(--text);background:var(--surface)}
.nav-link.active{color:var(--accent);background:rgba(0,217,255,0.08);border-color:rgba(0,217,255,0.2)}
.nav-right{margin-left:auto;display:flex;align-items:center;gap:12px}
.nav-badge{
  padding:3px 10px;border-radius:12px;font-size:10px;font-weight:600;
  font-family:'JetBrains Mono',monospace;
}
.nav-badge.admin{background:rgba(5,150,105,0.15);color:#34d399}
.nav-role-toggle{
  padding:4px 10px;border-radius:6px;font-size:11px;cursor:pointer;
  border:1px solid var(--border);background:var(--surface);color:var(--text2);
}
.nav-role-toggle:hover{border-color:var(--accent);color:var(--text)}

/* --- PAGE CONTAINER --- */
.page{display:none;padding:20px 24px;max-width:1400px;margin:0 auto}
.page.active{display:block}
.page-title{font-size:22px;font-weight:700;font-family:'JetBrains Mono',monospace;margin-bottom:4px}
.page-subtitle{font-size:13px;color:var(--text2);margin-bottom:20px}

/* --- CARDS --- */
.card-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:14px;margin-bottom:24px}
.card{
  background:var(--surface);border:1px solid var(--border);border-radius:10px;
  padding:16px;cursor:pointer;transition:all 0.2s;position:relative;overflow:hidden;
}
.card:hover{border-color:var(--accent);transform:translateY(-2px);box-shadow:0 4px 20px rgba(0,217,255,0.08)}
.card-icon{font-size:28px;margin-bottom:8px}
.card-title{font-size:15px;font-weight:600;margin-bottom:4px}
.card-desc{font-size:12px;color:var(--text2);line-height:1.5}
.card-stats{display:flex;gap:12px;margin-top:12px;flex-wrap:wrap}
.stat{padding:4px 10px;border-radius:6px;background:var(--surface2);font-size:11px;font-family:'JetBrains Mono',monospace}
.stat.green{color:#34d399;background:rgba(5,150,105,0.1)}
.stat.red{color:#f87171;background:rgba(220,38,38,0.1)}
.stat.yellow{color:#fbbf24;background:rgba(217,119,6,0.1)}
.stat.blue{color:#60a5fa;background:rgba(37,99,235,0.1)}

/* --- TABLES --- */
.table-wrap{overflow-x:auto;border:1px solid var(--border);border-radius:10px;background:var(--surface)}
table{width:100%;border-collapse:collapse;font-size:13px}
th{background:var(--surface2);padding:10px 14px;text-align:left;font-size:11px;font-weight:600;
  font-family:'JetBrains Mono',monospace;text-transform:uppercase;letter-spacing:0.3px;color:var(--text2);
  border-bottom:1px solid var(--border);position:sticky;top:0}
td{padding:10px 14px;border-bottom:1px solid var(--border);vertical-align:middle}
tr:hover{background:rgba(255,255,255,0.02)}
tr:last-child td{border-bottom:none}
.badge{padding:2px 8px;border-radius:4px;font-size:10px;font-weight:600;font-family:'JetBrains Mono',monospace;display:inline-block}
.badge-green{background:rgba(5,150,105,0.15);color:#34d399}
.badge-red{background:rgba(220,38,38,0.15);color:#f87171}
.badge-yellow{background:rgba(217,119,6,0.15);color:#fbbf24}
.badge-blue{background:rgba(37,99,235,0.15);color:#60a5fa}
.badge-purple{background:rgba(124,58,237,0.15);color:#a78bfa}
.badge-gray{background:rgba(107,114,128,0.15);color:#9ca3af}

/* --- BUTTONS --- */
.btn{
  padding:7px 14px;border:none;border-radius:6px;cursor:pointer;font-size:12px;
  font-weight:600;transition:all 0.15s;font-family:'DM Sans',sans-serif;
  display:inline-flex;align-items:center;gap:6px;
}
.btn-primary{background:var(--blue);color:#fff}.btn-primary:hover{filter:brightness(1.15)}
.btn-success{background:var(--green);color:#fff}.btn-success:hover{filter:brightness(1.15)}
.btn-danger{background:var(--red);color:#fff}.btn-danger:hover{filter:brightness(1.15)}
.btn-secondary{background:var(--surface2);color:var(--text2);border:1px solid var(--border)}
.btn-secondary:hover{color:var(--text);border-color:var(--text2)}
.btn-sm{padding:4px 10px;font-size:11px}
.btn-icon{width:32px;height:32px;padding:0;justify-content:center;border-radius:6px;background:var(--surface2);border:1px solid var(--border);color:var(--text2);cursor:pointer}
.btn-icon:hover{color:var(--text);border-color:var(--accent)}

/* --- TABS --- */
.tabs{display:flex;gap:2px;margin-bottom:16px;border-bottom:1px solid var(--border);padding-bottom:0}
.tab{
  padding:8px 16px;font-size:12px;font-weight:600;cursor:pointer;
  border-bottom:2px solid transparent;color:var(--text2);transition:all 0.15s;
  font-family:'JetBrains Mono',monospace;
}
.tab:hover{color:var(--text)}
.tab.active{color:var(--accent);border-bottom-color:var(--accent)}

/* --- VERSION SELECTOR --- */
.version-bar{display:flex;align-items:center;gap:12px;margin-bottom:16px;flex-wrap:wrap}
.version-select{
  padding:6px 12px;border-radius:6px;background:var(--surface2);border:1px solid var(--border);
  color:var(--text);font-size:12px;font-family:'JetBrains Mono',monospace;cursor:pointer;
}
.version-select:focus{outline:none;border-color:var(--accent)}
.version-info{font-size:11px;color:var(--text2);font-family:'JetBrains Mono',monospace}
.version-frozen{padding:3px 10px;border-radius:4px;background:rgba(59,130,246,0.1);color:#60a5fa;font-size:10px;font-weight:600;font-family:'JetBrains Mono',monospace}

/* --- ASSEMBLY TREE LIST VIEW --- */
.tree-list{margin-top:12px}
.group-block{margin-bottom:16px;border:1px solid var(--border);border-radius:8px;overflow:hidden;background:var(--surface)}
.group-header{
  padding:10px 14px;display:flex;align-items:center;gap:10px;cursor:pointer;
  background:var(--surface2);border-bottom:1px solid var(--border);
}
.group-header:hover{background:rgba(255,255,255,0.03)}
.group-color-dot{width:10px;height:10px;border-radius:3px;flex-shrink:0}
.group-label{font-weight:600;font-size:13px}
.group-icon{font-size:14px}
.group-count{font-size:10px;color:var(--text3);font-family:'JetBrains Mono',monospace;margin-left:auto}
.step-list{padding:4px 0}
.step-row{
  display:flex;align-items:center;gap:10px;padding:8px 14px 8px 28px;
  font-size:12px;cursor:pointer;transition:background 0.1s;
}
.step-row:hover{background:rgba(255,255,255,0.03)}
.step-seq{font-family:'JetBrains Mono',monospace;font-weight:600;color:var(--text2);min-width:28px}
.step-name{flex:1}
.step-ecn{display:flex;align-items:center;gap:4px}
.ecn-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.ecn-dot.changed{background:var(--red)}
.ecn-dot.pending{background:var(--yellow)}
.ecn-dot.applied{background:var(--green)}
.ecn-dot.none{background:var(--text3);opacity:0.5}

/* --- ECN PANEL --- */
.ecn-panel{
  position:fixed;right:0;top:48px;width:420px;height:calc(100vh - 48px);
  background:var(--surface);border-left:1px solid var(--border);
  transform:translateX(100%);transition:transform 0.3s ease;z-index:50;
  display:flex;flex-direction:column;
}
.ecn-panel.open{transform:translateX(0)}
.ecn-panel-header{
  padding:14px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;
  background:var(--surface2);
}
.ecn-panel-title{font-weight:700;font-size:14px;font-family:'JetBrains Mono',monospace}
.ecn-panel-body{flex:1;overflow-y:auto;padding:16px}
.ecn-panel-footer{padding:12px 16px;border-top:1px solid var(--border);display:flex;gap:8px;justify-content:flex-end}
.ecn-section{margin-bottom:16px}
.ecn-section-title{font-size:11px;font-weight:600;color:var(--text2);font-family:'JetBrains Mono',monospace;text-transform:uppercase;letter-spacing:0.3px;margin-bottom:8px}
.ecn-field{margin-bottom:12px}
.ecn-field label{display:block;font-size:11px;font-weight:600;color:var(--text2);margin-bottom:4px;font-family:'JetBrains Mono',monospace}
.ecn-field input,.ecn-field select,.ecn-field textarea{
  width:100%;padding:8px 10px;border:1px solid var(--border);border-radius:6px;
  background:var(--surface2);color:var(--text);font-size:12px;font-family:'DM Sans',sans-serif;
}
.ecn-field input:focus,.ecn-field select:focus,.ecn-field textarea:focus{outline:none;border-color:var(--accent)}
.ecn-field textarea{resize:vertical;min-height:60px}

/* --- CASCADE WARNING --- */
.cascade-warn{
  padding:12px;border-radius:8px;background:rgba(220,38,38,0.08);border:1px solid rgba(220,38,38,0.2);
  margin-top:12px;
}
.cascade-warn-title{font-size:12px;font-weight:700;color:#f87171;margin-bottom:6px;display:flex;align-items:center;gap:6px}
.cascade-warn-list{font-size:11px;color:var(--text2);line-height:1.8}
.cascade-unit{
  display:inline-flex;align-items:center;gap:4px;padding:2px 8px;border-radius:4px;
  background:rgba(220,38,38,0.1);margin:2px 3px;font-family:'JetBrains Mono',monospace;font-size:10px;
}

/* --- ECN MAP TABLE --- */
.ecn-map-table td{font-size:12px}
.ecn-change-type{font-size:10px;padding:2px 6px;border-radius:3px;font-weight:600;font-family:'JetBrains Mono',monospace}
.ecn-change-type.added{background:rgba(5,150,105,0.15);color:#34d399}
.ecn-change-type.removed{background:rgba(220,38,38,0.15);color:#f87171}
.ecn-change-type.modified{background:rgba(217,119,6,0.15);color:#fbbf24}
.ecn-change-type.replaced{background:rgba(124,58,237,0.15);color:#a78bfa}

/* --- TREE VIEW (D3) --- */
.tree-container{
  width:100%;height:calc(100vh - 200px);min-height:500px;position:relative;
  background:#0d1117;border-radius:10px;border:1px solid var(--border);overflow:hidden;
  background-image:radial-gradient(circle at 1px 1px,rgba(255,255,255,0.03) 1px,transparent 0);
  background-size:24px 24px;
}
.tree-container svg{display:block;width:100%;height:100%}
.tree-controls{
  position:absolute;top:10px;left:10px;display:flex;gap:6px;z-index:10;flex-wrap:wrap;
}
.tree-ctrl-btn{
  padding:5px 10px;font-size:11px;border:1px solid var(--border);border-radius:6px;
  background:rgba(22,27,34,0.9);backdrop-filter:blur(8px);color:var(--text2);cursor:pointer;
  font-family:'DM Sans',sans-serif;font-weight:500;transition:all 0.15s;
}
.tree-ctrl-btn:hover{border-color:var(--accent);color:var(--text)}
.tree-ctrl-btn.active{background:rgba(0,217,255,0.1);border-color:var(--accent);color:var(--accent)}
.tree-zoom-controls{
  position:absolute;bottom:12px;right:12px;display:flex;flex-direction:column;gap:4px;z-index:10;
}
.tree-zoom-btn{
  width:34px;height:34px;border:1px solid var(--border);border-radius:6px;
  background:rgba(22,27,34,0.9);backdrop-filter:blur(8px);cursor:pointer;
  font-size:16px;color:var(--text2);display:flex;align-items:center;justify-content:center;
}
.tree-zoom-btn:hover{color:var(--text);border-color:var(--accent)}
.tree-legend{
  position:absolute;top:10px;right:10px;z-index:10;
  background:rgba(22,27,34,0.92);backdrop-filter:blur(8px);border:1px solid var(--border);
  border-radius:8px;padding:8px 12px;display:flex;gap:10px;align-items:center;font-size:10px;color:var(--text2);
}
.legend-swatch{width:10px;height:10px;border-radius:2px;display:inline-block;margin-right:3px}

/* --- NODE STYLES (SVG) --- */
.node{cursor:pointer;transition:filter 0.15s}
.node:hover{filter:brightness(1.1) drop-shadow(0 2px 6px rgba(0,217,255,0.2))}
.node-label{fill:var(--bg);font-family:'DM Sans',sans-serif}
.link{fill:none;stroke-linecap:round}
.sequence-number{font-weight:700;fill:var(--text);font-family:'JetBrains Mono',monospace}

/* --- MODAL --- */
.modal-overlay{
  position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:200;
  display:none;align-items:center;justify-content:center;backdrop-filter:blur(3px);
}
.modal-overlay.show{display:flex}
.modal{background:var(--surface);border:1px solid var(--border);border-radius:12px;min-width:400px;max-width:520px;box-shadow:0 8px 40px rgba(0,0,0,0.4)}
.modal-header{padding:16px 20px;border-bottom:1px solid var(--border)}
.modal-title{font-size:16px;font-weight:700;font-family:'JetBrains Mono',monospace}
.modal-body{padding:16px 20px}
.modal-footer{padding:12px 20px;border-top:1px solid var(--border);display:flex;gap:8px;justify-content:flex-end}

/* --- TOAST --- */
.toast-container{position:fixed;top:56px;right:16px;z-index:999;display:flex;flex-direction:column;gap:6px}
.toast{
  padding:10px 16px;border-radius:8px;font-size:12px;font-weight:500;
  box-shadow:0 4px 16px rgba(0,0,0,0.3);transition:all 0.3s;max-width:320px;
}
.toast.success{background:var(--green);color:#fff}
.toast.error{background:var(--red);color:#fff}
.toast.info{background:var(--blue);color:#fff}
.toast.warning{background:var(--yellow);color:#fff}

/* --- SEARCH & FILTER --- */
.search-bar{
  display:flex;align-items:center;gap:8px;margin-bottom:16px;
}
.search-input{
  padding:8px 12px;border:1px solid var(--border);border-radius:6px;
  background:var(--surface2);color:var(--text);font-size:12px;flex:1;max-width:300px;
}
.search-input:focus{outline:none;border-color:var(--accent)}
.filter-btn{
  padding:6px 12px;font-size:11px;border:1px solid var(--border);border-radius:6px;
  background:var(--surface2);color:var(--text2);cursor:pointer;
}
.filter-btn:hover,.filter-btn.active{border-color:var(--accent);color:var(--accent);background:rgba(0,217,255,0.05)}

/* --- RESPONSIVE --- */
@media(max-width:768px){
  .card-grid{grid-template-columns:1fr}
  .page{padding:16px}
  .ecn-panel{width:100%}
}

/* --- UTILITY --- */
.flex{display:flex}.items-center{align-items:center}.gap-2{gap:8px}.gap-3{gap:12px}
.mt-2{margin-top:8px}.mt-3{margin-top:12px}.mt-4{margin-top:16px}
.mb-2{margin-bottom:8px}.mb-3{margin-bottom:12px}
.text-sm{font-size:12px}.text-xs{font-size:10px}.text-muted{color:var(--text2)}
.fw-600{font-weight:600}.fw-700{font-weight:700}
.w-full{width:100%}
</style>
</head>
<body>

<!-- ===================== NAV BAR ===================== -->
<nav class="navbar">
  <span class="nav-logo" onclick="goTo('home')">‚óà Eagle Eye</span>
  <div class="nav-links">
    <div class="nav-link active" data-page="home" onclick="goTo('home')">üè† Home</div>
    <div class="nav-link" data-page="units" onclick="goTo('units')">üî® Units</div>
    <div class="nav-link" data-page="assembly" onclick="goTo('assembly')">üå≤ Assembly</div>
    <div class="nav-link" data-page="tree" onclick="goTo('tree')">üî¨ Tree View</div>
  </div>
  <div class="nav-right">
    <button class="nav-role-toggle" id="roleToggle" onclick="toggleRole()">üîë Admin</button>
    <span class="nav-badge admin" id="roleBadge">üîë ADMIN</span>
  </div>
</nav>

<!-- ===================== HOME PAGE ===================== -->
<div class="page active" id="page-home">
  <h1 class="page-title">Assembly Dashboard</h1>
  <p class="page-subtitle">Track production units, manage versions, and monitor ECN changes</p>

  <div class="card-grid" id="assemblyCards"></div>

  <h2 style="font-size:16px;font-weight:600;margin-bottom:12px" class="mono">üìä Overview</h2>
  <div class="card-grid">
    <div class="card" style="cursor:default">
      <div class="card-title mono">Production Status</div>
      <div class="card-stats mt-2">
        <span class="stat green" id="stat-current">0 Current</span>
        <span class="stat yellow" id="stat-outdated">0 Outdated</span>
        <span class="stat red" id="stat-blocked">0 Blocked</span>
      </div>
    </div>
    <div class="card" style="cursor:default">
      <div class="card-title mono">ECN Activity</div>
      <div class="card-stats mt-2">
        <span class="stat red" id="stat-ecn-changed">0 Changed</span>
        <span class="stat yellow" id="stat-ecn-pending">0 Pending</span>
        <span class="stat green" id="stat-ecn-applied">0 Applied</span>
      </div>
    </div>
    <div class="card" style="cursor:default">
      <div class="card-title mono">Version Info</div>
      <div class="card-stats mt-2" id="stat-versions"></div>
    </div>
  </div>
</div>

<!-- ===================== UNITS PAGE ===================== -->
<div class="page" id="page-units">
  <h1 class="page-title">Unit Tracking</h1>
  <p class="page-subtitle" id="units-subtitle">Head & Body Assembly ‚Äî 120 units</p>

  <div class="search-bar">
    <input class="search-input" id="unitSearch" placeholder="Search by S/N or status..." oninput="filterUnits()">
    <button class="filter-btn" data-filter="all" onclick="setUnitFilter('all',this)">All</button>
    <button class="filter-btn" data-filter="current" onclick="setUnitFilter('current',this)">‚úÖ Current</button>
    <button class="filter-btn" data-filter="outdated" onclick="setUnitFilter('outdated',this)">‚ö†Ô∏è Outdated</button>
    <button class="filter-btn" data-filter="blocked" onclick="setUnitFilter('blocked',this)">üö´ Blocked</button>
  </div>

  <div class="table-wrap">
    <table>
      <thead>
        <tr><th>S/N</th><th>Version</th><th>Latest</th><th>Status</th><th>Assigned To</th><th>ECN Progress</th><th>Actions</th></tr>
      </thead>
      <tbody id="unitTableBody"></tbody>
    </table>
  </div>
</div>

<!-- ===================== ASSEMBLY PAGE ===================== -->
<div class="page" id="page-assembly">
  <h1 class="page-title">Assembly View</h1>

  <div class="version-bar">
    <label class="mono text-xs text-muted">Assembly:</label>
    <select class="version-select" id="assemblyPicker" onchange="onAssemblyPickerChange()"></select>
    <label class="mono text-xs text-muted" style="margin-left:12px">Version:</label>
    <select class="version-select" id="versionPicker" onchange="onVersionChange()"></select>
    <span class="version-info" id="versionInfo"></span>
    <span class="version-frozen" id="frozenBadge" style="display:none">üîí FROZEN</span>
    <button class="btn btn-sm btn-secondary" id="freezeBtn" onclick="toggleFreeze()" style="display:none">‚ùÑÔ∏è Freeze</button>
  </div>

  <div class="tabs">
    <div class="tab active" data-tab="versions" onclick="switchAssemblyTab('versions')">üìã Versions</div>
    <div class="tab" data-tab="tree-list" onclick="switchAssemblyTab('tree-list')">üå≤ Assembly Tree</div>
    <div class="tab" data-tab="ecn-map" onclick="switchAssemblyTab('ecn-map')">üó∫Ô∏è ECN Map</div>
  </div>

  <!-- Versions Sub-tab -->
  <div id="tab-versions">
    <div class="tabs" style="border-bottom:none;margin-bottom:8px">
      <div class="tab active text-xs" data-subtab="unit-versions" onclick="switchVersionSubTab('unit-versions')">Unit Versions</div>
      <div class="tab text-xs" data-subtab="version-history" onclick="switchVersionSubTab('version-history')">Version History</div>
    </div>
    <div id="subtab-unit-versions">
      <div class="table-wrap" style="max-height:500px;overflow-y:auto">
        <table><thead><tr><th>S/N</th><th>Current Ver</th><th>Latest Ver</th><th>Status</th><th>Steps Changed</th></tr></thead>
        <tbody id="unitVersionsBody"></tbody></table>
      </div>
    </div>
    <div id="subtab-version-history" style="display:none">
      <div class="table-wrap">
        <table><thead><tr><th>Version</th><th>Created</th><th>Created By</th><th>Notes</th><th>Status</th></tr></thead>
        <tbody id="versionHistoryBody"></tbody></table>
      </div>
    </div>
  </div>

  <!-- Assembly Tree List -->
  <div id="tab-tree-list" style="display:none">
    <div class="search-bar">
      <input class="search-input" placeholder="Search steps..." oninput="filterTreeList(this.value)">
      <button class="btn btn-sm btn-primary" id="addStepBtn" onclick="showAddStepModal()" style="display:none">‚ûï Add Step</button>
    </div>
    <div class="tree-list" id="treeListContainer"></div>
  </div>

  <!-- ECN Map -->
  <div id="tab-ecn-map" style="display:none">
    <div class="flex items-center gap-3 mb-3">
      <h3 class="mono" style="font-size:14px">ECN Change Records</h3>
      <button class="btn btn-sm btn-danger" id="markChangedBtn" onclick="showMarkChangedModal()" style="display:none">üî¥ Mark Steps Changed</button>
    </div>
    <div class="table-wrap">
      <table><thead><tr><th>Step</th><th>Change Type</th><th>Field</th><th>Old Value</th><th>New Value</th><th>Disposition</th><th>Version</th></tr></thead>
      <tbody id="ecnMapBody"></tbody></table>
    </div>
    <div id="cascadeContainer" style="margin-top:16px"></div>
  </div>
</div>

<!-- ===================== TREE VIEW PAGE ===================== -->
<div class="page" id="page-tree">
  <h1 class="page-title" style="margin-bottom:12px">Tree Visualization</h1>
  <div class="tree-container" id="treeContainer">
    <svg id="treeSvg"></svg>
    <div class="tree-controls">
      <button class="tree-ctrl-btn active" id="treeSeqBtn" onclick="toggleTreeSeq()">üî¢ Seq</button>
      <button class="tree-ctrl-btn active" id="treeLevelBtn" onclick="toggleTreeLevels()">üìä Levels</button>
      <button class="tree-ctrl-btn" id="treeSepBtn" onclick="toggleTreeSep()">‚îÄ Sep</button>
      <select class="version-select" style="font-size:11px" onchange="switchTreeColorMode(this.value)">
        <option value="group">Color: Group</option>
        <option value="level">Color: Level</option>
      </select>
    </div>
    <div class="tree-legend" id="treeLegend"></div>
    <div class="tree-zoom-controls">
      <button class="tree-zoom-btn" onclick="treeZoomIn()">+</button>
      <button class="tree-zoom-btn" onclick="treeZoomOut()">‚àí</button>
      <button class="tree-zoom-btn" onclick="treeFit()">‚ä°</button>
    </div>
  </div>
</div>

<!-- ===================== ECN EDIT PANEL ===================== -->
<div class="ecn-panel" id="ecnPanel">
  <div class="ecn-panel-header">
    <span class="ecn-panel-title" id="ecnPanelTitle">Edit Step ECN</span>
    <button class="btn-icon" onclick="closeEcnPanel()">‚úï</button>
  </div>
  <div class="ecn-panel-body" id="ecnPanelBody"></div>
  <div class="ecn-panel-footer" id="ecnPanelFooter"></div>
</div>

<!-- ===================== MODAL ===================== -->
<div class="modal-overlay" id="modalOverlay">
  <div class="modal">
    <div class="modal-header"><div class="modal-title" id="modalTitle">Confirm</div></div>
    <div class="modal-body" id="modalBody"></div>
    <div class="modal-footer" id="modalFooter"></div>
  </div>
</div>

<!-- ===================== TOAST ===================== -->
<div class="toast-container" id="toastContainer"></div>

<script>
// ============================================================
// MOCK DATA ‚Äî Head & Body Assembly
// ============================================================
const ASSEMBLIES = [
  { id: 'asm-hbd', tag: 'HBD_assy', name: 'Head & Body', icon: 'ü§ñ', version: '6.0', description: 'Head & Body assembly unit', unitCount: 120 },
  { id: 'asm-arm', tag: 'ARM_assy', name: 'Arm', icon: 'üí™', version: '3.0', description: 'Robotic arm assembly', unitCount: 85 },
  { id: 'asm-grp', tag: 'GRP_assy', name: 'Gripper', icon: 'ü§è', version: '2.0', description: 'End effector gripper', unitCount: 60 },
  { id: 'asm-bas', tag: 'BAS_assy', name: 'Base Unit', icon: 'üèóÔ∏è', version: '4.0', description: 'Mobile base platform', unitCount: 45 },
];

const GROUPS = [
  { id: 'g1', assembly_id: 'asm-hbd', label: 'Frame & Structure', color: '#4fc3f7', icon: 'üèóÔ∏è', sort_order: 1 },
  { id: 'g2', assembly_id: 'asm-hbd', label: 'Gearbox & Bearings', color: '#ce93d8', icon: '‚öôÔ∏è', sort_order: 2 },
  { id: 'g3', assembly_id: 'asm-hbd', label: 'Electronics & PCB', color: '#81c784', icon: 'üîå', sort_order: 3 },
  { id: 'g4', assembly_id: 'asm-hbd', label: 'Head Mount & Camera', color: '#fff176', icon: 'üì∏', sort_order: 4 },
  { id: 'g5', assembly_id: 'asm-hbd', label: 'Cables & Connectors', color: '#ffb74d', icon: 'üîó', sort_order: 5 },
];

// Steps (BOM-like): L1=root, L2=major sub-assemblies, L3-L6=components
const STEPS = [
  // L1 root
  { id: 's1', group_id: 'g1', label: 'Head & Body Unit', seq_tag: '1', level: 1, ecn_status: null, sort_order: 1 },
  // L2 branches
  { id: 's2', group_id: 'g1', label: 'Frame Assembly', seq_tag: '2a', level: 2, ecn_status: null, sort_order: 1 },
  { id: 's3', group_id: 'g2', label: 'Gearbox Assembly', seq_tag: '2b', level: 2, ecn_status: 'changed', sort_order: 2 },
  { id: 's4', group_id: 'g3', label: 'PCB Stack', seq_tag: '2c', level: 2, ecn_status: null, sort_order: 3 },
  { id: 's5', group_id: 'g4', label: 'Head Mount', seq_tag: '2d', level: 2, ecn_status: 'changed', sort_order: 4 },
  { id: 's6', group_id: 'g5', label: 'Cable Harness', seq_tag: '2e', level: 2, ecn_status: null, sort_order: 5 },
  // L3 under Frame
  { id: 's7', group_id: 'g1', label: 'Galina Body', seq_tag: '3a', level: 3, ecn_status: null, sort_order: 1 },
  { id: 's8', group_id: 'g1', label: 'Hook Arm', seq_tag: '3b', level: 3, ecn_status: null, sort_order: 2 },
  { id: 's9', group_id: 'g1', label: 'WiFi Antenna Mount', seq_tag: '3c', level: 3, ecn_status: 'pending', sort_order: 3 },
  // L3 under Gearbox
  { id: 's10', group_id: 'g2', label: 'Encoder Board', seq_tag: '3d', level: 3, ecn_status: 'changed', sort_order: 1 },
  { id: 's11', group_id: 'g2', label: 'Gear Set', seq_tag: '3e', level: 3, ecn_status: null, sort_order: 2 },
  { id: 's12', group_id: 'g2', label: 'Drive Pins', seq_tag: '3f', level: 3, ecn_status: null, sort_order: 3 },
  { id: 's13', group_id: 'g2', label: 'Gearbox Cover', seq_tag: '3g', level: 3, ecn_status: null, sort_order: 4 },
  // L3 under PCB
  { id: 's14', group_id: 'g3', label: 'Main Controller', seq_tag: '3h', level: 3, ecn_status: null, sort_order: 1 },
  { id: 's15', group_id: 'g3', label: 'Power Board', seq_tag: '3i', level: 3, ecn_status: 'applied', sort_order: 2 },
  // L3 under Head
  { id: 's16', group_id: 'g4', label: 'Ring Holder', seq_tag: '3j', level: 3, ecn_status: 'changed', sort_order: 1 },
  { id: 's17', group_id: 'g4', label: 'CAM Follower', seq_tag: '3k', level: 3, ecn_status: null, sort_order: 2 },
  // L4 deeper
  { id: 's18', group_id: 'g2', label: 'Bearing 6001', seq_tag: '4a', level: 4, ecn_status: null, sort_order: 1 },
  { id: 's19', group_id: 'g2', label: 'Bearing 6003', seq_tag: '4b', level: 4, ecn_status: null, sort_order: 2 },
  { id: 's20', group_id: 'g4', label: 'Camera Module', seq_tag: '4c', level: 4, ecn_status: 'changed', sort_order: 1 },
  { id: 's21', group_id: 'g4', label: 'LED Ring', seq_tag: '4d', level: 4, ecn_status: null, sort_order: 2 },
  // L5
  { id: 's22', group_id: 'g3', label: 'Motor Driver IC', seq_tag: '5a', level: 5, ecn_status: null, sort_order: 1 },
  { id: 's23', group_id: 'g4', label: 'Lens Assembly', seq_tag: '5b', level: 5, ecn_status: 'changed', sort_order: 1 },
  // L6
  { id: 's24', group_id: 'g2', label: 'Motor A', seq_tag: '6a', level: 6, ecn_status: null, sort_order: 1 },
  { id: 's25', group_id: 'g5', label: 'USB-C Cable', seq_tag: '6b', level: 6, ecn_status: null, sort_order: 1 },
  { id: 's26', group_id: 'g5', label: 'FFC Ribbon', seq_tag: '6c', level: 6, ecn_status: null, sort_order: 2 },
  { id: 's27', group_id: 'g4', label: 'IR Filter', seq_tag: '5c', level: 5, ecn_status: null, sort_order: 2 },
  { id: 's28', group_id: 'g1', label: 'Loctite 648 Bond', seq_tag: '3l', level: 3, ecn_status: null, sort_order: 4 },
];

const LINKS = [
  { id:'l1', parent_step_id:'s1', child_step_id:'s2' },
  { id:'l2', parent_step_id:'s1', child_step_id:'s3' },
  { id:'l3', parent_step_id:'s1', child_step_id:'s4' },
  { id:'l4', parent_step_id:'s1', child_step_id:'s5' },
  { id:'l5', parent_step_id:'s1', child_step_id:'s6' },
  { id:'l6', parent_step_id:'s2', child_step_id:'s7' },
  { id:'l7', parent_step_id:'s2', child_step_id:'s8' },
  { id:'l8', parent_step_id:'s2', child_step_id:'s9' },
  { id:'l9', parent_step_id:'s2', child_step_id:'s28' },
  { id:'l10', parent_step_id:'s3', child_step_id:'s10' },
  { id:'l11', parent_step_id:'s3', child_step_id:'s11' },
  { id:'l12', parent_step_id:'s3', child_step_id:'s12' },
  { id:'l13', parent_step_id:'s3', child_step_id:'s13' },
  { id:'l14', parent_step_id:'s4', child_step_id:'s14' },
  { id:'l15', parent_step_id:'s4', child_step_id:'s15' },
  { id:'l16', parent_step_id:'s5', child_step_id:'s16' },
  { id:'l17', parent_step_id:'s5', child_step_id:'s17' },
  { id:'l18', parent_step_id:'s11', child_step_id:'s18' },
  { id:'l19', parent_step_id:'s11', child_step_id:'s19' },
  { id:'l20', parent_step_id:'s16', child_step_id:'s20' },
  { id:'l21', parent_step_id:'s16', child_step_id:'s21' },
  { id:'l22', parent_step_id:'s14', child_step_id:'s22' },
  { id:'l23', parent_step_id:'s20', child_step_id:'s23' },
  { id:'l24', parent_step_id:'s3', child_step_id:'s24' },
  { id:'l25', parent_step_id:'s6', child_step_id:'s25' },
  { id:'l26', parent_step_id:'s6', child_step_id:'s26' },
  { id:'l27', parent_step_id:'s20', child_step_id:'s27' },
];

const FASTENERS = [
  { id:'f1', step_id:'s7', pn:'CBBTS2-5', qty:4, loctite:'222', torque:0.315 },
  { id:'f2', step_id:'s8', pn:'BSB-315CE', qty:2, loctite:'222', torque:0.65 },
  { id:'f3', step_id:'s13', pn:'CSH-M3-5', qty:6, loctite:'222', torque:1.14 },
  { id:'f4', step_id:'s9', pn:'CSH-M4-8', qty:2, loctite:'222', torque:2.7 },
  { id:'f5', step_id:'s16', pn:'CBE6-30', qty:3, loctite:'243', torque:5.2 },
  { id:'f6', step_id:'s28', pn:'CBE3-6', qty:8, loctite:'425', torque:1.14 },
];

const PARTS = [
  { id:'p1', step_id:'s7', pn:'GAL-BODY-V3', qty:1 },
  { id:'p2', step_id:'s8', pn:'HOOK-ARM-V2', qty:1 },
  { id:'p3', step_id:'s10', pn:'ENC-BOARD-R4', qty:1 },
  { id:'p4', step_id:'s18', pn:'BRG-6001-2RS', qty:2 },
  { id:'p5', step_id:'s19', pn:'BRG-6003-2RS', qty:1 },
  { id:'p6', step_id:'s20', pn:'CAM-IMX477', qty:1 },
  { id:'p7', step_id:'s21', pn:'LED-RING-24', qty:1 },
  { id:'p8', step_id:'s22', pn:'DRV8825', qty:2 },
  { id:'p9', step_id:'s23', pn:'LENS-6MM-CS', qty:1 },
  { id:'p10', step_id:'s24', pn:'MOT-NEMA17', qty:1 },
  { id:'p11', step_id:'s25', pn:'CABLE-USBC-30', qty:1 },
  { id:'p12', step_id:'s26', pn:'FFC-40P-150', qty:1 },
  { id:'p13', step_id:'s27', pn:'IR-FILTER-650', qty:1 },
  { id:'p14', step_id:'s14', pn:'PCB-MAIN-V5', qty:1 },
  { id:'p15', step_id:'s15', pn:'PCB-PWR-V3', qty:1 },
];

const VERSION_HISTORY = [
  { id:'vh1', assembly_id:'asm-hbd', version:'1.0', created_at:'2024-03-15', created_by:'Aniket', notes:'Initial release', frozen:true },
  { id:'vh2', assembly_id:'asm-hbd', version:'2.0', created_at:'2024-06-01', created_by:'Aniket', notes:'Updated gearbox bearings', frozen:true },
  { id:'vh3', assembly_id:'asm-hbd', version:'3.0', created_at:'2024-09-10', created_by:'Aniket', notes:'New encoder board, power board revision', frozen:true },
  { id:'vh4', assembly_id:'asm-hbd', version:'4.0', created_at:'2024-12-01', created_by:'Aniket', notes:'Camera module upgrade, head mount redesign', frozen:true },
  { id:'vh5', assembly_id:'asm-hbd', version:'5.0', created_at:'2025-03-15', created_by:'Aniket', notes:'Lens assembly change, ring holder update', frozen:true },
  { id:'vh6', assembly_id:'asm-hbd', version:'6.0', created_at:'2025-06-20', created_by:'Aniket', notes:'Current ‚Äî camera + encoder changes', frozen:false },
];

const ECN_CHANGES = [
  { id:'ec1', step_id:'s3', version:'6.0', change_type:'modified', field:'Encoder Board', old_value:'ENC-BOARD-R3', new_value:'ENC-BOARD-R4', disposition:'rework', description:'Updated encoder for higher resolution' },
  { id:'ec2', step_id:'s10', version:'6.0', change_type:'replaced', field:'IC Package', old_value:'QFN-24', new_value:'QFN-32', disposition:'replace', description:'New package with more I/O' },
  { id:'ec3', step_id:'s5', version:'6.0', change_type:'modified', field:'Head Mount', old_value:'HM-V3', new_value:'HM-V4', disposition:'rework', description:'Tighter tolerances for camera alignment' },
  { id:'ec4', step_id:'s16', version:'6.0', change_type:'modified', field:'Ring Holder', old_value:'RH-V2', new_value:'RH-V3', disposition:'rework', description:'New ring holder geometry' },
  { id:'ec5', step_id:'s20', version:'6.0', change_type:'replaced', field:'Camera Module', old_value:'CAM-IMX327', new_value:'CAM-IMX477', disposition:'replace', description:'Upgraded to IMX477 sensor' },
  { id:'ec6', step_id:'s23', version:'6.0', change_type:'modified', field:'Lens', old_value:'LENS-4MM', new_value:'LENS-6MM-CS', disposition:'replace', description:'Wider FOV lens' },
  { id:'ec7', step_id:'s15', version:'5.0', change_type:'modified', field:'Power Board', old_value:'PCB-PWR-V2', new_value:'PCB-PWR-V3', disposition:'rework', description:'Added overcurrent protection' },
  { id:'ec8', step_id:'s9', version:'6.0', change_type:'modified', field:'Mount Type', old_value:'Clip', new_value:'Screw Mount', disposition:'rework', description:'More stable WiFi antenna mount' },
];

// Generate 120 production units
function generateUnits() {
  const units = [];
  const versions = ['3.0','4.0','5.0','6.0'];
  const statuses = ['active','in_progress','completed','blocked'];
  const people = ['Aniket','David','Sarah','Mike','Elena'];
  for (let i = 1; i <= 120; i++) {
    const sn = `HBD-${String(i).padStart(4,'0')}`;
    const vi = i <= 15 ? 0 : i <= 40 ? 1 : i <= 80 ? 2 : 3;
    const ver = versions[vi];
    const latest = '6.0';
    const isCurrent = ver === latest;
    const status = isCurrent ? 'active' : (i % 7 === 0 ? 'blocked' : 'in_progress');
    units.push({
      id: `u${i}`, sn, version: ver, latest_version: latest, status,
      assigned_to: people[i % people.length],
      ecn_applied: isCurrent ? 6 : Math.floor(Math.random() * 4),
      ecn_total: 6,
    });
  }
  return units;
}
const UNITS = generateUnits();

// ============================================================
// APP STATE
// ============================================================
const APP = {
  currentPage: 'home',
  role: 'admin', // admin | viewer
  currentAssembly: 'asm-hbd',
  currentVersion: '6.0',
  treeShowSeq: true,
  treeShowLevels: true,
  treeShowSep: false,
  treeColorMode: 'group',
  unitFilter: 'all',
};

// ============================================================
// NAVIGATION
// ============================================================
function goTo(page) {
  APP.currentPage = page;
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById(`page-${page}`).classList.add('active');
  document.querySelectorAll('.nav-link').forEach(l => l.classList.toggle('active', l.dataset.page === page));
  if (page === 'home') renderHome();
  if (page === 'units') renderUnits();
  if (page === 'assembly') renderAssembly();
  if (page === 'tree') renderTreePage();
}

function toggleRole() {
  APP.role = APP.role === 'admin' ? 'viewer' : 'admin';
  const btn = document.getElementById('roleToggle');
  const badge = document.getElementById('roleBadge');
  btn.textContent = APP.role === 'admin' ? 'üîë Admin' : 'üëÅ Viewer';
  badge.textContent = APP.role === 'admin' ? 'üîë ADMIN' : 'üëÅ VIEWER';
  badge.className = `nav-badge ${APP.role === 'admin' ? 'admin' : ''}`;
  badge.style.background = APP.role === 'admin' ? 'rgba(5,150,105,0.15)' : 'rgba(107,114,128,0.15)';
  badge.style.color = APP.role === 'admin' ? '#34d399' : '#9ca3af';
  updateAdminUI();
}

function updateAdminUI() {
  const isAdmin = APP.role === 'admin';
  document.querySelectorAll('#addStepBtn,#markChangedBtn,#freezeBtn').forEach(el => {
    el.style.display = isAdmin ? '' : 'none';
  });
}

// ============================================================
// HOME PAGE
// ============================================================
function renderHome() {
  const grid = document.getElementById('assemblyCards');
  grid.innerHTML = ASSEMBLIES.map(a => {
    const units = a.id === 'asm-hbd' ? UNITS : [];
    const current = units.filter(u => u.version === u.latest_version).length;
    const outdated = units.filter(u => u.version !== u.latest_version && u.status !== 'blocked').length;
    return `<div class="card" onclick="APP.currentAssembly='${a.id}';goTo('units')">
      <div class="card-icon">${a.icon}</div>
      <div class="card-title">${a.name}</div>
      <div class="card-desc">${a.description}</div>
      <div class="card-stats">
        <span class="stat blue">${a.unitCount} units</span>
        <span class="stat">v${a.version}</span>
        ${a.id === 'asm-hbd' ? `<span class="stat green">${current} current</span><span class="stat yellow">${outdated} outdated</span>` : ''}
      </div>
    </div>`;
  }).join('');

  // Stats
  const current = UNITS.filter(u => u.version === u.latest_version).length;
  const outdated = UNITS.filter(u => u.version !== u.latest_version && u.status !== 'blocked').length;
  const blocked = UNITS.filter(u => u.status === 'blocked').length;
  document.getElementById('stat-current').textContent = `${current} Current`;
  document.getElementById('stat-outdated').textContent = `${outdated} Outdated`;
  document.getElementById('stat-blocked').textContent = `${blocked} Blocked`;

  const ecnChanged = STEPS.filter(s => s.ecn_status === 'changed').length;
  const ecnPending = STEPS.filter(s => s.ecn_status === 'pending').length;
  const ecnApplied = STEPS.filter(s => s.ecn_status === 'applied').length;
  document.getElementById('stat-ecn-changed').textContent = `${ecnChanged} Changed`;
  document.getElementById('stat-ecn-pending').textContent = `${ecnPending} Pending`;
  document.getElementById('stat-ecn-applied').textContent = `${ecnApplied} Applied`;

  document.getElementById('stat-versions').innerHTML = VERSION_HISTORY.map(v =>
    `<span class="stat ${v.frozen?'':'blue'}">${v.frozen?'üîí':'üîì'} v${v.version}</span>`
  ).join('');
}

// ============================================================
// UNITS PAGE
// ============================================================
function renderUnits() {
  filterUnits();
}
function filterUnits() {
  const query = (document.getElementById('unitSearch')?.value || '').toLowerCase();
  const filter = APP.unitFilter;
  let filtered = UNITS;
  if (filter === 'current') filtered = filtered.filter(u => u.version === u.latest_version);
  else if (filter === 'outdated') filtered = filtered.filter(u => u.version !== u.latest_version && u.status !== 'blocked');
  else if (filter === 'blocked') filtered = filtered.filter(u => u.status === 'blocked');
  if (query) filtered = filtered.filter(u => u.sn.toLowerCase().includes(query) || u.status.includes(query));

  const body = document.getElementById('unitTableBody');
  body.innerHTML = filtered.slice(0, 60).map(u => {
    const isCurrent = u.version === u.latest_version;
    const statusBadge = u.status === 'blocked' ? 'badge-red' : isCurrent ? 'badge-green' : 'badge-yellow';
    const statusText = u.status === 'blocked' ? 'üö´ Blocked' : isCurrent ? '‚úÖ Current' : '‚ö†Ô∏è Outdated';
    const pct = Math.round((u.ecn_applied / u.ecn_total) * 100);
    return `<tr>
      <td class="mono fw-600">${u.sn}</td>
      <td><span class="badge ${isCurrent ? 'badge-green' : 'badge-yellow'}">v${u.version}</span></td>
      <td><span class="badge badge-blue">v${u.latest_version}</span></td>
      <td><span class="badge ${statusBadge}">${statusText}</span></td>
      <td>${u.assigned_to}</td>
      <td>
        <div style="display:flex;align-items:center;gap:8px">
          <div style="flex:1;height:4px;background:var(--surface2);border-radius:2px;max-width:100px">
            <div style="width:${pct}%;height:100%;background:${pct===100?'var(--green)':'var(--yellow)'};border-radius:2px"></div>
          </div>
          <span class="text-xs mono text-muted">${u.ecn_applied}/${u.ecn_total}</span>
        </div>
      </td>
      <td><button class="btn btn-sm btn-secondary" onclick="openUnitEcn('${u.id}')">View ECN</button></td>
    </tr>`;
  }).join('');
}
function setUnitFilter(f, btn) {
  APP.unitFilter = f;
  document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  filterUnits();
}
function openUnitEcn(unitId) {
  const unit = UNITS.find(u => u.id === unitId);
  if (!unit) return;
  const changes = ECN_CHANGES.filter(c => parseFloat(c.version) > parseFloat(unit.version));
  const html = `<div style="margin-bottom:12px"><strong class="mono">${unit.sn}</strong> ‚Äî v${unit.version} ‚Üí v${unit.latest_version}</div>
    ${changes.length === 0 ? '<p class="text-muted text-sm">No pending ECN changes for this unit.</p>' :
    `<div class="table-wrap"><table><thead><tr><th>Step</th><th>Change</th><th>Disposition</th></tr></thead><tbody>
    ${changes.map(c => {
      const step = STEPS.find(s => s.id === c.step_id);
      return `<tr><td>${step?.label || '?'}</td><td><span class="ecn-change-type ${c.change_type}">${c.change_type}</span> ${c.field}</td><td><span class="badge badge-purple">${c.disposition}</span></td></tr>`;
    }).join('')}
    </tbody></table></div>`}`;
  showModal(`ECN Details ‚Äî ${unit.sn}`, html, [{ label: 'Close', cls: 'btn-secondary', action: hideModal }]);
}

// ============================================================
// ASSEMBLY PAGE
// ============================================================
function renderAssembly() {
  // Populate assembly picker
  const ap = document.getElementById('assemblyPicker');
  ap.innerHTML = ASSEMBLIES.map(a => `<option value="${a.id}" ${a.id===APP.currentAssembly?'selected':''}>${a.icon} ${a.name} (${a.tag})</option>`).join('');
  // Populate version picker
  const vp = document.getElementById('versionPicker');
  const versions = VERSION_HISTORY.filter(v => v.assembly_id === APP.currentAssembly);
  vp.innerHTML = versions.map(v => `<option value="${v.version}" ${v.version===APP.currentVersion?'selected':''}>v${v.version}${v.frozen?' üîí':' (active)'}</option>`).join('');
  updateVersionInfo();
  renderCurrentAssemblyTab();
  updateAdminUI();
}

function onAssemblyPickerChange() {
  APP.currentAssembly = document.getElementById('assemblyPicker').value;
  renderAssembly();
}
function onVersionChange() {
  APP.currentVersion = document.getElementById('versionPicker').value;
  updateVersionInfo();
  renderCurrentAssemblyTab();
}
function updateVersionInfo() {
  const vh = VERSION_HISTORY.find(v => v.version === APP.currentVersion && v.assembly_id === APP.currentAssembly);
  document.getElementById('versionInfo').textContent = vh ? `${vh.created_at} by ${vh.created_by}` : '';
  document.getElementById('frozenBadge').style.display = vh?.frozen ? '' : 'none';
  const freezeBtn = document.getElementById('freezeBtn');
  if (vh) {
    freezeBtn.textContent = vh.frozen ? 'üîì Unfreeze' : '‚ùÑÔ∏è Freeze';
    freezeBtn.style.display = APP.role === 'admin' ? '' : 'none';
  }
}

function toggleFreeze() {
  const vh = VERSION_HISTORY.find(v => v.version === APP.currentVersion && v.assembly_id === APP.currentAssembly);
  if (!vh) return;
  vh.frozen = !vh.frozen;
  toast(vh.frozen ? `v${vh.version} frozen üîí` : `v${vh.version} unfrozen üîì`, 'info');
  updateVersionInfo();
  renderAssembly();
}

function switchAssemblyTab(tab) {
  document.querySelectorAll('#page-assembly .tabs:first-of-type .tab').forEach(t => t.classList.toggle('active', t.dataset.tab === tab));
  ['versions','tree-list','ecn-map'].forEach(t => {
    document.getElementById(`tab-${t}`).style.display = t === tab ? '' : 'none';
  });
  renderCurrentAssemblyTab();
}

function renderCurrentAssemblyTab() {
  const activeTab = document.querySelector('#page-assembly .tabs:first-of-type .tab.active')?.dataset.tab;
  if (activeTab === 'versions') renderVersionsTab();
  if (activeTab === 'tree-list') renderTreeList();
  if (activeTab === 'ecn-map') renderEcnMap();
}

function switchVersionSubTab(sub) {
  document.querySelectorAll('[data-subtab]').forEach(t => t.classList.toggle('active', t.dataset.subtab === sub));
  document.getElementById('subtab-unit-versions').style.display = sub === 'unit-versions' ? '' : 'none';
  document.getElementById('subtab-version-history').style.display = sub === 'version-history' ? '' : 'none';
}

function renderVersionsTab() {
  // Unit versions
  const body = document.getElementById('unitVersionsBody');
  const outdated = UNITS.filter(u => u.version !== u.latest_version).slice(0, 40);
  body.innerHTML = outdated.map(u => {
    const changedSteps = ECN_CHANGES.filter(c => parseFloat(c.version) > parseFloat(u.version));
    return `<tr>
      <td class="mono fw-600">${u.sn}</td>
      <td><span class="badge badge-yellow">v${u.version}</span></td>
      <td><span class="badge badge-blue">v${u.latest_version}</span></td>
      <td><span class="badge ${u.status==='blocked'?'badge-red':'badge-yellow'}">${u.status==='blocked'?'üö´ Blocked':'‚ö†Ô∏è Outdated'}</span></td>
      <td class="text-sm text-muted">${changedSteps.length} changes</td>
    </tr>`;
  }).join('');

  // Version history
  const hBody = document.getElementById('versionHistoryBody');
  const versions = VERSION_HISTORY.filter(v => v.assembly_id === APP.currentAssembly);
  hBody.innerHTML = versions.map(v => `<tr>
    <td class="mono fw-700">v${v.version}</td>
    <td class="text-sm">${v.created_at}</td>
    <td class="text-sm">${v.created_by}</td>
    <td class="text-sm">${v.notes}</td>
    <td>${v.frozen ? '<span class="badge badge-blue">üîí Frozen</span>' : '<span class="badge badge-green">üîì Active</span>'}</td>
  </tr>`).join('');
}

// ============================================================
// TREE LIST VIEW
// ============================================================
function renderTreeList() {
  const container = document.getElementById('treeListContainer');
  const groups = GROUPS.filter(g => g.assembly_id === APP.currentAssembly);
  const vh = VERSION_HISTORY.find(v => v.version === APP.currentVersion && v.assembly_id === APP.currentAssembly);
  const isReadOnly = vh?.frozen && APP.currentVersion !== VERSION_HISTORY[VERSION_HISTORY.length-1]?.version;

  container.innerHTML = groups.map(g => {
    const steps = STEPS.filter(s => s.group_id === g.id).sort((a,b) => a.sort_order - b.sort_order);
    return `<div class="group-block">
      <div class="group-header" onclick="this.nextElementSibling.style.display=this.nextElementSibling.style.display==='none'?'':'none'">
        <div class="group-color-dot" style="background:${g.color}"></div>
        <span class="group-icon">${g.icon}</span>
        <span class="group-label">${g.label}</span>
        <span class="group-count">${steps.length} steps</span>
      </div>
      <div class="step-list">${steps.map(s => {
        const fasteners = FASTENERS.filter(f => f.step_id === s.id);
        const parts = PARTS.filter(p => p.step_id === s.id);
        return `<div class="step-row" onclick="openEcnPanel('${s.id}')">
          <span class="step-seq">${s.seq_tag || '‚Äî'}</span>
          <span class="step-name">${s.label}</span>
          ${fasteners.length ? `<span class="badge badge-purple text-xs">üî©${fasteners.length}</span>` : ''}
          ${parts.length ? `<span class="badge badge-blue text-xs">üì¶${parts.length}</span>` : ''}
          <span class="step-ecn"><span class="ecn-dot ${s.ecn_status||'none'}"></span><span class="text-xs text-muted">${s.ecn_status||'‚Äî'}</span></span>
        </div>`;
      }).join('')}</div>
    </div>`;
  }).join('');
}

function filterTreeList(query) {
  query = query.toLowerCase();
  document.querySelectorAll('.step-row').forEach(row => {
    const text = row.textContent.toLowerCase();
    row.style.display = !query || text.includes(query) ? '' : 'none';
  });
}

// ============================================================
// ECN MAP
// ============================================================
function renderEcnMap() {
  const body = document.getElementById('ecnMapBody');
  const changes = ECN_CHANGES.filter(c => {
    const step = STEPS.find(s => s.id === c.step_id);
    return step;
  });
  body.innerHTML = changes.map(c => {
    const step = STEPS.find(s => s.id === c.step_id);
    return `<tr>
      <td><span class="fw-600">${step?.label || '?'}</span><br><span class="text-xs text-muted mono">${step?.seq_tag || ''}</span></td>
      <td><span class="ecn-change-type ${c.change_type}">${c.change_type.toUpperCase()}</span></td>
      <td class="text-sm">${c.field}</td>
      <td class="text-sm mono" style="color:var(--red);text-decoration:line-through">${c.old_value}</td>
      <td class="text-sm mono" style="color:var(--green)">${c.new_value}</td>
      <td><span class="badge badge-purple">${c.disposition}</span></td>
      <td><span class="badge badge-blue">v${c.version}</span></td>
    </tr>`;
  }).join('');

  // Cascade detection
  renderCascadeWarning();
}

function renderCascadeWarning() {
  const container = document.getElementById('cascadeContainer');
  const changedStepIds = STEPS.filter(s => s.ecn_status === 'changed').map(s => s.id);
  if (changedStepIds.length === 0) { container.innerHTML = ''; return; }

  const affectedUnits = UNITS.filter(u => u.version !== u.latest_version);
  const byVersion = {};
  affectedUnits.forEach(u => {
    if (!byVersion[u.version]) byVersion[u.version] = [];
    byVersion[u.version].push(u);
  });

  container.innerHTML = `
    <div class="cascade-warn">
      <div class="cascade-warn-title">‚ö†Ô∏è ECN Cascade Warning ‚Äî ${changedStepIds.length} steps changed</div>
      <div class="cascade-warn-list">
        <p style="margin-bottom:8px;font-size:12px;color:var(--text)">${affectedUnits.length} units need ECN updates:</p>
        ${Object.entries(byVersion).map(([ver, units]) =>
          `<div style="margin-bottom:6px"><span class="badge badge-yellow" style="margin-right:8px">v${ver}</span>
          <span class="text-xs text-muted">${units.length} units:</span>
          ${units.slice(0,8).map(u => `<span class="cascade-unit">${u.sn}</span>`).join('')}
          ${units.length > 8 ? `<span class="text-xs text-muted">+${units.length-8} more</span>` : ''}
          </div>`
        ).join('')}
      </div>
    </div>`;
}

// ============================================================
// ECN EDIT PANEL
// ============================================================
function openEcnPanel(stepId) {
  const step = STEPS.find(s => s.id === stepId);
  if (!step) return;
  const group = GROUPS.find(g => g.id === step.group_id);
  const fasteners = FASTENERS.filter(f => f.step_id === stepId);
  const parts = PARTS.filter(p => p.step_id === stepId);
  const changes = ECN_CHANGES.filter(c => c.step_id === stepId);
  const isAdmin = APP.role === 'admin';

  document.getElementById('ecnPanelTitle').textContent = `${step.label}`;
  document.getElementById('ecnPanelBody').innerHTML = `
    <div style="padding:10px 12px;background:${group?.color || '#666'}22;border-left:3px solid ${group?.color || '#666'};border-radius:0 6px 6px 0;margin-bottom:16px">
      <div class="fw-700 mono" style="font-size:14px">${step.label}</div>
      <div class="text-xs text-muted mt-2">Level ${step.level} ¬∑ ${group?.label || '?'} ¬∑ ${step.seq_tag || '‚Äî'}</div>
    </div>

    <div class="ecn-section">
      <div class="ecn-section-title">ECN Status</div>
      <div class="ecn-field">
        <label>Status</label>
        <select id="ecn_status_sel" ${!isAdmin?'disabled':''}>
          <option value="" ${!step.ecn_status?'selected':''}>None</option>
          <option value="changed" ${step.ecn_status==='changed'?'selected':''}>üî¥ Changed</option>
          <option value="pending" ${step.ecn_status==='pending'?'selected':''}>üü° Pending Review</option>
          <option value="applied" ${step.ecn_status==='applied'?'selected':''}>üü¢ Applied</option>
        </select>
      </div>
      ${isAdmin ? `
      <div class="ecn-field">
        <label>Change Description</label>
        <textarea id="ecn_desc" placeholder="Describe the change...">${changes[0]?.description || ''}</textarea>
      </div>
      <div class="ecn-field">
        <label>Disposition</label>
        <select id="ecn_disposition">
          <option value="">‚Äî Select ‚Äî</option>
          <option value="rework" ${changes[0]?.disposition==='rework'?'selected':''}>üîß Rework</option>
          <option value="replace" ${changes[0]?.disposition==='replace'?'selected':''}>üîÑ Replace</option>
          <option value="scrap" ${changes[0]?.disposition==='scrap'?'selected':''}>üóëÔ∏è Scrap</option>
          <option value="use_as_is" ${changes[0]?.disposition==='use_as_is'?'selected':''}>‚úÖ Use As-Is</option>
        </select>
      </div>` : ''}
    </div>

    ${changes.length > 0 ? `
    <div class="ecn-section">
      <div class="ecn-section-title">Change History</div>
      ${changes.map(c => `
        <div style="padding:8px 10px;background:var(--surface2);border-radius:6px;margin-bottom:6px;font-size:12px">
          <div class="flex items-center gap-2">
            <span class="ecn-change-type ${c.change_type}">${c.change_type}</span>
            <span class="fw-600">${c.field}</span>
            <span class="badge badge-blue text-xs">v${c.version}</span>
          </div>
          <div class="mt-2 text-xs"><span style="color:var(--red);text-decoration:line-through">${c.old_value}</span> ‚Üí <span style="color:var(--green)">${c.new_value}</span></div>
          <div class="mt-2 text-xs text-muted">${c.description}</div>
          <div class="mt-2"><span class="badge badge-purple text-xs">${c.disposition}</span></div>
        </div>
      `).join('')}
    </div>` : ''}

    ${fasteners.length > 0 ? `
    <div class="ecn-section">
      <div class="ecn-section-title">üî© Fasteners (${fasteners.length})</div>
      ${fasteners.map(f => `
        <div style="padding:6px 10px;background:var(--surface2);border-radius:6px;margin-bottom:4px;font-size:12px">
          <strong class="mono">${f.pn}</strong> √ó${f.qty}
          ${f.loctite ? `<span style="color:var(--purple);margin-left:8px">LT-${f.loctite}</span>` : ''}
          ${f.torque ? `<span style="color:var(--yellow);margin-left:8px">${f.torque}Nm</span>` : ''}
        </div>
      `).join('')}
    </div>` : ''}

    ${parts.length > 0 ? `
    <div class="ecn-section">
      <div class="ecn-section-title">üì¶ Parts (${parts.length})</div>
      ${parts.map(p => `
        <div style="padding:6px 10px;background:var(--surface2);border-radius:6px;margin-bottom:4px;font-size:12px">
          <strong class="mono">${p.pn}</strong> √ó${p.qty}
        </div>
      `).join('')}
    </div>` : ''}

    <div class="text-xs text-muted mono mt-3">ID: ${step.id} ¬∑ Group: ${group?.label || '?'}</div>
  `;

  const footer = document.getElementById('ecnPanelFooter');
  footer.innerHTML = isAdmin ?
    `<button class="btn btn-secondary" onclick="closeEcnPanel()">Cancel</button>
     <button class="btn btn-primary" onclick="saveEcnEdit('${stepId}')">üíæ Save</button>` :
    `<button class="btn btn-secondary" onclick="closeEcnPanel()">Close</button>`;

  document.getElementById('ecnPanel').classList.add('open');
}

function closeEcnPanel() {
  document.getElementById('ecnPanel').classList.remove('open');
}

function saveEcnEdit(stepId) {
  const step = STEPS.find(s => s.id === stepId);
  if (!step) return;
  const newStatus = document.getElementById('ecn_status_sel').value || null;
  step.ecn_status = newStatus;
  closeEcnPanel();
  toast(`ECN status updated: ${step.label} ‚Üí ${newStatus || 'none'}`, 'success');
  renderCurrentAssemblyTab();
  if (APP.currentPage === 'tree') renderTreePage();
}

// Mark steps changed modal
function showMarkChangedModal() {
  const steps = STEPS.filter(s => !s.ecn_status || s.ecn_status === 'applied');
  const html = `<p class="text-sm mb-3">Select steps to mark as <strong style="color:var(--red)">changed</strong>:</p>
    <div style="max-height:300px;overflow-y:auto">
    ${steps.map(s => `
      <label style="display:flex;align-items:center;gap:8px;padding:6px 8px;cursor:pointer;border-radius:4px;font-size:12px" class="step-check-row">
        <input type="checkbox" value="${s.id}" class="mark-check">
        <span class="mono">${s.seq_tag || '‚Äî'}</span>
        <span>${s.label}</span>
      </label>
    `).join('')}
    </div>`;
  showModal('Mark Steps Changed', html, [
    { label: 'Cancel', cls: 'btn-secondary', action: hideModal },
    { label: 'üî¥ Mark Changed', cls: 'btn-danger', action: doMarkChanged },
  ]);
}

function doMarkChanged() {
  const checks = document.querySelectorAll('.mark-check:checked');
  checks.forEach(ch => {
    const step = STEPS.find(s => s.id === ch.value);
    if (step) step.ecn_status = 'changed';
  });
  hideModal();
  toast(`${checks.length} steps marked as changed`, 'warning');
  renderCurrentAssemblyTab();
}

// ============================================================
// D3 TREE VISUALIZATION
// ============================================================
const LEVEL_COLORS = ['#a5d6a7','#e1bee7','#b3e5fc','#c8e6c9','#fff9c4','#ffe0b2','#ffcdd2','#e8e8e8'];
const LEVEL_SHAPES = ['stadium','octagon','hexagon','pentagon','diamond','rounded_rectangle','rectangle','parallelogram'];
let zoomBehavior = null, currentTransform = d3.zoomIdentity;

function renderTreePage() {
  const container = document.getElementById('treeContainer');
  const svg = d3.select('#treeSvg');
  svg.selectAll('*').remove();
  const w = container.clientWidth, h = container.clientHeight;
  svg.attr('width', w).attr('height', h);

  // Build node data
  const nodes = STEPS.map(s => ({
    ...s,
    goesInto: LINKS.filter(l => l.child_step_id === s.id).map(l => l.parent_step_id),
    receivesFrom: LINKS.filter(l => l.parent_step_id === s.id).map(l => l.child_step_id),
    groupData: GROUPS.find(g => g.id === s.group_id),
  }));
  const links = LINKS;

  if (nodes.length === 0) return;

  // Calculate tree layout
  const layout = calcTreeLayout(nodes, links);
  const { positions, levels, columnXMap, topPadding, separatorLines } = layout;

  // Apply positions
  nodes.forEach(n => {
    const p = positions[n.id];
    if (p) { n.tx = p.x; n.ty = p.y; n.tw = p.w; n.th = p.h; }
  });

  const g = svg.append('g').attr('class','zoom-group');

  // Zoom
  zoomBehavior = d3.zoom().scaleExtent([0.1, 3]).on('zoom', e => { currentTransform = e.transform; g.attr('transform', e.transform); });
  svg.call(zoomBehavior);

  // Arrow marker
  const defs = svg.append('defs');
  defs.append('marker').attr('id','arrow').attr('viewBox','0 0 10 10')
    .attr('refX',9).attr('refY',5).attr('orient','auto').attr('markerWidth',5).attr('markerHeight',5)
    .append('path').attr('d','M 0,1 L 8,5 L 0,9 z').attr('fill','#475569');

  // Level headers
  if (APP.treeShowLevels) {
    levels.forEach(lv => {
      const hx = columnXMap[lv];
      g.append('rect').attr('x',hx-48).attr('y',topPadding-5).attr('width',96).attr('height',28).attr('rx',5).attr('fill','#2563eb').attr('opacity',0.85);
      g.append('text').attr('x',hx).attr('y',topPadding+14).attr('text-anchor','middle').attr('fill','white').attr('font-size','12px').attr('font-weight','600').attr('font-family','JetBrains Mono,monospace').text(`L${lv}`);
    });
  }

  // Separator lines
  if (APP.treeShowSep && separatorLines.length) {
    const maxX = Math.max(...Object.values(columnXMap)) + 200;
    separatorLines.forEach(sy => {
      g.append('line').attr('x1',20).attr('y1',sy).attr('x2',maxX).attr('y2',sy)
        .attr('stroke','#30363d').attr('stroke-width',1).attr('stroke-dasharray','8,4').attr('opacity',0.7);
    });
  }

  // Links
  links.forEach(ld => {
    const src = nodes.find(n => n.id === ld.child_step_id);
    const tgt = nodes.find(n => n.id === ld.parent_step_id);
    if (!src || !tgt) return;
    const sx = src.tx + src.tw/2, sy = src.ty;
    const tx = tgt.tx - tgt.tw/2, ty = tgt.ty;
    const mx = (sx + tx) / 2;
    g.append('path').attr('d', `M ${sx} ${sy} C ${mx} ${sy}, ${mx} ${ty}, ${tx} ${ty}`)
      .attr('stroke','#475569').attr('stroke-width',1.5).attr('fill','none').attr('marker-end','url(#arrow)');
  });

  // Nodes
  const nodeEls = g.selectAll('.node').data(nodes, d => d.id).enter().append('g').attr('class','node')
    .attr('transform', d => `translate(${d.tx},${d.ty})`);

  nodeEls.each(function(d) {
    const grp = d3.select(this);
    const color = APP.treeColorMode === 'group' && d.groupData ? d.groupData.color : LEVEL_COLORS[Math.min((d.level||1)-1, 7)];
    const hw = d.tw/2, hh = d.th/2;
    const shape = LEVEL_SHAPES[Math.min((d.level||1)-1, 7)];

    // Shape
    if (shape === 'stadium') {
      grp.append('rect').attr('x',-hw).attr('y',-hh).attr('width',d.tw).attr('height',d.th).attr('rx',hh).attr('ry',hh).attr('fill',color).attr('stroke',darken(color)).attr('stroke-width',1.5);
    } else if (shape === 'hexagon') {
      const pts = `${-hw+8},${-hh} ${hw-8},${-hh} ${hw},0 ${hw-8},${hh} ${-hw+8},${hh} ${-hw},0`;
      grp.append('polygon').attr('points',pts).attr('fill',color).attr('stroke',darken(color)).attr('stroke-width',1.5);
    } else if (shape === 'octagon') {
      const c = Math.min(hw,hh)*0.35;
      const pts = `${-hw+c},${-hh} ${hw-c},${-hh} ${hw},${-hh+c} ${hw},${hh-c} ${hw-c},${hh} ${-hw+c},${hh} ${-hw},${hh-c} ${-hw},${-hh+c}`;
      grp.append('polygon').attr('points',pts).attr('fill',color).attr('stroke',darken(color)).attr('stroke-width',1.5);
    } else if (shape === 'diamond') {
      const pts = `0,${-hh} ${hw},0 0,${hh} ${-hw},0`;
      grp.append('polygon').attr('points',pts).attr('fill',color).attr('stroke',darken(color)).attr('stroke-width',1.5);
    } else if (shape === 'pentagon') {
      const a=(2*Math.PI)/5,sa=-Math.PI/2,rx=hw*0.85,ry=hh*0.9;
      const pts = Array.from({length:5},(_,i)=>`${rx*Math.cos(sa+i*a)},${ry*Math.sin(sa+i*a)}`).join(' ');
      grp.append('polygon').attr('points',pts).attr('fill',color).attr('stroke',darken(color)).attr('stroke-width',1.5);
    } else {
      grp.append('rect').attr('x',-hw).attr('y',-hh).attr('width',d.tw).attr('height',d.th).attr('rx',4).attr('fill',color).attr('stroke',darken(color)).attr('stroke-width',1.5);
    }

    // ECN dot
    const ecnColors = { changed:'#dc2626', pending:'#d97706', applied:'#059669' };
    grp.append('circle').attr('cx',-hw+9).attr('cy',-hh+9).attr('r',4).attr('fill',ecnColors[d.ecn_status]||'#6e7681').attr('stroke','white').attr('stroke-width',1.5);

    // Label
    const fs = Math.min(12 - (d.level - 1), 10);
    grp.append('text').attr('text-anchor','middle').attr('y',3).attr('font-size',fs+'px').attr('font-weight', d.level <= 2 ? 700 : 500)
      .attr('fill','#0d1117').attr('font-family','DM Sans,sans-serif').text(d.label);

    // Seq tag
    if (d.seq_tag && APP.treeShowSeq) {
      grp.append('text').attr('x',hw+6).attr('y',-hh+4).attr('font-size','11px').attr('font-weight',700)
        .attr('fill','#e6edf3').attr('font-family','JetBrains Mono,monospace').text(d.seq_tag);
    }

    // Group icon
    if (d.groupData?.icon) {
      grp.append('text').attr('x',hw-6).attr('y',-hh-3).attr('text-anchor','middle').attr('font-size','10px').text(d.groupData.icon);
    }

    // Fastener badge
    const fCount = FASTENERS.filter(f => f.step_id === d.id).length;
    if (fCount > 0) {
      grp.append('circle').attr('cx',-hw+9).attr('cy',hh-5).attr('r',6).attr('fill','#6366f1').attr('stroke','white').attr('stroke-width',1);
      grp.append('text').attr('x',-hw+9).attr('y',hh-2).attr('text-anchor','middle').attr('font-size','6px').attr('fill','white').attr('font-weight',700).text(`üî©${fCount}`);
    }
  });

  // Click to open ECN panel
  nodeEls.on('click', (e, d) => { e.stopPropagation(); openEcnPanel(d.id); });

  // Legend
  const legend = document.getElementById('treeLegend');
  legend.innerHTML = levels.map(lv => `<span><span class="legend-swatch" style="background:${LEVEL_COLORS[Math.min(lv-1,7)]}"></span>L${lv}</span>`).join('');

  // Fit
  setTimeout(() => treeFit(), 200);
}

function calcTreeLayout(nodes, links) {
  const levelGroups = {};
  let maxLevel = 1;
  nodes.forEach(n => {
    const lv = n.level || 1;
    if (!levelGroups[lv]) levelGroups[lv] = [];
    levelGroups[lv].push(n);
    maxLevel = Math.max(maxLevel, lv);
  });

  const nodeW = 130, nodeH = 38, vGap = 58, groupGap = 35;
  const topPadding = 70, leftPadding = 100;
  const defaultGaps = [280, 240, 210, 190, 170, 150, 140];
  const levels = Object.keys(levelGroups).map(Number).sort((a,b) => b - a);

  const columnXMap = {};
  let cumX = leftPadding;
  levels.forEach((lv, i) => {
    columnXMap[lv] = cumX;
    if (i < levels.length - 1) {
      const lower = Math.min(lv, levels[i+1]);
      cumX += defaultGaps[Math.min(lower-1, 6)] || 150;
    }
  });

  const p2c = {}, c2p = {};
  links.forEach(l => {
    if (!p2c[l.parent_step_id]) p2c[l.parent_step_id] = [];
    p2c[l.parent_step_id].push(l.child_step_id);
    if (!c2p[l.child_step_id]) c2p[l.child_step_id] = [];
    c2p[l.child_step_id].push(l.parent_step_id);
  });

  // Detect groups from L2
  const groups = [], visited = new Set();
  const l2 = nodes.filter(n => n.level === 2).sort((a,b) => a.sort_order - b.sort_order);
  l2.forEach(root => {
    if (visited.has(root.id)) return;
    const grp = { nodeIds: new Set() };
    const q = [root.id];
    while (q.length) {
      const nid = q.shift();
      if (grp.nodeIds.has(nid)) continue;
      grp.nodeIds.add(nid); visited.add(nid);
      (p2c[nid]||[]).forEach(c => { if (!grp.nodeIds.has(c)) q.push(c); });
    }
    (c2p[root.id]||[]).forEach(pid => { grp.nodeIds.add(pid); visited.add(pid); });
    groups.push(grp);
  });
  const unv = nodes.filter(n => !visited.has(n.id));
  if (unv.length && groups.length) unv.forEach(n => groups[groups.length-1].nodeIds.add(n.id));
  else if (unv.length) groups.push({ nodeIds: new Set(unv.map(n=>n.id)) });

  const positions = {};
  let groupStartY = topPadding + 40;

  groups.forEach(group => {
    levels.forEach(lv => {
      const nodesInLv = (levelGroups[lv]||[]).filter(n => group.nodeIds.has(n.id)).sort((a,b) => a.sort_order - b.sort_order);
      nodesInLv.forEach((node, idx) => {
        const children = (p2c[node.id]||[]).filter(c => group.nodeIds.has(c));
        let y = groupStartY + idx * vGap;
        if (children.length && children.some(c => positions[c]?.y > 0)) {
          const ys = children.map(c => positions[c]?.y).filter(Boolean);
          y = (Math.min(...ys) + Math.max(...ys)) / 2;
        }
        positions[node.id] = { x: columnXMap[lv], y, w: nodeW - 16, h: nodeH - 6 };
      });
      // Resolve overlaps
      nodesInLv.sort((a,b) => (positions[a.id]?.y||0) - (positions[b.id]?.y||0));
      let lastY = groupStartY - vGap;
      nodesInLv.forEach(n => {
        if (positions[n.id].y < lastY + vGap) positions[n.id].y = lastY + vGap;
        lastY = positions[n.id].y;
      });
    });
    const gNodes = nodes.filter(n => group.nodeIds.has(n.id));
    const maxY = Math.max(...gNodes.map(n => positions[n.id]?.y || 0));
    groupStartY = maxY + vGap + groupGap;
  });

  // 3-pass centering
  for (let pass = 0; pass < 3; pass++) {
    [...levels].reverse().forEach(lv => {
      (levelGroups[lv]||[]).forEach(node => {
        const children = (p2c[node.id]||[]).filter(c => positions[c]);
        if (children.length) {
          const ys = children.map(c => positions[c].y);
          positions[node.id].y = (Math.min(...ys) + Math.max(...ys)) / 2;
        }
      });
      const nodesInLv = (levelGroups[lv]||[]).sort((a,b) => (positions[a.id]?.y||0) - (positions[b.id]?.y||0));
      let lastY = topPadding;
      nodesInLv.forEach(n => {
        if (positions[n.id].y < lastY + vGap) positions[n.id].y = lastY + vGap;
        lastY = positions[n.id].y;
      });
    });
  }

  // Separator lines
  const separatorLines = [];
  for (let i = 0; i < groups.length - 1; i++) {
    const g1Ys = nodes.filter(n => groups[i].nodeIds.has(n.id)).map(n => positions[n.id]?.y||0);
    const g2Ys = nodes.filter(n => groups[i+1].nodeIds.has(n.id)).map(n => positions[n.id]?.y||0);
    if (g1Ys.length && g2Ys.length) separatorLines.push((Math.max(...g1Ys) + Math.min(...g2Ys)) / 2);
  }

  return { positions, levels, columnXMap, topPadding, separatorLines };
}

function darken(hex, pct=30) {
  hex = hex.replace('#','');
  let r = parseInt(hex.substring(0,2),16), g = parseInt(hex.substring(2,4),16), b = parseInt(hex.substring(4,6),16);
  r = Math.max(0, Math.floor(r*(100-pct)/100));
  g = Math.max(0, Math.floor(g*(100-pct)/100));
  b = Math.max(0, Math.floor(b*(100-pct)/100));
  return `#${r.toString(16).padStart(2,'0')}${g.toString(16).padStart(2,'0')}${b.toString(16).padStart(2,'0')}`;
}

// Tree controls
function toggleTreeSeq() { APP.treeShowSeq = !APP.treeShowSeq; document.getElementById('treeSeqBtn').classList.toggle('active'); renderTreePage(); }
function toggleTreeLevels() { APP.treeShowLevels = !APP.treeShowLevels; document.getElementById('treeLevelBtn').classList.toggle('active'); renderTreePage(); }
function toggleTreeSep() { APP.treeShowSep = !APP.treeShowSep; document.getElementById('treeSepBtn').classList.toggle('active'); renderTreePage(); }
function switchTreeColorMode(mode) { APP.treeColorMode = mode; renderTreePage(); }
function treeZoomIn() { d3.select('#treeSvg').transition().duration(300).call(zoomBehavior.scaleBy, 1.3); }
function treeZoomOut() { d3.select('#treeSvg').transition().duration(300).call(zoomBehavior.scaleBy, 0.7); }
function treeFit() {
  const nodes = STEPS;
  if (!nodes.length || !zoomBehavior) return;
  const c = document.getElementById('treeContainer');
  let mnX=Infinity,mxX=-Infinity,mnY=Infinity,mxY=-Infinity;
  nodes.forEach(n => {
    if (n.tx==null) return;
    mnX=Math.min(mnX,n.tx-80);mxX=Math.max(mxX,n.tx+80);mnY=Math.min(mnY,n.ty-30);mxY=Math.max(mxY,n.ty+30);
  });
  if (mnX === Infinity) return;
  const cw=c.clientWidth-40, ch=c.clientHeight-40;
  const scale=Math.min(cw/(mxX-mnX), ch/(mxY-mnY), 1.5)*0.85;
  const cx=(mnX+mxX)/2, cy=(mnY+mxY)/2;
  const t = d3.zoomIdentity.translate(cw/2-cx*scale+20, ch/2-cy*scale+20).scale(scale);
  d3.select('#treeSvg').transition().duration(500).call(zoomBehavior.transform, t);
}

// ============================================================
// UI HELPERS
// ============================================================
function toast(msg, type='info') {
  const c = document.getElementById('toastContainer');
  const t = document.createElement('div'); t.className = `toast ${type}`; t.textContent = msg;
  c.appendChild(t);
  setTimeout(() => { t.style.opacity='0'; t.style.transform='translateY(-20px)'; setTimeout(()=>t.remove(),300); }, 3000);
}
function showModal(title, content, buttons=[]) {
  document.getElementById('modalTitle').textContent = title;
  document.getElementById('modalBody').innerHTML = content;
  const footer = document.getElementById('modalFooter');
  footer.innerHTML = buttons.map(b => `<button class="btn ${b.cls||'btn-primary'}">${b.label}</button>`).join('');
  footer.querySelectorAll('button').forEach((el,i) => { if (buttons[i]?.action) el.onclick = buttons[i].action; });
  document.getElementById('modalOverlay').classList.add('show');
}
function hideModal() { document.getElementById('modalOverlay').classList.remove('show'); }

function showAddStepModal() {
  showModal('Add Step', `<p class="text-sm text-muted mb-3">This is a mock ‚Äî real version would save to Supabase.</p>
    <div class="ecn-field"><label>Label</label><input id="new_step_label" placeholder="Step name"></div>
    <div class="ecn-field"><label>Seq Tag</label><input id="new_step_seq" placeholder="e.g. 3m"></div>
  `, [
    { label: 'Cancel', cls: 'btn-secondary', action: hideModal },
    { label: 'Add', cls: 'btn-primary', action: () => { toast('Step added (mock)', 'success'); hideModal(); }},
  ]);
}

// ============================================================
// INIT
// ============================================================
document.addEventListener('DOMContentLoaded', () => {
  renderHome();
  updateAdminUI();
});
</script>
</body>
</html>

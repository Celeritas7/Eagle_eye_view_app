<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EagleEye ‚Äî Assembly Tracking</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700;800&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#0a0b0f;--card:#12131a;--hover:#1a1c24;--modal:#15161e;
  --border:#1e2030;--text:#d1d5e4;--muted:#6b7080;--dim:#3a3d4d;
  --accent:#f59e0b;--purple:#8b5cf6;
  --red:#ef4444;--green:#22c55e;--blue:#3b82f6;--orange:#f97316;--pink:#ec4899;--cyan:#06b6d4;
}
body{font-family:'DM Sans',system-ui,sans-serif;background:var(--bg);color:var(--text);min-height:100vh;font-size:12px}
::-webkit-scrollbar{width:4px}::-webkit-scrollbar-track{background:var(--bg)}::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px}
select option{background:var(--card);color:var(--text)}
input[type=number]::-webkit-inner-spin-button,input[type=number]::-webkit-outer-spin-button{-webkit-appearance:none}
.mono{font-family:'JetBrains Mono',monospace}
.badge{padding:1px 6px;border-radius:6px;font-size:9px;font-weight:700;font-family:'JetBrains Mono',monospace;display:inline-block}
.btn-sm{padding:3px 10px;border-radius:6px;font-size:10px;font-weight:700;border:1px solid var(--border);cursor:pointer;font-family:'JetBrains Mono',monospace}
.inp{background:#0d0e14;border:1px solid var(--border);border-radius:5px;padding:4px 7px;color:var(--text);font-size:11px;font-family:'JetBrains Mono',monospace;outline:none}
.inp:focus{border-color:var(--accent)}
.loading-wrap{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:200px;color:var(--muted)}
.spinner{width:24px;height:24px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin 0.8s linear infinite;margin-bottom:12px}
@keyframes spin{to{transform:rotate(360deg)}}
.error-banner{margin:16px 24px;padding:12px 16px;border-radius:8px;background:rgba(239,68,68,0.08);border:1px solid rgba(239,68,68,0.15);color:var(--red);font-size:12px;max-width:780px;width:100%}

/* HOME */
.home-wrap{min-height:100vh;display:flex;flex-direction:column;align-items:center}
.home-admin{position:fixed;top:10px;right:14px;display:flex;align-items:center;gap:6px;z-index:10}
.admin-pill{display:flex;align-items:center;gap:4px;padding:4px 10px;border-radius:6px;background:rgba(245,158,11,0.08);border:1px solid rgba(245,158,11,0.2);font-size:10px;font-weight:600;color:var(--accent);font-family:'JetBrains Mono',monospace}
.home-hero{text-align:center;padding-top:50px;margin-bottom:28px}
.home-logo{font-size:42px;font-weight:900;color:var(--accent);font-family:'JetBrains Mono',monospace;letter-spacing:-2px;line-height:1}
.home-sub{font-size:13px;color:var(--muted);margin-top:8px}
.section-label{font-family:'JetBrains Mono',monospace;font-size:10px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--dim);margin-bottom:10px}
.assy-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(170px,1fr));gap:8px;max-width:780px;width:100%;padding:0 20px 40px}
.assy-card{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:12px 14px;cursor:pointer;transition:all 0.15s}
.assy-card:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,0.3)}
.full-robot-card{background:var(--card);border:2px solid rgba(34,197,94,0.25);border-radius:10px;padding:14px 16px;cursor:pointer;transition:all 0.2s;max-width:280px}
.full-robot-card:hover{border-color:var(--green);transform:translateY(-2px)}

/* UNIT SELECT */
.us-filter{padding:4px 10px;border-radius:6px;font-size:10px;font-weight:600;cursor:pointer;border:1px solid var(--border);background:transparent;color:var(--muted);text-transform:capitalize;font-family:'DM Sans',sans-serif}
.us-filter.active{border:none}
.us-filter[data-f="all"].active{background:rgba(245,158,11,0.15);color:var(--accent)}
.us-filter[data-f="outdated"].active{background:rgba(239,68,68,0.15);color:var(--red)}
.us-filter[data-f="current"].active{background:rgba(34,197,94,0.15);color:var(--green)}
.unit-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(125px,1fr));gap:4px;max-height:380px;overflow-y:auto;padding:2px}
.unit-card{padding:6px 8px;border-radius:6px;cursor:pointer;border:1px solid var(--border);background:var(--card);transition:all 0.1s;position:relative}
.unit-card.selected{border:2px solid var(--accent);background:rgba(245,158,11,0.03)}

/* ASSEMBLY VIEW */
.av-header{display:flex;align-items:center;gap:12px;padding:12px 24px;border-bottom:1px solid var(--border);background:#0e0f15;position:sticky;top:0;z-index:10;flex-wrap:wrap}
.av-tabs{display:flex;align-items:center;gap:0;padding:0 24px;border-bottom:1px solid var(--border);background:#0e0f15}
.av-tab{display:flex;align-items:center;gap:6px;padding:14px 22px;font-size:16px;font-weight:500;color:var(--muted);background:transparent;border:none;cursor:pointer;border-bottom:2px solid transparent;font-family:'DM Sans',sans-serif}
.av-tab.active{font-weight:700;color:var(--accent);border-bottom-color:var(--accent)}
.av-tab .count{font-size:11px;font-weight:700;padding:2px 7px;border-radius:6px;background:rgba(239,68,68,0.15);color:var(--red);font-family:'JetBrains Mono',monospace}
.av-tab .soon{font-size:10px;font-weight:700;padding:2px 7px;border-radius:4px;background:rgba(58,61,77,0.25);color:var(--dim);font-family:'JetBrains Mono',monospace}
.ecn-banner{margin:16px 24px 0;padding:14px 18px;border-radius:10px;background:rgba(239,68,68,0.04);border:1px solid rgba(239,68,68,0.1)}
.ecn-item{display:flex;align-items:center;gap:12px;padding:12px 16px;border-radius:8px;cursor:pointer;margin-bottom:5px;border:1px solid var(--border);background:var(--card);transition:all 0.1s;font-size:15px}
.ecn-item:hover{border-color:var(--muted)}
.ecn-item.done{background:rgba(34,197,94,0.04);border-color:rgba(34,197,94,0.1)}
.ecn-item.blocked{opacity:0.5;cursor:not-allowed}
.tree-list{padding:0 24px 24px}
.grp-hdr{display:flex;align-items:center;gap:10px;padding:12px 14px;border-radius:8px;cursor:pointer;margin-top:8px}
.grp-hdr:hover{background:rgba(255,255,255,0.02)}
.step-row{display:flex;align-items:center;gap:14px;padding:10px 14px 10px 28px;cursor:pointer;border-radius:6px;font-size:15px}
.step-row:hover{background:rgba(255,255,255,0.02)}

/* TREE EDITOR */
.te-wrap{display:flex;height:100vh;overflow:hidden}
.te-left{flex:1;display:flex;flex-direction:column;overflow:hidden}
.te-right{width:380px;border-left:1px solid var(--border);background:var(--card);overflow-y:auto;padding:16px}
.te-topbar{padding:10px 16px;border-bottom:1px solid var(--border);background:#0e0f15;display:flex;align-items:center;gap:10px;flex-wrap:wrap}
.te-pick-wrap{min-height:100vh;display:flex;flex-direction:column;align-items:center;padding:50px 24px}
.te-pick-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:14px;max-width:760px;width:100%}
.te-pick-card{background:var(--card);border:2px solid var(--border);border-radius:14px;padding:24px;cursor:pointer;transition:all 0.2s;text-align:center}
.te-pick-card:hover{transform:translateY(-3px);border-color:var(--purple);box-shadow:0 8px 24px rgba(139,92,246,0.12)}
.te-verbar{padding:8px 16px;border-bottom:1px solid var(--border);background:#0e0f15;display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.te-ver-pill{padding:5px 14px;border-radius:7px;font-size:13px;font-weight:700;cursor:pointer;font-family:'JetBrains Mono',monospace}
.te-frozen{padding:8px 16px;background:rgba(239,68,68,0.06);border-bottom:1px solid rgba(239,68,68,0.1);font-size:14px;color:var(--red);font-weight:700;text-align:center}
.te-tree{flex:1;overflow-y:auto;padding:8px 12px}
.te-grp{display:flex;align-items:center;gap:8px;padding:10px 12px;border-radius:8px;margin-top:4px}
.te-step{display:flex;align-items:center;gap:8px;padding:8px 10px 8px 28px;cursor:pointer;border-radius:6px;margin:2px 0;font-size:14px}
.te-step.sel{background:rgba(139,92,246,0.08);border:1px solid rgba(139,92,246,0.2)}
.dp-label{font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px}
.dp-row{display:flex;gap:4px;align-items:center;margin-bottom:4px;padding:6px 8px;border-radius:6px;border:1px solid var(--border)}
.disp-btn{flex:1;padding:6px;border-radius:5px;font-size:10px;font-weight:700;cursor:pointer;font-family:'JetBrains Mono',monospace}

/* MODAL */
.cm-overlay{position:fixed;inset:0;z-index:100;background:rgba(0,0,0,0.65);backdrop-filter:blur(4px);display:flex;align-items:center;justify-content:center}
.cm-box{background:var(--modal);border-radius:14px;width:min(520px,92vw);max-height:80vh;box-shadow:0 12px 40px rgba(0,0,0,0.6);border:1px solid var(--border);overflow:hidden;display:flex;flex-direction:column}
.dup-overlay{position:fixed;inset:0;z-index:100;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center}
.dup-box{background:var(--modal);border-radius:12px;width:340px;padding:20px;border:1px solid var(--border)}
.db-status{display:flex;align-items:center;gap:4px;padding:3px 8px;border-radius:5px;font-size:9px;font-weight:600;font-family:'JetBrains Mono',monospace}
.db-status.ok{background:rgba(34,197,94,0.1);color:#22c55e}
.db-status.err{background:rgba(239,68,68,0.1);color:#ef4444}
.db-status.load{background:rgba(245,158,11,0.1);color:#f59e0b}
</style>
</head>
<body>
<div id="app"></div>
<script>
// ============================================================
// CONFIG
// ============================================================
const SUPABASE_URL = 'https://wylxvmkcrexwfpjpbhyy.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind5bHh2bWtjcmV4d2ZwanBiaHl5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg2MzkxMDYsImV4cCI6MjA4NDIxNTEwNn0.6Bxo42hx4jwlJGWnfjiTpiDUsYfc1QLTN3YtrU1efak';
const GSHEET_ID = '1mUhNDzucbHpS2y-IYu3A5ML1x5I_opUeNnqqyOtg95M';

// Assembly display metadata (icons/colors not in DB)
const ASSY_META = {
  'GST_assy':  {icon:'ü§ñ',color:'#22c55e',section:'full',  name:'Ghost (Full Robot)'},
  'MBB_assy':  {icon:'üèóÔ∏è',color:'#22c55e',                 name:'Mobile Base'},
  'PLR_assy':  {icon:'üóº',color:'#ec4899',                  name:'Pillar'},
  'HBD_assy':  {icon:'ü§ñ',color:'#f97316',                  name:'Head & Body'},
  'GPR_assy':  {icon:'ü§è',color:'#06b6d4',                  name:'Gripper'},
  'ARM_assy':  {icon:'üí™',color:'#3b82f6',                  name:'Arm'},
  'LAC_assy':  {icon:'‚ö°',color:'#eab308',                  name:'L-Motor'},
  'A12_assy':  {icon:'üî©',color:'#a855f7',                  name:'A12-Motor'},
  'A35_assy':  {icon:'üîß',color:'#f43f5e',                  name:'A35-Motor'},
  'A4A_assy':  {icon:'‚öôÔ∏è',color:'#14b8a6',                  name:'A4-Motor'},
};

// Google Sheet tab mapping: assembly tag ‚Üí sheet name
const GS_SHEET_MAP = {
  'GST_assy':  '00_GHOST',
  'MBB_assy':  '05_Mobile Base',
  'PLR_assy':  '06_Pillar',
  'HBD_assy':  '07_Head & Body',
  'GPR_assy':  '08_Gripper',
  'ARM_assy':  '09_Arm',
  'LAC_assy':  '01_L-motor',
  'A12_assy':  '02_A12-motor',
  'A35_assy':  '03_A35-motor',
  'A4A_assy':  '04_A4-motor',
};
// Column index (0-based) for S/N in each sheet
const GS_COL = {
  'GST_assy':{sn:1,done:6},'MBB_assy':{sn:1,done:8},'PLR_assy':{sn:1,done:7},
  'HBD_assy':{sn:1,done:8},'GPR_assy':{sn:1,done:8},'ARM_assy':{sn:1,done:9},
  'LAC_assy':{sn:1,done:8},'A12_assy':{sn:1,done:8},'A35_assy':{sn:1,done:8},
  'A4A_assy':{sn:1,done:8},
};

const DISP_MAP={reuse:{label:"REUSE",color:"#3b82f6",icon:"‚ôªÔ∏è",bg:"rgba(59,130,246,0.12)"},scrap:{label:"SCRAP",color:"#ef4444",icon:"üóëÔ∏è",bg:"rgba(239,68,68,0.12)"},rework:{label:"REWORK",color:"#f59e0b",icon:"üîß",bg:"rgba(245,158,11,0.12)"}};

// ============================================================
// SUPABASE REST HELPERS
// ============================================================
const hdrs = () => ({
  'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}`,
  'Content-Type': 'application/json', 'Prefer': 'return=representation',
});
async function sbGet(table, q='') {
  const r = await fetch(`${SUPABASE_URL}/rest/v1/${table}?${q}`, {headers:hdrs()});
  if(!r.ok) throw new Error(`GET ${table}: ${r.status}`);
  return r.json();
}
async function sbPost(table, data) {
  const r = await fetch(`${SUPABASE_URL}/rest/v1/${table}`, {method:'POST',headers:hdrs(),body:JSON.stringify(data)});
  if(!r.ok) throw new Error(`POST ${table}: ${r.status} ${await r.text()}`);
  return r.json();
}
async function sbPatch(table, q, data) {
  const r = await fetch(`${SUPABASE_URL}/rest/v1/${table}?${q}`, {method:'PATCH',headers:hdrs(),body:JSON.stringify(data)});
  if(!r.ok) throw new Error(`PATCH ${table}: ${r.status}`);
  return r.json();
}
async function sbUpsert(table, data) {
  const r = await fetch(`${SUPABASE_URL}/rest/v1/${table}`, {method:'POST',headers:{...hdrs(),'Prefer':'return=representation,resolution=merge-duplicates'},body:JSON.stringify(data)});
  if(!r.ok) throw new Error(`UPSERT ${table}: ${r.status}`);
  return r.json();
}
async function sbDelete(table, q) {
  const r = await fetch(`${SUPABASE_URL}/rest/v1/${table}?${q}`, {method:'DELETE',headers:hdrs()});
  if(!r.ok) throw new Error(`DELETE ${table}: ${r.status}`);
}

// ============================================================
// GOOGLE SHEETS CSV FETCH
// ============================================================
function gsCsvUrl(sheetName) {
  return `https://docs.google.com/spreadsheets/d/${GSHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(sheetName)}`;
}
function parseCSV(text) {
  const rows=[]; let cur='',inQ=false;
  for(let i=0;i<text.length;i++){
    const c=text[i];
    if(c==='"'){if(inQ&&text[i+1]==='"'){cur+='"';i++;}else inQ=!inQ;}
    else if(c===','&&!inQ){rows.length===0?rows.push([cur]):rows[rows.length-1].push(cur);cur='';}
    else if((c==='\n'||c==='\r')&&!inQ){if(cur||rows[rows.length-1]){rows.length===0?rows.push([cur]):rows[rows.length-1].push(cur);}cur='';if(c==='\r'&&text[i+1]==='\n')i++;rows.push([]);}
    else cur+=c;
  }
  if(cur){if(!rows.length)rows.push([]);rows[rows.length-1].push(cur);}
  return rows.filter(r=>r.length>0&&r.some(c=>c.trim()));
}
async function fetchGSheetUnits(assyTag) {
  const sheet=GS_SHEET_MAP[assyTag]; if(!sheet) return null;
  const cols=GS_COL[assyTag]; if(!cols) return null;
  try {
    const res=await fetch(gsCsvUrl(sheet));
    if(!res.ok) throw new Error(res.status);
    const rows=parseCSV(await res.text());
    const units=[];
    for(let i=3;i<rows.length;i++){
      const r=rows[i];
      const sn=(r[cols.sn]||'').trim().replace(/^"|"$/g,'');
      if(!sn||sn.startsWith('FXCN')||sn.startsWith('Á§æÂÜÖ'))continue;
      const done=cols.done!==null?(r[cols.done]||'').trim().replace(/^"|"$/g,''):'';
      units.push({sn, completed:done&&done!=='FALSE'?done:null, status:done&&done!=='FALSE'?'current':'pending'});
    }
    return units;
  } catch(e){ console.error('GSheet error:',e); return null; }
}

// ============================================================
// DATA STORE
// ============================================================
const DB = {
  assemblies: [],      // from eagle_eye_app_assemblies
  units: {},           // { [assemblyId]: Unit[] }
  tree: {},            // { [assemblyId]: { groups:[], steps:[], parts:[], fasteners:[] } }
  ecnChanges: {},      // { [assemblyId]: ChangeRecord[] }
  ecnApplied: {},      // { "unitSn-seqTag": {id, applied, disposition, ...} }
  versions: {},        // { [assemblyId]: string[] }
  status: 'loading',   // 'ok' | 'err' | 'loading'
  gsStatus: 'unknown',
  errors: [],

  async init() {
    this.status='loading'; render();
    try {
      this.assemblies = await sbGet('eagle_eye_app_assemblies','order=id');
      // Enrich with display meta
      this.assemblies.forEach(a => {
        const m = ASSY_META[a.tag] || {icon:'üì¶',color:'#6366f1',name:a.tag};
        a.icon = m.icon; a.color = m.color; a.section = m.section || null; a.name = m.name || a.tag;
      });
      this.status='ok';
    } catch(e) {
      console.error('Init error:',e);
      this.status='err'; this.errors.push(e.message);
    }
    render();
  },

  async loadUnits(assemblyId, assyTag) {
    if(this.units[assemblyId]) return this.units[assemblyId];
    // Try Google Sheets first
    const gsUnits = await fetchGSheetUnits(assyTag);
    if(gsUnits && gsUnits.length>0) {
      this.gsStatus='ok'; this.units[assemblyId]=gsUnits;
    } else {
      // Fallback: try production_units table
      this.gsStatus='err';
      try {
        const rows = await sbGet('eagle_eye_app_production_units',`assembly_id=eq.${assemblyId}&order=sn`);
        this.units[assemblyId] = rows.map(r=>({
          sn:r.sn, version:r.version, latestVer:r.latest_version,
          status:r.status||'current', notes:r.notes, assignedTo:r.assigned_to,
          completed: r.status==='current'?'yes':null,
        }));
      } catch(e) {
        console.error('Units load error:',e);
        this.units[assemblyId]=[];
      }
    }
    return this.units[assemblyId];
  },

  async loadTree(assemblyId, version) {
    const key=`${assemblyId}`;
    if(this.tree[key]) return this.tree[key];
    try {
      // Load ALL groups for this assembly (version filtering done client-side if needed)
      let gq = `assembly_id=eq.${assemblyId}&order=sort_order`;
      const groups = await sbGet('eagle_eye_app_groups', gq);
      if(groups.length===0){ this.tree[key]={groups:[],steps:[],partsMap:{},fastMap:{}}; return this.tree[key]; }
      const gids = groups.map(g=>g.id);
      // Load steps for these groups
      const steps = await sbGet('eagle_eye_app_steps',`group_id=in.(${gids.join(',')})&order=sort_order`);
      // Normalize type to uppercase (DB stores lowercase)
      steps.forEach(s => { if(s.type) s.type = s.type.toUpperCase(); });
      const sids = steps.map(s=>s.id);
      // Load parts & fasteners
      let parts=[], fasteners=[];
      if(sids.length>0){
        [parts, fasteners] = await Promise.all([
          sbGet('eagle_eye_app_parts',`step_id=in.(${sids.join(',')})&order=sort_order`),
          sbGet('eagle_eye_app_fasteners',`step_id=in.(${sids.join(',')})&order=sort_order`),
        ]);
      }
      // Index parts/fasteners by step_id
      const partsMap={}, fastMap={};
      parts.forEach(p=>{ if(!partsMap[p.step_id])partsMap[p.step_id]=[]; partsMap[p.step_id].push(p); });
      fasteners.forEach(f=>{ if(!fastMap[f.step_id])fastMap[f.step_id]=[]; fastMap[f.step_id].push(f); });
      this.tree[key]={groups, steps, partsMap, fastMap};
    } catch(e){
      console.error('Tree load error:',e);
      this.tree[key]={groups:[],steps:[],partsMap:{},fastMap:{}};
    }
    return this.tree[key];
  },

  async loadEcnChanges(assemblyId) {
    if(this.ecnChanges[assemblyId]) return this.ecnChanges[assemblyId];
    try {
      // Get ECN logs for steps in this assembly's groups
      const groups = await sbGet('eagle_eye_app_groups',`assembly_id=eq.${assemblyId}&select=id`);
      if(groups.length===0){this.ecnChanges[assemblyId]=[];return [];}
      const gids=groups.map(g=>g.id);
      const steps=await sbGet('eagle_eye_app_steps',`group_id=in.(${gids.join(',')})&select=id`);
      if(steps.length===0){this.ecnChanges[assemblyId]=[];return [];}
      const sids=steps.map(s=>s.id);
      const records=await sbGet('eagle_eye_app_ecn_change_records',`step_id=in.(${sids.join(',')})&order=created_at`);
      this.ecnChanges[assemblyId]=records;
    } catch(e){
      console.error('ECN load error:',e);
      this.ecnChanges[assemblyId]=[];
    }
    return this.ecnChanges[assemblyId];
  },

  async loadEcnApplied(unitSn) {
    try {
      const rows=await sbGet('eagle_eye_app_ecn_applications',`unit_sn=eq.${unitSn}`);
      rows.forEach(r=>{ this.ecnApplied[`${r.unit_sn}-${r.seq_tag}`]=r; });
    } catch(e){ console.error('ECN applied load error:',e); }
  },

  isApplied(unitSn, seqTag) {
    const r=this.ecnApplied[`${unitSn}-${seqTag}`];
    return r?.applied===true;
  },

  async toggleApplied(unitSn, seqTag, stepId) {
    const key=`${unitSn}-${seqTag}`;
    const existing=this.ecnApplied[key];
    if(existing?.applied) {
      // Undo
      await sbPatch('eagle_eye_app_ecn_applications',`id=eq.${existing.id}`,{applied:false, applied_at:null});
      existing.applied=false;
    } else if(existing) {
      // Re-apply
      await sbPatch('eagle_eye_app_ecn_applications',`id=eq.${existing.id}`,{applied:true, applied_at:new Date().toISOString(), applied_by:'Aniket'});
      existing.applied=true;
    } else {
      // New
      const [row]=await sbPost('eagle_eye_app_ecn_applications',[{unit_sn:unitSn, step_id:stepId, seq_tag:seqTag, applied:true, applied_by:'Aniket', applied_at:new Date().toISOString()}]);
      this.ecnApplied[key]=row;
    }
  },

  async loadVersions(assemblyId) {
    if(this.versions[assemblyId]) return this.versions[assemblyId];
    try {
      const rows=await sbGet('eagle_eye_app_version_history',`assembly_id=eq.${assemblyId}&order=created_at`);
      this.versions[assemblyId]=rows;
    } catch(e){ this.versions[assemblyId]=[]; }
    return this.versions[assemblyId];
  },

  // --- TREE EDITOR WRITES ---
  async addStep(groupId, data) {
    const [row]=await sbPost('eagle_eye_app_steps',[{group_id:groupId,...data}]);
    return row;
  },
  async updateStep(stepId, data) {
    const [row]=await sbPatch('eagle_eye_app_steps',`id=eq.${stepId}`,data);
    return row;
  },
  async addGroup(assemblyId, version, data) {
    const [row]=await sbPost('eagle_eye_app_groups',[{assembly_id:assemblyId, version,...data}]);
    return row;
  },
  async addPart(stepId, data) {
    const [row]=await sbPost('eagle_eye_app_parts',[{step_id:stepId,...data}]);
    return row;
  },
  async deletePart(partId) { await sbDelete('eagle_eye_app_parts',`id=eq.${partId}`); },
  async addFastener(stepId, data) {
    const [row]=await sbPost('eagle_eye_app_fasteners',[{step_id:stepId,...data}]);
    return row;
  },
  async deleteFastener(fastId) { await sbDelete('eagle_eye_app_fasteners',`id=eq.${fastId}`); },
  async updatePart(partId, data) { await sbPatch('eagle_eye_app_parts',`id=eq.${partId}`,data); },
  async updateFastener(fastId, data) { await sbPatch('eagle_eye_app_fasteners',`id=eq.${fastId}`,data); },
};

// ============================================================
// HELPERS
// ============================================================
let ID=()=>Math.random().toString(36).slice(2,9);
function toast(msg){const c=document.createElement('div');c.style.cssText='position:fixed;bottom:16px;left:50%;transform:translateX(-50%);padding:6px 16px;border-radius:6px;background:#22c55e;color:#000;font-weight:700;font-size:10px;z-index:999;font-family:"JetBrains Mono",monospace';c.textContent=msg;document.body.appendChild(c);setTimeout(()=>c.remove(),2000);}
function stepsForGroup(tree, gid){ return tree.steps.filter(s=>s.group_id===gid); }
function partsForStep(tree, sid){ return tree.partsMap[sid]||[]; }
function fastenersForStep(tree, sid){ return tree.fastMap[sid]||[]; }
function stepName(s, tree) {
  if(s.label) return s.label;
  const pts = partsForStep(tree, s.id);
  if(pts.length===1 && pts[0].pn) return pts[0].pn;
  if(pts.length>1) return pts.map(p=>p.pn).filter(Boolean).join(' + ');
  return '';
}
function dbStatus(){
  const s=DB.status, g=DB.gsStatus;
  return `<div style="display:flex;gap:4px">
    <div class="db-status ${s==='ok'?'ok':s==='err'?'err':'load'}" title="Supabase: ${s}">${s==='ok'?'‚óè':'‚óã'} DB</div>
    ${g!=='unknown'?`<div class="db-status ${g==='ok'?'ok':'err'}" title="GSheet: ${g}">${g==='ok'?'‚óè':'‚óã'} GS</div>`:''}
  </div>`;
}

// ============================================================
// STATE
// ============================================================
const S = {
  page:'home', assy:null, unitSel:new Set(), unitFilter:'all', unitSearch:'',
  selectedUnits:[], avTab:'list', modal:null, loadingUnits:false,
  teAssy:null, teVer:null, teSel:null, dupModal:false, dupVer:'',
  saveTimeout:null,
};

// ============================================================
// RENDER
// ============================================================
function render(){
  const app=document.getElementById('app');
  if(S.page==='home') app.innerHTML=renderHome();
  else if(S.page==='unitSelect') app.innerHTML=renderUnitSelect();
  else if(S.page==='assembly') app.innerHTML=renderAssembly();
  else if(S.page==='editor') app.innerHTML=renderEditor();
  attachEvents();
}

function renderHome(){
  const full=DB.assemblies.filter(a=>a.section==='full');
  const majors=DB.assemblies.filter(a=>a.section!=='full');
  return `<div class="home-wrap">
    <div class="home-admin">
      ${dbStatus()}
      <div class="admin-pill">üîß Admin ¬∑ Aniket</div>
      <button class="btn-sm" style="background:rgba(139,92,246,0.12);color:#8b5cf6;border:1px solid rgba(139,92,246,0.25)" data-action="editor">üîß Tree Editor</button>
      <div style="width:20px;height:20px;border-radius:50%;background:linear-gradient(135deg,#f59e0b,#e8952e);border:2px solid var(--border)"></div>
    </div>
    <div class="home-hero">
      <div class="home-logo">‚óà EagleEye</div>
      <div class="home-sub">Assembly version tracking & ECN management</div>
    </div>
    ${DB.errors.length>0?`<div class="error-banner">${DB.errors.map(e=>`‚ö† ${e}`).join('<br>')}</div>`:''}
    ${DB.status==='loading'?'<div class="loading-wrap"><div class="spinner"></div>Connecting to database...</div>':`
    ${full.length?`<div style="max-width:780px;width:100%;padding:0 20px"><div class="section-label">FULL ROBOT</div></div>
    <div style="max-width:780px;width:100%;padding:0 20px;margin-bottom:28px">
      ${full.map(a=>`<div class="full-robot-card" data-action="assy" data-id="${a.id}">
        <div style="font-size:28px;margin-bottom:6px">${a.icon}</div>
        <div style="font-size:15px;font-weight:700;display:flex;align-items:center;gap:8px">${a.name} <span class="badge" style="background:rgba(34,197,94,0.12);color:#22c55e">v${a.version}</span></div>
      </div>`).join('')}
    </div>`:''}
    <div style="max-width:780px;width:100%;padding:0 20px"><div class="section-label">MAJOR ASSEMBLIES</div></div>
    <div class="assy-grid">${majors.map(a=>`<div class="assy-card" style="border-left:3px solid ${a.color}" data-action="assy" data-id="${a.id}">
      <div style="display:flex;align-items:center;gap:6px;margin-bottom:6px"><span style="font-size:18px">${a.icon}</span><span style="font-size:13px;font-weight:700">${a.name}</span></div>
      <div style="display:flex;gap:4px;flex-wrap:wrap">
        <span class="badge" style="background:${a.color}15;color:${a.color}">v${a.version}</span>
      </div>
    </div>`).join('')}</div>`}
  </div>`;
}

function renderUnitSelect(){
  const a=S.assy, units=DB.units[a.id]||[];
  let filtered=units;
  if(S.unitFilter==='outdated')filtered=filtered.filter(u=>u.status==='outdated');
  if(S.unitFilter==='current')filtered=filtered.filter(u=>u.status==='current'||u.status==='pending');
  if(S.unitSearch)filtered=filtered.filter(u=>u.sn.toLowerCase().includes(S.unitSearch.toLowerCase()));
  return `<div style="min-height:100vh;background:var(--bg);padding:16px"><div style="max-width:800px;margin:0 auto">
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:14px">
      <button class="btn-sm" style="background:transparent;color:var(--muted)" data-action="goHome">‚Üê Back</button>
      <span style="font-size:22px">${a.icon}</span>
      <div><div style="font-size:16px;font-weight:700">${a.name}</div><div style="font-size:10px;color:var(--muted)" class="mono">${units.length} units ¬∑ v${a.version} ${DB.gsStatus==='ok'?'<span style="color:#22c55e">‚óè Live from Google Sheets</span>':DB.gsStatus==='err'?'<span style="color:#f59e0b">‚óè From Supabase</span>':''}</div></div>
    </div>
    ${S.loadingUnits?'<div class="loading-wrap"><div class="spinner"></div>Loading units...</div>':`
    <div style="display:flex;gap:6px;margin-bottom:10px;flex-wrap:wrap;align-items:center">
      <input class="inp" style="width:150px" placeholder="Search S/N..." data-role="unitSearch" value="${S.unitSearch}">
      ${['all','outdated','current'].map(f=>`<button class="us-filter ${S.unitFilter===f?'active':''}" data-f="${f}" data-action="setFilter">${f}</button>`).join('')}
      <button class="btn-sm" style="margin-left:auto;background:transparent;color:var(--muted);font-size:9px" data-action="selectAll">Select all (${filtered.length})</button>
    </div>
    <div class="unit-grid">${filtered.map(u=>{const sel=S.unitSel.has(u.sn),out=u.status==='outdated';
      return `<div class="unit-card ${sel?'selected':''}" data-action="toggleUnit" data-sn="${u.sn}">
        ${sel?'<div style="position:absolute;top:4px;right:6px;font-size:10px;color:var(--accent)">‚úì</div>':''}
        <div style="font-size:11px;font-weight:700" class="mono">${u.sn}</div>
        <div style="display:flex;gap:3px;margin-top:2px">
          <span class="badge" style="background:${out?'rgba(239,68,68,0.12)':u.completed?'rgba(34,197,94,0.12)':'rgba(245,158,11,0.12)'};color:${out?'#ef4444':u.completed?'#22c55e':'#f59e0b'}">${out?'outdated':u.completed?'done':'pending'}</span>
          ${u.version?`<span class="badge" style="background:rgba(107,112,128,0.1);color:var(--muted)">v${u.version}</span>`:''}
        </div>
      </div>`;}).join('')}
    </div>
    ${S.unitSel.size>0?`<div style="margin-top:10px;padding:8px 14px;border-radius:10px;background:rgba(245,158,11,0.04);border:1px solid rgba(245,158,11,0.15);display:flex;align-items:center;justify-content:space-between">
      <span style="font-weight:700;font-size:12px">${S.unitSel.size} selected</span>
      <button style="padding:6px 18px;border-radius:8px;font-size:12px;font-weight:700;border:none;color:#000;cursor:pointer;background:${a.color}" data-action="proceed">Open Assembly View ‚Üí</button>
    </div>`:''}`}
  </div></div>`;
}

function renderAssembly(){
  const a=S.assy, unit=S.selectedUnits[0]; if(!unit) return '';
  const treeKey=`${a.id}`;
  const tree=DB.tree[treeKey];
  if(!tree) return '<div class="loading-wrap"><div class="spinner"></div>Loading tree...</div>';
  const ecnRecords=DB.ecnChanges[a.id]||[];
  const appliedCount=ecnRecords.filter(c=>DB.isApplied(unit.sn,c.seq_tag)).length;
  const allDone=ecnRecords.length>0&&ecnRecords.every(c=>DB.isApplied(unit.sn,c.seq_tag));
  const tab=S.avTab;
  const totalP=tree.steps.reduce((s,st)=>(partsForStep(tree,st.id)).length+s,0);
  const totalF=tree.steps.reduce((s,st)=>(fastenersForStep(tree,st.id)).length+s,0);

  let tabContent='';
  if(tab==='list'){
    let banner='';
    if(ecnRecords.length>0){
      banner=`<div class="ecn-banner">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px">
          <span style="font-size:15px;font-weight:700;color:#ef4444">‚ö† ${ecnRecords.length} ECN changes</span>
          <span style="font-size:13px;color:var(--muted)" class="mono">${appliedCount}/${ecnRecords.length}</span>
        </div>
        <div style="height:3px;border-radius:2px;background:rgba(239,68,68,0.1);overflow:hidden;margin-bottom:8px"><div style="height:100%;border-radius:2px;transition:width 0.3s;width:${ecnRecords.length>0?(appliedCount/ecnRecords.length)*100:0}%;background:${allDone?'#22c55e':'#f59e0b'}"></div></div>
        ${ecnRecords.map((c,i)=>{const done=DB.isApplied(unit.sn,c.seq_tag);
          return `<div class="ecn-item ${done?'done':''}" data-action="openChange" data-idx="${i}">
            <span style="font-size:13px;font-weight:700;font-family:'JetBrains Mono',monospace;min-width:34px;text-align:center;padding:4px 8px;border-radius:6px;color:${done?'#22c55e':'#ef4444'};background:${done?'rgba(34,197,94,0.12)':'rgba(239,68,68,0.1)'}">${c.seq_tag}</span>
            <span style="flex:1;font-size:14px;font-weight:500;${done?'opacity:0.5;text-decoration:line-through':''}">${c.step_name||''}</span>
            <span style="font-size:13px;color:var(--muted)" class="mono">${c.field||c.change_type}</span>
            <span style="font-size:14px;color:${done?'#22c55e':'var(--dim)'}">${done?'‚úì':'‚óã'}</span>
          </div>`;}).join('')}
        ${allDone?`<div style="margin-top:10px;padding:14px 16px;border-radius:10px;background:rgba(34,197,94,0.06);border:2px solid rgba(34,197,94,0.25);text-align:center">
          <div style="font-size:15px;font-weight:700;color:#22c55e">‚úÖ All changes applied for ${unit.sn}</div>
        </div>`:''}
      </div>`;
    }
    // Tree list
    let treeHtml='<div class="tree-list">';
    tree.groups.forEach(g=>{
      const gSteps=stepsForGroup(tree,g.id);
      treeHtml+=`<div style="margin-bottom:6px"><div class="grp-hdr" style="background:${g.color||'#666'}08;border-left:4px solid ${g.color||'#666'}">
        <span style="font-size:11px;color:var(--muted)">‚ñº</span>
        <span style="font-size:16px">${g.icon||'üì¶'}</span>
        <span style="font-weight:700;color:${g.color||'#666'};flex:1;font-size:15px">${g.label}</span>
        <span style="color:var(--muted);font-size:13px" class="mono">${gSteps.length}</span></div>`;
      gSteps.forEach(s=>{
        const pts=partsForStep(tree,s.id), fts=fastenersForStep(tree,s.id);
        const hasEcn=s.ecn_status==='changed'||ecnRecords.some(c=>c.step_id===s.id);
        const done=DB.isApplied(unit.sn,s.seq_tag);
        treeHtml+=`<div class="step-row" style="${done?'opacity:0.4':''}">
          <span style="color:var(--dim);font-size:12px">‚†ø</span>
          ${hasEcn?`<span style="font-size:10px">${done?'‚úÖ':'üî¥'}</span>`:''}
          <span style="font-weight:700;min-width:32px;text-align:center;font-size:13px;padding:3px 8px;border-radius:5px;background:${g.color||'#666'}15;color:${g.color||'#666'}" class="mono">${s.seq_tag||'‚Äî'}</span>
          <span style="font-size:12px;font-weight:600;padding:2px 8px;border-radius:4px;color:${s.type==='PREP'?'#a855f7':s.type==='CHECK'?'#ec4899':'#22c55e'};background:${s.type==='PREP'?'rgba(168,85,247,0.1)':s.type==='CHECK'?'rgba(236,72,153,0.1)':'rgba(34,197,94,0.1)'}">${s.type||'STEP'}</span>
          <span style="flex:1;font-size:14px">${s.label||s.pn||''}</span>
          ${pts.length>0?`<span style="font-size:12px;color:#22c55e;font-weight:600" class="mono">${pts.length}P</span>`:''}
          ${fts.length>0?`<span style="font-size:12px;color:#ef4444;font-weight:600" class="mono">${fts.length}F</span>`:''}
        </div>`;});
      treeHtml+='</div>';});
    treeHtml+='</div>';
    tabContent=banner+treeHtml;
  } else {
    tabContent=`<div style="display:flex;flex-direction:column;align-items:center;padding:80px 20px;color:var(--dim)"><div style="font-size:40px;margin-bottom:12px;opacity:0.3">üîß</div><div style="font-size:20px;font-weight:700">${tab==='graph'?'Graph':'Kanban'} View</div><div style="font-size:13px;margin-top:6px">Coming soon</div></div>`;
  }

  return `<div style="min-height:100vh;background:var(--bg)">
    <div class="av-header">
      <button style="background:none;border:1px solid var(--border);border-radius:8px;padding:6px 14px;color:var(--muted);cursor:pointer;font-size:13px" data-action="backToUnits">‚Üê Units</button>
      <span style="font-size:18px;font-weight:800;color:var(--accent)" class="mono">‚óà</span>
      <select class="inp" style="padding:6px 12px;font-size:14px;font-weight:600;min-width:200px" data-role="unitPicker">${S.selectedUnits.map(u=>`<option value="${u.sn}" ${u.sn===unit.sn?'selected':''}>${u.sn}</option>`).join('')}</select>
      <div style="margin-left:auto;display:flex;align-items:center;gap:8px">
        ${dbStatus()}
        <div class="admin-pill">üîß Admin ¬∑ Aniket</div>
      </div>
    </div>
    <div class="av-tabs">
      <button class="av-tab ${tab==='list'?'active':''}" data-action="avTab" data-tab="list">‚â° List ${ecnRecords.length-appliedCount>0?`<span class="count">${ecnRecords.length-appliedCount}</span>`:''}</button>
      <button class="av-tab ${tab==='graph'?'active':''}" data-action="avTab" data-tab="graph">‚óà Graph <span class="soon">SOON</span></button>
      <button class="av-tab ${tab==='kanban'?'active':''}" data-action="avTab" data-tab="kanban">‚ñ¶ Kanban <span class="soon">SOON</span></button>
      <div style="margin-left:auto;display:flex;gap:12px;font-size:13px;color:var(--muted)" class="mono">
        <span><span style="color:#22c55e;font-weight:700">${totalP}</span> parts</span>
        <span><span style="color:#ef4444;font-weight:700">${totalF}</span> fasteners</span>
        <span><span style="font-weight:700">${tree.steps.length}</span> steps</span>
      </div>
    </div>
    ${tabContent}
  </div>${S.modal!==null?renderChangeModal():''}`;
}

function renderChangeModal(){
  const unit=S.selectedUnits[0], ecnRecords=DB.ecnChanges[S.assy.id]||[], ch=ecnRecords[S.modal]; if(!ch) return '';
  const isDone=DB.isApplied(unit.sn,ch.seq_tag);
  const tc={part_changed:{bg:"rgba(59,130,246,0.08)",c:"#3b82f6",l:"Part Changed"},fastener_changed:{bg:"rgba(239,68,68,0.08)",c:"#ef4444",l:"Fastener Changed"},step_modified:{bg:"rgba(168,85,247,0.08)",c:"#a855f7",l:"Step Modified"}}[ch.change_type]||{bg:"rgba(168,85,247,0.08)",c:"#a855f7",l:ch.change_type||"Modified"};
  return `<div class="cm-overlay" data-action="closeModal"><div class="cm-box" onclick="event.stopPropagation()">
    <div style="padding:14px 18px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px">
      <span class="mono" style="font-size:14px;font-weight:700;color:${tc.c};background:${tc.bg};padding:4px 10px;border-radius:6px">${ch.seq_tag}</span>
      <div style="flex:1"><div style="font-size:16px;font-weight:700">${ch.step_name||''}</div><div style="font-size:12px;color:var(--muted)">${ch.group_name||''} ¬∑ ${unit.sn}</div></div>
      <button style="background:none;border:none;color:var(--muted);font-size:18px;cursor:pointer" data-action="closeModal">‚úï</button>
    </div>
    <div style="padding:18px;overflow-y:auto;flex:1;display:flex;flex-direction:column;gap:14px">
      <span class="badge" style="background:${tc.bg};color:${tc.c};align-self:flex-start;font-size:11px;padding:3px 10px">${tc.l}</span>
      <div style="display:flex;gap:8px">
        ${ch.old_value?`<div style="flex:1;padding:12px;border-radius:8px;background:rgba(239,68,68,0.04);border:1px solid rgba(239,68,68,0.08)"><div style="font-size:9px;font-weight:700;color:#ef4444;text-transform:uppercase;letter-spacing:1px;margin-bottom:4px">Before</div><div style="font-size:14px;font-weight:600" class="mono">${ch.old_value}</div></div>`:''}
        <div style="flex:1;padding:12px;border-radius:8px;background:rgba(34,197,94,0.04);border:1px solid rgba(34,197,94,0.08)"><div style="font-size:9px;font-weight:700;color:#22c55e;text-transform:uppercase;letter-spacing:1px;margin-bottom:4px">${ch.old_value?'After':'New'}</div><div style="font-size:14px;font-weight:600" class="mono">${ch.new_value||''}</div></div>
      </div>
      ${ch.reason?`<div style="padding:12px;border-radius:8px;background:rgba(245,158,11,0.04);border:1px solid rgba(245,158,11,0.08)"><div style="font-size:9px;font-weight:700;color:var(--accent);text-transform:uppercase;letter-spacing:1px;margin-bottom:3px">Reason</div><div style="font-size:13px">${ch.reason}</div></div>`:''}
      ${ch.disposition?`<div style="font-size:12px;color:var(--muted)">Disposition: <span style="font-weight:700">${ch.disposition}</span></div>`:''}
    </div>
    <div style="padding:12px 18px;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:8px;align-items:center">
      ${isDone?'<span style="font-size:12px;color:#22c55e;margin-right:auto">‚úÖ Applied</span>':''}
      <button style="background:transparent;border:1px solid var(--border);border-radius:8px;padding:8px 16px;color:var(--muted);cursor:pointer;font-size:13px" data-action="closeModal">Close</button>
      <button style="padding:8px 20px;border-radius:8px;font-size:13px;font-weight:700;border:none;cursor:pointer;background:${isDone?'rgba(239,68,68,0.12)':'#22c55e'};color:${isDone?'#ef4444':'#000'}" data-action="toggleApply" data-seq="${ch.seq_tag}" data-sid="${ch.step_id}">${isDone?'‚Ü© Undo':'‚úì Mark Applied'}</button>
    </div>
  </div></div>`;
}

// ---------- TREE EDITOR ----------
function renderEditor(){
  if(!S.teAssy) return renderEditorPicker();
  const a=DB.assemblies.find(x=>x.id===S.teAssy); if(!a) return '';
  const treeKey=`${a.id}`;
  const tree=DB.tree[treeKey];
  if(!tree) return '<div class="loading-wrap"><div class="spinner"></div>Loading tree...</div>';
  const sel=S.teSel;
  let selStep=null, selParts=[], selFast=[];
  if(sel){
    selStep=tree.steps.find(s=>s.id===sel);
    if(selStep){ selParts=partsForStep(tree,selStep.id); selFast=fastenersForStep(tree,selStep.id); }
  }
  let rightPanel='';
  if(selStep){
    rightPanel=`
      <div style="font-size:16px;font-weight:700;margin-bottom:12px">${selStep.label||selStep.pn||'Untitled'}</div>
      <div style="display:flex;gap:8px;align-items:center;margin-bottom:12px">
        <div><div class="dp-label">SEQ TAG</div><input class="inp" style="width:56px;font-weight:700;font-size:13px;padding:6px 8px" value="${selStep.seq_tag||''}" data-role="teSeqTag" data-sid="${selStep.id}"></div>
        <div><div class="dp-label">TYPE</div><select class="inp" style="font-size:13px;padding:6px 8px" data-role="teType" data-sid="${selStep.id}"><option ${selStep.type==='STEP'?'selected':''}>STEP</option><option ${selStep.type==='PREP'?'selected':''}>PREP</option><option ${selStep.type==='CHECK'?'selected':''}>CHECK</option></select></div>
        <div style="flex:1"><div class="dp-label">LABEL</div><input class="inp" style="width:100%;font-size:13px;padding:6px 8px" value="${selStep.label||''}" data-role="teLabel" data-sid="${selStep.id}"></div>
      </div>
      ${selStep.ecn_status?`<div style="padding:8px 12px;border-radius:8px;margin-bottom:12px;background:rgba(239,68,68,0.04);border:1px solid rgba(239,68,68,0.12);font-size:12px;font-weight:700;color:#ef4444">üî¥ ECN: ${selStep.ecn_status}</div>`:''}
      <div style="margin-bottom:12px">
        <div style="display:flex;align-items:center;margin-bottom:6px"><span class="dp-label" style="flex:1;margin:0">PARTS (${selParts.length})</span><button class="btn-sm" style="background:rgba(34,197,94,0.12);color:#22c55e;border:none;font-size:11px;padding:4px 10px" data-action="addPart" data-sid="${selStep.id}">+ Part</button></div>
        ${selParts.map((p,pi)=>`<div class="dp-row"><input class="inp" style="width:80px;font-weight:700;color:#0ea5e9;font-size:12px" value="${p.pn||''}" data-role="partPn" data-pid="${p.id}"><input class="inp" type="number" style="width:40px;text-align:center;font-size:12px" value="${p.qty||1}" data-role="partQty" data-pid="${p.id}"><button style="background:none;border:none;color:#ef4444;font-size:12px;cursor:pointer" data-action="delPart" data-pid="${p.id}">‚úï</button></div>`).join('')}
      </div>
      <div style="margin-bottom:12px">
        <div style="display:flex;align-items:center;margin-bottom:6px"><span class="dp-label" style="flex:1;margin:0">FASTENERS (${selFast.length})</span><button class="btn-sm" style="background:rgba(245,158,11,0.12);color:#f59e0b;border:none;font-size:11px;padding:4px 10px" data-action="addFastener" data-sid="${selStep.id}">+ Fastener</button></div>
        ${selFast.map((f,fi)=>`<div style="display:flex;gap:4px;align-items:center;margin-bottom:4px"><input class="inp" style="width:74px;font-weight:700;color:#f59e0b;font-size:12px" value="${f.pn||''}" data-role="fastPn" data-fid="${f.id}"><input class="inp" style="flex:1;font-size:12px" value="${f.torque||''}" placeholder="Torque" data-role="fastTorque" data-fid="${f.id}"><input class="inp" style="width:36px;font-size:12px" value="${f.loctite||''}" placeholder="Loc" data-role="fastLoc" data-fid="${f.id}"><input class="inp" type="number" style="width:32px;text-align:center;font-size:12px" value="${f.qty||1}" data-role="fastQty" data-fid="${f.id}"><button style="background:none;border:none;color:#ef4444;font-size:12px;cursor:pointer" data-action="delFast" data-fid="${f.id}">‚úï</button></div>`).join('')}
      </div>`;
  } else {
    rightPanel='<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;color:var(--dim);font-size:14px"><div style="font-size:36px;margin-bottom:12px;opacity:0.3">üîß</div><div>Select a step to edit</div></div>';
  }

  return `<div class="te-wrap">
    <div class="te-left">
      <div class="te-topbar">
        <button style="background:none;border:1px solid var(--border);border-radius:8px;padding:6px 14px;color:var(--muted);cursor:pointer;font-size:13px" data-action="teBack">‚Üê Assemblies</button>
        <span style="font-size:16px;font-weight:800;color:#8b5cf6">üîß</span>
        <span style="font-weight:700;color:#8b5cf6;font-size:16px" class="mono">Tree Editor</span>
        <div style="width:1px;height:18px;background:var(--border);margin:0 4px"></div>
        <span style="font-size:18px">${a.icon}</span>
        <span style="font-weight:700;font-size:16px;color:${a.color}">${a.name}</span>
        <span class="badge" style="background:${a.color}15;color:${a.color}">v${S.teVer||a.version}</span>
        <div style="margin-left:auto">${dbStatus()}</div>
      </div>
      <div class="te-tree">
        ${tree.groups.map((g,gi)=>{
          const gSteps=stepsForGroup(tree,g.id);
          return `<div style="margin-bottom:6px">
          <div class="te-grp" style="background:${g.color||'#666'}08;border-left:4px solid ${g.color||'#666'}">
            <span style="font-size:16px">${g.icon||'üì¶'}</span>
            <span style="font-weight:700;color:${g.color||'#666'};flex:1;font-size:15px" class="mono">${g.label}</span>
            <span style="color:var(--muted);font-size:13px">${gSteps.length}</span>
            <button style="background:none;border:none;color:#22c55e;cursor:pointer;font-size:16px;padding:0 4px" data-action="addStep" data-gid="${g.id}">+</button>
          </div>
          ${gSteps.map(s=>{const isSel=sel===s.id;
            return `<div class="te-step ${isSel?'sel':''}" data-action="selStep" data-sid="${s.id}" style="${isSel?'':'border:1px solid transparent'}">
              ${s.ecn_status?'<span style="font-size:11px">üî¥</span>':''}
              <span style="font-weight:700;color:${g.color||'#666'};min-width:30px;text-align:center;font-size:13px;background:${g.color||'#666'}15;padding:3px 8px;border-radius:5px" class="mono">${s.seq_tag||'‚Äî'}</span>
              <span style="font-size:11px;font-weight:600;padding:2px 8px;border-radius:4px;color:${s.type==='PREP'?'#a855f7':s.type==='CHECK'?'#ec4899':'#22c55e'};background:${s.type==='PREP'?'rgba(168,85,247,0.1)':s.type==='CHECK'?'rgba(236,72,153,0.1)':'rgba(34,197,94,0.1)'}">${s.type||'STEP'}</span>
              <span style="flex:1;color:${s.label?'var(--text)':'var(--dim)'};font-size:14px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${s.label||s.pn||'untitled'}</span>
              ${(partsForStep(tree,s.id)).length>0?`<span style="font-size:11px;color:#22c55e;font-weight:600" class="mono">${partsForStep(tree,s.id).length}P</span>`:''}
              ${(fastenersForStep(tree,s.id)).length>0?`<span style="font-size:11px;color:#ef4444;font-weight:600" class="mono">${fastenersForStep(tree,s.id).length}F</span>`:''}
            </div>`;}).join('')}
        </div>`;}).join('')}
        <button class="btn-sm" style="width:100%;margin-top:8px;padding:10px;background:rgba(99,102,241,0.12);color:#6366f1;border:none;font-size:12px" data-action="addGroup">+ Add Group</button>
      </div>
    </div>
    <div class="te-right">${rightPanel}</div>
  </div>`;
}

function renderEditorPicker(){
  const editable=DB.assemblies.filter(a=>a.section!=='full');
  return `<div class="te-pick-wrap">
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:36px;width:100%;max-width:760px">
      <button style="background:none;border:1px solid var(--border);border-radius:8px;padding:6px 14px;color:var(--muted);cursor:pointer;font-size:13px" data-action="goHome">‚Üê Home</button>
      <span style="font-size:20px;font-weight:800;color:#8b5cf6">üîß</span>
      <span style="font-weight:700;color:#8b5cf6;font-size:20px" class="mono">Tree Editor</span>
      <div style="margin-left:auto">${dbStatus()}</div>
    </div>
    <div class="te-pick-grid">
      ${editable.map(a=>`<div class="te-pick-card" data-action="pickAssy" data-id="${a.id}" style="border-color:${a.color}40"
        onmouseenter="this.style.borderColor='${a.color}'" onmouseleave="this.style.borderColor='${a.color}40'">
        <div style="font-size:48px;margin-bottom:12px">${a.icon}</div>
        <div style="font-size:17px;font-weight:700;margin-bottom:8px">${a.name}</div>
        <span class="badge" style="background:${a.color}15;color:${a.color};font-size:11px;padding:3px 8px">v${a.version}</span>
      </div>`).join('')}
    </div>
  </div>`;
}

// ============================================================
// EVENTS
// ============================================================
function attachEvents(){
  document.querySelectorAll('[data-action]').forEach(el=>{
    el.onclick=async(e)=>{
      const a=el.dataset.action;
      if(a==='editor'){S.page='editor';S.teAssy=null;S.teSel=null;render();}
      else if(a==='goHome'){S.page='home';render();}
      else if(a==='assy'){
        const assy=DB.assemblies.find(x=>x.id===parseInt(el.dataset.id));
        S.assy=assy;S.page='unitSelect';S.unitSel=new Set();S.unitFilter='all';S.unitSearch='';
        S.loadingUnits=true;render();
        await DB.loadUnits(assy.id, assy.tag);
        await DB.loadEcnChanges(assy.id);
        S.loadingUnits=false;render();
      }
      else if(a==='setFilter'){S.unitFilter=el.dataset.f;render();}
      else if(a==='selectAll'){
        const units=DB.units[S.assy.id]||[];
        let f=units;
        if(S.unitFilter==='outdated')f=f.filter(u=>u.status==='outdated');
        if(S.unitFilter==='current')f=f.filter(u=>u.status==='current'||u.status==='pending');
        f.forEach(u=>S.unitSel.add(u.sn));render();
      }
      else if(a==='toggleUnit'){const sn=el.dataset.sn;S.unitSel.has(sn)?S.unitSel.delete(sn):S.unitSel.add(sn);render();}
      else if(a==='proceed'){
        const units=DB.units[S.assy.id]||[];
        S.selectedUnits=[...S.unitSel].map(sn=>units.find(u=>u.sn===sn)).filter(Boolean);
        S.avTab='list';S.page='assembly';render();
        // Load tree + applied changes
        await DB.loadTree(S.assy.id, S.assy.version);
        if(S.selectedUnits[0]) await DB.loadEcnApplied(S.selectedUnits[0].sn);
        render();
      }
      else if(a==='backToUnits'){S.page='unitSelect';render();}
      else if(a==='avTab'){S.avTab=el.dataset.tab;render();}
      else if(a==='openChange'){S.modal=parseInt(el.dataset.idx);render();}
      else if(a==='closeModal'){S.modal=null;render();}
      else if(a==='toggleApply'){
        try {
          await DB.toggleApplied(S.selectedUnits[0].sn, el.dataset.seq, parseInt(el.dataset.sid));
          S.modal=null; toast('üíæ Saved'); render();
        } catch(err){ toast('‚ùå '+err.message); }
      }
      // Tree editor
      else if(a==='pickAssy'){
        S.teAssy=parseInt(el.dataset.id);S.teSel=null;
        const assy=DB.assemblies.find(x=>x.id===S.teAssy);
        S.teVer=assy?.version;
        await DB.loadTree(S.teAssy, S.teVer); render();
      }
      else if(a==='teBack'){S.teAssy=null;S.teSel=null;render();}
      else if(a==='selStep'){S.teSel=parseInt(el.dataset.sid);render();}
      else if(a==='addStep'){
        try {
          const gid=parseInt(el.dataset.gid);
          const row=await DB.addStep(gid,{seq_tag:'',type:'STEP',label:'New step',sort_order:999});
          // Refresh tree
          const assy=DB.assemblies.find(x=>x.id===S.teAssy);
          delete DB.tree[`${S.teAssy}`];
          await DB.loadTree(S.teAssy, S.teVer||assy?.version);
          toast('‚úÖ Step added'); render();
        } catch(err){ toast('‚ùå '+err.message); }
      }
      else if(a==='addGroup'){
        try {
          const assy=DB.assemblies.find(x=>x.id===S.teAssy);
          await DB.addGroup(S.teAssy, S.teVer||assy?.version, {label:'New Group',icon:'üì¶',color:'#6366f1',sort_order:999});
          delete DB.tree[`${S.teAssy}`];
          await DB.loadTree(S.teAssy, S.teVer||assy?.version);
          toast('‚úÖ Group added'); render();
        } catch(err){ toast('‚ùå '+err.message); }
      }
      else if(a==='addPart'){
        try {
          const sid=parseInt(el.dataset.sid);
          await DB.addPart(sid,{pn:'',qty:1,sort_order:999});
          const assy=DB.assemblies.find(x=>x.id===S.teAssy);
          delete DB.tree[`${S.teAssy}`];
          await DB.loadTree(S.teAssy, S.teVer||assy?.version);
          toast('‚úÖ Part added'); render();
        } catch(err){ toast('‚ùå '+err.message); }
      }
      else if(a==='delPart'){
        try {
          await DB.deletePart(parseInt(el.dataset.pid));
          const assy=DB.assemblies.find(x=>x.id===S.teAssy);
          delete DB.tree[`${S.teAssy}`];
          await DB.loadTree(S.teAssy, S.teVer||assy?.version);
          render();
        } catch(err){ toast('‚ùå '+err.message); }
      }
      else if(a==='addFastener'){
        try {
          const sid=parseInt(el.dataset.sid);
          await DB.addFastener(sid,{pn:'',qty:1,torque:'',loctite:'',sort_order:999});
          const assy=DB.assemblies.find(x=>x.id===S.teAssy);
          delete DB.tree[`${S.teAssy}`];
          await DB.loadTree(S.teAssy, S.teVer||assy?.version);
          toast('‚úÖ Fastener added'); render();
        } catch(err){ toast('‚ùå '+err.message); }
      }
      else if(a==='delFast'){
        try {
          await DB.deleteFastener(parseInt(el.dataset.fid));
          const assy=DB.assemblies.find(x=>x.id===S.teAssy);
          delete DB.tree[`${S.teAssy}`];
          await DB.loadTree(S.teAssy, S.teVer||assy?.version);
          render();
        } catch(err){ toast('‚ùå '+err.message); }
      }
      e.stopPropagation();
    };
  });

  // Debounced input handlers for tree editor updates
  let saveTimer=null;
  function debouncedSave(fn){
    clearTimeout(saveTimer);
    saveTimer=setTimeout(async()=>{try{await fn();toast('üíæ');}catch(err){toast('‚ùå '+err.message);}},800);
  }
  document.querySelectorAll('[data-role]').forEach(el=>{
    const r=el.dataset.role;
    if(r==='unitSearch'){el.oninput=()=>{S.unitSearch=el.value;render();};}
    if(r==='unitPicker'){el.onchange=async()=>{
      const u=S.selectedUnits.find(x=>x.sn===el.value);
      if(u){S.selectedUnits=[u,...S.selectedUnits.filter(x=>x.sn!==u.sn)];await DB.loadEcnApplied(u.sn);render();}
    };}
    // Tree editor field updates
    if(r==='teSeqTag'){el.oninput=()=>debouncedSave(()=>DB.updateStep(parseInt(el.dataset.sid),{seq_tag:el.value}));}
    if(r==='teType'){el.onchange=()=>debouncedSave(()=>DB.updateStep(parseInt(el.dataset.sid),{type:el.value}));}
    if(r==='teLabel'){el.oninput=()=>debouncedSave(()=>DB.updateStep(parseInt(el.dataset.sid),{label:el.value}));}
    if(r==='partPn'){el.oninput=()=>debouncedSave(()=>DB.updatePart(parseInt(el.dataset.pid),{pn:el.value}));}
    if(r==='partQty'){el.oninput=()=>debouncedSave(()=>DB.updatePart(parseInt(el.dataset.pid),{qty:parseInt(el.value)||1}));}
    if(r==='fastPn'){el.oninput=()=>debouncedSave(()=>DB.updateFastener(parseInt(el.dataset.fid),{pn:el.value}));}
    if(r==='fastTorque'){el.oninput=()=>debouncedSave(()=>DB.updateFastener(parseInt(el.dataset.fid),{torque:el.value}));}
    if(r==='fastLoc'){el.oninput=()=>debouncedSave(()=>DB.updateFastener(parseInt(el.dataset.fid),{loctite:el.value}));}
    if(r==='fastQty'){el.oninput=()=>debouncedSave(()=>DB.updateFastener(parseInt(el.dataset.fid),{qty:parseInt(el.value)||1}));}
  });
}

// ============================================================
// BOOT
// ============================================================
DB.init();
</script>
</body>
</html>

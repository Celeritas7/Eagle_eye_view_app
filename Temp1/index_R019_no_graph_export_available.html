<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EagleEye ‚Äî Assembly Tracking</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700;800&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#0a0b0f;--card:#12131a;--hover:#1a1c24;--modal:#15161e;
  --border:#1e2030;--text:#d1d5e4;--muted:#6b7080;--dim:#3a3d4d;
  --accent:#f59e0b;--purple:#8b5cf6;
  --red:#ef4444;--green:#22c55e;--blue:#3b82f6;--orange:#f97316;--pink:#ec4899;--cyan:#06b6d4;
}
body{font-family:'DM Sans',system-ui,sans-serif;background:var(--bg);color:var(--text);min-height:100vh;font-size:12px}
::-webkit-scrollbar{width:4px}::-webkit-scrollbar-track{background:var(--bg)}::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px}
select option{background:var(--card);color:var(--text)}
input[type=number]::-webkit-inner-spin-button,input[type=number]::-webkit-outer-spin-button{-webkit-appearance:none}
.mono{font-family:'JetBrains Mono',monospace}
.badge{padding:1px 6px;border-radius:6px;font-size:9px;font-weight:700;font-family:'JetBrains Mono',monospace;display:inline-block}
.btn-sm{padding:3px 10px;border-radius:6px;font-size:10px;font-weight:700;border:1px solid var(--border);cursor:pointer;font-family:'JetBrains Mono',monospace}
.btn-sm:hover{background:var(--hover)}
.inp{background:#0d0e14;border:1px solid var(--border);border-radius:5px;padding:4px 7px;color:var(--text);font-size:11px;font-family:'JetBrains Mono',monospace;outline:none}
.inp:focus{border-color:var(--accent)}
.loading-wrap{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:200px;color:var(--muted)}
.spinner{width:24px;height:24px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin 0.8s linear infinite;margin-bottom:12px}
@keyframes spin{to{transform:rotate(360deg)}}
.error-banner{margin:16px 24px;padding:12px 16px;border-radius:8px;background:rgba(239,68,68,0.08);border:1px solid rgba(239,68,68,0.15);color:var(--red);font-size:12px;max-width:780px;width:100%}

/* HOME */
.home-wrap{min-height:100vh;display:flex;flex-direction:column;align-items:center}
.home-admin{position:fixed;top:10px;right:14px;display:flex;align-items:center;gap:6px;z-index:10}
.admin-pill{display:flex;align-items:center;gap:4px;padding:4px 10px;border-radius:6px;background:rgba(245,158,11,0.08);border:1px solid rgba(245,158,11,0.2);font-size:10px;font-weight:600;color:var(--accent);font-family:'JetBrains Mono',monospace}
.home-hero{text-align:center;padding-top:50px;margin-bottom:28px}
.home-logo{font-size:42px;font-weight:900;color:var(--accent);font-family:'JetBrains Mono',monospace;letter-spacing:-2px;line-height:1}
.home-sub{font-size:13px;color:var(--muted);margin-top:8px}
.section-label{font-family:'JetBrains Mono',monospace;font-size:10px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--dim);margin-bottom:10px}
.assy-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(170px,1fr));gap:8px;max-width:780px;width:100%;padding:0 20px 40px}
.assy-card{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:12px 14px;cursor:pointer;transition:all 0.15s}
.assy-card:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,0.3)}
.full-robot-card{background:var(--card);border:2px solid rgba(34,197,94,0.25);border-radius:10px;padding:14px 16px;cursor:pointer;transition:all 0.2s;max-width:280px}
.full-robot-card:hover{border-color:var(--green);transform:translateY(-2px)}

/* UNIT SELECT */
.us-filter{padding:4px 10px;border-radius:6px;font-size:10px;font-weight:600;cursor:pointer;border:1px solid var(--border);background:transparent;color:var(--muted);text-transform:capitalize;font-family:'DM Sans',sans-serif}
.us-filter.active{border:none}
.us-filter[data-f="all"].active{background:rgba(245,158,11,0.15);color:var(--accent)}
.us-filter[data-f="outdated"].active{background:rgba(239,68,68,0.15);color:var(--red)}
.us-filter[data-f="current"].active{background:rgba(34,197,94,0.15);color:var(--green)}
.unit-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(125px,1fr));gap:4px;max-height:380px;overflow-y:auto;padding:2px}
.unit-card{padding:6px 8px;border-radius:6px;cursor:pointer;border:1px solid var(--border);background:var(--card);transition:all 0.1s;position:relative}
.unit-card.selected{border:2px solid var(--accent);background:rgba(245,158,11,0.03)}

/* ASSEMBLY VIEW */
.av-header{display:flex;align-items:center;gap:12px;padding:12px 24px;border-bottom:1px solid var(--border);background:#0e0f15;position:sticky;top:0;z-index:10;flex-wrap:wrap}
.av-tabs{display:flex;align-items:center;gap:0;padding:0 24px;border-bottom:1px solid var(--border);background:#0e0f15}
.av-tab{display:flex;align-items:center;gap:6px;padding:14px 22px;font-size:16px;font-weight:500;color:var(--muted);background:transparent;border:none;cursor:pointer;border-bottom:2px solid transparent;font-family:'DM Sans',sans-serif}
.av-tab.active{font-weight:700;color:var(--accent);border-bottom-color:var(--accent)}
.av-tab .count{font-size:11px;font-weight:700;padding:2px 7px;border-radius:6px;background:rgba(239,68,68,0.15);color:var(--red);font-family:'JetBrains Mono',monospace}
.av-tab .soon{font-size:10px;font-weight:700;padding:2px 7px;border-radius:4px;background:rgba(58,61,77,0.25);color:var(--dim);font-family:'JetBrains Mono',monospace}
.ecn-banner{margin:16px 24px 0;padding:14px 18px;border-radius:10px;background:rgba(239,68,68,0.04);border:1px solid rgba(239,68,68,0.1)}
.ecn-item{display:flex;align-items:center;gap:12px;padding:12px 16px;border-radius:8px;cursor:pointer;margin-bottom:5px;border:1px solid var(--border);background:var(--card);transition:all 0.1s;font-size:15px}
.ecn-item:hover{border-color:var(--muted)}
.ecn-item.done{background:rgba(34,197,94,0.04);border-color:rgba(34,197,94,0.1)}
.tree-list{padding:0 24px 24px}
.grp-hdr{display:flex;align-items:center;gap:10px;padding:12px 14px;border-radius:8px;cursor:pointer;margin-top:8px}
.grp-hdr:hover{background:rgba(255,255,255,0.02)}
.step-row{display:flex;align-items:center;gap:14px;padding:10px 14px 10px 28px;cursor:pointer;border-radius:6px;font-size:15px}
.step-row:hover{background:rgba(255,255,255,0.02)}

/* GRAPH VIEW */
.gv-wrap{position:relative;width:100%;height:calc(100vh - 130px);overflow:hidden;cursor:grab;background:var(--bg)}
.gv-wrap.dragging{cursor:grabbing}
.gv-header{position:absolute;top:8px;left:8px;z-index:20;display:flex;gap:4px;align-items:center}
.gv-btn{background:rgba(14,15,22,0.95);border:1px solid var(--border);border-radius:5px;color:var(--muted);width:26px;height:26px;cursor:pointer;font-size:13px;font-family:'JetBrains Mono',monospace;display:flex;align-items:center;justify-content:center}
.gv-btn:hover{color:var(--accent)}
.gv-panel{position:absolute;top:38px;right:8px;z-index:20;padding:12px 14px;border-radius:10px;background:rgba(14,15,22,0.96);border:1px solid var(--border);width:250px;backdrop-filter:blur(10px);font-family:'JetBrains Mono',monospace}
.gv-panel label{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;font-size:9px;color:var(--muted)}
.gv-panel label .val{font-size:10px;font-weight:700;color:var(--accent);background:rgba(245,158,11,0.1);padding:1px 6px;border-radius:4px}
.gv-panel input[type=range]{-webkit-appearance:none;appearance:none;width:100%;height:4px;border-radius:2px;background:var(--border);outline:none;cursor:pointer;margin-bottom:10px}
.gv-panel input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:14px;height:14px;border-radius:50%;background:var(--accent);cursor:pointer}
.gv-footer{position:absolute;bottom:8px;left:8px;padding:5px 12px;background:rgba(14,15,22,0.9);border:1px solid var(--border);border-radius:6px;font-size:9px;color:var(--dim);font-family:'JetBrains Mono',monospace}
.gv-legend{position:absolute;bottom:8px;right:8px;display:flex;gap:8px;padding:5px 10px;background:rgba(14,15,22,0.9);border:1px solid var(--border);border-radius:6px;font-size:8px;color:var(--muted);font-family:'JetBrains Mono',monospace;flex-wrap:wrap}
.gv-legend i{width:7px;height:7px;border-radius:2px;display:inline-block;vertical-align:middle;margin-right:3px}

/* TREE EDITOR */
.te-wrap{display:flex;height:100vh;overflow:hidden}
.te-left{flex:1;display:flex;flex-direction:column;overflow:hidden}
.te-right{width:400px;border-left:1px solid var(--border);background:var(--card);overflow-y:auto;padding:16px}
.te-topbar{padding:10px 16px;border-bottom:1px solid var(--border);background:#0e0f15;display:flex;align-items:center;gap:10px;flex-wrap:wrap}
.te-verbar{padding:8px 16px;border-bottom:1px solid var(--border);background:#0c0d12;display:flex;align-items:center;gap:6px;flex-wrap:wrap}
.te-ver-pill{padding:4px 12px;border-radius:6px;font-size:11px;font-weight:700;cursor:pointer;font-family:'JetBrains Mono',monospace;border:1px solid var(--border);background:transparent;color:var(--muted);transition:all 0.15s}
.te-ver-pill:hover{border-color:var(--muted)}
.te-ver-pill.active{background:rgba(139,92,246,0.15);border-color:rgba(139,92,246,0.4);color:#a78bfa}
.te-ver-pill.frozen{opacity:0.6}
.te-frozen-bar{padding:6px 16px;background:rgba(239,68,68,0.06);border-bottom:1px solid rgba(239,68,68,0.1);font-size:11px;color:var(--red);font-weight:700;text-align:center;display:flex;align-items:center;justify-content:center;gap:8px}
.te-pick-wrap{min-height:100vh;display:flex;flex-direction:column;align-items:center;padding:50px 24px}
.te-pick-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:14px;max-width:760px;width:100%}
.te-pick-card{background:var(--card);border:2px solid var(--border);border-radius:14px;padding:24px;cursor:pointer;transition:all 0.2s;text-align:center}
.te-pick-card:hover{transform:translateY(-3px);border-color:var(--purple);box-shadow:0 8px 24px rgba(139,92,246,0.12)}
.te-tree{flex:1;overflow-y:auto;padding:8px 12px}
.te-grp{display:flex;align-items:center;gap:8px;padding:10px 12px;border-radius:8px;margin-top:4px}
.te-grp:hover{background:rgba(255,255,255,0.015)}
.te-step{display:flex;align-items:center;gap:8px;padding:8px 10px 8px 28px;cursor:pointer;border-radius:6px;margin:2px 0;font-size:14px}
.te-step.sel{background:rgba(139,92,246,0.08);border:1px solid rgba(139,92,246,0.2)}
.dp-label{font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px}
.dp-row{display:flex;gap:4px;align-items:center;margin-bottom:4px;padding:6px 8px;border-radius:6px;border:1px solid var(--border)}
.dp-section{margin-bottom:16px;padding-bottom:14px;border-bottom:1px solid var(--border)}
.dp-section:last-child{border-bottom:none}

/* ECN Controls */
.ecn-disp-btn{padding:5px 10px;border-radius:5px;font-size:10px;font-weight:700;cursor:pointer;font-family:'JetBrains Mono',monospace;border:1px solid var(--border);background:transparent;color:var(--muted);transition:all 0.15s}
.ecn-disp-btn:hover{opacity:0.8}
.ecn-disp-btn.active{border-color:transparent}

/* MODAL */
.cm-overlay{position:fixed;inset:0;z-index:100;background:rgba(0,0,0,0.65);backdrop-filter:blur(4px);display:flex;align-items:center;justify-content:center}
.cm-box{background:var(--modal);border-radius:14px;width:min(520px,92vw);max-height:80vh;box-shadow:0 12px 40px rgba(0,0,0,0.6);border:1px solid var(--border);overflow:hidden;display:flex;flex-direction:column}
.confirm-overlay{position:fixed;inset:0;z-index:110;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center}
.confirm-box{background:var(--modal);border-radius:12px;width:380px;padding:24px;border:1px solid var(--border)}
.db-status{display:flex;align-items:center;gap:4px;padding:3px 8px;border-radius:5px;font-size:9px;font-weight:600;font-family:'JetBrains Mono',monospace}
.db-status.ok{background:rgba(34,197,94,0.1);color:#22c55e}
.db-status.err{background:rgba(239,68,68,0.1);color:#ef4444}
.db-status.load{background:rgba(245,158,11,0.1);color:#f59e0b}
</style>
</head>
<body>
<div id="app"></div>
<script>
// ============================================================
// CONFIG
// ============================================================
const SUPABASE_URL = 'https://wylxvmkcrexwfpjpbhyy.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind5bHh2bWtjcmV4d2ZwanBiaHl5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg2MzkxMDYsImV4cCI6MjA4NDIxNTEwNn0.6Bxo42hx4jwlJGWnfjiTpiDUsYfc1QLTN3YtrU1efak';
const GSHEET_ID = '1mUhNDzucbHpS2y-IYu3A5ML1x5I_opUeNnqqyOtg95M';

const ASSY_META = {
  'GST_assy':  {icon:'ü§ñ',color:'#22c55e',section:'full',  name:'Ghost (Full Robot)'},
  'MBB_assy':  {icon:'üèóÔ∏è',color:'#22c55e',                 name:'Mobile Base'},
  'PLR_assy':  {icon:'üóº',color:'#ec4899',                  name:'Pillar'},
  'HBD_assy':  {icon:'ü§ñ',color:'#f97316',                  name:'Head & Body'},
  'GPR_assy':  {icon:'ü§è',color:'#06b6d4',                  name:'Gripper'},
  'ARM_assy':  {icon:'üí™',color:'#3b82f6',                  name:'Arm'},
  'LAC_assy':  {icon:'‚ö°',color:'#eab308',                  name:'L-Motor'},
  'A12_assy':  {icon:'üî©',color:'#a855f7',                  name:'A12-Motor'},
  'A35_assy':  {icon:'üîß',color:'#f43f5e',                  name:'A35-Motor'},
  'A4A_assy':  {icon:'‚öôÔ∏è',color:'#14b8a6',                  name:'A4-Motor'},
};

const GS_SHEET_MAP = {
  'GST_assy':'00_GHOST','MBB_assy':'05_Mobile Base','PLR_assy':'06_Pillar',
  'HBD_assy':'07_Head & Body','GPR_assy':'08_Gripper','ARM_assy':'09_Arm',
  'LAC_assy':'01_L-motor','A12_assy':'02_A12-motor','A35_assy':'03_A35-motor','A4A_assy':'04_A4-motor',
};
const GS_COL = {
  'GST_assy':{sn:1,done:6},'MBB_assy':{sn:1,done:8},'PLR_assy':{sn:1,done:7},
  'HBD_assy':{sn:1,done:8},'GPR_assy':{sn:1,done:8},'ARM_assy':{sn:1,done:9},
  'LAC_assy':{sn:1,done:8},'A12_assy':{sn:1,done:8},'A35_assy':{sn:1,done:8},'A4A_assy':{sn:1,done:8},
};

const ECN_DISPOSITIONS = {
  scrap:   {label:'SCRAP',   color:'#ef4444', icon:'üóëÔ∏è', bg:'rgba(239,68,68,0.12)'},
  replace: {label:'REPLACE', color:'#3b82f6', icon:'üîÑ', bg:'rgba(59,130,246,0.12)'},
  repair:  {label:'REPAIR',  color:'#f59e0b', icon:'üîß', bg:'rgba(245,158,11,0.12)'},
  reuse:   {label:'REUSE',   color:'#22c55e', icon:'‚ôªÔ∏è', bg:'rgba(34,197,94,0.12)'},
};

const GROUP_COLORS = ['#8b5cf6','#10b981','#f59e0b','#ef4444','#06b6d4','#ec4899','#6366f1','#f97316','#a855f7','#14b8a6'];
const GROUP_ICONS = ['üì¶','üîß','‚ö°','üî©','‚öôÔ∏è','üîå','üõ°Ô∏è','üèóÔ∏è','üéØ','üî¨','üí°','üîã','üß≤','üîó','üìê'];

// ============================================================
// SUPABASE REST
// ============================================================
const hdrs=()=>({'apikey':SUPABASE_KEY,'Authorization':`Bearer ${SUPABASE_KEY}`,'Content-Type':'application/json','Prefer':'return=representation'});
async function sbGet(t,q=''){const r=await fetch(`${SUPABASE_URL}/rest/v1/${t}?${q}`,{headers:hdrs()});if(!r.ok)throw new Error(`GET ${t}: ${r.status}`);return r.json();}
async function sbPost(t,d){const r=await fetch(`${SUPABASE_URL}/rest/v1/${t}`,{method:'POST',headers:hdrs(),body:JSON.stringify(d)});if(!r.ok)throw new Error(`POST ${t}: ${r.status} ${await r.text()}`);return r.json();}
async function sbPatch(t,q,d){const r=await fetch(`${SUPABASE_URL}/rest/v1/${t}?${q}`,{method:'PATCH',headers:hdrs(),body:JSON.stringify(d)});if(!r.ok)throw new Error(`PATCH ${t}: ${r.status}`);return r.json();}
async function sbDelete(t,q){const r=await fetch(`${SUPABASE_URL}/rest/v1/${t}?${q}`,{method:'DELETE',headers:hdrs()});if(!r.ok)throw new Error(`DELETE ${t}: ${r.status}`);}

// ============================================================
// GOOGLE SHEETS (fallback)
// ============================================================
function gsCsvUrl(s){return `https://docs.google.com/spreadsheets/d/${GSHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(s)}`;}
function parseCSV(t){const rows=[];let cur='',inQ=false;for(let i=0;i<t.length;i++){const c=t[i];if(c==='"'){if(inQ&&t[i+1]==='"'){cur+='"';i++;}else inQ=!inQ;}else if(c===','&&!inQ){rows.length===0?rows.push([cur]):rows[rows.length-1].push(cur);cur='';}else if((c==='\n'||c==='\r')&&!inQ){if(cur||rows[rows.length-1]){rows.length===0?rows.push([cur]):rows[rows.length-1].push(cur);}cur='';if(c==='\r'&&t[i+1]==='\n')i++;rows.push([]);}else cur+=c;}if(cur){if(!rows.length)rows.push([]);rows[rows.length-1].push(cur);}return rows.filter(r=>r.length>0&&r.some(c=>c.trim()));}
async function fetchGSheetUnits(tag){const sheet=GS_SHEET_MAP[tag],cols=GS_COL[tag];if(!sheet||!cols)return null;try{const res=await fetch(gsCsvUrl(sheet));if(!res.ok)throw new Error(res.status);const rows=parseCSV(await res.text()),units=[];for(let i=3;i<rows.length;i++){const r=rows[i],sn=(r[cols.sn]||'').trim().replace(/^"|"$/g,'');if(!sn||sn.startsWith('FXCN')||sn.startsWith('Á§æÂÜÖ'))continue;const done=cols.done!==null?(r[cols.done]||'').trim().replace(/^"|"$/g,''):'';units.push({sn,completed:done&&done!=='FALSE'?done:null,status:done&&done!=='FALSE'?'current':'pending'});}return units;}catch(e){console.warn('GSheet:',e);return null;}}

// ============================================================
// DATA STORE
// ============================================================
const DB = {
  assemblies:[], units:{}, tree:{}, ecnChanges:{}, ecnApplied:{}, versions:{},
  status:'loading', gsStatus:'unknown', errors:[],

  async init(){
    this.status='loading';render();
    try{
      this.assemblies=await sbGet('eagle_eye_app_assemblies','order=id');
      this.assemblies.forEach(a=>{const m=ASSY_META[a.tag]||{icon:'üì¶',color:'#6366f1',name:a.tag};a.icon=m.icon;a.color=m.color;a.section=m.section||null;a.name=m.name||a.tag;});
      this.status='ok';
    }catch(e){console.error('Init:',e);this.status='err';this.errors.push(e.message);}
    render();
  },

  async loadUnits(assemblyId,assyTag){
    if(this.units[assemblyId])return this.units[assemblyId];
    try{
      const rows=await sbGet('eagle_eye_app_production_units',`assembly_id=eq.${assemblyId}&order=sn`);
      if(rows.length>0){this.units[assemblyId]=rows.map(r=>({sn:r.sn,version:r.version,latestVer:r.latest_version,status:r.status||'current',notes:r.notes,assignedTo:r.assigned_to,completed:r.status==='current'?'yes':null}));this.gsStatus='db';return this.units[assemblyId];}
    }catch(e){console.error('DB units:',e);}
    try{const gs=await fetchGSheetUnits(assyTag);if(gs&&gs.length>0){this.gsStatus='gs';this.units[assemblyId]=gs;return this.units[assemblyId];}}catch(e){}
    this.gsStatus='err';this.units[assemblyId]=[];return[];
  },

  async loadTree(assemblyId){
    const key=`${assemblyId}`;
    if(this.tree[key])return this.tree[key];
    try{
      const groups=await sbGet('eagle_eye_app_groups',`assembly_id=eq.${assemblyId}&order=sort_order`);
      if(groups.length===0){this.tree[key]={groups:[],steps:[],partsMap:{},fastMap:{}};return this.tree[key];}
      const gids=groups.map(g=>g.id);
      const steps=await sbGet('eagle_eye_app_steps',`group_id=in.(${gids.join(',')})&order=sort_order`);
      steps.forEach(s=>{if(s.type)s.type=s.type.toUpperCase();});
      const sids=steps.map(s=>s.id);
      let parts=[],fasteners=[];
      if(sids.length>0)[parts,fasteners]=await Promise.all([sbGet('eagle_eye_app_parts',`step_id=in.(${sids.join(',')})&order=sort_order`),sbGet('eagle_eye_app_fasteners',`step_id=in.(${sids.join(',')})&order=sort_order`)]);
      const partsMap={},fastMap={};
      parts.forEach(p=>{if(!partsMap[p.step_id])partsMap[p.step_id]=[];partsMap[p.step_id].push(p);});
      fasteners.forEach(f=>{if(!fastMap[f.step_id])fastMap[f.step_id]=[];fastMap[f.step_id].push(f);});
      this.tree[key]={groups,steps,partsMap,fastMap};
    }catch(e){console.error('Tree:',e);this.tree[key]={groups:[],steps:[],partsMap:{},fastMap:{}};}
    return this.tree[key];
  },

  invalidateTree(aid){delete this.tree[`${aid}`];},

  async loadEcnChanges(aid){
    if(this.ecnChanges[aid])return this.ecnChanges[aid];
    try{
      const groups=await sbGet('eagle_eye_app_groups',`assembly_id=eq.${aid}&select=id`);if(groups.length===0){this.ecnChanges[aid]=[];return[];}
      const steps=await sbGet('eagle_eye_app_steps',`group_id=in.(${groups.map(g=>g.id).join(',')})&select=id`);if(steps.length===0){this.ecnChanges[aid]=[];return[];}
      this.ecnChanges[aid]=await sbGet('eagle_eye_app_ecn_change_records',`step_id=in.(${steps.map(s=>s.id).join(',')})&order=created_at`);
    }catch(e){console.error('ECN:',e);this.ecnChanges[aid]=[];}
    return this.ecnChanges[aid];
  },

  async loadEcnApplied(sn){try{(await sbGet('eagle_eye_app_ecn_applications',`unit_sn=eq.${sn}`)).forEach(r=>{this.ecnApplied[`${r.unit_sn}-${r.seq_tag}`]=r;});}catch(e){}},
  isApplied(sn,seq){return this.ecnApplied[`${sn}-${seq}`]?.applied===true;},

  async toggleApplied(sn,seq,sid){
    const k=`${sn}-${seq}`,ex=this.ecnApplied[k];
    if(ex?.applied){await sbPatch('eagle_eye_app_ecn_applications',`id=eq.${ex.id}`,{applied:false,applied_at:null});ex.applied=false;}
    else if(ex){await sbPatch('eagle_eye_app_ecn_applications',`id=eq.${ex.id}`,{applied:true,applied_at:new Date().toISOString(),applied_by:'Aniket'});ex.applied=true;}
    else{const[row]=await sbPost('eagle_eye_app_ecn_applications',[{unit_sn:sn,step_id:sid,seq_tag:seq,applied:true,applied_by:'Aniket',applied_at:new Date().toISOString()}]);this.ecnApplied[k]=row;}
  },

  async loadVersions(aid){
    if(this.versions[aid])return this.versions[aid];
    try{this.versions[aid]=await sbGet('eagle_eye_app_version_history',`assembly_id=eq.${aid}&order=created_at`);}catch(e){this.versions[aid]=[];}
    return this.versions[aid];
  },

  // --- WRITES ---
  async addStep(gid,d){const[r]=await sbPost('eagle_eye_app_steps',[{group_id:gid,...d}]);return r;},
  async updateStep(sid,d){return(await sbPatch('eagle_eye_app_steps',`id=eq.${sid}`,d))[0];},
  async deleteStep(sid){
    // Delete parts, fasteners, then step
    await sbDelete('eagle_eye_app_parts',`step_id=eq.${sid}`);
    await sbDelete('eagle_eye_app_fasteners',`step_id=eq.${sid}`);
    await sbDelete('eagle_eye_app_steps',`id=eq.${sid}`);
  },
  async addGroup(aid,ver,d){const[r]=await sbPost('eagle_eye_app_groups',[{assembly_id:aid,version:ver,...d}]);return r;},
  async updateGroup(gid,d){return(await sbPatch('eagle_eye_app_groups',`id=eq.${gid}`,d))[0];},
  async deleteGroup(gid){
    // Delete all steps in group (and their parts/fasteners)
    const steps=await sbGet('eagle_eye_app_steps',`group_id=eq.${gid}&select=id`);
    for(const s of steps){await this.deleteStep(s.id);}
    await sbDelete('eagle_eye_app_groups',`id=eq.${gid}`);
  },
  async addPart(sid,d){const[r]=await sbPost('eagle_eye_app_parts',[{step_id:sid,...d}]);return r;},
  async deletePart(pid){await sbDelete('eagle_eye_app_parts',`id=eq.${pid}`);},
  async addFastener(sid,d){const[r]=await sbPost('eagle_eye_app_fasteners',[{step_id:sid,...d}]);return r;},
  async deleteFastener(fid){await sbDelete('eagle_eye_app_fasteners',`id=eq.${fid}`);},
  async updatePart(pid,d){await sbPatch('eagle_eye_app_parts',`id=eq.${pid}`,d);},
  async updateFastener(fid,d){await sbPatch('eagle_eye_app_fasteners',`id=eq.${fid}`,d);},

  // --- ECN WRITES ---
  async createEcnChangeRecord(d){const[r]=await sbPost('eagle_eye_app_ecn_change_records',[d]);return r;},
  async updateEcnChangeRecord(id,d){await sbPatch('eagle_eye_app_ecn_change_records',`id=eq.${id}`,d);},
  async deleteEcnChangeRecord(id){await sbDelete('eagle_eye_app_ecn_change_records',`id=eq.${id}`);},
  async createEcnLog(d){const[r]=await sbPost('eagle_eye_app_ecn_log',[d]);return r;},

  // --- VERSION WRITES ---
  async assignVersionToUnits(assemblyId, sns, version){
    const latestVer = this.assemblies.find(a=>a.id===assemblyId)?.version || version;
    const status = version === latestVer ? 'current' : 'outdated';
    // If units came from GSheets, sync all to DB first
    if(this.gsStatus==='gs'){
      const allUnits=this.units[assemblyId]||[];
      for(const u of allUnits){
        try{
          const existing=await sbGet('eagle_eye_app_production_units',`assembly_id=eq.${assemblyId}&sn=eq.${encodeURIComponent(u.sn)}`);
          if(existing.length===0){
            await sbPost('eagle_eye_app_production_units',[{assembly_id:assemblyId,sn:u.sn,status:u.status||'pending',latest_version:latestVer}]);
          }
        }catch(e){}
      }
    }
    // Now assign version to selected units
    for(const sn of sns){
      try{
        const existing=await sbGet('eagle_eye_app_production_units',`assembly_id=eq.${assemblyId}&sn=eq.${encodeURIComponent(sn)}`);
        if(existing.length>0){
          await sbPatch('eagle_eye_app_production_units',`id=eq.${existing[0].id}`,{version, latest_version:latestVer, status, updated_at:new Date().toISOString()});
        }else{
          await sbPost('eagle_eye_app_production_units',[{assembly_id:assemblyId, sn, version, latest_version:latestVer, status}]);
        }
      }catch(e){console.error('Assign version for',sn,e);}
    }
    // Refresh local cache
    delete this.units[assemblyId];
  },

  async createVersion(aid,ver,notes){
    const[r]=await sbPost('eagle_eye_app_version_history',[{assembly_id:aid,version:ver,notes:notes||null,created_by:'Aniket'}]);
    delete this.versions[aid];
    return r;
  },
  async updateAssemblyVersion(aid,ver){
    await sbPatch('eagle_eye_app_assemblies',`id=eq.${aid}`,{version:ver,updated_at:new Date().toISOString()});
    const a=this.assemblies.find(x=>x.id===aid);if(a)a.version=ver;
  },
};

// ============================================================
// HELPERS
// ============================================================
function toast(msg,err){const c=document.createElement('div');c.style.cssText=`position:fixed;bottom:16px;left:50%;transform:translateX(-50%);padding:6px 16px;border-radius:6px;background:${err?'#ef4444':'#22c55e'};color:${err?'#fff':'#000'};font-weight:700;font-size:10px;z-index:999;font-family:'JetBrains Mono',monospace;max-width:400px;text-align:center`;c.textContent=msg;document.body.appendChild(c);setTimeout(()=>c.remove(),2500);}
function stepsForGroup(tree,gid){return tree.steps.filter(s=>s.group_id===gid);}
function partsForStep(tree,sid){return tree.partsMap[sid]||[];}
function fastenersForStep(tree,sid){return tree.fastMap[sid]||[];}
function dbStatus(){
  const s=DB.status,g=DB.gsStatus;
  return `<div style="display:flex;gap:4px">
    <div class="db-status ${s==='ok'?'ok':s==='err'?'err':'load'}" title="Supabase: ${s}">${s==='ok'?'‚óè':'‚óã'} DB</div>
    ${g==='db'?'<div class="db-status ok" title="Units from DB">‚óè Units</div>':g==='gs'?'<div class="db-status ok" title="Units from GSheets">‚óè GS</div>':''}
  </div>`;
}

// ============================================================
// STATE
// ============================================================
const S = {
  page:'home', assy:null, unitSel:new Set(), unitFilter:'all', unitSearch:'',
  selectedUnits:[], avTab:'list', modal:null, loadingUnits:false,
  // Graph view
  gvZoom:0.65, gvPan:{x:10,y:0}, gvTValues:{}, gvPanelOpen:false,
  gvGaps:{partsToSteps:150,stepsToGroups:160,groupsToAssy:140},
  // Tree editor
  teAssy:null, teVer:null, teSel:null, teSelGroup:null,
  teVersions:[], teFrozen:false,
  // Modals
  confirmAction:null, confirmMsg:'', confirmData:null,
  newVerModal:false, newVerStr:'', newVerNotes:'',
  ecnModal:false, ecnStep:null, ecnField:'', ecnOld:'', ecnNew:'', ecnReason:'', ecnDisp:'replace', ecnChangeType:'part_changed',
  editGroupModal:false, editGroupData:null,
  // Version assignment
  versionAssignModal:false, versionAssignVer:'',
};

// ============================================================
// RENDER ENGINE
// ============================================================
function render(){
  const app=document.getElementById('app');
  if(S.page==='home') app.innerHTML=renderHome();
  else if(S.page==='unitSelect') app.innerHTML=renderUnitSelect();
  else if(S.page==='assembly') app.innerHTML=renderAssembly();
  else if(S.page==='editor') app.innerHTML=renderEditor();
  // Overlays
  if(S.confirmAction) app.innerHTML+=renderConfirmModal();
  if(S.newVerModal) app.innerHTML+=renderNewVersionModal();
  if(S.ecnModal) app.innerHTML+=renderEcnModal();
  if(S.editGroupModal) app.innerHTML+=renderEditGroupModal();
  if(S.versionAssignModal) app.innerHTML+=renderVersionAssignModal();
  attachEvents();
}

// ============================================================
// HOME
// ============================================================
function renderHome(){
  const full=DB.assemblies.filter(a=>a.section==='full'), majors=DB.assemblies.filter(a=>a.section!=='full');
  return `<div class="home-wrap">
    <div class="home-admin">${dbStatus()}<div class="admin-pill">üîß Admin ¬∑ Aniket</div>
      <button class="btn-sm" style="background:rgba(139,92,246,0.12);color:#8b5cf6;border:1px solid rgba(139,92,246,0.25)" data-action="editor">üîß Tree Editor</button>
      <div style="width:20px;height:20px;border-radius:50%;background:linear-gradient(135deg,#f59e0b,#e8952e);border:2px solid var(--border)"></div>
    </div>
    <div class="home-hero"><div class="home-logo">‚óà EagleEye</div><div class="home-sub">Assembly version tracking & ECN management</div></div>
    ${DB.errors.length?`<div class="error-banner">${DB.errors.map(e=>`‚ö† ${e}`).join('<br>')}</div>`:''}
    ${DB.status==='loading'?'<div class="loading-wrap"><div class="spinner"></div>Connecting to database...</div>':`
    ${full.length?`<div style="max-width:780px;width:100%;padding:0 20px"><div class="section-label">FULL ROBOT</div></div>
    <div style="max-width:780px;width:100%;padding:0 20px;margin-bottom:28px">${full.map(a=>`<div class="full-robot-card" data-action="assy" data-id="${a.id}"><div style="font-size:28px;margin-bottom:6px">${a.icon}</div><div style="font-size:15px;font-weight:700;display:flex;align-items:center;gap:8px">${a.name} <span class="badge" style="background:rgba(34,197,94,0.12);color:#22c55e">v${a.version}</span></div></div>`).join('')}</div>`:''}
    <div style="max-width:780px;width:100%;padding:0 20px"><div class="section-label">MAJOR ASSEMBLIES</div></div>
    <div class="assy-grid">${majors.map(a=>`<div class="assy-card" style="border-left:3px solid ${a.color}" data-action="assy" data-id="${a.id}"><div style="display:flex;align-items:center;gap:6px;margin-bottom:6px"><span style="font-size:18px">${a.icon}</span><span style="font-size:13px;font-weight:700">${a.name}</span></div><span class="badge" style="background:${a.color}15;color:${a.color}">v${a.version}</span></div>`).join('')}</div>`}
  </div>`;
}

// ============================================================
// UNIT SELECT
// ============================================================
function renderUnitSelect(){
  const a=S.assy, units=DB.units[a.id]||[];
  let filtered=units;
  if(S.unitFilter==='outdated')filtered=filtered.filter(u=>u.status==='outdated');
  if(S.unitFilter==='current')filtered=filtered.filter(u=>u.status==='current'||u.status==='pending');
  if(S.unitSearch)filtered=filtered.filter(u=>u.sn.toLowerCase().includes(S.unitSearch.toLowerCase()));
  return `<div style="min-height:100vh;background:var(--bg);padding:16px"><div style="max-width:800px;margin:0 auto">
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:14px">
      <button class="btn-sm" style="background:transparent;color:var(--muted)" data-action="goHome">‚Üê Back</button>
      <span style="font-size:22px">${a.icon}</span>
      <div><div style="font-size:16px;font-weight:700">${a.name}</div><div style="font-size:10px;color:var(--muted)" class="mono">${units.length} units ¬∑ v${a.version} ${DB.gsStatus==='gs'?'<span style="color:#22c55e">‚óè Live from Google Sheets</span>':DB.gsStatus==='db'?'<span style="color:#22c55e">‚óè From Database</span>':DB.gsStatus==='err'?'<span style="color:#ef4444">‚óè No unit data found</span>':''}</div></div>
    </div>
    ${S.loadingUnits?'<div class="loading-wrap"><div class="spinner"></div>Loading units...</div>':`
    <div style="display:flex;gap:6px;margin-bottom:10px;flex-wrap:wrap;align-items:center">
      <input class="inp" style="width:150px" placeholder="Search S/N..." data-role="unitSearch" value="${S.unitSearch}">
      ${['all','outdated','current'].map(f=>`<button class="us-filter ${S.unitFilter===f?'active':''}" data-f="${f}" data-action="setFilter">${f}</button>`).join('')}
      <button class="btn-sm" style="margin-left:auto;background:transparent;color:var(--muted);font-size:9px" data-action="selectAll">Select all (${filtered.length})</button>
    </div>
    <div class="unit-grid">${filtered.map(u=>{const sel=S.unitSel.has(u.sn),out=u.status==='outdated';const needsUpgrade=u.version&&u.latestVer&&u.version!==u.latestVer;
      return `<div class="unit-card ${sel?'selected':''}" data-action="toggleUnit" data-sn="${u.sn}">
        ${sel?'<div style="position:absolute;top:4px;right:6px;font-size:10px;color:var(--accent)">‚úì</div>':''}
        <div style="font-size:11px;font-weight:700" class="mono">${u.sn}</div>
        <div style="display:flex;gap:3px;margin-top:2px;flex-wrap:wrap">
          <span class="badge" style="background:${out?'rgba(239,68,68,0.12)':u.completed?'rgba(34,197,94,0.12)':'rgba(245,158,11,0.12)'};color:${out?'#ef4444':u.completed?'#22c55e':'#f59e0b'}">${out?'outdated':u.completed?'done':'pending'}</span>
          ${u.version?`<span class="badge" style="background:${needsUpgrade?'rgba(239,68,68,0.12)':'rgba(107,112,128,0.08)'};color:${needsUpgrade?'#ef4444':'var(--muted)'}">v${u.version}</span>`:''}
        </div></div>`;}).join('')}</div>
    ${S.unitSel.size?`<div style="margin-top:10px;padding:8px 14px;border-radius:10px;background:rgba(245,158,11,0.04);border:1px solid rgba(245,158,11,0.15);display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap">
      <span style="font-weight:700;font-size:12px">${S.unitSel.size} selected</span>
      <div style="display:flex;gap:6px;align-items:center">
        <button style="padding:6px 14px;border-radius:8px;font-size:11px;font-weight:700;border:1px solid rgba(139,92,246,0.3);color:#a78bfa;cursor:pointer;background:rgba(139,92,246,0.08);font-family:'JetBrains Mono',monospace" data-action="openVersionAssign">üìã Assign Version</button>
        <button style="padding:6px 18px;border-radius:8px;font-size:12px;font-weight:700;border:none;color:#000;cursor:pointer;background:${a.color}" data-action="proceed">Open Assembly View ‚Üí</button>
      </div>
    </div>`:''}`}
  </div></div>`;
}

// ============================================================
// ASSEMBLY VIEW
// ============================================================
function renderAssembly(){
  const a=S.assy, unit=S.selectedUnits[0]; if(!unit) return '';
  const tree=DB.tree[`${a.id}`];
  if(!tree) return '<div class="loading-wrap"><div class="spinner"></div>Loading tree...</div>';
  const ecnRecords=DB.ecnChanges[a.id]||[];
  const appliedCount=ecnRecords.filter(c=>DB.isApplied(unit.sn,c.seq_tag)).length;
  const allDone=ecnRecords.length>0&&ecnRecords.every(c=>DB.isApplied(unit.sn,c.seq_tag));
  const tab=S.avTab;
  const totalP=tree.steps.reduce((s,st)=>partsForStep(tree,st.id).length+s,0);
  const totalF=tree.steps.reduce((s,st)=>fastenersForStep(tree,st.id).length+s,0);

  let tabContent='';
  if(tab==='list'){
    let banner='';
    if(ecnRecords.length>0){
      banner=`<div class="ecn-banner">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px"><span style="font-size:15px;font-weight:700;color:#ef4444">‚ö† ${ecnRecords.length} ECN changes</span><span style="font-size:13px;color:var(--muted)" class="mono">${appliedCount}/${ecnRecords.length}</span></div>
        <div style="height:3px;border-radius:2px;background:rgba(239,68,68,0.1);overflow:hidden;margin-bottom:8px"><div style="height:100%;border-radius:2px;width:${ecnRecords.length?(appliedCount/ecnRecords.length)*100:0}%;background:${allDone?'#22c55e':'#f59e0b'}"></div></div>
        ${ecnRecords.map((c,i)=>{const done=DB.isApplied(unit.sn,c.seq_tag);const disp=ECN_DISPOSITIONS[c.disposition]||{};
          return `<div class="ecn-item ${done?'done':''}" data-action="openChange" data-idx="${i}">
            <span style="font-size:13px;font-weight:700;min-width:34px;text-align:center;padding:4px 8px;border-radius:6px;color:${done?'#22c55e':'#ef4444'};background:${done?'rgba(34,197,94,0.12)':'rgba(239,68,68,0.1)'}" class="mono">${c.seq_tag||'‚Äî'}</span>
            <span style="flex:1;font-size:14px;font-weight:500;${done?'opacity:0.5;text-decoration:line-through':''}">${c.step_name||''}</span>
            ${c.disposition?`<span style="font-size:10px;font-weight:700;padding:2px 8px;border-radius:4px;background:${disp.bg||'rgba(107,112,128,0.1)'};color:${disp.color||'var(--muted)'}">${(c.disposition||'').toUpperCase()}</span>`:''}
            <span style="font-size:13px;color:var(--muted)" class="mono">${c.field||c.change_type}</span>
            <span style="font-size:14px;color:${done?'#22c55e':'var(--dim)'}">${done?'‚úì':'‚óã'}</span>
          </div>`;}).join('')}
        ${allDone?`<div style="margin-top:10px;padding:14px;border-radius:10px;background:rgba(34,197,94,0.06);border:2px solid rgba(34,197,94,0.25);text-align:center"><div style="font-size:15px;font-weight:700;color:#22c55e">‚úÖ All changes applied for ${unit.sn}</div></div>`:''}
      </div>`;
    }
    let treeHtml='<div class="tree-list">';
    tree.groups.forEach(g=>{const gSteps=stepsForGroup(tree,g.id);
      treeHtml+=`<div style="margin-bottom:6px"><div class="grp-hdr" style="background:${g.color||'#666'}08;border-left:4px solid ${g.color||'#666'}"><span style="font-size:11px;color:var(--muted)">‚ñº</span><span style="font-size:16px">${g.icon||'üì¶'}</span><span style="font-weight:700;color:${g.color||'#666'};flex:1;font-size:15px">${g.label}</span><span style="color:var(--muted);font-size:13px" class="mono">${gSteps.length}</span></div>`;
      gSteps.forEach(s=>{const pts=partsForStep(tree,s.id),fts=fastenersForStep(tree,s.id),hasEcn=s.ecn_status==='changed'||ecnRecords.some(c=>c.step_id===s.id),done=DB.isApplied(unit.sn,s.seq_tag);
        treeHtml+=`<div class="step-row" style="${done?'opacity:0.4':''}"><span style="color:var(--dim);font-size:12px">‚†ø</span>${hasEcn?`<span style="font-size:10px">${done?'‚úÖ':'üî¥'}</span>`:''}
          <span style="font-weight:700;min-width:32px;text-align:center;font-size:13px;padding:3px 8px;border-radius:5px;background:${g.color||'#666'}15;color:${g.color||'#666'}" class="mono">${s.seq_tag||'‚Äî'}</span>
          <span style="font-size:12px;font-weight:600;padding:2px 8px;border-radius:4px;color:${s.type==='PREP'?'#a855f7':s.type==='CHECK'?'#ec4899':'#22c55e'};background:${s.type==='PREP'?'rgba(168,85,247,0.1)':s.type==='CHECK'?'rgba(236,72,153,0.1)':'rgba(34,197,94,0.1)'}">${s.type||'STEP'}</span>
          <span style="flex:1;font-size:14px">${s.label||s.pn||''}</span>
          ${pts.length?`<span style="font-size:12px;color:#22c55e;font-weight:600" class="mono">${pts.length}P</span>`:''}
          ${fts.length?`<span style="font-size:12px;color:#ef4444;font-weight:600" class="mono">${fts.length}F</span>`:''}
        </div>`;});
      treeHtml+='</div>';});
    treeHtml+='</div>';
    tabContent=banner+treeHtml;
  } else if(tab==='graph'){
    tabContent=renderGraphView(tree, a, ecnRecords, unit);
  } else tabContent=`<div style="display:flex;flex-direction:column;align-items:center;padding:80px 20px;color:var(--dim)"><div style="font-size:40px;margin-bottom:12px;opacity:0.3">üîß</div><div style="font-size:20px;font-weight:700">Kanban View</div><div style="font-size:13px;margin-top:6px">Coming soon</div></div>`;

  return `<div style="min-height:100vh;background:var(--bg)">
    <div class="av-header">
      <button style="background:none;border:1px solid var(--border);border-radius:8px;padding:6px 14px;color:var(--muted);cursor:pointer;font-size:13px" data-action="backToUnits">‚Üê Units</button>
      <span style="font-size:18px;font-weight:800;color:var(--accent)" class="mono">‚óà</span>
      <select class="inp" style="padding:6px 12px;font-size:14px;font-weight:600;min-width:200px" data-role="unitPicker">${S.selectedUnits.map(u=>`<option value="${u.sn}" ${u.sn===unit.sn?'selected':''}>${u.sn}</option>`).join('')}</select>
      <div style="margin-left:auto;display:flex;align-items:center;gap:8px">${dbStatus()}<div class="admin-pill">üîß Admin ¬∑ Aniket</div></div>
    </div>
    <div class="av-tabs">
      <button class="av-tab ${tab==='list'?'active':''}" data-action="avTab" data-tab="list">‚â° List ${ecnRecords.length-appliedCount>0?`<span class="count">${ecnRecords.length-appliedCount}</span>`:''}</button>
      <button class="av-tab ${tab==='graph'?'active':''}" data-action="avTab" data-tab="graph">‚óà Graph</button>
      <button class="av-tab ${tab==='kanban'?'active':''}" data-action="avTab" data-tab="kanban">‚ñ¶ Kanban <span class="soon">SOON</span></button>
      <div style="margin-left:auto;display:flex;gap:12px;font-size:13px;color:var(--muted)" class="mono"><span><span style="color:#22c55e;font-weight:700">${totalP}</span> parts</span><span><span style="color:#ef4444;font-weight:700">${totalF}</span> fasteners</span><span><span style="font-weight:700">${tree.steps.length}</span> steps</span></div>
    </div>
    ${tabContent}
  </div>${S.modal!==null?renderChangeModal():''}`;
}

// ============================================================
// GRAPH VIEW
// ============================================================
function renderGraphView(tree, assy, ecnRecords, unit) {
  if (!tree || !tree.groups.length) return '<div class="loading-wrap"><div style="color:var(--dim)">No tree data</div></div>';

  const G = S.gvGaps;
  const STEP_W=220,STEP_H=54,PART_W=140,PART_H=32,GRP_W=185,GRP_H=54,ASSY_W=200,ASSY_H=60,MAX_FAST=2;
  const COL_CHILD=50, COL_STEP=COL_CHILD+PART_W+G.partsToSteps, COL_GRP=COL_STEP+STEP_W+G.stepsToGroups, COL_ASSY=COL_GRP+GRP_W+G.groupsToAssy;

  // Colors
  const GC={
    partFill:'#0c1824',partStroke:'#2563eb',partText:'#7dd3fc',
    stepFill:'#140c24',stepStroke:'#7c3aed',stepText:'#c4b5fd',
    prepFill:'#1a1406',prepStroke:'#d97706',prepText:'#fbbf24',
    checkFill:'#1a0820',checkStroke:'#db2777',checkText:'#f9a8d4',
    kanryoFill:'#061a12',kanryoStroke:'#16a34a',kanryoText:'#86efac',
    grpFill:'#0e0f14',assyFill:'#0a1e12',assyStroke:'#22c55e',assyText:'#4ade80',
    ecnGlow:'#ef4444',cascadeGlow:'#f59e0b',
    fastName:'#f59e0b',loctite:'#a78bfa',torque:'#22c55e',
    arrow:'#252838',arrowHi:'#3d4160',seqBg:'#1a1408',seqCol:'#f59e0b',
    dim:'#363950',dimText:'#4a4e68',labelBg:'rgba(8,9,13,0.8)',labelDot:'#f59e0b',
  };
  function sc(type,ecn,casc){
    let f=GC.stepFill,s=GC.stepStroke,t=GC.stepText;
    if(type==='PREP'){f=GC.prepFill;s=GC.prepStroke;t=GC.prepText;}
    if(type==='CHECK'){f=GC.checkFill;s=GC.checkStroke;t=GC.checkText;}
    if(type==='KANRYO'){f=GC.kanryoFill;s=GC.kanryoStroke;t=GC.kanryoText;}
    if(ecn)s=GC.ecnGlow; else if(casc)s=GC.cascadeGlow;
    return{f,s,t};
  }
  function clip(s,n){return s&&s.length>n?s.slice(0,n-1)+'‚Ä¶':s||'';}
  function bezP(x1,y1,x2,y2){const d=Math.abs(x2-x1)*0.42;return`M${x1},${y1} C${x1+d},${y1} ${x2-d},${y2} ${x2},${y2}`;}
  function bezPt(x1,y1,x2,y2,t){const d=Math.abs(x2-x1)*0.42,cx1=x1+d,cy1=y1,cx2=x2-d,cy2=y2,u=1-t;return{x:u*u*u*x1+3*u*u*t*cx1+3*u*t*t*cx2+t*t*t*x2,y:u*u*u*y1+3*u*u*t*cy1+3*u*t*t*cy2+t*t*t*y2};}

  // Layout
  const nodes=[],edges=[];
  let y=50;

  tree.groups.forEach(g=>{
    const gy0=y;
    const gSteps=stepsForGroup(tree,g.id);
    const stepNds=[];

    gSteps.forEach(step=>{
      const pts=partsForStep(tree,step.id);
      const fts=fastenersForStep(tree,step.id);
      const np=pts.length;
      const isSingle=np===1, isMulti=np>1;
      const hasEcn=step.ecn_status==='changed'||ecnRecords.some(c=>c.step_id===step.id);
      const colors=sc((step.type||'STEP').toUpperCase(),hasEcn,false);
      const childNds=[];

      if(isMulti){
        const totalCH=np*(PART_H+12)-12;
        const cy0=y-totalCH/2+PART_H/2;
        pts.forEach((p,pi)=>{
          const py=cy0+pi*(PART_H+12);
          const cn={id:'cp-'+step.id+'-'+pi,type:'part',x:COL_CHILD,y:py,w:PART_W,h:PART_H,pn:p.pn||'',name:p.name||p.pn||'Part',qty:p.qty||1};
          nodes.push(cn);childNds.push(cn);
        });
      }

      const sn={id:'s-'+step.id,type:'step',x:COL_STEP,y,w:STEP_W,h:STEP_H,
        stepId:step.id,seq:step.seq_tag||'',name:step.label||step.pn||'',stepType:(step.type||'STEP').toUpperCase(),
        colors,isSingle,isMulti,hasEcn,
        inlinePartName:isSingle?(pts[0].name||pts[0].pn||''):'',
        inlinePartPn:isSingle?(pts[0].pn||''):'',
        fts};
      nodes.push(sn);stepNds.push(sn);

      if(isMulti){
        childNds.forEach((cn,ci)=>{
          edges.push({id:'e-cp-'+step.id+'-'+ci,from:cn,to:sn,kind:'part-step',fts:ci===0?fts:[],defT:0.45});
        });
      }

      const blockH=isMulti?Math.max(STEP_H,np*(PART_H+12)):STEP_H;
      y+=blockH+26;
    });

    const gmid=(gy0+y-26)/2;
    const gn={id:'g-'+g.id,type:'group',x:COL_GRP,y:gmid,w:GRP_W,h:GRP_H,label:g.label,icon:g.icon||'üì¶',color:g.color||'#6b7280',stepCount:gSteps.length};
    nodes.push(gn);

    stepNds.forEach(sn=>{
      edges.push({id:'e-sg-'+sn.stepId,from:sn,to:gn,kind:'step-grp',fts:sn.isMulti?[]:sn.fts,defT:0.35});
    });
    y+=44;
  });

  const grps=nodes.filter(n=>n.type==='group');
  const ay=grps.length?grps.reduce((a,n)=>a+n.y,0)/grps.length:200;
  const an={id:'assy',type:'assy',x:COL_ASSY,y:ay,w:ASSY_W,h:ASSY_H};
  nodes.push(an);
  grps.forEach(gn=>{edges.push({id:'e-ga-'+gn.id,from:gn,to:an,kind:'grp-assy',fts:[],defT:0.5});});

  const totalH=y+80;
  window._gvEdges=edges;

  // Build SVG strings
  let svgEdges='', svgNodes='', svgLabels='';

  // Column guides
  [{x:COL_CHILD,l:'Parts',c:GC.partStroke},{x:COL_STEP,l:'Steps',c:GC.stepStroke},{x:COL_GRP,l:'Groups',c:'#6b7280'},{x:COL_ASSY,l:'Assembly',c:GC.assyStroke}].forEach(g=>{
    svgEdges+=`<line x1="${g.x}" y1="-20" x2="${g.x}" y2="${totalH}" stroke="${g.c}" stroke-width="0.5" opacity="0.08" stroke-dasharray="6 4"/>`;
    svgEdges+=`<text x="${g.x+4}" y="-8" fill="${g.c}" font-size="8" font-weight="700" opacity="0.2" font-family="'JetBrains Mono',monospace">${g.l}</text>`;
  });

  // Edges
  edges.forEach(e=>{
    const x1=e.from.x+e.from.w,y1=e.from.y,x2=e.to.x,y2=e.to.y;
    const isHi=e.kind==='grp-assy',sw=isHi?2.2:1.2;
    const ecn=e.to.hasEcn;
    const col=ecn?(GC.ecnGlow+'40'):(isHi?GC.arrowHi:GC.arrow);
    svgEdges+=`<path d="${bezP(x1,y1,x2,y2)}" fill="none" stroke="${col}" stroke-width="${sw}"/>`;
    svgEdges+=`<circle cx="${x2}" cy="${y2}" r="2.8" fill="${col}"/>`;
  });

  // Nodes
  nodes.forEach(n=>{
    if(n.type==='part'){
      const ind=11,pts=`${n.x+ind},${n.y-n.h/2} ${n.x+n.w-ind},${n.y-n.h/2} ${n.x+n.w},${n.y} ${n.x+n.w-ind},${n.y+n.h/2} ${n.x+ind},${n.y+n.h/2} ${n.x},${n.y}`;
      svgNodes+=`<polygon points="${pts}" fill="${GC.partFill}" stroke="${GC.partStroke}" stroke-width="1.2"/>`;
      svgNodes+=`<text x="${n.x+n.w/2}" y="${n.y+1}" fill="${GC.partText}" font-size="9" font-weight="600" text-anchor="middle" font-family="'JetBrains Mono',monospace">${clip(n.name||n.pn,17)}</text>`;
      if(n.qty>1)svgNodes+=`<text x="${n.x+n.w-ind-2}" y="${n.y+n.h/2-3}" fill="${GC.partStroke}" font-size="7" font-weight="700" text-anchor="end" font-family="'JetBrains Mono',monospace">√ó${n.qty}</text>`;
    }
    else if(n.type==='step'){
      const r=10,c=n.colors,glow=n.hasEcn?GC.ecnGlow:null;
      const iconX=n.hasEcn?28:12;
      if(glow)svgNodes+=`<rect x="${n.x-5}" y="${n.y-n.h/2-5}" width="${n.w+10}" height="${n.h+10}" rx="${r+4}" fill="none" stroke="${glow}" stroke-width="2.5" opacity="0.28" filter="url(#gvGlow)"/>`;
      svgNodes+=`<rect x="${n.x}" y="${n.y-n.h/2}" width="${n.w}" height="${n.h}" rx="${r}" fill="${c.f}" stroke="${c.s}" stroke-width="1.5"/>`;
      if(n.seq&&n.seq!=='‚Äî'){
        svgNodes+=`<rect x="${n.x+n.w-38}" y="${n.y-n.h/2-10}" width="36" height="20" rx="5" fill="${GC.seqBg}" stroke="${GC.seqCol}" stroke-width="1.2"/>`;
        svgNodes+=`<text x="${n.x+n.w-20}" y="${n.y-n.h/2+5}" fill="${GC.seqCol}" font-size="11" font-weight="800" text-anchor="middle" font-family="'JetBrains Mono',monospace">${n.seq}</text>`;
      }
      if(n.hasEcn)svgNodes+=`<circle cx="${n.x+14}" cy="${n.y-n.h/2+15}" r="5.5" fill="${GC.ecnGlow}"/>`;
      if(n.isSingle&&n.inlinePartName){
        svgNodes+=`<text x="${n.x+iconX}" y="${n.y-4}" fill="${c.t}" font-size="14" font-weight="700" font-family="'DM Sans',sans-serif">${clip(n.inlinePartName,24)}</text>`;
        svgNodes+=`<text x="${n.x+iconX}" y="${n.y+12}" fill="${GC.dim}" font-size="9" font-family="'JetBrains Mono',monospace">${n.inlinePartPn}</text>`;
      } else {
        svgNodes+=`<text x="${n.x+iconX}" y="${n.y-4}" fill="${c.t}" font-size="13" font-weight="700" font-family="'DM Sans',sans-serif">${clip(n.name,22)}</text>`;
        svgNodes+=`<text x="${n.x+iconX}" y="${n.y+10}" fill="${c.s}" font-size="8" font-weight="700" opacity="0.4" font-family="'JetBrains Mono',monospace">${n.stepType}</text>`;
      }
    }
    else if(n.type==='group'){
      svgNodes+=`<rect x="${n.x}" y="${n.y-n.h/2}" width="${n.w}" height="${n.h}" rx="14" fill="${GC.grpFill}" stroke="${n.color}" stroke-width="2"/>`;
      svgNodes+=`<text x="${n.x+16}" y="${n.y+2}" font-size="16">${n.icon}</text>`;
      svgNodes+=`<text x="${n.x+38}" y="${n.y-6}" fill="${n.color}" font-size="13" font-weight="700" font-family="'DM Sans',sans-serif">${n.label}</text>`;
      svgNodes+=`<text x="${n.x+38}" y="${n.y+10}" fill="#4b5563" font-size="9" font-weight="600" font-family="'JetBrains Mono',monospace">ÂÆå‰∫Ü ¬∑ ${n.stepCount} steps</text>`;
    }
    else if(n.type==='assy'){
      svgNodes+=`<rect x="${n.x}" y="${n.y-n.h/2}" width="${n.w}" height="${n.h}" rx="${n.h/2}" fill="${GC.assyFill}" stroke="${GC.assyStroke}" stroke-width="2.5"/>`;
      svgNodes+=`<circle cx="${n.x+22}" cy="${n.y}" r="6" fill="${GC.assyStroke}" opacity="0.3"/>`;
      svgNodes+=`<text x="${n.x+n.w/2+8}" y="${n.y-3}" fill="${GC.assyText}" font-size="14" font-weight="800" text-anchor="middle" font-family="'DM Sans',sans-serif">${assy.name||assy.tag}</text>`;
      svgNodes+=`<text x="${n.x+n.w/2+8}" y="${n.y+13}" fill="${GC.assyStroke}" font-size="9" font-weight="700" text-anchor="middle" opacity="0.5" font-family="'JetBrains Mono',monospace">v${assy.version||'?'}</text>`;
    }
  });

  // Fastener labels on edges
  edges.filter(e=>e.fts&&e.fts.length>0).forEach(e=>{
    const tVal=S.gvTValues[e.id]??e.defT;
    const x1=e.from.x+e.from.w,y1=e.from.y,x2=e.to.x,y2=e.to.y;
    const pt=bezPt(x1,y1,x2,y2,tVal);
    const show=e.fts.slice(0,MAX_FAST),extra=e.fts.length-MAX_FAST;
    const lines=[];
    show.forEach((f,fi)=>{
      lines.push({t:clip((f.name||f.pn||'Fastener'),24)+(f.qty>1?' √ó'+f.qty:''),c:GC.fastName});
      if(f.loctite)lines.push({t:f.loctite,c:GC.loctite});
      if(f.torque)lines.push({t:f.torque+'Nm',c:GC.torque});
      if(fi<show.length-1)lines.push(null);
    });
    if(extra>0)lines.push({t:'+'+extra+' more',c:GC.dimText});
    const lineH=12,gap=4;
    const totalLH=lines.filter(Boolean).length*lineH+lines.filter(l=>!l).length*gap;
    const maxW=Math.max(...lines.filter(Boolean).map(l=>l.t.length),5)*6.2+12;

    let lbl=`<g data-role="gvLabel" data-eid="${e.id}" data-x1="${x1}" data-y1="${y1}" data-x2="${x2}" data-y2="${y2}" transform="translate(${pt.x},${pt.y-10})" style="cursor:ew-resize">`;
    lbl+=`<circle cx="0" cy="10" r="3.5" fill="${GC.labelDot}" opacity="0.7"/>`;
    lbl+=`<line x1="0" y1="8" x2="0" y2="0" stroke="${GC.labelDot}" stroke-width="0.8" opacity="0.3"/>`;
    lbl+=`<rect x="${-maxW}" y="${-totalLH-4}" width="${maxW+6}" height="${totalLH+8}" rx="4" fill="${GC.labelBg}" stroke="#1e2030" stroke-width="0.5"/>`;
    let ty=0;
    const textEls=[];
    for(let i=lines.length-1;i>=0;i--){
      const l=lines[i];if(!l){ty-=gap;continue;}
      ty-=lineH;
      textEls.push(`<text x="0" y="${ty+lineH-3}" fill="${l.c}" font-size="9" font-weight="600" text-anchor="end" font-family="'JetBrains Mono',monospace">${l.t}</text>`);
    }
    lbl+=textEls.join('');
    lbl+=`</g>`;
    svgLabels+=lbl;
  });

  const z=S.gvZoom, px=S.gvPan.x, py=S.gvPan.y;
  const partCount=nodes.filter(n=>n.type==='part').length;
  const stepCount=nodes.filter(n=>n.type==='step').length;

  return `<div class="gv-wrap" id="gvWrap">
    <div class="gv-header">
      <button class="gv-btn" data-action="gvZoomOut">‚àí</button>
      <span class="mono" style="font-size:10px;color:var(--muted);min-width:36px;text-align:center">${Math.round(z*100)}%</span>
      <button class="gv-btn" data-action="gvZoomIn">+</button>
      <button class="gv-btn" style="width:auto;padding:0 8px;font-size:9px" data-action="gvReset">Reset</button>
      <button class="gv-btn" style="width:auto;padding:0 8px;font-size:10px;${S.gvPanelOpen?'color:var(--accent);border-color:var(--accent)':''}" data-action="gvTogglePanel">‚áî</button>
    </div>
    ${S.gvPanelOpen?`<div class="gv-panel">
      <label><span>‚¨°‚Üí‚ñ£ Parts ‚Üî Steps</span><span class="val">${G.partsToSteps}px</span></label>
      <input type="range" min="60" max="400" value="${G.partsToSteps}" data-role="gvGap" data-key="partsToSteps">
      <label><span>‚ñ£‚Üí‚óé Steps ‚Üî Groups</span><span class="val">${G.stepsToGroups}px</span></label>
      <input type="range" min="60" max="500" value="${G.stepsToGroups}" data-role="gvGap" data-key="stepsToGroups">
      <label><span>‚óé‚Üí‚óè Groups ‚Üî Assembly</span><span class="val">${G.groupsToAssy}px</span></label>
      <input type="range" min="60" max="400" value="${G.groupsToAssy}" data-role="gvGap" data-key="groupsToAssy">
      <button class="btn-sm" style="width:100%;margin-top:4px;text-align:center;color:var(--accent);border-color:rgba(245,158,11,0.2);background:rgba(245,158,11,0.05)" data-action="gvResetGaps">Reset Spacing</button>
    </div>`:''}
    <svg id="gvSvg" width="100%" height="100%" style="position:absolute;top:0;left:0">
      <defs><filter id="gvGlow" x="-50%" y="-50%" width="200%" height="200%"><feGaussianBlur in="SourceGraphic" stdDeviation="6" result="b"/><feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge></filter></defs>
      <g id="gvCanvas" transform="translate(${px},${py}) scale(${z})">
        ${svgEdges}${svgNodes}${svgLabels}
      </g>
    </svg>
    <div class="gv-footer">Scroll to zoom ¬∑ Drag to pan ¬∑ ‚Üî Slide labels along arrows ¬∑ ${partCount} parts ¬∑ ${stepCount} steps</div>
    <div class="gv-legend">
      <span><i style="background:#2563eb"></i>Part</span><span><i style="background:#7c3aed"></i>Step</span>
      <span><i style="background:#d97706"></i>Prep</span><span><i style="background:#16a34a"></i>Kanryo</span>
      <span><i style="background:#ef4444"></i>ECN</span><span><i style="background:#f59e0b"></i>Fastener</span>
      <span><i style="background:#a78bfa"></i>Loctite</span><span><i style="background:#22c55e"></i>Torque</span>
    </div>
  </div>`;
}

function initGV(){
  const wrap=document.getElementById('gvWrap');
  const svg=document.getElementById('gvSvg');
  if(!wrap||!svg)return;
  let dragging=false,dragX=0,dragY=0;

  // Pan
  svg.addEventListener('mousedown',e=>{
    if(e.target.closest('[data-role="gvLabel"]'))return;
    if(e.button!==0)return;
    dragging=true;wrap.classList.add('dragging');
    dragX=e.clientX-S.gvPan.x;dragY=e.clientY-S.gvPan.y;
  });
  svg.addEventListener('mousemove',e=>{
    if(!dragging)return;
    S.gvPan.x=e.clientX-dragX;S.gvPan.y=e.clientY-dragY;
    const c=document.getElementById('gvCanvas');
    if(c)c.setAttribute('transform',`translate(${S.gvPan.x},${S.gvPan.y}) scale(${S.gvZoom})`);
  });
  const stopDrag=()=>{dragging=false;wrap.classList.remove('dragging');};
  svg.addEventListener('mouseup',stopDrag);
  svg.addEventListener('mouseleave',stopDrag);

  // Wheel zoom
  wrap.addEventListener('wheel',e=>{
    e.preventDefault();
    S.gvZoom=Math.min(3,Math.max(0.1,S.gvZoom+(e.deltaY>0?-0.06:0.06)));
    const c=document.getElementById('gvCanvas');
    if(c)c.setAttribute('transform',`translate(${S.gvPan.x},${S.gvPan.y}) scale(${S.gvZoom})`);
  },{passive:false});

  // Column gap sliders (live update)
  wrap.querySelectorAll('[data-role="gvGap"]').forEach(slider=>{
    slider.addEventListener('input',()=>{
      const key=slider.dataset.key;
      S.gvGaps[key]=parseInt(slider.value);
      // Update displayed value
      const valEl=slider.previousElementSibling?.querySelector('.val');
      if(valEl)valEl.textContent=slider.value+'px';
      // Re-render SVG only (not the full app)
      reRenderGvSvg();
    });
  });

  // Sliding fastener labels
  attachGvLabels(svg);
}

function reRenderGvSvg(){
  const svg=document.getElementById('gvSvg');
  if(!svg)return;
  const tree=DB.tree[`${S.assy.id}`];
  const ecnRecords=DB.ecnChanges[S.assy.id]||[];
  if(!tree)return;
  // Re-call renderGraphView logic for SVG only
  const inner=renderGvSvgInner(tree,S.assy,ecnRecords);
  svg.innerHTML=inner;
  attachGvLabels(svg);
}

function renderGvSvgInner(tree,assy,ecnRecords){
  // Duplicate mini-layout from renderGraphView to rebuild SVG
  const G=S.gvGaps;
  const STEP_W=220,STEP_H=54,PART_W=140,PART_H=32,GRP_W=185,GRP_H=54,ASSY_W=200,ASSY_H=60,MAX_FAST=2;
  const COL_CHILD=50,COL_STEP=COL_CHILD+PART_W+G.partsToSteps,COL_GRP=COL_STEP+STEP_W+G.stepsToGroups,COL_ASSY=COL_GRP+GRP_W+G.groupsToAssy;
  const GC={partFill:'#0c1824',partStroke:'#2563eb',partText:'#7dd3fc',stepFill:'#140c24',stepStroke:'#7c3aed',stepText:'#c4b5fd',prepFill:'#1a1406',prepStroke:'#d97706',prepText:'#fbbf24',checkFill:'#1a0820',checkStroke:'#db2777',checkText:'#f9a8d4',kanryoFill:'#061a12',kanryoStroke:'#16a34a',kanryoText:'#86efac',grpFill:'#0e0f14',assyFill:'#0a1e12',assyStroke:'#22c55e',assyText:'#4ade80',ecnGlow:'#ef4444',cascadeGlow:'#f59e0b',fastName:'#f59e0b',loctite:'#a78bfa',torque:'#22c55e',arrow:'#252838',arrowHi:'#3d4160',seqBg:'#1a1408',seqCol:'#f59e0b',dim:'#363950',dimText:'#4a4e68',labelBg:'rgba(8,9,13,0.8)',labelDot:'#f59e0b'};
  function sc(type,ecn,casc){let f=GC.stepFill,s=GC.stepStroke,t=GC.stepText;if(type==='PREP'){f=GC.prepFill;s=GC.prepStroke;t=GC.prepText;}if(type==='CHECK'){f=GC.checkFill;s=GC.checkStroke;t=GC.checkText;}if(type==='KANRYO'){f=GC.kanryoFill;s=GC.kanryoStroke;t=GC.kanryoText;}if(ecn)s=GC.ecnGlow;return{f,s,t};}
  function clip(s,n){return s&&s.length>n?s.slice(0,n-1)+'‚Ä¶':s||'';}
  function bezP(x1,y1,x2,y2){const d=Math.abs(x2-x1)*0.42;return`M${x1},${y1} C${x1+d},${y1} ${x2-d},${y2} ${x2},${y2}`;}
  function bezPt(x1,y1,x2,y2,t){const d=Math.abs(x2-x1)*0.42,cx1=x1+d,cy1=y1,cx2=x2-d,cy2=y2,u=1-t;return{x:u*u*u*x1+3*u*u*t*cx1+3*u*t*t*cx2+t*t*t*x2,y:u*u*u*y1+3*u*u*t*cy1+3*u*t*t*cy2+t*t*t*y2};}

  const nodes=[],edges=[];let y=50;
  tree.groups.forEach(g=>{
    const gy0=y,gSteps=stepsForGroup(tree,g.id),stepNds=[];
    gSteps.forEach(step=>{
      const pts=partsForStep(tree,step.id),fts=fastenersForStep(tree,step.id),np=pts.length;
      const isSingle=np===1,isMulti=np>1;
      const hasEcn=step.ecn_status==='changed'||ecnRecords.some(c=>c.step_id===step.id);
      const colors=sc((step.type||'STEP').toUpperCase(),hasEcn,false);
      const childNds=[];
      if(isMulti){const totalCH=np*(PART_H+12)-12;const cy0=y-totalCH/2+PART_H/2;pts.forEach((p,pi)=>{const py=cy0+pi*(PART_H+12);const cn={id:'cp-'+step.id+'-'+pi,type:'part',x:COL_CHILD,y:py,w:PART_W,h:PART_H,pn:p.pn||'',name:p.name||p.pn||'Part',qty:p.qty||1};nodes.push(cn);childNds.push(cn);});}
      const sn={id:'s-'+step.id,type:'step',x:COL_STEP,y,w:STEP_W,h:STEP_H,stepId:step.id,seq:step.seq_tag||'',name:step.label||step.pn||'',stepType:(step.type||'STEP').toUpperCase(),colors,isSingle,isMulti,hasEcn,inlinePartName:isSingle?(pts[0].name||pts[0].pn||''):'',inlinePartPn:isSingle?(pts[0].pn||''):'',fts};
      nodes.push(sn);stepNds.push(sn);
      if(isMulti){childNds.forEach((cn,ci)=>{edges.push({id:'e-cp-'+step.id+'-'+ci,from:cn,to:sn,kind:'part-step',fts:ci===0?fts:[],defT:0.45});});}
      const blockH=isMulti?Math.max(STEP_H,np*(PART_H+12)):STEP_H;
      y+=blockH+26;
    });
    const gmid=(gy0+y-26)/2;
    const gn={id:'g-'+g.id,type:'group',x:COL_GRP,y:gmid,w:GRP_W,h:GRP_H,label:g.label,icon:g.icon||'üì¶',color:g.color||'#6b7280',stepCount:gSteps.length};
    nodes.push(gn);
    stepNds.forEach(sn=>{edges.push({id:'e-sg-'+sn.stepId,from:sn,to:gn,kind:'step-grp',fts:sn.isMulti?[]:sn.fts,defT:0.35});});
    y+=44;
  });
  const grps=nodes.filter(n=>n.type==='group'),ay=grps.length?grps.reduce((a,n)=>a+n.y,0)/grps.length:200;
  const an={id:'assy',type:'assy',x:COL_ASSY,y:ay,w:ASSY_W,h:ASSY_H};nodes.push(an);
  grps.forEach(gn=>{edges.push({id:'e-ga-'+gn.id,from:gn,to:an,kind:'grp-assy',fts:[],defT:0.5});});
  const totalH=y+80;

  // Stash for label sliding
  window._gvEdges=edges;

  let svgE='',svgN='',svgL='';
  [{x:COL_CHILD,l:'Parts',c:GC.partStroke},{x:COL_STEP,l:'Steps',c:GC.stepStroke},{x:COL_GRP,l:'Groups',c:'#6b7280'},{x:COL_ASSY,l:'Assembly',c:GC.assyStroke}].forEach(g=>{svgE+=`<line x1="${g.x}" y1="-20" x2="${g.x}" y2="${totalH}" stroke="${g.c}" stroke-width="0.5" opacity="0.08" stroke-dasharray="6 4"/><text x="${g.x+4}" y="-8" fill="${g.c}" font-size="8" font-weight="700" opacity="0.2" font-family="'JetBrains Mono',monospace">${g.l}</text>`;});
  edges.forEach(e=>{const x1=e.from.x+e.from.w,y1=e.from.y,x2=e.to.x,y2=e.to.y,isHi=e.kind==='grp-assy',sw=isHi?2.2:1.2,ecn=e.to.hasEcn,col=ecn?(GC.ecnGlow+'40'):(isHi?GC.arrowHi:GC.arrow);svgE+=`<path d="${bezP(x1,y1,x2,y2)}" fill="none" stroke="${col}" stroke-width="${sw}"/><circle cx="${x2}" cy="${y2}" r="2.8" fill="${col}"/>`;});
  nodes.forEach(n=>{
    if(n.type==='part'){const ind=11,pts=`${n.x+ind},${n.y-n.h/2} ${n.x+n.w-ind},${n.y-n.h/2} ${n.x+n.w},${n.y} ${n.x+n.w-ind},${n.y+n.h/2} ${n.x+ind},${n.y+n.h/2} ${n.x},${n.y}`;svgN+=`<polygon points="${pts}" fill="${GC.partFill}" stroke="${GC.partStroke}" stroke-width="1.2"/><text x="${n.x+n.w/2}" y="${n.y+1}" fill="${GC.partText}" font-size="9" font-weight="600" text-anchor="middle" font-family="'JetBrains Mono',monospace">${clip(n.name||n.pn,17)}</text>`;if(n.qty>1)svgN+=`<text x="${n.x+n.w-ind-2}" y="${n.y+n.h/2-3}" fill="${GC.partStroke}" font-size="7" font-weight="700" text-anchor="end" font-family="'JetBrains Mono',monospace">√ó${n.qty}</text>`;}
    else if(n.type==='step'){const r=10,c=n.colors,glow=n.hasEcn?GC.ecnGlow:null,iconX=n.hasEcn?28:12;if(glow)svgN+=`<rect x="${n.x-5}" y="${n.y-n.h/2-5}" width="${n.w+10}" height="${n.h+10}" rx="${r+4}" fill="none" stroke="${glow}" stroke-width="2.5" opacity="0.28" filter="url(#gvGlow)"/>`;svgN+=`<rect x="${n.x}" y="${n.y-n.h/2}" width="${n.w}" height="${n.h}" rx="${r}" fill="${c.f}" stroke="${c.s}" stroke-width="1.5"/>`;if(n.seq&&n.seq!=='‚Äî'){svgN+=`<rect x="${n.x+n.w-38}" y="${n.y-n.h/2-10}" width="36" height="20" rx="5" fill="${GC.seqBg}" stroke="${GC.seqCol}" stroke-width="1.2"/><text x="${n.x+n.w-20}" y="${n.y-n.h/2+5}" fill="${GC.seqCol}" font-size="11" font-weight="800" text-anchor="middle" font-family="'JetBrains Mono',monospace">${n.seq}</text>`;}if(n.hasEcn)svgN+=`<circle cx="${n.x+14}" cy="${n.y-n.h/2+15}" r="5.5" fill="${GC.ecnGlow}"/>`;if(n.isSingle&&n.inlinePartName){svgN+=`<text x="${n.x+iconX}" y="${n.y-4}" fill="${c.t}" font-size="14" font-weight="700" font-family="'DM Sans',sans-serif">${clip(n.inlinePartName,24)}</text><text x="${n.x+iconX}" y="${n.y+12}" fill="${GC.dim}" font-size="9" font-family="'JetBrains Mono',monospace">${n.inlinePartPn}</text>`;}else{svgN+=`<text x="${n.x+iconX}" y="${n.y-4}" fill="${c.t}" font-size="13" font-weight="700" font-family="'DM Sans',sans-serif">${clip(n.name,22)}</text><text x="${n.x+iconX}" y="${n.y+10}" fill="${c.s}" font-size="8" font-weight="700" opacity="0.4" font-family="'JetBrains Mono',monospace">${n.stepType}</text>`;}}
    else if(n.type==='group'){svgN+=`<rect x="${n.x}" y="${n.y-n.h/2}" width="${n.w}" height="${n.h}" rx="14" fill="${GC.grpFill}" stroke="${n.color}" stroke-width="2"/><text x="${n.x+16}" y="${n.y+2}" font-size="16">${n.icon}</text><text x="${n.x+38}" y="${n.y-6}" fill="${n.color}" font-size="13" font-weight="700" font-family="'DM Sans',sans-serif">${n.label}</text><text x="${n.x+38}" y="${n.y+10}" fill="#4b5563" font-size="9" font-weight="600" font-family="'JetBrains Mono',monospace">ÂÆå‰∫Ü ¬∑ ${n.stepCount} steps</text>`;}
    else if(n.type==='assy'){svgN+=`<rect x="${n.x}" y="${n.y-n.h/2}" width="${n.w}" height="${n.h}" rx="${n.h/2}" fill="${GC.assyFill}" stroke="${GC.assyStroke}" stroke-width="2.5"/><circle cx="${n.x+22}" cy="${n.y}" r="6" fill="${GC.assyStroke}" opacity="0.3"/><text x="${n.x+n.w/2+8}" y="${n.y-3}" fill="${GC.assyText}" font-size="14" font-weight="800" text-anchor="middle" font-family="'DM Sans',sans-serif">${assy.name||assy.tag}</text><text x="${n.x+n.w/2+8}" y="${n.y+13}" fill="${GC.assyStroke}" font-size="9" font-weight="700" text-anchor="middle" opacity="0.5" font-family="'JetBrains Mono',monospace">v${assy.version||'?'}</text>`;}
  });
  edges.filter(e=>e.fts&&e.fts.length>0).forEach(e=>{
    const tVal=S.gvTValues[e.id]??e.defT,x1=e.from.x+e.from.w,y1=e.from.y,x2=e.to.x,y2=e.to.y,pt=bezPt(x1,y1,x2,y2,tVal);
    const show=e.fts.slice(0,MAX_FAST),extra=e.fts.length-MAX_FAST,lines=[];
    show.forEach((f,fi)=>{lines.push({t:clip((f.name||f.pn||'Fastener'),24)+(f.qty>1?' √ó'+f.qty:''),c:GC.fastName});if(f.loctite)lines.push({t:f.loctite,c:GC.loctite});if(f.torque)lines.push({t:f.torque+'Nm',c:GC.torque});if(fi<show.length-1)lines.push(null);});
    if(extra>0)lines.push({t:'+'+extra+' more',c:GC.dimText});
    const lineH=12,gap=4,totalLH=lines.filter(Boolean).length*lineH+lines.filter(l=>!l).length*gap,maxW=Math.max(...lines.filter(Boolean).map(l=>l.t.length),5)*6.2+12;
    let lbl=`<g data-role="gvLabel" data-eid="${e.id}" data-x1="${x1}" data-y1="${y1}" data-x2="${x2}" data-y2="${y2}" transform="translate(${pt.x},${pt.y-10})" style="cursor:ew-resize">`;
    lbl+=`<circle cx="0" cy="10" r="3.5" fill="${GC.labelDot}" opacity="0.7"/><line x1="0" y1="8" x2="0" y2="0" stroke="${GC.labelDot}" stroke-width="0.8" opacity="0.3"/>`;
    lbl+=`<rect x="${-maxW}" y="${-totalLH-4}" width="${maxW+6}" height="${totalLH+8}" rx="4" fill="${GC.labelBg}" stroke="#1e2030" stroke-width="0.5"/>`;
    let ty=0;for(let i=lines.length-1;i>=0;i--){const l=lines[i];if(!l){ty-=gap;continue;}ty-=lineH;lbl+=`<text x="0" y="${ty+lineH-3}" fill="${l.c}" font-size="9" font-weight="600" text-anchor="end" font-family="'JetBrains Mono',monospace">${l.t}</text>`;}
    lbl+=`</g>`;svgL+=lbl;
  });
  const z=S.gvZoom,px=S.gvPan.x,py=S.gvPan.y;
  return`<defs><filter id="gvGlow" x="-50%" y="-50%" width="200%" height="200%"><feGaussianBlur in="SourceGraphic" stdDeviation="6" result="b"/><feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge></filter></defs><g id="gvCanvas" transform="translate(${px},${py}) scale(${z})">${svgE}${svgN}${svgL}</g>`;
}

function attachGvLabels(svg){
  svg.querySelectorAll('[data-role="gvLabel"]').forEach(el=>{
    let startX=null,t0=0;
    const eid=el.dataset.eid,x1=+el.dataset.x1,y1=+el.dataset.y1,x2=+el.dataset.x2,y2=+el.dataset.y2;
    const edge=window._gvEdges?.find(e=>e.id===eid);
    const defT=edge?edge.defT:0.4;

    el.addEventListener('mousedown',ev=>{
      ev.stopPropagation();startX=ev.clientX;t0=S.gvTValues[eid]??defT;
      function bezPt(t){const d=Math.abs(x2-x1)*0.42,cx1=x1+d,cy1=y1,cx2=x2-d,cy2=y2,u=1-t;return{x:u*u*u*x1+3*u*u*t*cx1+3*u*t*t*cx2+t*t*t*x2,y:u*u*u*y1+3*u*u*t*cy1+3*u*t*t*cy2+t*t*t*y2};}
      const onMove=e=>{if(startX===null)return;const dx=(e.clientX-startX)/S.gvZoom,dt=dx/Math.abs(x2-x1),newT=Math.max(0.05,Math.min(0.95,t0+dt));S.gvTValues[eid]=newT;const pt=bezPt(newT);el.setAttribute('transform',`translate(${pt.x},${pt.y-10})`);};
      const onUp=()=>{startX=null;window.removeEventListener('mousemove',onMove);window.removeEventListener('mouseup',onUp);};
      window.addEventListener('mousemove',onMove);window.addEventListener('mouseup',onUp);
    });
  });
}

function renderChangeModal(){
  const unit=S.selectedUnits[0],ecn=DB.ecnChanges[S.assy.id]||[],ch=ecn[S.modal];if(!ch)return'';
  const isDone=DB.isApplied(unit.sn,ch.seq_tag),disp=ECN_DISPOSITIONS[ch.disposition]||{};
  return `<div class="cm-overlay" data-action="closeModal"><div class="cm-box" onclick="event.stopPropagation()">
    <div style="padding:14px 18px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px">
      <span class="mono" style="font-size:14px;font-weight:700;padding:4px 10px;border-radius:6px;background:rgba(239,68,68,0.1);color:#ef4444">${ch.seq_tag||'‚Äî'}</span>
      <div style="flex:1"><div style="font-size:16px;font-weight:700">${ch.step_name||''}</div><div style="font-size:12px;color:var(--muted)">${ch.group_name||''} ¬∑ ${unit.sn}</div></div>
      <button style="background:none;border:none;color:var(--muted);font-size:18px;cursor:pointer" data-action="closeModal">‚úï</button>
    </div>
    <div style="padding:18px;overflow-y:auto;flex:1;display:flex;flex-direction:column;gap:14px">
      <div style="display:flex;gap:6px;flex-wrap:wrap">
        <span class="badge" style="background:rgba(139,92,246,0.1);color:#a78bfa;font-size:11px;padding:3px 10px">${ch.change_type||'modified'}</span>
        ${ch.disposition?`<span class="badge" style="background:${disp.bg||''};color:${disp.color||''};font-size:11px;padding:3px 10px">${disp.icon||''} ${(ch.disposition||'').toUpperCase()}</span>`:''}
      </div>
      <div style="display:flex;gap:8px">
        ${ch.old_value?`<div style="flex:1;padding:12px;border-radius:8px;background:rgba(239,68,68,0.04);border:1px solid rgba(239,68,68,0.08)"><div style="font-size:9px;font-weight:700;color:#ef4444;text-transform:uppercase;letter-spacing:1px;margin-bottom:4px">Before</div><div style="font-size:14px;font-weight:600" class="mono">${ch.old_value}</div></div>`:''}
        <div style="flex:1;padding:12px;border-radius:8px;background:rgba(34,197,94,0.04);border:1px solid rgba(34,197,94,0.08)"><div style="font-size:9px;font-weight:700;color:#22c55e;text-transform:uppercase;letter-spacing:1px;margin-bottom:4px">${ch.old_value?'After':'New'}</div><div style="font-size:14px;font-weight:600" class="mono">${ch.new_value||''}</div></div>
      </div>
      ${ch.reason?`<div style="padding:12px;border-radius:8px;background:rgba(245,158,11,0.04);border:1px solid rgba(245,158,11,0.08)"><div style="font-size:9px;font-weight:700;color:var(--accent);text-transform:uppercase;letter-spacing:1px;margin-bottom:3px">Reason</div><div style="font-size:13px">${ch.reason}</div></div>`:''}
    </div>
    <div style="padding:12px 18px;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:8px;align-items:center">
      ${isDone?'<span style="font-size:12px;color:#22c55e;margin-right:auto">‚úÖ Applied</span>':''}
      <button style="background:transparent;border:1px solid var(--border);border-radius:8px;padding:8px 16px;color:var(--muted);cursor:pointer;font-size:13px" data-action="closeModal">Close</button>
      <button style="padding:8px 20px;border-radius:8px;font-size:13px;font-weight:700;border:none;cursor:pointer;background:${isDone?'rgba(239,68,68,0.12)':'#22c55e'};color:${isDone?'#ef4444':'#000'}" data-action="toggleApply" data-seq="${ch.seq_tag}" data-sid="${ch.step_id}">${isDone?'‚Ü© Undo':'‚úì Mark Applied'}</button>
    </div>
  </div></div>`;
}

// ============================================================
// TREE EDITOR
// ============================================================
function renderEditor(){
  if(!S.teAssy) return renderEditorPicker();
  const a=DB.assemblies.find(x=>x.id===S.teAssy);if(!a)return'';
  const tree=DB.tree[`${a.id}`];
  if(!tree) return '<div class="loading-wrap"><div class="spinner"></div>Loading tree...</div>';

  const versions=S.teVersions||[];
  const currentVer=S.teVer||a.version;
  const isFrozen=versions.some(v=>v.version===currentVer);
  const sel=S.teSel;
  const selGrp=S.teSelGroup;

  // Find selected step
  let selStep=null,selParts=[],selFast=[];
  if(sel){selStep=tree.steps.find(s=>s.id===sel);if(selStep){selParts=partsForStep(tree,selStep.id);selFast=fastenersForStep(tree,selStep.id);}}

  // --- RIGHT PANEL ---
  let rightPanel='';
  if(selStep){
    const ecnRecs=(DB.ecnChanges[a.id]||[]).filter(c=>c.step_id===selStep.id);
    const ro=isFrozen?'readonly disabled':'';
    const roStyle=isFrozen?'opacity:0.6;pointer-events:none':'';
    rightPanel=`
      ${isFrozen?'<div style="padding:8px 12px;border-radius:8px;margin-bottom:12px;background:rgba(59,130,246,0.06);border:1px solid rgba(59,130,246,0.15);font-size:11px;font-weight:700;color:#3b82f6;text-align:center">üîí Frozen ‚Äî unfreeze to edit</div>':''}
      <div class="dp-section" style="${roStyle}">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px">
          <div style="font-size:18px;font-weight:800;flex:1">${selStep.label||selStep.pn||'Untitled'}</div>
          ${!isFrozen?`<button class="btn-sm" style="background:rgba(239,68,68,0.1);color:#ef4444;border-color:rgba(239,68,68,0.2);font-size:9px" data-action="deleteStep" data-sid="${selStep.id}">üóë Delete</button>`:''}
        </div>
        <div style="display:flex;gap:8px;align-items:flex-start;margin-bottom:12px;flex-wrap:wrap">
          <div><div class="dp-label">SEQ TAG</div><input class="inp" style="width:56px;font-weight:700;font-size:13px;padding:6px 8px" value="${selStep.seq_tag||''}" data-role="teSeqTag" data-sid="${selStep.id}"></div>
          <div><div class="dp-label">TYPE</div><select class="inp" style="font-size:13px;padding:6px 8px" data-role="teType" data-sid="${selStep.id}"><option value="step" ${selStep.type==='STEP'?'selected':''}>STEP</option><option value="prep" ${selStep.type==='PREP'?'selected':''}>PREP</option><option value="check" ${selStep.type==='CHECK'?'selected':''}>CHECK</option></select></div>
          <div style="flex:1"><div class="dp-label">LABEL</div><input class="inp" style="width:100%;font-size:13px;padding:6px 8px" value="${selStep.label||''}" data-role="teLabel" data-sid="${selStep.id}"></div>
        </div>
        <div><div class="dp-label">PART NUMBER (PN)</div><input class="inp" style="width:100%;font-size:12px;padding:6px 8px;margin-bottom:6px" value="${selStep.pn||''}" data-role="teStepPn" data-sid="${selStep.id}"></div>
        <div style="display:flex;gap:8px">
          <div><div class="dp-label">SORT ORDER</div><input class="inp" type="number" style="width:60px;font-size:12px;padding:6px 8px" value="${selStep.sort_order||0}" data-role="teSortOrder" data-sid="${selStep.id}"></div>
          <div><div class="dp-label">ECN STATUS</div>
            <select class="inp" style="font-size:11px;padding:5px 8px" data-role="teEcnStatus" data-sid="${selStep.id}">
              <option value="" ${!selStep.ecn_status?'selected':''}>None</option>
              <option value="changed" ${selStep.ecn_status==='changed'?'selected':''}>üî¥ Changed</option>
              <option value="pending" ${selStep.ecn_status==='pending'?'selected':''}>üü° Pending</option>
              <option value="reviewed" ${selStep.ecn_status==='reviewed'?'selected':''}>üü¢ Reviewed</option>
            </select>
          </div>
        </div>
      </div>

      <div class="dp-section" style="${roStyle}">
        <div style="display:flex;align-items:center;margin-bottom:6px"><span class="dp-label" style="flex:1;margin:0">PARTS (${selParts.length})</span>${!isFrozen?`<button class="btn-sm" style="background:rgba(34,197,94,0.12);color:#22c55e;border:none;font-size:11px;padding:4px 10px" data-action="addPart" data-sid="${selStep.id}">+ Part</button>`:''}</div>
        ${selParts.map(p=>`<div class="dp-row">
          <input class="inp" style="width:100px;font-weight:700;color:#0ea5e9;font-size:11px" value="${p.pn||''}" data-role="partPn" data-pid="${p.id}" placeholder="PN">
          <input class="inp" type="number" style="width:40px;text-align:center;font-size:11px" value="${p.qty||1}" data-role="partQty" data-pid="${p.id}">
          <button style="background:none;border:none;color:#ef4444;font-size:12px;cursor:pointer;padding:2px 4px" data-action="delPart" data-pid="${p.id}">‚úï</button>
        </div>`).join('')}
      </div>

      <div class="dp-section" style="${roStyle}">
        <div style="display:flex;align-items:center;margin-bottom:6px"><span class="dp-label" style="flex:1;margin:0">FASTENERS (${selFast.length})</span>${!isFrozen?`<button class="btn-sm" style="background:rgba(245,158,11,0.12);color:#f59e0b;border:none;font-size:11px;padding:4px 10px" data-action="addFastener" data-sid="${selStep.id}">+ Fastener</button>`:''}</div>
        ${selFast.map(f=>`<div style="display:flex;gap:4px;align-items:center;margin-bottom:4px">
          <input class="inp" style="width:90px;font-weight:700;color:#f59e0b;font-size:11px" value="${f.pn||''}" data-role="fastPn" data-fid="${f.id}" placeholder="PN">
          <input class="inp" style="width:50px;font-size:11px" value="${f.torque||''}" placeholder="Torque" data-role="fastTorque" data-fid="${f.id}">
          <input class="inp" style="width:30px;font-size:11px" value="${f.loctite||''}" placeholder="Loc" data-role="fastLoc" data-fid="${f.id}">
          <input class="inp" type="number" style="width:32px;text-align:center;font-size:11px" value="${f.qty||1}" data-role="fastQty" data-fid="${f.id}">
          <button style="background:none;border:none;color:#ef4444;font-size:12px;cursor:pointer" data-action="delFast" data-fid="${f.id}">‚úï</button>
        </div>`).join('')}
      </div>

      <div class="dp-section">
        <div style="display:flex;align-items:center;margin-bottom:8px"><span class="dp-label" style="flex:1;margin:0">ECN RECORDS (${ecnRecs.length})</span><button class="btn-sm" style="background:rgba(239,68,68,0.12);color:#ef4444;border:none;font-size:11px;padding:4px 10px" data-action="openEcnCreate" data-sid="${selStep.id}">+ ECN Change</button></div>
        ${ecnRecs.map(c=>{const d=ECN_DISPOSITIONS[c.disposition]||{};return `<div style="padding:8px 10px;border-radius:6px;border:1px solid var(--border);margin-bottom:4px;display:flex;align-items:center;gap:6px">
          <span style="font-size:11px;font-weight:700;color:var(--muted)" class="mono">${c.seq_tag||'‚Äî'}</span>
          <span style="flex:1;font-size:12px">${c.field||c.change_type}: ${c.old_value||'‚Äî'} ‚Üí ${c.new_value||'‚Äî'}</span>
          ${c.disposition?`<span style="font-size:9px;font-weight:700;padding:2px 6px;border-radius:4px;background:${d.bg||''};color:${d.color||''}">${(c.disposition||'').toUpperCase()}</span>`:''}
          <button style="background:none;border:none;color:#ef4444;font-size:10px;cursor:pointer" data-action="delEcnRec" data-ecnid="${c.id}">‚úï</button>
        </div>`;}).join('')}
      </div>`;
  } else if(selGrp){
    const grp=tree.groups.find(g=>g.id===selGrp);
    if(grp){
      const roStyle=isFrozen?'opacity:0.6;pointer-events:none':'';
      rightPanel=`
      ${isFrozen?'<div style="padding:8px 12px;border-radius:8px;margin-bottom:12px;background:rgba(59,130,246,0.06);border:1px solid rgba(59,130,246,0.15);font-size:11px;font-weight:700;color:#3b82f6;text-align:center">üîí Frozen ‚Äî unfreeze to edit</div>':''}
      <div class="dp-section" style="${roStyle}">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:14px">
          <span style="font-size:24px">${grp.icon||'üì¶'}</span>
          <div style="font-size:18px;font-weight:800;flex:1;color:${grp.color||'#666'}">${grp.label}</div>
          ${!isFrozen?`<button class="btn-sm" style="background:rgba(239,68,68,0.1);color:#ef4444;border-color:rgba(239,68,68,0.2);font-size:9px" data-action="deleteGroup" data-gid="${grp.id}">üóë Delete Group</button>`:''}
        </div>
        <div style="margin-bottom:10px"><div class="dp-label">GROUP NAME</div><input class="inp" style="width:100%;font-size:13px;padding:6px 8px" value="${grp.label||''}" data-role="grpLabel" data-gid="${grp.id}"></div>
        <div style="margin-bottom:10px"><div class="dp-label">COLOR</div>
          <div style="display:flex;gap:4px;flex-wrap:wrap">${GROUP_COLORS.map(c=>`<div style="width:24px;height:24px;border-radius:6px;background:${c};cursor:pointer;border:2px solid ${c===grp.color?'#fff':'transparent'};opacity:${c===grp.color?1:0.5}" data-action="setGrpColor" data-gid="${grp.id}" data-color="${c}"></div>`).join('')}</div>
        </div>
        <div style="margin-bottom:10px"><div class="dp-label">ICON</div>
          <div style="display:flex;gap:4px;flex-wrap:wrap">${GROUP_ICONS.map(ic=>`<div style="width:28px;height:28px;border-radius:6px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:16px;background:${ic===grp.icon?'rgba(255,255,255,0.1)':'transparent'};border:1px solid ${ic===grp.icon?'var(--muted)':'transparent'}" data-action="setGrpIcon" data-gid="${grp.id}" data-icon="${ic}">${ic}</div>`).join('')}</div>
        </div>
        <div style="display:flex;gap:8px">
          <div><div class="dp-label">SORT ORDER</div><input class="inp" type="number" style="width:60px;font-size:12px;padding:6px 8px" value="${grp.sort_order||0}" data-role="grpSort" data-gid="${grp.id}"></div>
          <div><div class="dp-label">VERSION</div><input class="inp" style="width:60px;font-size:12px;padding:6px 8px" value="${grp.version||''}" data-role="grpVersion" data-gid="${grp.id}"></div>
        </div>
      </div>
      <div class="dp-section"><div class="dp-label">STEPS IN GROUP</div><div style="font-size:13px;color:var(--muted)">${stepsForGroup(tree,grp.id).length} steps</div></div>`;
    }
  } else {
    rightPanel=`<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;color:var(--dim);font-size:14px"><div style="font-size:36px;margin-bottom:12px;opacity:0.3">üîß</div><div>Select a step or group to edit</div><div style="font-size:11px;color:var(--dim);margin-top:6px">Click a group header to edit group properties</div></div>`;
  }

  // --- VERSION BAR ---
  const verBar=`<div class="te-verbar">
    <span style="font-size:10px;font-weight:700;color:var(--dim);letter-spacing:1px;margin-right:4px">VERSIONS</span>
    ${versions.map(v=>`<button class="te-ver-pill ${v.version===currentVer?'active':''}" data-action="switchVer" data-ver="${v.version}" title="${v.notes||''}">v${v.version} üîí</button>`).join('')}
    ${!versions.some(v=>v.version===currentVer)?`<button class="te-ver-pill active" style="border-color:rgba(245,158,11,0.4);background:rgba(245,158,11,0.1);color:#f59e0b">v${currentVer} <span style="font-size:8px">DRAFT</span></button>`:''}
    <button class="btn-sm" style="background:rgba(139,92,246,0.12);color:#8b5cf6;border:none;font-size:10px;padding:4px 10px;margin-left:4px" data-action="openNewVer">+ New Version</button>
    <div style="margin-left:auto;display:flex;gap:6px">
      ${isFrozen?`<button class="btn-sm" style="background:rgba(245,158,11,0.1);color:#f59e0b;border-color:rgba(245,158,11,0.2);font-size:10px" data-action="unfreezeVer">üîì Unfreeze to Draft</button>`
      :`<button class="btn-sm" style="background:rgba(59,130,246,0.1);color:#3b82f6;border-color:rgba(59,130,246,0.2);font-size:10px" data-action="freezeVer">üîí Freeze v${currentVer}</button>`}
      <button class="btn-sm" style="background:rgba(34,197,94,0.1);color:#22c55e;border-color:rgba(34,197,94,0.2);font-size:10px" data-action="setProduction">üè≠ Set as Production</button>
    </div>
  </div>
  ${isFrozen?`<div class="te-frozen-bar">üîí Version v${currentVer} is frozen. Unfreeze to make edits.</div>`:''}`;

  return `<div class="te-wrap">
    <div class="te-left">
      <div class="te-topbar">
        <button style="background:none;border:1px solid var(--border);border-radius:8px;padding:6px 14px;color:var(--muted);cursor:pointer;font-size:13px" data-action="teBack">‚Üê Assemblies</button>
        <span style="font-size:16px;font-weight:800;color:#8b5cf6">üîß</span>
        <span style="font-weight:700;color:#8b5cf6;font-size:16px" class="mono">Tree Editor</span>
        <div style="width:1px;height:18px;background:var(--border);margin:0 4px"></div>
        <span style="font-size:18px">${a.icon}</span>
        <span style="font-weight:700;font-size:16px;color:${a.color}">${a.name}</span>
        <span class="badge" style="background:${a.color}15;color:${a.color}">v${currentVer}</span>
        <div style="margin-left:auto;display:flex;gap:6px">${dbStatus()}</div>
      </div>
      ${verBar}
      <div class="te-tree">
        ${tree.groups.map(g=>{const gSteps=stepsForGroup(tree,g.id);const isGSel=selGrp===g.id;
          return `<div style="margin-bottom:6px">
          <div class="te-grp" style="background:${g.color||'#666'}08;border-left:4px solid ${g.color||'#666'};cursor:pointer;${isGSel?'outline:1px solid rgba(139,92,246,0.3);outline-offset:-1px;border-radius:8px':''}" data-action="selGroup" data-gid="${g.id}">
            <span style="font-size:16px">${g.icon||'üì¶'}</span>
            <span style="font-weight:700;color:${g.color||'#666'};flex:1;font-size:15px" class="mono">${g.label}</span>
            <span style="color:var(--muted);font-size:13px">${gSteps.length}</span>
            ${!isFrozen?`<button style="background:none;border:none;color:#22c55e;cursor:pointer;font-size:16px;padding:0 4px" data-action="addStep" data-gid="${g.id}" onclick="event.stopPropagation()">+</button>`:''}
          </div>
          ${gSteps.map(s=>{const isSel=sel===s.id;const hasEcn=s.ecn_status&&s.ecn_status!=='';
            return `<div class="te-step ${isSel?'sel':''}" data-action="selStep" data-sid="${s.id}" style="${isSel?'':'border:1px solid transparent'}">
              ${hasEcn?`<span style="font-size:11px">${s.ecn_status==='changed'?'üî¥':s.ecn_status==='pending'?'üü°':'üü¢'}</span>`:''}
              <span style="font-weight:700;color:${g.color||'#666'};min-width:30px;text-align:center;font-size:13px;background:${g.color||'#666'}15;padding:3px 8px;border-radius:5px" class="mono">${s.seq_tag||'‚Äî'}</span>
              <span style="font-size:11px;font-weight:600;padding:2px 8px;border-radius:4px;color:${s.type==='PREP'?'#a855f7':s.type==='CHECK'?'#ec4899':'#22c55e'};background:${s.type==='PREP'?'rgba(168,85,247,0.1)':s.type==='CHECK'?'rgba(236,72,153,0.1)':'rgba(34,197,94,0.1)'}">${s.type||'STEP'}</span>
              <span style="flex:1;color:${s.label?'var(--text)':'var(--dim)'};font-size:14px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${s.label||s.pn||'untitled'}</span>
              ${partsForStep(tree,s.id).length?`<span style="font-size:11px;color:#22c55e;font-weight:600" class="mono">${partsForStep(tree,s.id).length}P</span>`:''}
              ${fastenersForStep(tree,s.id).length?`<span style="font-size:11px;color:#ef4444;font-weight:600" class="mono">${fastenersForStep(tree,s.id).length}F</span>`:''}
            </div>`;}).join('')}
        </div>`;}).join('')}
        ${!isFrozen?`<button class="btn-sm" style="width:100%;margin-top:8px;padding:10px;background:rgba(99,102,241,0.12);color:#6366f1;border:none;font-size:12px" data-action="addGroup">+ Add Group</button>`:''}
      </div>
    </div>
    <div class="te-right">${rightPanel}</div>
  </div>`;
}

function renderEditorPicker(){
  const all=DB.assemblies;
  return `<div class="te-pick-wrap">
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:36px;width:100%;max-width:760px">
      <button style="background:none;border:1px solid var(--border);border-radius:8px;padding:6px 14px;color:var(--muted);cursor:pointer;font-size:13px" data-action="goHome">‚Üê Home</button>
      <span style="font-size:20px;font-weight:800;color:#8b5cf6">üîß</span><span style="font-weight:700;color:#8b5cf6;font-size:20px" class="mono">Tree Editor</span>
      <div style="margin-left:auto">${dbStatus()}</div>
    </div>
    <div class="te-pick-grid">${all.map(a=>`<div class="te-pick-card" data-action="pickAssy" data-id="${a.id}" style="border-color:${a.color}40" onmouseenter="this.style.borderColor='${a.color}'" onmouseleave="this.style.borderColor='${a.color}40'">
      <div style="font-size:48px;margin-bottom:12px">${a.icon}</div><div style="font-size:17px;font-weight:700;margin-bottom:8px">${a.name}</div>
      <span class="badge" style="background:${a.color}15;color:${a.color};font-size:11px;padding:3px 8px">v${a.version}</span>
    </div>`).join('')}</div>
  </div>`;
}

// ============================================================
// MODALS
// ============================================================
function renderConfirmModal(){
  return `<div class="confirm-overlay"><div class="confirm-box">
    <div style="font-size:16px;font-weight:700;margin-bottom:10px">‚ö†Ô∏è Confirm Action</div>
    <div style="font-size:13px;color:var(--muted);margin-bottom:18px;line-height:1.5">${S.confirmMsg}</div>
    <div style="display:flex;gap:8px;justify-content:flex-end">
      <button class="btn-sm" style="padding:8px 16px;font-size:12px" data-action="confirmCancel">Cancel</button>
      <button class="btn-sm" style="padding:8px 16px;font-size:12px;background:#ef4444;color:#fff;border-color:#ef4444" data-action="confirmYes">Confirm</button>
    </div>
  </div></div>`;
}

function renderNewVersionModal(){
  return `<div class="confirm-overlay"><div class="confirm-box" style="width:400px">
    <div style="font-size:16px;font-weight:700;margin-bottom:14px">üìã Create New Version</div>
    <div style="margin-bottom:10px"><div class="dp-label">VERSION NUMBER</div><input class="inp" style="width:100%;font-size:14px;padding:8px 10px" placeholder="e.g. 6.0" data-role="newVerStr" value="${S.newVerStr}"></div>
    <div style="margin-bottom:14px"><div class="dp-label">NOTES (optional)</div><input class="inp" style="width:100%;font-size:12px;padding:8px 10px" placeholder="ECN description, changes made..." data-role="newVerNotes" value="${S.newVerNotes}"></div>
    <div style="display:flex;gap:8px;justify-content:flex-end">
      <button class="btn-sm" style="padding:8px 16px;font-size:12px" data-action="cancelNewVer">Cancel</button>
      <button class="btn-sm" style="padding:8px 16px;font-size:12px;background:#8b5cf6;color:#fff;border-color:#8b5cf6" data-action="createNewVer">Create Version</button>
    </div>
  </div></div>`;
}

function renderVersionAssignModal(){
  const a=S.assy;if(!a)return'';
  const versions=DB.versions[a.id]||[];
  const latestVer=a.version;
  const sns=[...S.unitSel];
  const units=DB.units[a.id]||[];
  // Build version list: all from history + current assembly ver
  const verSet=new Set(versions.map(v=>v.version));
  verSet.add(latestVer);
  const verList=[...verSet].sort((a,b)=>{
    const pa=a.split('.').map(Number),pb=b.split('.').map(Number);
    for(let i=0;i<Math.max(pa.length,pb.length);i++){if((pb[i]||0)!==(pa[i]||0))return(pb[i]||0)-(pa[i]||0);}return 0;
  });
  const selVer=S.versionAssignVer||latestVer;
  const isLatest=selVer===latestVer;
  const verNote=versions.find(v=>v.version===selVer);

  return `<div class="confirm-overlay" data-action="cancelVersionAssign"><div class="confirm-box" style="width:480px" onclick="event.stopPropagation()">
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:16px">
      <span style="font-size:22px">üìã</span>
      <div><div style="font-size:16px;font-weight:700">Assign Version to Units</div>
        <div style="font-size:11px;color:var(--muted)" class="mono">${sns.length} unit${sns.length>1?'s':''} selected ¬∑ ${a.name}</div></div>
    </div>

    <div style="margin-bottom:14px">
      <div class="dp-label">SELECTED UNITS</div>
      <div style="display:flex;flex-wrap:wrap;gap:4px;max-height:100px;overflow-y:auto;padding:6px 0">
        ${sns.map(sn=>{const u=units.find(x=>x.sn===sn);const curV=u?.version;
          return `<span style="padding:2px 8px;border-radius:4px;font-size:10px;font-weight:600;background:rgba(245,158,11,0.08);border:1px solid rgba(245,158,11,0.15);color:var(--text);font-family:'JetBrains Mono',monospace">${sn}${curV?` <span style="color:var(--muted);font-size:9px">v${curV}</span>`:''}</span>`;
        }).join('')}
      </div>
    </div>

    <div style="margin-bottom:14px">
      <div class="dp-label">ASSIGN VERSION</div>
      <div style="display:flex;flex-wrap:wrap;gap:6px;margin-top:4px">
        ${verList.map(v=>{
          const isCur=v===latestVer;
          const isActive=v===selVer;
          const vInfo=versions.find(x=>x.version===v);
          return `<button class="btn-sm" style="padding:5px 12px;font-size:11px;${isActive?`background:rgba(139,92,246,0.2);border-color:#8b5cf6;color:#a78bfa`:`background:transparent;color:var(--muted)`}" data-action="pickAssignVer" data-ver="${v}">
            v${v}${isCur?' <span style="font-size:8px;color:#22c55e">LATEST</span>':''}${vInfo?' üîí':''}
          </button>`;
        }).join('')}
      </div>
    </div>

    ${verNote?`<div style="margin-bottom:14px;padding:8px 12px;border-radius:6px;background:rgba(139,92,246,0.04);border:1px solid rgba(139,92,246,0.1)">
      <div style="font-size:9px;font-weight:700;color:var(--muted);text-transform:uppercase;margin-bottom:3px">VERSION NOTES</div>
      <div style="font-size:12px;color:var(--text)">${verNote.notes||'No notes'}</div>
      <div style="font-size:9px;color:var(--dim);margin-top:2px" class="mono">${verNote.created_by||''} ¬∑ ${verNote.created_at?new Date(verNote.created_at).toLocaleDateString():''}</div>
    </div>`:''}

    <div style="padding:10px 12px;border-radius:8px;margin-bottom:14px;background:${isLatest?'rgba(34,197,94,0.04)':'rgba(239,68,68,0.04)'};border:1px solid ${isLatest?'rgba(34,197,94,0.12)':'rgba(239,68,68,0.12)'}">
      <div style="font-size:11px;font-weight:700;color:${isLatest?'#22c55e':'#ef4444'}">${isLatest?'‚úì Units will be marked CURRENT':'‚ö† Units will be marked OUTDATED'}</div>
      <div style="font-size:10px;color:var(--muted);margin-top:2px">Latest assembly version: v${latestVer}${isLatest?'':` ¬∑ Assigning: v${selVer}`}</div>
    </div>

    <div style="display:flex;gap:8px;justify-content:flex-end">
      <button class="btn-sm" style="padding:8px 16px;font-size:12px" data-action="cancelVersionAssign">Cancel</button>
      <button class="btn-sm" style="padding:8px 20px;font-size:12px;background:#8b5cf6;color:#fff;border-color:#8b5cf6;font-weight:700" data-action="confirmVersionAssign">
        Assign v${selVer} to ${sns.length} unit${sns.length>1?'s':''}
      </button>
    </div>
  </div></div>`;
}

function renderEcnModal(){
  const step=S.ecnStep;if(!step)return'';
  return `<div class="confirm-overlay"><div class="confirm-box" style="width:480px">
    <div style="font-size:16px;font-weight:700;margin-bottom:4px">üî¥ Create ECN Change Record</div>
    <div style="font-size:12px;color:var(--muted);margin-bottom:14px">Step: ${step.label||step.pn||'‚Äî'} (${step.seq_tag||'‚Äî'})</div>
    <div style="display:flex;gap:8px;margin-bottom:10px">
      <div style="flex:1"><div class="dp-label">CHANGE TYPE</div>
        <select class="inp" style="width:100%;font-size:12px;padding:6px 8px" data-role="ecnChangeType">
          <option value="part_changed" ${S.ecnChangeType==='part_changed'?'selected':''}>Part Changed</option>
          <option value="fastener_changed" ${S.ecnChangeType==='fastener_changed'?'selected':''}>Fastener Changed</option>
          <option value="step_modified" ${S.ecnChangeType==='step_modified'?'selected':''}>Step Modified</option>
          <option value="step_added" ${S.ecnChangeType==='step_added'?'selected':''}>Step Added</option>
          <option value="step_removed" ${S.ecnChangeType==='step_removed'?'selected':''}>Step Removed</option>
        </select>
      </div>
      <div style="flex:1"><div class="dp-label">FIELD</div><input class="inp" style="width:100%;font-size:12px;padding:6px 8px" placeholder="e.g. pn, torque, qty" data-role="ecnField" value="${S.ecnField}"></div>
    </div>
    <div style="display:flex;gap:8px;margin-bottom:10px">
      <div style="flex:1"><div class="dp-label">OLD VALUE</div><input class="inp" style="width:100%;font-size:12px;padding:6px 8px" placeholder="Before" data-role="ecnOld" value="${S.ecnOld}"></div>
      <div style="flex:1"><div class="dp-label">NEW VALUE</div><input class="inp" style="width:100%;font-size:12px;padding:6px 8px" placeholder="After" data-role="ecnNew" value="${S.ecnNew}"></div>
    </div>
    <div style="margin-bottom:10px"><div class="dp-label">REASON</div><input class="inp" style="width:100%;font-size:12px;padding:6px 8px" placeholder="Why this change?" data-role="ecnReason" value="${S.ecnReason}"></div>
    <div style="margin-bottom:14px"><div class="dp-label">DISPOSITION</div>
      <div style="display:flex;gap:6px;margin-top:4px">${Object.entries(ECN_DISPOSITIONS).map(([k,v])=>`<button class="ecn-disp-btn ${S.ecnDisp===k?'active':''}" style="${S.ecnDisp===k?`background:${v.bg};color:${v.color};border-color:${v.color}`:''}" data-action="setEcnDisp" data-d="${k}">${v.icon} ${v.label}</button>`).join('')}</div>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end">
      <button class="btn-sm" style="padding:8px 16px;font-size:12px" data-action="cancelEcn">Cancel</button>
      <button class="btn-sm" style="padding:8px 16px;font-size:12px;background:#ef4444;color:#fff;border-color:#ef4444" data-action="saveEcn">Create ECN Record</button>
    </div>
  </div></div>`;
}

function renderEditGroupModal(){ return ''; /* inline editing now */ }

// ============================================================
// EVENT HANDLERS
// ============================================================
function attachEvents(){
  document.querySelectorAll('[data-action]').forEach(el=>{
    el.onclick=async(e)=>{
      const a=el.dataset.action;
      e.stopPropagation();

      // --- NAV ---
      if(a==='editor'){S.page='editor';S.teAssy=null;S.teSel=null;S.teSelGroup=null;render();}
      else if(a==='goHome'){S.page='home';render();}
      else if(a==='assy'){
        const assy=DB.assemblies.find(x=>x.id===parseInt(el.dataset.id));
        S.assy=assy;S.page='unitSelect';S.unitSel=new Set();S.unitFilter='all';S.unitSearch='';S.loadingUnits=true;render();
        await Promise.all([DB.loadUnits(assy.id,assy.tag),DB.loadEcnChanges(assy.id),DB.loadVersions(assy.id)]);S.loadingUnits=false;render();
      }
      else if(a==='setFilter'){S.unitFilter=el.dataset.f;render();}
      else if(a==='selectAll'){const units=DB.units[S.assy.id]||[];let f=units;if(S.unitFilter==='outdated')f=f.filter(u=>u.status==='outdated');if(S.unitFilter==='current')f=f.filter(u=>u.status==='current'||u.status==='pending');f.forEach(u=>S.unitSel.add(u.sn));render();}
      else if(a==='toggleUnit'){const sn=el.dataset.sn;S.unitSel.has(sn)?S.unitSel.delete(sn):S.unitSel.add(sn);render();}
      else if(a==='proceed'){
        const units=DB.units[S.assy.id]||[];S.selectedUnits=[...S.unitSel].map(sn=>units.find(u=>u.sn===sn)).filter(Boolean);
        S.avTab='list';S.page='assembly';render();await DB.loadTree(S.assy.id);if(S.selectedUnits[0])await DB.loadEcnApplied(S.selectedUnits[0].sn);render();
      }
      else if(a==='backToUnits'){S.page='unitSelect';render();}
      // Version assignment
      else if(a==='openVersionAssign'){S.versionAssignModal=true;S.versionAssignVer=S.assy.version;render();}
      else if(a==='cancelVersionAssign'){S.versionAssignModal=false;render();}
      else if(a==='pickAssignVer'){S.versionAssignVer=el.dataset.ver;render();}
      else if(a==='confirmVersionAssign'){
        const sns=[...S.unitSel];const ver=S.versionAssignVer;
        if(!ver||!sns.length){toast('‚ùå Select version and units',true);return;}
        try{
          toast('‚è≥ Assigning v'+ver+' to '+sns.length+' units...');
          await DB.assignVersionToUnits(S.assy.id,sns,ver);
          await DB.loadUnits(S.assy.id,S.assy.tag);
          S.versionAssignModal=false;
          toast('‚úÖ v'+ver+' assigned to '+sns.length+' unit'+(sns.length>1?'s':''));
          render();
        }catch(err){toast('‚ùå '+err.message,true);}
      }
      else if(a==='avTab'){S.avTab=el.dataset.tab;render();if(el.dataset.tab==='graph')setTimeout(initGV,50);}
      // Graph view controls
      else if(a==='gvZoomIn'){S.gvZoom=Math.min(3,S.gvZoom+0.12);const c=document.getElementById('gvCanvas');if(c)c.setAttribute('transform',`translate(${S.gvPan.x},${S.gvPan.y}) scale(${S.gvZoom}`);}
      else if(a==='gvZoomOut'){S.gvZoom=Math.max(0.1,S.gvZoom-0.12);const c=document.getElementById('gvCanvas');if(c)c.setAttribute('transform',`translate(${S.gvPan.x},${S.gvPan.y}) scale(${S.gvZoom}`);}
      else if(a==='gvReset'){S.gvZoom=0.65;S.gvPan={x:10,y:0};S.gvTValues={};render();setTimeout(initGV,50);}
      else if(a==='gvTogglePanel'){S.gvPanelOpen=!S.gvPanelOpen;render();setTimeout(initGV,50);}
      else if(a==='gvResetGaps'){S.gvGaps={partsToSteps:150,stepsToGroups:160,groupsToAssy:140};render();setTimeout(initGV,50);}
      else if(a==='openChange'){S.modal=parseInt(el.dataset.idx);render();}
      else if(a==='closeModal'){S.modal=null;render();}
      else if(a==='toggleApply'){try{await DB.toggleApplied(S.selectedUnits[0].sn,el.dataset.seq,parseInt(el.dataset.sid));S.modal=null;toast('üíæ Saved');render();}catch(err){toast('‚ùå '+err.message,true);}}

      // --- TREE EDITOR ---
      else if(a==='pickAssy'){
        S.teAssy=parseInt(el.dataset.id);S.teSel=null;S.teSelGroup=null;
        const assy=DB.assemblies.find(x=>x.id===S.teAssy);S.teVer=assy?.version;
        await Promise.all([DB.loadTree(S.teAssy),DB.loadVersions(S.teAssy),DB.loadEcnChanges(S.teAssy)]);
        S.teVersions=DB.versions[S.teAssy]||[];render();
      }
      else if(a==='teBack'){S.teAssy=null;S.teSel=null;S.teSelGroup=null;render();}
      else if(a==='selStep'){S.teSel=parseInt(el.dataset.sid);S.teSelGroup=null;render();}
      else if(a==='selGroup'){S.teSelGroup=parseInt(el.dataset.gid);S.teSel=null;render();}

      // Add step
      else if(a==='addStep'){
        try{const gid=parseInt(el.dataset.gid);await DB.addStep(gid,{seq_tag:'',type:'step',label:'New step',sort_order:999});DB.invalidateTree(S.teAssy);await DB.loadTree(S.teAssy);toast('‚úÖ Step added');render();}catch(err){toast('‚ùå '+err.message,true);}
      }
      // Delete step (confirm)
      else if(a==='deleteStep'){
        S.confirmMsg=`Delete step <strong>${el.dataset.sid}</strong>? This will also delete all its parts and fasteners. This cannot be undone.`;
        S.confirmData={type:'deleteStep',sid:parseInt(el.dataset.sid)};S.confirmAction=true;render();
      }
      // Add group
      else if(a==='addGroup'){
        try{const assy=DB.assemblies.find(x=>x.id===S.teAssy);await DB.addGroup(S.teAssy,S.teVer||assy?.version,{label:'New Group',icon:'üì¶',color:GROUP_COLORS[Math.floor(Math.random()*GROUP_COLORS.length)],sort_order:999});DB.invalidateTree(S.teAssy);await DB.loadTree(S.teAssy);toast('‚úÖ Group added');render();}catch(err){toast('‚ùå '+err.message,true);}
      }
      // Delete group (confirm)
      else if(a==='deleteGroup'){
        const gid=parseInt(el.dataset.gid);const tree=DB.tree[`${S.teAssy}`];const cnt=tree?stepsForGroup(tree,gid).length:0;
        S.confirmMsg=`Delete this group and <strong>${cnt} steps</strong> inside it? All parts and fasteners will also be deleted. This cannot be undone.`;
        S.confirmData={type:'deleteGroup',gid};S.confirmAction=true;render();
      }
      // Parts/fasteners
      else if(a==='addPart'){try{await DB.addPart(parseInt(el.dataset.sid),{pn:'',qty:1,sort_order:999});DB.invalidateTree(S.teAssy);await DB.loadTree(S.teAssy);toast('‚úÖ');render();}catch(err){toast('‚ùå '+err.message,true);}}
      else if(a==='delPart'){try{await DB.deletePart(parseInt(el.dataset.pid));DB.invalidateTree(S.teAssy);await DB.loadTree(S.teAssy);render();}catch(err){toast('‚ùå '+err.message,true);}}
      else if(a==='addFastener'){try{await DB.addFastener(parseInt(el.dataset.sid),{pn:'',qty:1,torque:'',loctite:'',sort_order:999});DB.invalidateTree(S.teAssy);await DB.loadTree(S.teAssy);toast('‚úÖ');render();}catch(err){toast('‚ùå '+err.message,true);}}
      else if(a==='delFast'){try{await DB.deleteFastener(parseInt(el.dataset.fid));DB.invalidateTree(S.teAssy);await DB.loadTree(S.teAssy);render();}catch(err){toast('‚ùå '+err.message,true);}}

      // Group editing
      else if(a==='setGrpColor'){try{await DB.updateGroup(parseInt(el.dataset.gid),{color:el.dataset.color});DB.invalidateTree(S.teAssy);await DB.loadTree(S.teAssy);render();}catch(err){toast('‚ùå '+err.message,true);}}
      else if(a==='setGrpIcon'){try{await DB.updateGroup(parseInt(el.dataset.gid),{icon:el.dataset.icon});DB.invalidateTree(S.teAssy);await DB.loadTree(S.teAssy);render();}catch(err){toast('‚ùå '+err.message,true);}}

      // --- CONFIRM MODAL ---
      else if(a==='confirmCancel'){S.confirmAction=null;S.confirmData=null;render();}
      else if(a==='confirmYes'){
        const d=S.confirmData;S.confirmAction=null;S.confirmData=null;
        try{
          if(d.type==='deleteStep'){await DB.deleteStep(d.sid);S.teSel=null;DB.invalidateTree(S.teAssy);await DB.loadTree(S.teAssy);toast('üóë Step deleted');}
          else if(d.type==='deleteGroup'){await DB.deleteGroup(d.gid);S.teSelGroup=null;DB.invalidateTree(S.teAssy);await DB.loadTree(S.teAssy);toast('üóë Group deleted');}
          else if(d.type==='unfreezeVer'){
            // Delete the version_history entry to unfreeze
            await sbDelete('eagle_eye_app_version_history',`assembly_id=eq.${S.teAssy}&version=eq.${d.ver}`);
            delete DB.versions[S.teAssy];S.teVersions=await DB.loadVersions(S.teAssy);
            toast(`üîì v${d.ver} is now a draft`);
          }
          render();
        }catch(err){toast('‚ùå '+err.message,true);render();}
      }

      // --- VERSION MANAGEMENT ---
      else if(a==='switchVer'){S.teVer=el.dataset.ver;render();}
      else if(a==='openNewVer'){S.newVerModal=true;S.newVerStr='';S.newVerNotes='';render();}
      else if(a==='cancelNewVer'){S.newVerModal=false;render();}
      else if(a==='createNewVer'){
        if(!S.newVerStr.trim()){toast('Enter a version number',true);return;}
        try{
          await DB.createVersion(S.teAssy,S.newVerStr.trim(),S.newVerNotes.trim());
          S.teVersions=await DB.loadVersions(S.teAssy);delete DB.versions[S.teAssy];S.teVersions=await DB.loadVersions(S.teAssy);
          S.teVer=S.newVerStr.trim();S.newVerModal=false;toast('‚úÖ Version created');render();
        }catch(err){toast('‚ùå '+err.message,true);}
      }
      else if(a==='setProduction'){
        try{await DB.updateAssemblyVersion(S.teAssy,S.teVer);toast(`üè≠ v${S.teVer} is now production`);render();}catch(err){toast('‚ùå '+err.message,true);}
      }
      else if(a==='freezeVer'){
        const exists=S.teVersions.some(v=>v.version===S.teVer);
        if(!exists){
          try{
            await DB.createVersion(S.teAssy,S.teVer,`Frozen by Aniket`);
            delete DB.versions[S.teAssy];S.teVersions=await DB.loadVersions(S.teAssy);
            toast(`üîí v${S.teVer} frozen`);render();
          }catch(err){toast('‚ùå '+err.message,true);}
        } else { toast('Already frozen',true); }
      }
      else if(a==='unfreezeVer'){
        S.confirmMsg=`Unfreeze <strong>v${S.teVer}</strong> and make it a draft? This allows editing the tree.`;
        S.confirmData={type:'unfreezeVer',ver:S.teVer};S.confirmAction=true;render();
      }

      // --- ECN ---
      else if(a==='openEcnCreate'){
        const tree=DB.tree[`${S.teAssy}`];const step=tree?.steps.find(s=>s.id===parseInt(el.dataset.sid));
        S.ecnStep=step;S.ecnModal=true;S.ecnField='';S.ecnOld='';S.ecnNew='';S.ecnReason='';S.ecnDisp='replace';S.ecnChangeType='part_changed';render();
      }
      else if(a==='setEcnDisp'){S.ecnDisp=el.dataset.d;render();}
      else if(a==='cancelEcn'){S.ecnModal=false;S.ecnStep=null;render();}
      else if(a==='saveEcn'){
        try{
          const step=S.ecnStep;const grp=(DB.tree[`${S.teAssy}`]?.groups||[]).find(g=>g.id===step.group_id);
          await DB.createEcnChangeRecord({
            ecn_log_id:null, step_id:step.id, seq_tag:step.seq_tag||'',
            step_name:step.label||step.pn||'', change_type:S.ecnChangeType,
            field:S.ecnField, old_value:S.ecnOld, new_value:S.ecnNew,
            reason:S.ecnReason, group_name:grp?.label||'', disposition:S.ecnDisp,
          });
          // Mark step as changed
          await DB.updateStep(step.id,{ecn_status:'changed'});
          delete DB.ecnChanges[S.teAssy];await DB.loadEcnChanges(S.teAssy);
          DB.invalidateTree(S.teAssy);await DB.loadTree(S.teAssy);
          S.ecnModal=false;S.ecnStep=null;toast('üî¥ ECN record created');render();
        }catch(err){toast('‚ùå '+err.message,true);}
      }
      else if(a==='delEcnRec'){
        try{await DB.deleteEcnChangeRecord(parseInt(el.dataset.ecnid));delete DB.ecnChanges[S.teAssy];await DB.loadEcnChanges(S.teAssy);toast('üóë ECN record deleted');render();}catch(err){toast('‚ùå '+err.message,true);}
      }
    };
  });

  // --- DEBOUNCED INPUTS ---
  let saveTimer=null;
  function ds(fn){clearTimeout(saveTimer);saveTimer=setTimeout(async()=>{try{await fn();toast('üíæ');}catch(err){toast('‚ùå '+err.message,true);}},800);}
  document.querySelectorAll('[data-role]').forEach(el=>{
    const r=el.dataset.role;
    if(r==='unitSearch'){el.oninput=()=>{S.unitSearch=el.value;render();};}
    if(r==='unitPicker'){el.onchange=async()=>{const u=S.selectedUnits.find(x=>x.sn===el.value);if(u){S.selectedUnits=[u,...S.selectedUnits.filter(x=>x.sn!==u.sn)];await DB.loadEcnApplied(u.sn);render();}};}
    // Step fields
    if(r==='teSeqTag') el.oninput=()=>ds(()=>DB.updateStep(parseInt(el.dataset.sid),{seq_tag:el.value}));
    if(r==='teType') el.onchange=()=>ds(()=>DB.updateStep(parseInt(el.dataset.sid),{type:el.value}));
    if(r==='teLabel') el.oninput=()=>ds(()=>DB.updateStep(parseInt(el.dataset.sid),{label:el.value}));
    if(r==='teStepPn') el.oninput=()=>ds(()=>DB.updateStep(parseInt(el.dataset.sid),{pn:el.value}));
    if(r==='teSortOrder') el.oninput=()=>ds(()=>DB.updateStep(parseInt(el.dataset.sid),{sort_order:parseInt(el.value)||0}));
    if(r==='teEcnStatus') el.onchange=()=>ds(async()=>{await DB.updateStep(parseInt(el.dataset.sid),{ecn_status:el.value||null});DB.invalidateTree(S.teAssy);await DB.loadTree(S.teAssy);render();});
    // Part fields
    if(r==='partPn') el.oninput=()=>ds(()=>DB.updatePart(parseInt(el.dataset.pid),{pn:el.value}));
    if(r==='partQty') el.oninput=()=>ds(()=>DB.updatePart(parseInt(el.dataset.pid),{qty:parseInt(el.value)||1}));
    // Fastener fields
    if(r==='fastPn') el.oninput=()=>ds(()=>DB.updateFastener(parseInt(el.dataset.fid),{pn:el.value}));
    if(r==='fastTorque') el.oninput=()=>ds(()=>DB.updateFastener(parseInt(el.dataset.fid),{torque:el.value}));
    if(r==='fastLoc') el.oninput=()=>ds(()=>DB.updateFastener(parseInt(el.dataset.fid),{loctite:el.value}));
    if(r==='fastQty') el.oninput=()=>ds(()=>DB.updateFastener(parseInt(el.dataset.fid),{qty:parseInt(el.value)||1}));
    // Group fields
    if(r==='grpLabel') el.oninput=()=>ds(async()=>{await DB.updateGroup(parseInt(el.dataset.gid),{label:el.value});DB.invalidateTree(S.teAssy);await DB.loadTree(S.teAssy);render();});
    if(r==='grpSort') el.oninput=()=>ds(async()=>{await DB.updateGroup(parseInt(el.dataset.gid),{sort_order:parseInt(el.value)||0});DB.invalidateTree(S.teAssy);await DB.loadTree(S.teAssy);render();});
    if(r==='grpVersion') el.oninput=()=>ds(()=>DB.updateGroup(parseInt(el.dataset.gid),{version:el.value}));
    // Modal fields
    if(r==='newVerStr'){el.oninput=()=>{S.newVerStr=el.value;};}
    if(r==='newVerNotes'){el.oninput=()=>{S.newVerNotes=el.value;};}
    if(r==='ecnChangeType'){el.onchange=()=>{S.ecnChangeType=el.value;};}
    if(r==='ecnField'){el.oninput=()=>{S.ecnField=el.value;};}
    if(r==='ecnOld'){el.oninput=()=>{S.ecnOld=el.value;};}
    if(r==='ecnNew'){el.oninput=()=>{S.ecnNew=el.value;};}
    if(r==='ecnReason'){el.oninput=()=>{S.ecnReason=el.value;};}
  });
}

// ============================================================
// BOOT
// ============================================================
DB.init();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Eagle Eye ‚Äî Assembly Tree</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://d3js.org/d3.v7.min.js"></script>
<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box;}
:root{--bg:#0c1222;--bg2:#111827;--bg3:#1e293b;--border:#1e293b;--text:#e2e8f0;--text2:#94a3b8;--text3:#64748b;--text4:#475569;--blue:#60a5fa;--green:#10b981;--red:#ef4444;--yellow:#f59e0b;--purple:#8b5cf6;--cyan:#06b6d4;--pink:#ec4899;}
body{font-family:'Segoe UI','Noto Sans JP',system-ui,sans-serif;background:var(--bg);color:var(--text);height:100vh;overflow:hidden;}
button{cursor:pointer;font-family:inherit;border:none;outline:none;}
input,textarea,select{font-family:inherit;outline:none;}
::-webkit-scrollbar{width:6px;height:6px;}::-webkit-scrollbar-track{background:transparent;}::-webkit-scrollbar-thumb{background:var(--bg3);border-radius:3px;}

.app{display:flex;height:100vh;}
.sidebar{width:420px;border-right:1px solid var(--border);display:flex;flex-direction:column;flex-shrink:0;transition:width .2s;}
.main{flex:1;display:flex;flex-direction:column;overflow:hidden;}

.hdr{padding:10px 14px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px;}
.hdr h1{font-size:14px;font-weight:800;} .hdr h1 span{color:var(--blue);}
.hdr .tag-badge{font-size:9px;padding:2px 8px;border-radius:4px;background:#1e3a5f;color:#93c5fd;font-weight:700;font-family:monospace;}
.hdr .count{font-size:10px;color:var(--text4);margin-left:auto;}
.hdr .status{width:8px;height:8px;border-radius:50%;}

.tabs{padding:6px 14px;border-bottom:1px solid var(--border);display:flex;gap:3px;}
.tab{font-size:10px;padding:4px 12px;border-radius:5px;border:1px solid var(--border);background:transparent;color:var(--text4);flex:1;font-weight:400;transition:all .15s;}
.tab.active{border-color:var(--blue);background:#1e3a5f;color:#93c5fd;font-weight:700;}

.search-box{padding:6px 14px;border-bottom:1px solid var(--border);}
.search-box input{width:100%;padding:5px 10px;background:var(--bg3);border:1px solid #334155;border-radius:6px;color:var(--text);font-size:11px;}

.ecn-bar{padding:6px 14px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:5px;flex-wrap:wrap;}
.ecn-btn{font-size:10px;padding:3px 10px;border-radius:4px;font-weight:800;}
.ecn-brush{font-size:9px;padding:2px 7px;border-radius:4px;font-weight:700;}
.ecn-summary{padding:6px 14px;border-bottom:1px solid var(--border);font-size:10px;color:var(--yellow);background:rgba(69,26,3,0.13);}

.tree{flex:1;overflow-y:auto;}
.group-hdr{display:flex;align-items:center;gap:8px;padding:8px 14px;cursor:pointer;background:var(--bg2);user-select:none;}
.group-hdr .arrow{font-size:9px;color:var(--text4);transition:transform .15s;display:inline-block;}
.group-hdr .arrow.open{transform:rotate(90deg);}
.group-hdr .label{font-size:12px;font-weight:700;flex:1;}
.group-hdr .cnt{font-size:10px;color:var(--text4);}
.group-hdr .ecn-cnt{font-size:9px;font-weight:800;color:var(--yellow);background:#451a03;padding:1px 6px;border-radius:3px;}
.group-hdr .add-step-btn{font-size:9px;padding:2px 7px;border-radius:3px;border:1px solid transparent;background:transparent;color:var(--text4);opacity:0;transition:opacity .15s;}
.group-hdr:hover .add-step-btn{opacity:1;}
.group-hdr .add-step-btn:hover{border-color:var(--green);color:var(--green);}

.step-row{display:flex;align-items:center;gap:8px;padding:5px 10px 5px 24px;cursor:pointer;transition:all .1s;border-left:3px solid transparent;}
.step-row:hover{background:rgba(255,255,255,0.02);}
.step-row.selected{background:#172033;border-left-color:#3b82f6;}
.step-row .sid{font-family:monospace;font-size:11px;color:var(--text4);min-width:22px;}
.step-row .badge{font-size:8px;font-weight:800;padding:2px 5px;border-radius:3px;font-family:monospace;letter-spacing:0.5px;}
.badge-step{background:#064e3b;color:#6ee7b7;}.badge-prep{background:#312e81;color:#a5b4fc;}.badge-kanryo{background:#7f1d1d;color:#fca5a5;}.badge-note{background:#1e3a5f;color:#93c5fd;}
.step-row .slabel{font-size:11px;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.step-row .slabel.kanryo{color:var(--yellow);font-weight:800;}
.step-row .step-row-actions{opacity:0;display:flex;gap:1px;transition:opacity .15s;margin-left:2px;}
.step-row:hover .step-row-actions{opacity:1;}
.step-row .step-row-actions button{font-size:8px;padding:1px 4px;border-radius:3px;background:transparent;border:1px solid transparent;color:var(--text4);line-height:1;}
.step-row .step-row-actions button:hover{border-color:var(--text3);color:var(--text2);}
.tag{font-size:8px;padding:1px 4px;border-radius:3px;font-weight:700;}
.tag-p{background:#0c4a6e;color:#38bdf8;}.tag-f{background:#450a0a;color:#f87171;}
.ecn-mark{font-size:10px;font-weight:800;}

.detail{padding:16px;overflow-y:auto;flex:1;}
.detail-hdr{display:flex;align-items:flex-start;gap:10px;margin-bottom:12px;}
.detail-hdr .did{font-size:22px;font-weight:900;color:#334155;font-family:monospace;line-height:1;}
.detail-hdr .dinfo{flex:1;}.detail-hdr .dgrp{font-size:10px;font-weight:600;margin-bottom:2px;}.detail-hdr .dlabel{font-size:15px;font-weight:700;}
.section-title{font-size:10px;font-weight:800;letter-spacing:1px;margin-bottom:4px;display:flex;align-items:center;gap:6px;}

.item-row{display:flex;align-items:center;gap:6px;padding:5px 8px;font-size:11px;position:relative;border-radius:4px;margin-bottom:1px;}
.item-row:hover{background:rgba(255,255,255,0.03);}
.item-row:hover .row-actions{opacity:1;}
.item-row .dot{width:5px;height:5px;border-radius:50%;flex-shrink:0;}
.item-row .mono{font-family:monospace;min-width:150px;font-size:10px;}
.item-row .iqty{font-weight:600;min-width:24px;text-align:right;}
.row-actions{opacity:0;display:flex;gap:2px;transition:opacity .15s;}
.row-actions button{font-size:9px;padding:1px 5px;border-radius:3px;background:transparent;border:1px solid transparent;}
.row-actions .edit-btn{color:var(--blue);}.row-actions .edit-btn:hover{border-color:var(--blue);}
.row-actions .del-btn{color:var(--red);}.row-actions .del-btn:hover{border-color:var(--red);}
.row-actions .up-btn,.row-actions .dn-btn{color:var(--text4);font-size:8px;}.row-actions .up-btn:hover,.row-actions .dn-btn:hover{color:var(--text2);}
.fast-meta{display:flex;gap:14px;padding-left:11px;font-size:10px;margin-top:1px;}
.add-btn{font-size:9px;padding:2px 8px;border-radius:3px;border:1px dashed var(--border);background:transparent;color:var(--text4);cursor:pointer;margin-top:4px;}
.add-btn:hover{border-color:var(--text3);color:var(--text3);}

.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:100;}
.modal{background:var(--bg2);border:1px solid var(--border);border-radius:10px;padding:20px;width:460px;max-height:80vh;overflow-y:auto;}
.modal h3{font-size:14px;font-weight:700;margin-bottom:14px;color:var(--blue);}
.form-row{margin-bottom:10px;}.form-row label{display:block;font-size:10px;color:var(--text3);margin-bottom:3px;font-weight:600;letter-spacing:0.5px;}
.form-row input,.form-row select{width:100%;padding:6px 10px;background:var(--bg);border:1px solid #334155;border-radius:6px;color:var(--text);font-size:12px;}
.form-actions{display:flex;gap:8px;margin-top:16px;}
.btn-primary{padding:6px 16px;border-radius:6px;background:var(--blue);color:#fff;font-size:11px;font-weight:700;}
.btn-ghost{padding:6px 16px;border-radius:6px;background:transparent;border:1px solid var(--border);color:var(--text3);font-size:11px;font-weight:600;}

.ctx-menu{position:fixed;background:var(--bg2);border:1px solid var(--border);border-radius:8px;padding:4px;z-index:200;min-width:180px;box-shadow:0 8px 32px rgba(0,0,0,0.6);}
.ctx-item{padding:6px 12px;font-size:11px;color:var(--text2);border-radius:4px;cursor:pointer;display:flex;align-items:center;gap:8px;}
.ctx-item:hover{background:rgba(255,255,255,0.05);color:var(--text);}
.ctx-item.danger{color:var(--red);}
.ctx-sep{height:1px;background:var(--border);margin:4px 0;}

.kanban{display:flex;gap:8px;padding:12px;flex:1;overflow-x:auto;background:#060c18;}
.kan-col{min-width:190px;max-width:220px;flex-shrink:0;display:flex;flex-direction:column;}
.kan-hdr{padding:8px 10px;border-radius:8px 8px 0 0;margin-bottom:6px;}
.kan-cards{display:flex;flex-direction:column;gap:4px;flex:1;overflow-y:auto;}
.kan-card{padding:8px 10px;background:var(--bg2);border:1px solid var(--border);border-radius:6px;cursor:pointer;transition:all .15s;position:relative;}
.kan-card:hover{border-color:var(--text3);}.kan-card.selected{border-color:var(--blue);}

.empty{display:flex;align-items:center;justify-content:center;height:100%;flex-direction:column;gap:10px;}
.empty .big{font-size:48px;opacity:0.15;}.empty .msg{font-size:13px;color:#334155;text-align:center;line-height:1.8;}
.step-actions{display:flex;gap:4px;margin-top:8px;margin-bottom:12px;flex-wrap:wrap;}
.step-actions button{font-size:9px;padding:3px 10px;border-radius:4px;border:1px solid var(--border);background:transparent;color:var(--text3);font-weight:600;}
.step-actions button:hover{border-color:var(--text2);color:var(--text2);}
.step-actions button.danger:hover{border-color:var(--red);color:var(--red);}
.loading-bar{height:2px;background:linear-gradient(90deg,transparent,var(--blue),transparent);animation:slide 1s infinite;}
@keyframes slide{0%{transform:translateX(-100%)}100%{transform:translateX(100%)}}
.toast{position:fixed;bottom:20px;right:20px;padding:8px 16px;border-radius:6px;font-size:11px;font-weight:600;z-index:300;animation:fadeIn .2s;}
@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}

.graph-container{flex:1;overflow:hidden;background:#fafbfc;position:relative;}
.graph-container svg{width:100%;height:100%;}
.graph-container .zoom-controls{position:absolute;bottom:14px;right:14px;display:flex;flex-direction:column;gap:3px;z-index:10;}
.graph-container .zoom-controls button{width:32px;height:32px;border-radius:6px;background:#fff;border:1px solid #d1d5db;color:#374151;font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:0 1px 3px rgba(0,0,0,0.08);}
.graph-container .zoom-controls button:hover{background:#f3f4f6;color:#111827;}
.graph-container .graph-legend{position:absolute;top:10px;left:10px;display:flex;gap:10px;padding:6px 14px;background:rgba(255,255,255,0.92);border:1px solid #e5e7eb;border-radius:8px;box-shadow:0 1px 4px rgba(0,0,0,0.06);flex-wrap:wrap;}
.graph-container .legend-item{display:flex;align-items:center;gap:4px;font-size:10px;color:#6b7280;font-weight:500;}
.graph-container .legend-swatch{width:14px;height:10px;border-radius:3px;border:1px solid rgba(0,0,0,0.12);}
.node-shape{transition:opacity .15s;cursor:pointer;}
.node-label{font-family:'Segoe UI',system-ui,sans-serif;pointer-events:none;user-select:none;}
.link-label{font-family:'Segoe UI',system-ui,sans-serif;pointer-events:none;user-select:none;}
.link{fill:none;transition:stroke-width .15s;}
.link:hover{stroke-width:3 !important;}
.node-group:hover .node-shape{opacity:0.85;}
.node-group.selected .node-shape{stroke-width:2.5 !important;filter:drop-shadow(0 0 4px rgba(59,130,246,0.4));}
.graph-container .level-header{font-size:13px;font-weight:700;fill:#3b82f6;text-anchor:middle;letter-spacing:0.5px;}
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const {useState,useEffect,useCallback,useRef,createContext,useContext} = React;

// ‚ïê‚ïê‚ïê SUPABASE ‚ïê‚ïê‚ïê
const SUPA_URL='https://wylxvmkcrexwfpjpbhyy.supabase.co';
const SUPA_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind5bHh2bWtjcmV4d2ZwanBiaHl5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg2MzkxMDYsImV4cCI6MjA4NDIxNTEwNn0.6Bxo42hx4jwlJGWnfjiTpiDUsYfc1QLTN3YtrU1efak';
const sb=supabase.createClient(SUPA_URL,SUPA_KEY);

// Table names
const T={
  assy:'eagle_eye_app_assemblies',
  grp:'eagle_eye_app_groups',
  step:'eagle_eye_app_steps',
  part:'eagle_eye_app_parts',
  fast:'eagle_eye_app_fasteners',
  ecn:'eagle_eye_app_ecn_log',
  master:'master_parts_list_all'
};

// ‚ïê‚ïê‚ïê LEVEL STYLING (Logi Assembly style) ‚ïê‚ïê‚ïê
const LEVEL_COLORS=['#b3e5fc','#e1bee7','#b3e5fc','#c8e6c9','#fff9c4','#ffe0b2','#ffcdd2','#e8e8e8'];
const LEVEL_SHAPES=['hexagon','rounded_rectangle','hexagon','rounded_rectangle','octagon','stadium','rectangle','rounded_rectangle'];
const STATUS_DOTS={DONE:'#27ae60',IN_PROGRESS:'#f39c12',BLOCKED:'#e74c3c',NOT_STARTED:'#95a5a6'};
const FASTENER_LINK_COLORS={CBE:'#3498db',CBST:'#9b59b6',CSH:'#27ae60',MS:'#e67e22',BSB:'#e74c3c',default:'#555'};

function darkenColor(hex,pct){
  let r=parseInt(hex.slice(1,3),16),g=parseInt(hex.slice(3,5),16),b=parseInt(hex.slice(5,7),16);
  r=Math.floor(r*(1-pct/100));g=Math.floor(g*(1-pct/100));b=Math.floor(b*(1-pct/100));
  return '#'+[r,g,b].map(c=>c.toString(16).padStart(2,'0')).join('');
}
function lightenColor(hex,pct){
  let r=parseInt(hex.slice(1,3),16),g=parseInt(hex.slice(3,5),16),b=parseInt(hex.slice(5,7),16);
  r=Math.min(255,Math.floor(r+(255-r)*pct/100));g=Math.min(255,Math.floor(g+(255-g)*pct/100));b=Math.min(255,Math.floor(b+(255-b)*pct/100));
  return '#'+[r,g,b].map(c=>c.toString(16).padStart(2,'0')).join('');
}
function getFastenerLinkColor(pn){
  if(!pn)return FASTENER_LINK_COLORS.default;
  const p=pn.toUpperCase();
  for(const[k,v]of Object.entries(FASTENER_LINK_COLORS)){if(k!=='default'&&p.startsWith(k))return v;}
  return FASTENER_LINK_COLORS.default;
}
function shapePath(type,w,h){
  const hw=w/2,hh=h/2;
  switch(type){
    case 'stadium': return `M${-hw+hh},${-hh}L${hw-hh},${-hh}A${hh},${hh} 0 0,1 ${hw-hh},${hh}L${-hw+hh},${hh}A${hh},${hh} 0 0,1 ${-hw+hh},${-hh}Z`;
    case 'hexagon':{const s=12;return `M${-hw+s},${-hh}L${hw-s},${-hh}L${hw},0L${hw-s},${hh}L${-hw+s},${hh}L${-hw},0Z`;}
    case 'octagon':{const c=Math.min(hw,hh)*0.38;return `M${-hw+c},${-hh}L${hw-c},${-hh}L${hw},${-hh+c}L${hw},${hh-c}L${hw-c},${hh}L${-hw+c},${hh}L${-hw},${hh-c}L${-hw},${-hh+c}Z`;}
    case 'diamond': return `M0,${-hh}L${hw},0L0,${hh}L${-hw},0Z`;
    case 'pentagon':{const a=(2*Math.PI)/5,sa=-Math.PI/2,rx=hw*0.9,ry=hh*0.9;const pts=Array.from({length:5},(_,i)=>`${rx*Math.cos(sa+i*a)},${ry*Math.sin(sa+i*a)}`);return 'M'+pts.join('L')+'Z';}
    default: return `M${-hw+6},${-hh}L${hw-6},${-hh}Q${hw},${-hh} ${hw},${-hh+6}L${hw},${hh-6}Q${hw},${hh} ${hw-6},${hh}L${-hw+6},${hh}Q${-hw},${hh} ${-hw},${hh-6}L${-hw},${-hh+6}Q${-hw},${-hh} ${-hw+6},${-hh}Z`;
  }
}

// ‚ïê‚ïê‚ïê DATA CONTEXT ‚ïê‚ïê‚ïê
const DataCtx=createContext({});

function useData(){return useContext(DataCtx);}

function DataProvider({children}){
  const [assy,setAssy]=useState(null);
  const [groups,setGroups]=useState([]);
  const [steps,setSteps]=useState([]);
  const [parts,setParts]=useState([]);
  const [fasts,setFasts]=useState([]);
  const [masterMap,setMasterMap]=useState({});
  const [loading,setLoading]=useState(true);
  const [error,setError]=useState(null);
  const [toast,setToast]=useState(null);

  const showToast=(msg,type='ok')=>{setToast({msg,type});setTimeout(()=>setToast(null),2000);};

  // Load all data for HBD_assy
  const loadAll=useCallback(async()=>{
    try{
      // Load master parts (shared table)
      const {data:mp}=await sb.from(T.master).select('pn,name,location');
      const mm={};
      (mp||[]).forEach(p=>{mm[p.pn]={name:p.name,location:p.location};});
      setMasterMap(mm);

      const {data:a,error:ae}=await sb.from(T.assy).select('*').eq('tag','HBD_assy').single();
      if(ae){setError('Assemblies query failed: '+ae.message+' (code: '+ae.code+', details: '+ae.details+')');setLoading(false);return;}
      if(!a){setError('Assembly HBD_assy not found. Run the SQL setup first.');setLoading(false);return;}
      setAssy(a);
      const {data:g}=await sb.from(T.grp).select('*').eq('assembly_id',a.id).order('sort_order');
      setGroups(g||[]);
      const gids=(g||[]).map(x=>x.id);
      if(gids.length){
        const {data:s}=await sb.from(T.step).select('*').in('group_id',gids).order('sort_order');
        setSteps(s||[]);
        const sids=(s||[]).map(x=>x.id);
        if(sids.length){
          const {data:p}=await sb.from(T.part).select('*').in('step_id',sids).order('sort_order');
          setParts(p||[]);
          const {data:f}=await sb.from(T.fast).select('*').in('step_id',sids).order('sort_order');
          setFasts(f||[]);
        }
      }
      setLoading(false);
    }catch(e){setError(e.message);setLoading(false);}
  },[]);

  useEffect(()=>{loadAll();},[loadAll]);

  // ‚ïê‚ïê‚ïê CRUD helpers ‚ïê‚ïê‚ïê
  const refresh=async()=>{await loadAll();};

  const addStep=async(groupId,label,type)=>{
    const maxSort=Math.max(0,...steps.filter(s=>s.group_id===groupId).map(s=>s.sort_order||0))+1;
    const {error:e}=await sb.from(T.step).insert({group_id:groupId,label,type,sort_order:maxSort});
    if(e){showToast(e.message,'err');return;}
    showToast('Step added');await refresh();
  };

  const updateStep=async(id,fields)=>{
    const {error:e}=await sb.from(T.step).update(fields).eq('id',id);
    if(e){showToast(e.message,'err');return;}
    showToast('Step updated');await refresh();
  };

  const deleteStep=async(id)=>{
    await sb.from(T.part).delete().eq('step_id',id);
    await sb.from(T.fast).delete().eq('step_id',id);
    const {error:e}=await sb.from(T.step).delete().eq('id',id);
    if(e){showToast(e.message,'err');return;}
    showToast('Step deleted');await refresh();
  };

  const moveStep=async(step,newGroupId)=>{
    const maxSort=Math.max(0,...steps.filter(s=>s.group_id===newGroupId).map(s=>s.sort_order||0))+1;
    await sb.from(T.step).update({group_id:newGroupId,sort_order:maxSort}).eq('id',step.id);
    showToast('Step moved');await refresh();
  };

  const swapSteps=async(step,dir)=>{
    const sibs=steps.filter(s=>s.group_id===step.group_id).sort((a,b)=>(a.sort_order||0)-(b.sort_order||0));
    const idx=sibs.findIndex(s=>s.id===step.id);
    const si=idx+dir;
    if(si<0||si>=sibs.length)return;
    const a=sibs[idx],b=sibs[si];
    await sb.from(T.step).update({sort_order:b.sort_order}).eq('id',a.id);
    await sb.from(T.step).update({sort_order:a.sort_order}).eq('id',b.id);
    await refresh();
  };

  const addPart=async(stepId,pn,qty)=>{
    const maxSort=Math.max(0,...parts.filter(p=>p.step_id===stepId).map(p=>p.sort_order||0))+1;
    const {error:e}=await sb.from(T.part).insert({step_id:stepId,pn,qty:Number(qty),sort_order:maxSort});
    if(e){showToast(e.message,'err');return;}
    showToast('Part added');await refresh();
  };

  const updatePart=async(id,fields)=>{
    const {error:e}=await sb.from(T.part).update(fields).eq('id',id);
    if(e){showToast(e.message,'err');return;}
    showToast('Part updated');await refresh();
  };

  const deletePart=async(id)=>{
    await sb.from(T.part).delete().eq('id',id);
    showToast('Part deleted');await refresh();
  };

  const swapParts=async(stepId,partId,dir)=>{
    const sibs=parts.filter(p=>p.step_id===stepId).sort((a,b)=>(a.sort_order||0)-(b.sort_order||0));
    const idx=sibs.findIndex(p=>p.id===partId);const si=idx+dir;
    if(si<0||si>=sibs.length)return;
    await sb.from(T.part).update({sort_order:sibs[si].sort_order}).eq('id',sibs[idx].id);
    await sb.from(T.part).update({sort_order:sibs[idx].sort_order}).eq('id',sibs[si].id);
    await refresh();
  };

  const addFast=async(stepId,pn,qty,loctite,torque)=>{
    const maxSort=Math.max(0,...fasts.filter(f=>f.step_id===stepId).map(f=>f.sort_order||0))+1;
    const {error:e}=await sb.from(T.fast).insert({step_id:stepId,pn,qty:Number(qty),loctite,torque,sort_order:maxSort});
    if(e){showToast(e.message,'err');return;}
    showToast('Fastener added');await refresh();
  };

  const updateFast=async(id,fields)=>{
    const {error:e}=await sb.from(T.fast).update(fields).eq('id',id);
    if(e){showToast(e.message,'err');return;}
    showToast('Fastener updated');await refresh();
  };

  const deleteFast=async(id)=>{
    await sb.from(T.fast).delete().eq('id',id);
    showToast('Fastener deleted');await refresh();
  };

  const swapFasts=async(stepId,fastId,dir)=>{
    const sibs=fasts.filter(f=>f.step_id===stepId).sort((a,b)=>(a.sort_order||0)-(b.sort_order||0));
    const idx=sibs.findIndex(f=>f.id===fastId);const si=idx+dir;
    if(si<0||si>=sibs.length)return;
    await sb.from(T.fast).update({sort_order:sibs[si].sort_order}).eq('id',sibs[idx].id);
    await sb.from(T.fast).update({sort_order:sibs[idx].sort_order}).eq('id',sibs[si].id);
    await refresh();
  };

  // Lookup helper: pn ‚Üí {name, location}
  const lookup=useCallback((pn)=>masterMap[pn]||{name:null,location:null},[masterMap]);

  const val={assy,groups,steps,parts,fasts,loading,error,toast,masterMap,lookup,
    addStep,updateStep,deleteStep,moveStep,swapSteps,
    addPart,updatePart,deletePart,swapParts,
    addFast,updateFast,deleteFast,swapFasts,
    refresh};

  return <DataCtx.Provider value={val}>{children}</DataCtx.Provider>;
}

// ‚ïê‚ïê‚ïê HELPERS ‚ïê‚ïê‚ïê
const ecnC={remove:'#ef4444',replace:'#f59e0b',add:'#10b981',modify:'#3b82f6'};
const ecnI={remove:'‚úï',replace:'‚Üª',add:'+',modify:'~'};
const ecnBg={remove:'rgba(239,68,68,0.08)',replace:'rgba(245,158,11,0.08)',add:'rgba(16,185,129,0.08)',modify:'rgba(59,130,246,0.08)'};
const bC={step:'badge-step',prep:'badge-prep',kanryo:'badge-kanryo',note:'badge-note'};
const bT={step:'STEP',prep:'PREP',kanryo:'ÂÆå‰∫Ü',note:'NOTE'};

// ‚ïê‚ïê‚ïê CONTEXT MENU ‚ïê‚ïê‚ïê
function CtxMenu({x,y,items,onClose}){
  const ref=useRef(null);
  const [pos,setPos]=useState({x,y});
  useEffect(()=>{const h=e=>{if(ref.current&&!ref.current.contains(e.target))onClose();};document.addEventListener('mousedown',h);return()=>document.removeEventListener('mousedown',h);},[onClose]);
  useEffect(()=>{if(ref.current){const r=ref.current.getBoundingClientRect();setPos({x:Math.max(0,r.right>window.innerWidth?x-r.width:x),y:Math.max(0,r.bottom>window.innerHeight?y-r.height:y)});}},[x,y]);
  return(<div ref={ref} className="ctx-menu" style={{left:pos.x,top:pos.y}}>
    {items.map((it,i)=>it.sep?<div key={i} className="ctx-sep"/>:
      <div key={i} className={'ctx-item'+(it.danger?' danger':'')} onClick={()=>{it.action();onClose();}}>
        <span style={{width:16,textAlign:'center',fontSize:12}}>{it.icon||''}</span>{it.label}
      </div>)}
  </div>);
}

// ‚ïê‚ïê‚ïê MODALS ‚ïê‚ïê‚ïê
function PartModal({mode,stepId,data,onClose}){
  const {addPart,updatePart}=useData();
  const [pn,setPn]=useState(data?.pn||'');const [qty,setQty]=useState(data?.qty||1);
  const save=async()=>{if(!pn)return;if(mode==='add')await addPart(stepId,pn,qty);else await updatePart(data.id,{pn,qty:Number(qty)});onClose();};
  return(<div className="modal-overlay" onClick={onClose}><div className="modal" onClick={e=>e.stopPropagation()}>
    <h3>{mode==='add'?'Add Part':'Edit Part'}</h3>
    <div className="form-row"><label>P/N</label><input value={pn} onChange={e=>setPn(e.target.value)} placeholder="GPCP-0000000-0-0" autoFocus/></div>
    <div className="form-row"><label>Qty</label><input type="number" value={qty} onChange={e=>setQty(e.target.value)} min={1}/></div>
    <div className="form-actions"><button className="btn-primary" onClick={save}>{mode==='add'?'Add':'Save'}</button><button className="btn-ghost" onClick={onClose}>Cancel</button></div>
  </div></div>);
}

function FastModal({mode,stepId,data,onClose}){
  const {addFast,updateFast}=useData();
  const [pn,setPn]=useState(data?.pn||'');const [qty,setQty]=useState(data?.qty||1);const [lt,setLt]=useState(data?.loctite||'222');const [tq,setTq]=useState(data?.torque||'');
  const save=async()=>{if(!pn)return;if(mode==='add')await addFast(stepId,pn,qty,lt,tq);else await updateFast(data.id,{pn,qty:Number(qty),loctite:lt,torque:tq});onClose();};
  return(<div className="modal-overlay" onClick={onClose}><div className="modal" onClick={e=>e.stopPropagation()}>
    <h3>{mode==='add'?'Add Fastener':'Edit Fastener'}</h3>
    <div className="form-row"><label>P/N</label><input value={pn} onChange={e=>setPn(e.target.value)} placeholder="GPCP-0000000-0-0" autoFocus/></div>
    <div className="form-row"><label>Qty</label><input type="number" value={qty} onChange={e=>setQty(e.target.value)} min={1}/></div>
    <div className="form-row"><label>Loctite</label><select value={lt} onChange={e=>setLt(e.target.value)}><option value="222">222</option><option value="243">243</option><option value="425">425</option><option value="648">648</option><option value="---">---</option></select></div>
    <div className="form-row"><label>Torque</label><input value={tq} onChange={e=>setTq(e.target.value)} placeholder="1.14 Nm"/></div>
    <div className="form-actions"><button className="btn-primary" onClick={save}>{mode==='add'?'Add':'Save'}</button><button className="btn-ghost" onClick={onClose}>Cancel</button></div>
  </div></div>);
}

function StepModal({mode,groupId,data,onClose}){
  const {groups,addStep,updateStep,moveStep:mv}=useData();
  const [label,setLabel]=useState(data?.label||'');const [type,setType]=useState(data?.type||'step');const [gid,setGid]=useState(data?.group_id||groupId);
  const save=async()=>{if(!label)return;if(mode==='add')await addStep(gid,label,type);else{await updateStep(data.id,{label,type});if(data.group_id!==gid)await mv(data,gid);}onClose();};
  return(<div className="modal-overlay" onClick={onClose}><div className="modal" onClick={e=>e.stopPropagation()}>
    <h3>{mode==='add'?'Add Step':'Edit Step'}</h3>
    <div className="form-row"><label>Label</label><input value={label} onChange={e=>setLabel(e.target.value)} placeholder="Step name" autoFocus/></div>
    <div className="form-row"><label>Type</label><select value={type} onChange={e=>setType(e.target.value)}><option value="step">Step</option><option value="prep">Prep</option><option value="kanryo">ÂÆå‰∫Ü</option><option value="note">Note</option></select></div>
    <div className="form-row"><label>Group</label><select value={gid} onChange={e=>setGid(Number(e.target.value))}>{groups.map(g=><option key={g.id} value={g.id}>{g.icon} {g.label}</option>)}</select></div>
    <div className="form-actions"><button className="btn-primary" onClick={save}>{mode==='add'?'Add':'Save'}</button><button className="btn-ghost" onClick={onClose}>Cancel</button></div>
  </div></div>);
}

function MoveModal({stepData,onClose}){
  const {groups,moveStep}=useData();
  const [gid,setGid]=useState(stepData.group_id);
  const move=async()=>{if(gid===stepData.group_id){onClose();return;}await moveStep(stepData,gid);onClose();};
  return(<div className="modal-overlay" onClick={onClose}><div className="modal" onClick={e=>e.stopPropagation()}>
    <h3>Move "{stepData.label}"</h3>
    <div className="form-row"><label>Move to group</label><select value={gid} onChange={e=>setGid(Number(e.target.value))}>{groups.map(g=><option key={g.id} value={g.id}>{g.icon} {g.label}</option>)}</select></div>
    <div className="form-actions"><button className="btn-primary" onClick={move}>Move</button><button className="btn-ghost" onClick={onClose}>Cancel</button></div>
  </div></div>);
}

// ‚ïê‚ïê‚ïê DETAIL PANEL ‚ïê‚ïê‚ïê
function DetailPanel({stepId,ecnChanges}){
  const {groups,steps,parts,fasts,deleteStep,swapParts,deletePart,swapFasts,deleteFast,lookup}=useData();
  const [modal,setModal]=useState(null);
  if(!stepId)return <div className="empty"><div className="big">üîß</div><div className="msg">Select a step to view details<br/>Right-click steps for more actions</div></div>;
  const s=steps.find(x=>x.id===stepId);
  if(!s)return <div className="empty"><div className="msg">Step not found</div></div>;
  const g=groups.find(x=>x.id===s.group_id);
  const sp=parts.filter(p=>p.step_id===stepId).sort((a,b)=>(a.sort_order||0)-(b.sort_order||0));
  const sf=fasts.filter(f=>f.step_id===stepId).sort((a,b)=>(a.sort_order||0)-(b.sort_order||0));
  const ecn=ecnChanges[stepId]||'none';

  return(<div className="detail">
    <div className="detail-hdr">
      <div className="did">{s.id}</div>
      <div className="dinfo">
        <div className="dgrp" style={{color:g?.color}}>‚Ü≥ {g?.label}</div>
        <div className="dlabel" style={{color:s.type==='kanryo'?'var(--yellow)':'var(--text)'}}>{s.label}</div>
      </div>
      {ecn!=='none'&&<span style={{padding:'3px 10px',borderRadius:5,background:ecnC[ecn]+'18',border:'1px solid '+ecnC[ecn],color:ecnC[ecn],fontSize:10,fontWeight:800,textTransform:'uppercase'}}>{ecn}</span>}
    </div>
    <div className="step-actions">
      <button onClick={()=>setModal({t:'editStep',d:s})}>‚úèÔ∏è Edit</button>
      <button onClick={()=>setModal({t:'moveStep',d:s})}>üì¶ Move</button>
      <button className="danger" onClick={()=>{if(confirm(`Delete "${s.label}"?`))deleteStep(s.id);}}>üóë Delete</button>
    </div>

    <div className="section-title" style={{color:'var(--green)'}}>PARTS ({sp.length})<button className="add-btn" onClick={()=>setModal({t:'addP',sid:stepId})}>+ Add</button></div>
    {sp.map((p,i)=>{const m=lookup(p.pn);return <div key={p.id}>
      <div className="item-row" style={{background:i%2?'#071a12':'transparent'}}>
        <div className="dot" style={{background:'var(--green)'}}/><span className="mono" style={{color:'#34d399'}}>{p.pn}</span><span className="iqty" style={{color:'#6ee7b7'}}>√ó{p.qty}</span>
        <div className="row-actions"><button className="up-btn" onClick={()=>swapParts(stepId,p.id,-1)}>‚ñ≤</button><button className="dn-btn" onClick={()=>swapParts(stepId,p.id,1)}>‚ñº</button><button className="edit-btn" onClick={()=>setModal({t:'editP',sid:stepId,d:p})}>‚úèÔ∏è</button><button className="del-btn" onClick={()=>{if(confirm('Delete?'))deletePart(p.id);}}>‚úï</button></div>
      </div>
      <div style={{paddingLeft:11,display:'flex',gap:12,fontSize:10,marginTop:1}}>
        {m.name&&<span style={{color:'#86efac'}}>{m.name}</span>}
        {m.location&&<span style={{color:'var(--text4)'}}>üìç {m.location}</span>}
        {!m.name&&<span style={{color:'#475569',fontStyle:'italic'}}>not in master DB</span>}
      </div>
    </div>;})}

    <div className="section-title" style={{color:'var(--red)',marginTop:16}}>FASTENERS ({sf.length})<button className="add-btn" onClick={()=>setModal({t:'addF',sid:stepId})}>+ Add</button></div>
    {sf.map((f,i)=>{const m=lookup(f.pn);return <div key={f.id}>
      <div className="item-row" style={{background:i%2?'#1a0505':'transparent'}}>
        <div className="dot" style={{background:'var(--red)'}}/><span className="mono" style={{color:'#fca5a5'}}>{f.pn}</span><span className="iqty" style={{color:'#f87171'}}>√ó{f.qty}</span>
        <div className="row-actions"><button className="up-btn" onClick={()=>swapFasts(stepId,f.id,-1)}>‚ñ≤</button><button className="dn-btn" onClick={()=>swapFasts(stepId,f.id,1)}>‚ñº</button><button className="edit-btn" onClick={()=>setModal({t:'editF',sid:stepId,d:f})}>‚úèÔ∏è</button><button className="del-btn" onClick={()=>{if(confirm('Delete?'))deleteFast(f.id);}}>‚úï</button></div>
      </div>
      <div style={{paddingLeft:11,display:'flex',gap:12,fontSize:10,marginTop:1}}>
        {m.name&&<span style={{color:'#fecaca'}}>{m.name}</span>}
        {m.location&&<span style={{color:'var(--text4)'}}>üìç {m.location}</span>}
        {!m.name&&<span style={{color:'#475569',fontStyle:'italic'}}>not in master DB</span>}
      </div>
      <div className="fast-meta"><span><span style={{color:'var(--text4)'}}>LT </span><span style={{color:f.loctite==='---'?'var(--text4)':'var(--yellow)',fontWeight:700}}>{f.loctite}</span></span><span><span style={{color:'var(--text4)'}}>TQ </span><span style={{color:!f.torque||f.torque==='---'?'var(--text4)':'var(--blue)',fontWeight:700}}>{f.torque||'‚Äî'}</span></span></div>
    </div>;})}

    {modal?.t==='addP'&&<PartModal mode="add" stepId={modal.sid} onClose={()=>setModal(null)}/>}
    {modal?.t==='editP'&&<PartModal mode="edit" stepId={modal.sid} data={modal.d} onClose={()=>setModal(null)}/>}
    {modal?.t==='addF'&&<FastModal mode="add" stepId={modal.sid} onClose={()=>setModal(null)}/>}
    {modal?.t==='editF'&&<FastModal mode="edit" stepId={modal.sid} data={modal.d} onClose={()=>setModal(null)}/>}
    {modal?.t==='editStep'&&<StepModal mode="edit" data={modal.d} onClose={()=>setModal(null)}/>}
    {modal?.t==='moveStep'&&<MoveModal stepData={modal.d} onClose={()=>setModal(null)}/>}
  </div>);
}

// ‚ïê‚ïê‚ïê LIST VIEW ‚ïê‚ïê‚ïê
function ListView({selected,setSelected,ecnOn,brush,ecnChanges,setEcnChanges,search}){
  const {groups,steps,parts,fasts,swapSteps,deleteStep,lookup}=useData();
  const [exp,setExp]=useState(new Set());
  const [ctx,setCtx]=useState(null);
  const [modal,setModal]=useState(null);

  useEffect(()=>{setExp(new Set(groups.map(g=>g.id)));},[groups]);

  const toggle=id=>setExp(p=>{const n=new Set(p);n.has(id)?n.delete(id):n.add(id);return n;});
  const click=id=>{if(ecnOn){setEcnChanges(p=>{const n={...p};n[id]===brush?delete n[id]:(n[id]=brush);return n;});}else setSelected(selected===id?null:id);};

  const searchLower=search?.toLowerCase()||'';
  const matchStep=s=>{
    if(!searchLower)return true;
    if(s.label.toLowerCase().includes(searchLower))return true;
    if(parts.some(p=>p.step_id===s.id&&(p.pn.toLowerCase().includes(searchLower)||(lookup(p.pn).name||'').toLowerCase().includes(searchLower))))return true;
    if(fasts.some(f=>f.step_id===s.id&&(f.pn.toLowerCase().includes(searchLower)||(lookup(f.pn).name||'').toLowerCase().includes(searchLower))))return true;
    return false;
  };

  return(<div className="tree">
    {groups.map(g=>{
      const gSteps=steps.filter(s=>s.group_id===g.id).sort((a,b)=>(a.sort_order||0)-(b.sort_order||0));
      const open=exp.has(g.id);const gEcn=gSteps.filter(s=>ecnChanges[s.id]).length;
      return(<div key={g.id}>
        <div className="group-hdr" onClick={()=>toggle(g.id)} style={{borderLeft:'3px solid '+g.color}}>
          <span className={'arrow'+(open?' open':'')}>‚ñ∂</span><span style={{fontSize:12}}>{g.icon}</span><span className="label" style={{color:g.color}}>{g.label}</span>
          <button className="add-step-btn" onClick={e=>{e.stopPropagation();setModal({t:'addStep',gid:g.id});}}>+ step</button>
          <span className="cnt">{gSteps.length}</span>{gEcn>0&&<span className="ecn-cnt">{gEcn}</span>}
        </div>
        {open&&gSteps.map(s=>{
          const e=ecnChanges[s.id];const sel=selected===s.id;const vis=matchStep(s);
          const pc=parts.filter(p=>p.step_id===s.id).length;
          const fc=fasts.filter(f=>f.step_id===s.id).length;
          return(<div key={s.id} className={'step-row'+(sel?' selected':'')} onClick={()=>click(s.id)} onContextMenu={ev=>{ev.preventDefault();setCtx({x:ev.clientX,y:ev.clientY,s});}}
            style={{background:e?ecnBg[e]:undefined,borderLeftColor:e?ecnC[e]:undefined,opacity:vis?1:0.2}}>
            <span className="sid">{s.id}</span><span className={'badge '+(bC[s.type]||'badge-step')}>{bT[s.type]||'STEP'}</span>
            <span className={'slabel'+(s.type==='kanryo'?' kanryo':'')} title={s.label}>{s.label}</span>
            {pc>0&&<span className="tag tag-p">{pc}P</span>}{fc>0&&<span className="tag tag-f">{fc}F</span>}
            {e&&<span className="ecn-mark" style={{color:ecnC[e]}}>{ecnI[e]}</span>}
            <div className="step-row-actions">
              <button onClick={ev=>{ev.stopPropagation();swapSteps(s,-1);}} title="Move up">‚ñ≤</button>
              <button onClick={ev=>{ev.stopPropagation();swapSteps(s,1);}} title="Move down">‚ñº</button>
            </div>
          </div>);
        })}
      </div>);
    })}
    {ctx&&<CtxMenu x={ctx.x} y={ctx.y} onClose={()=>setCtx(null)} items={[
      {icon:'‚úèÔ∏è',label:'Edit step',action:()=>setModal({t:'editStep',d:ctx.s})},
      {icon:'üì¶',label:'Move to group...',action:()=>setModal({t:'moveStep',d:ctx.s})},
      {sep:true},{icon:'‚ñ≤',label:'Move up',action:()=>swapSteps(ctx.s,-1)},{icon:'‚ñº',label:'Move down',action:()=>swapSteps(ctx.s,1)},
      {sep:true},{icon:'üóë',label:'Delete step',action:()=>{if(confirm(`Delete "${ctx.s.label}"?`))deleteStep(ctx.s.id);},danger:true},
    ]}/>}
    {modal?.t==='addStep'&&<StepModal mode="add" groupId={modal.gid} onClose={()=>setModal(null)}/>}
    {modal?.t==='editStep'&&<StepModal mode="edit" data={modal.d} onClose={()=>setModal(null)}/>}
    {modal?.t==='moveStep'&&<MoveModal stepData={modal.d} onClose={()=>setModal(null)}/>}
  </div>);
}

// ‚ïê‚ïê‚ïê GRAPH VIEW ‚ïê‚ïê‚ïê
function GraphView({selected,setSelected,ecnOn,brush,ecnChanges,setEcnChanges}){
  const {groups,steps,parts,fasts,lookup}=useData();
  const containerRef=useRef(null);const svgRef=useRef(null);const zoomRef=useRef(null);

  const clickStep=useCallback(id=>{
    if(ecnOn){setEcnChanges(p=>{const n={...p};n[id]===brush?delete n[id]:(n[id]=brush);return n;});}
    else setSelected(selected===id?null:id);
  },[ecnOn,brush,selected,setEcnChanges,setSelected]);

  useEffect(()=>{
    if(!svgRef.current||!containerRef.current||groups.length===0||steps.length===0)return;

    const svg=d3.select(svgRef.current);svg.selectAll('*').remove();
    const W=containerRef.current.clientWidth,H=containerRef.current.clientHeight;
    svg.attr('width',W).attr('height',H);

    // Defs
    const defs=svg.append('defs');
    defs.append('marker').attr('id','arrow').attr('viewBox','0 0 10 10')
      .attr('refX',9).attr('refY',5).attr('orient','auto').attr('markerWidth',6).attr('markerHeight',6)
      .append('path').attr('d','M 0,1 L 8,5 L 0,9 z').attr('fill','#888');

    // Zoom group
    const g=svg.append('g').attr('class','zoom-group');
    const zoom=d3.zoom().scaleExtent([0.08,4]).on('zoom',e=>g.attr('transform',e.transform));
    svg.call(zoom);zoomRef.current={svg,zoom};

    // ‚ïê‚ïê‚ïê LAYOUT CALCULATION ‚ïê‚ïê‚ïê
    const sortedGroups=groups.slice().sort((a,b)=>(a.sort_order||0)-(b.sort_order||0));
    const colGap=300,partGap=180,nodeW=150,nodeH=36,partW=115,partH=26,rowGap=24,partRowGap=30;
    const topPad=70,leftPad=180;

    const nodes=[];const links=[];
    let globalMaxY=topPad;

    sortedGroups.forEach((grp,gi)=>{
      const gSteps=steps.filter(s=>s.group_id===grp.id).sort((a,b)=>(a.sort_order||0)-(b.sort_order||0));
      const levelX=leftPad+gi*colGap;
      const levelColor=grp.color||LEVEL_COLORS[gi%LEVEL_COLORS.length];
      const levelShape=LEVEL_SHAPES[gi%LEVEL_SHAPES.length];
      let curY=topPad;

      gSteps.forEach((step,si)=>{
        const sp=parts.filter(p=>p.step_id===step.id).sort((a,b)=>(a.sort_order||0)-(b.sort_order||0));
        const sf=fasts.filter(f=>f.step_id===step.id).sort((a,b)=>(a.sort_order||0)-(b.sort_order||0));
        const nParts=sp.length;
        const partsSpan=nParts>0?(nParts-1)*partRowGap:0;
        const blockH=Math.max(nodeH,partsSpan+partH);
        const stepY=curY+blockH/2;

        nodes.push({id:step.id,x:levelX,y:stepY,w:nodeW,h:nodeH,type:'step',shape:levelShape,
          color:levelColor,label:step.label,stepType:step.type,level:gi+1,
          groupLabel:grp.label,ecn:ecnChanges[step.id]||null,
          isSelected:selected===step.id,partCount:nParts,fastCount:sf.length});

        // Parts as leaf nodes to the left
        sp.forEach((p,pi)=>{
          const pY=stepY-partsSpan/2+pi*partRowGap;
          const pX=levelX-partGap;
          const m=lookup(p.pn);const pColor=lightenColor(levelColor,30);
          const pid='p_'+p.id;
          nodes.push({id:pid,x:pX,y:pY,w:partW,h:partH,type:'part',shape:'hexagon',
            color:pColor,label:m.name||p.pn,pn:p.pn,qty:p.qty,level:gi+1,isSelected:false});

          // Find fasteners for this step to annotate the link
          const matchFast=sf.length>0?sf[Math.min(pi,sf.length-1)]:null;
          links.push({source:pid,target:step.id,
            sx:pX+partW/2,sy:pY,tx:levelX-nodeW/2,ty:stepY,
            fastener:matchFast?matchFast.pn:null,loctite:matchFast?matchFast.loctite:null,
            torque:matchFast?matchFast.torque:null,qty:p.qty,
            linkColor:matchFast?getFastenerLinkColor(matchFast.pn):'#9ca3af'});
        });

        // Fasteners not matched to parts ‚Üí show as standalone right-side nodes
        if(sf.length>sp.length){
          sf.slice(sp.length).forEach((f,fi)=>{
            const fY=stepY+nodeH/2+10+(fi*22);
            const fid='f_'+f.id;
            nodes.push({id:fid,x:levelX+nodeW/2+8,y:fY,w:0,h:0,type:'fastLabel',
              label:`${f.pn} √ó${f.qty}`,loctite:f.loctite,torque:f.torque,color:getFastenerLinkColor(f.pn)});
          });
        }

        curY+=blockH+rowGap;
      });
      globalMaxY=Math.max(globalMaxY,curY);
    });

    // ‚ïê‚ïê‚ïê RENDER LEVEL HEADERS ‚ïê‚ïê‚ïê
    sortedGroups.forEach((grp,gi)=>{
      const x=leftPad+gi*colGap;
      g.append('rect').attr('x',x-58).attr('y',12).attr('width',116).attr('height',28)
        .attr('rx',6).attr('fill','#3b82f6').attr('opacity',0.88);
      g.append('text').attr('x',x).attr('y',31).attr('text-anchor','middle')
        .attr('fill','white').attr('font-size','12px').attr('font-weight','700')
        .text(`L${gi+1} ${grp.label.length>12?grp.label.slice(0,12)+'‚Ä¶':grp.label}`);
    });

    // ‚ïê‚ïê‚ïê RENDER LINKS ‚ïê‚ïê‚ïê
    links.forEach(lk=>{
      const midX=(lk.sx+lk.tx)/2;
      const pathD=`M${lk.sx},${lk.sy} C${midX},${lk.sy} ${midX},${lk.ty} ${lk.tx},${lk.ty}`;
      g.append('path').attr('class','link').attr('d',pathD)
        .attr('stroke',lk.linkColor).attr('stroke-width',1.5)
        .attr('marker-end','url(#arrow)');

      // Link labels (fastener, loctite, torque)
      const hasLabel=lk.fastener||lk.loctite;
      if(hasLabel){
        const lx=(lk.sx+lk.tx)/2,ly=(lk.sy+lk.ty)/2;
        const lines=[];
        if(lk.fastener){const t=lk.fastener+(lk.qty>1?' √ó'+lk.qty:'');lines.push({text:t,color:lk.linkColor,bold:true});}
        if(lk.loctite&&lk.loctite!=='---')lines.push({text:'LT-'+lk.loctite,color:'#9b59b6',bold:false});
        if(lk.torque&&lk.torque!=='---'&&lk.torque!=='‚Äî')lines.push({text:lk.torque,color:'#e67e22',bold:false});

        const lH=lines.length*12+6;const lW=Math.max(60,...lines.map(l=>l.text.length*5.5+14));
        g.append('rect').attr('x',lx-lW/2).attr('y',ly-lH/2).attr('width',lW).attr('height',lH)
          .attr('rx',3).attr('fill','white').attr('opacity',0.92).attr('stroke','#e5e7eb').attr('stroke-width',0.5);
        lines.forEach((ln,i)=>{
          const tY=ly-lH/2+10+i*12;
          g.append('text').attr('x',lx).attr('y',tY).attr('text-anchor','middle')
            .attr('fill',ln.color).attr('font-size','8.5px').attr('font-weight',ln.bold?'700':'400')
            .attr('class','link-label').text(ln.text);
        });
      }
    });

    // ‚ïê‚ïê‚ïê RENDER NODES ‚ïê‚ïê‚ïê
    const nodeGs=g.selectAll('.node-group').data(nodes.filter(n=>n.type==='step'||n.type==='part'),d=>d.id)
      .enter().append('g').attr('class',d=>'node-group'+(d.isSelected?' selected':''))
      .attr('transform',d=>`translate(${d.x},${d.y})`);

    // Draw shape
    nodeGs.append('path').attr('class','node-shape')
      .attr('d',d=>shapePath(d.shape,d.w,d.h))
      .attr('fill',d=>{
        if(d.ecn)return({remove:'#fdedec',replace:'#ebf5fb',add:'#d5f5e3',modify:'#fef9e7'}[d.ecn]||d.color);
        return d.color;
      })
      .attr('stroke',d=>{
        if(d.ecn)return ecnC[d.ecn]||darkenColor(d.color,30);
        if(d.isSelected)return '#3b82f6';
        return darkenColor(d.color,30);
      })
      .attr('stroke-width',d=>d.isSelected?2.5:1.5);

    // Status indicator dot
    nodeGs.filter(d=>d.type==='step').append('circle')
      .attr('cx',d=>-d.w/2+9).attr('cy',d=>-d.h/2+9).attr('r',4)
      .attr('fill',d=>d.stepType==='kanryo'?'#27ae60':'#95a5a6')
      .attr('stroke','white').attr('stroke-width',1.5);

    // ECN indicator
    nodeGs.filter(d=>d.ecn).append('text')
      .attr('x',d=>d.w/2-6).attr('y',4).attr('text-anchor','end')
      .attr('font-size','12px').attr('fill',d=>ecnC[d.ecn])
      .attr('font-weight','900').text(d=>ecnI[d.ecn]);

    // Node labels
    nodeGs.append('text').attr('class','node-label')
      .attr('text-anchor','middle').attr('y',d=>d.type==='part'?4:4)
      .attr('font-size',d=>d.type==='part'?'9px':'11px')
      .attr('font-weight',d=>d.type==='step'?'600':'400')
      .attr('fill',d=>d.type==='part'?'#374151':'#1f2937')
      .text(d=>{const max=d.type==='part'?16:20;return d.label.length>max?d.label.slice(0,max)+'‚Ä¶':d.label;});

    // Part quantity badge
    nodeGs.filter(d=>d.type==='part'&&d.qty>1).append('text')
      .attr('x',d=>d.w/2-4).attr('y',d=>-d.h/2+3)
      .attr('text-anchor','end').attr('font-size','8px').attr('font-weight','700')
      .attr('fill','#6b7280').text(d=>'√ó'+d.qty);

    // Sequence numbers (step index within group)
    const stepsByGroup={};
    nodes.filter(n=>n.type==='step').forEach(n=>{
      if(!stepsByGroup[n.level])stepsByGroup[n.level]=[];
      stepsByGroup[n.level].push(n.id);
    });
    nodeGs.filter(d=>d.type==='step').append('text')
      .attr('x',d=>d.w/2+8).attr('y',d=>-d.h/2+4)
      .attr('text-anchor','start').attr('font-size','14px').attr('font-weight','900')
      .attr('fill','#374151')
      .text(d=>{const arr=stepsByGroup[d.level]||[];const idx=arr.indexOf(d.id);return idx>=0?String(idx+1):'';});

    // Part/fast count badge on steps
    nodeGs.filter(d=>d.type==='step').append('text')
      .attr('x',0).attr('y',d=>d.h/2+12)
      .attr('text-anchor','middle').attr('font-size','7.5px').attr('fill','#9ca3af')
      .text(d=>{const tags=[];if(d.partCount)tags.push(d.partCount+'P');if(d.fastCount)tags.push(d.fastCount+'F');return tags.join(' ¬∑ ');});

    // Fastener label nodes (standalone, no shape)
    const fastLabels=g.selectAll('.fast-label').data(nodes.filter(n=>n.type==='fastLabel'))
      .enter().append('g').attr('transform',d=>`translate(${d.x},${d.y})`);
    fastLabels.append('text').attr('font-size','8px').attr('fill',d=>d.color).attr('font-weight','600').text(d=>d.label);
    fastLabels.filter(d=>d.loctite&&d.loctite!=='---').append('text')
      .attr('y',10).attr('font-size','7.5px').attr('fill','#9b59b6').text(d=>'LT-'+d.loctite);
    fastLabels.filter(d=>d.torque&&d.torque!=='---'&&d.torque!=='‚Äî').append('text')
      .attr('y',d=>(d.loctite&&d.loctite!=='---')?20:10).attr('font-size','7.5px').attr('fill','#e67e22').text(d=>d.torque);

    // Click handler for step nodes
    nodeGs.filter(d=>d.type==='step').style('cursor','pointer')
      .on('click',function(event,d){clickStep(d.id);});

    // ‚ïê‚ïê‚ïê FIT TO SCREEN ‚ïê‚ïê‚ïê
    let minX=Infinity,maxX=-Infinity,minY=Infinity,maxY=-Infinity;
    nodes.forEach(n=>{if(n.type==='fastLabel')return;minX=Math.min(minX,n.x-(n.w||60));maxX=Math.max(maxX,n.x+(n.w||60));minY=Math.min(minY,n.y-30);maxY=Math.max(maxY,n.y+30);});
    const cw=maxX-minX+100,ch=maxY-minY+100;
    const scale=Math.min(W/cw,H/ch,1.5)*0.88;
    const cx=(minX+maxX)/2,cy=(minY+maxY)/2;
    const tx=W/2-cx*scale,ty=H/2-cy*scale;
    svg.call(zoom.transform,d3.zoomIdentity.translate(tx,ty).scale(scale));

  },[groups,steps,parts,fasts,selected,ecnChanges,lookup,clickStep]);

  const zoomIn=()=>{if(zoomRef.current)zoomRef.current.svg.transition().duration(200).call(zoomRef.current.zoom.scaleBy,1.4);};
  const zoomOut=()=>{if(zoomRef.current)zoomRef.current.svg.transition().duration(200).call(zoomRef.current.zoom.scaleBy,0.7);};
  const fitScreen=()=>{if(zoomRef.current){
    const{svg:s,zoom:z}=zoomRef.current;const c=containerRef.current;
    const W=c.clientWidth,H=c.clientHeight;
    let minX=Infinity,maxX=-Infinity,minY=Infinity,maxY=-Infinity;
    d3.select(svgRef.current).selectAll('.node-group').each(function(d){
      minX=Math.min(minX,d.x-(d.w||60));maxX=Math.max(maxX,d.x+(d.w||60));
      minY=Math.min(minY,d.y-30);maxY=Math.max(maxY,d.y+30);});
    if(minX===Infinity)return;
    const cw=maxX-minX+100,ch=maxY-minY+100;
    const scale=Math.min(W/cw,H/ch,1.5)*0.88;
    const cx=(minX+maxX)/2,cy=(minY+maxY)/2;
    s.transition().duration(400).call(z.transform,d3.zoomIdentity.translate(W/2-cx*scale,H/2-cy*scale).scale(scale));
  }};

  return(<div ref={containerRef} className="graph-container">
    <svg ref={svgRef}/>
    <div className="zoom-controls">
      <button onClick={zoomIn} title="Zoom In">+</button>
      <button onClick={zoomOut} title="Zoom Out">‚àí</button>
      <button onClick={fitScreen} title="Fit to Screen">‚ä°</button>
    </div>
    {groups.length>0&&<div className="graph-legend">
      {groups.slice().sort((a,b)=>(a.sort_order||0)-(b.sort_order||0)).map((g,i)=>
        <div key={g.id} className="legend-item">
          <div className="legend-swatch" style={{background:g.color||LEVEL_COLORS[i%LEVEL_COLORS.length]}}/>
          <span>L{i+1}</span>
        </div>
      )}
    </div>}
  </div>);
}

// ‚ïê‚ïê‚ïê KANBAN VIEW ‚ïê‚ïê‚ïê
function KanbanView({selected,setSelected,ecnOn,brush,ecnChanges,setEcnChanges}){
  const {groups,steps,parts,fasts}=useData();
  const click=id=>{if(ecnOn){setEcnChanges(p=>{const n={...p};n[id]===brush?delete n[id]:(n[id]=brush);return n;});}else setSelected(selected===id?null:id);};
  return(<div className="kanban">{groups.map(g=>{
    const gSteps=steps.filter(s=>s.group_id===g.id).sort((a,b)=>(a.sort_order||0)-(b.sort_order||0));
    const gE=gSteps.filter(s=>ecnChanges[s.id]).length;
    return(<div key={g.id} className="kan-col">
      <div className="kan-hdr" style={{background:g.color+'15',borderBottom:'2px solid '+g.color}}>
        <div style={{display:'flex',alignItems:'center',gap:6}}><span style={{fontSize:12}}>{g.icon}</span><span style={{fontSize:11,fontWeight:800,color:g.color,flex:1}}>{g.label}</span>{gE>0&&<span style={{fontSize:9,fontWeight:800,color:'var(--yellow)',background:'#451a03',padding:'1px 6px',borderRadius:3}}>{gE}</span>}</div>
        <div style={{fontSize:10,color:'var(--text4)',marginTop:2}}>{gSteps.length} steps</div>
      </div>
      <div className="kan-cards">{gSteps.map(s=>{
        const e=ecnChanges[s.id];const sel=selected===s.id;
        const pc=parts.filter(p=>p.step_id===s.id).length;const fc=fasts.filter(f=>f.step_id===s.id).length;
        const lts=[...new Set(fasts.filter(f=>f.step_id===s.id&&f.loctite&&f.loctite!=='---').map(f=>f.loctite))];
        return(<div key={s.id} className={'kan-card'+(sel?' selected':'')} onClick={()=>click(s.id)} style={{background:e?ecnBg[e]:undefined,borderColor:e?ecnC[e]:sel?'var(--blue)':undefined}}>
          {e&&<div style={{position:'absolute',top:4,right:6,fontSize:12,fontWeight:900,color:ecnC[e]}}>{ecnI[e]}</div>}
          <div style={{fontSize:11,color:s.type==='kanryo'?'var(--yellow)':'var(--text)',fontWeight:s.type==='kanryo'?800:400,paddingRight:e?16:0,marginBottom:4}}>{s.label}</div>
          <div style={{display:'flex',gap:4,flexWrap:'wrap'}}>{pc>0&&<span className="tag tag-p">{pc}P</span>}{fc>0&&<span className="tag tag-f">{fc}F</span>}{lts.map((l,i)=><span key={i} style={{fontSize:8,color:'var(--yellow)'}}>LT-{l}</span>)}</div>
        </div>);
      })}</div>
    </div>);
  })}</div>);
}

// ‚ïê‚ïê‚ïê MAIN APP ‚ïê‚ïê‚ïê
function AppInner(){
  const {assy,loading,error,toast,steps,masterMap}=useData();
  const [view,setView]=useState('list');const [selected,setSelected]=useState(null);
  const [ecnOn,setEcnOn]=useState(false);const [brush,setBrush]=useState('remove');
  const [ecnChanges,setEcnChanges]=useState({});const [search,setSearch]=useState('');

  const ecnCount=Object.keys(ecnChanges).length;

  if(loading)return <div style={{display:'flex',alignItems:'center',justifyContent:'center',height:'100vh',flexDirection:'column',gap:12}}>
    <div style={{width:200}}><div className="loading-bar" style={{overflow:'hidden',borderRadius:2}}></div></div>
    <div style={{color:'var(--text3)',fontSize:12}}>Connecting to Eagle_eye_...</div>
  </div>;

  if(error)return <div style={{display:'flex',alignItems:'center',justifyContent:'center',height:'100vh',flexDirection:'column',gap:12,padding:40,textAlign:'center'}}>
    <div style={{fontSize:48,opacity:0.3}}>‚ö†Ô∏è</div>
    <div style={{color:'var(--red)',fontSize:14,fontWeight:700}}>Connection Error</div>
    <div style={{color:'var(--text3)',fontSize:12,maxWidth:400}}>{error}</div>
  </div>;

  return(<>
    <div className="app">
      <div className="sidebar" style={{width:view==='list'?420:320}}>
        <div className="hdr">
          <div className="status" style={{background:'var(--green)'}}/>
          <h1><span>Eagle Eye</span></h1>
          <span className="tag-badge">{assy?.tag}</span>
          <span className="count">{steps.length} steps ¬∑ {Object.keys(masterMap).length} master parts</span>
        </div>
        <div className="tabs">{[{v:'list',l:'üìã List'},{v:'graph',l:'üîó Graph'},{v:'kanban',l:'üìä Kanban'}].map(t=><button key={t.v} className={'tab'+(view===t.v?' active':'')} onClick={()=>setView(t.v)}>{t.l}</button>)}</div>
        <div className="search-box"><input value={search} onChange={e=>setSearch(e.target.value)} placeholder="Search P/N, part name, step..."/></div>
        <div className="ecn-bar">
          <button className="ecn-btn" onClick={()=>setEcnOn(!ecnOn)} style={{border:ecnOn?'1px solid var(--yellow)':'1px solid var(--text4)',background:ecnOn?'#451a03':'transparent',color:ecnOn?'var(--yellow)':'var(--text4)'}}>{ecnOn?'‚ö° ECN':'ECN'}</button>
          {ecnOn&&[{s:'remove',l:'Remove',c:'var(--red)'},{s:'replace',l:'Replace',c:'var(--yellow)'},{s:'add',l:'Add',c:'var(--green)'},{s:'modify',l:'Modify',c:'var(--blue)'}].map(b=><button key={b.s} className="ecn-brush" onClick={()=>setBrush(b.s)} style={{border:'1px solid '+(brush===b.s?b.c:'var(--border)'),background:brush===b.s?b.c+'18':'transparent',color:brush===b.s?b.c:'var(--text4)'}}>{b.l}</button>)}
          {ecnCount>0&&<button className="ecn-brush" onClick={()=>setEcnChanges({})} style={{border:'1px solid var(--border)',background:'transparent',color:'var(--text4)',marginLeft:'auto'}}>Clear</button>}
        </div>
        {ecnCount>0&&<div className="ecn-summary">‚ö° {ecnCount} steps affected</div>}
        {view==='list'?<ListView selected={selected} setSelected={setSelected} ecnOn={ecnOn} brush={brush} ecnChanges={ecnChanges} setEcnChanges={setEcnChanges} search={search}/>:<DetailPanel stepId={selected} ecnChanges={ecnChanges}/>}
      </div>
      <div className="main">
        {view==='list'&&<DetailPanel stepId={selected} ecnChanges={ecnChanges}/>}
        {view==='graph'&&<GraphView selected={selected} setSelected={setSelected} ecnOn={ecnOn} brush={brush} ecnChanges={ecnChanges} setEcnChanges={setEcnChanges}/>}
        {view==='kanban'&&<KanbanView selected={selected} setSelected={setSelected} ecnOn={ecnOn} brush={brush} ecnChanges={ecnChanges} setEcnChanges={setEcnChanges}/>}
      </div>
    </div>
    {toast&&<div className="toast" style={{background:toast.type==='err'?'var(--red)':'var(--green)',color:'#fff'}}>{toast.msg}</div>}
  </>);
}

function App(){
  return <DataProvider><AppInner/></DataProvider>;
}

ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EagleEye â€” Assembly Tracking</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700;800&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#0a0b0f;--card:#12131a;--card-hover:#1a1c24;--modal:#15161e;
  --border:#1e2030;--text:#d1d5e4;--muted:#6b7080;--dim:#3a3d4d;
  --accent:#f59e0b;--purple:#8b5cf6;
  --red:#ef4444;--green:#22c55e;--blue:#3b82f6;--orange:#f97316;--pink:#ec4899;--cyan:#06b6d4;
}
body{font-family:'DM Sans',system-ui,sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
::-webkit-scrollbar{width:4px}::-webkit-scrollbar-track{background:var(--bg)}::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px}
.mono{font-family:'JetBrains Mono',monospace}

/* ====== SHARED STYLES ====== */
.badge{padding:2px 7px;border-radius:8px;font-size:9px;font-weight:700;font-family:'JetBrains Mono',monospace;display:inline-block}
.btn-sm{padding:3px 10px;border-radius:6px;font-size:10px;font-weight:700;border:1px solid var(--border);cursor:pointer;font-family:'JetBrains Mono',monospace}
.inp{background:#0d0e14;border:1px solid var(--border);border-radius:6px;padding:5px 8px;color:var(--text);font-size:11px;font-family:'JetBrains Mono',monospace;outline:none}
.inp:focus{border-color:var(--accent)}

/* ====== PAGE SYSTEM ====== */
.page{display:none}.page.active{display:block}

/* ====== HOME PAGE ====== */
.home-wrap{min-height:100vh;display:flex;flex-direction:column;align-items:center}
.home-admin{position:fixed;top:12px;right:16px;display:flex;align-items:center;gap:8px;z-index:10}
.admin-pill{display:flex;align-items:center;gap:5px;padding:5px 12px;border-radius:8px;background:rgba(245,158,11,0.08);border:1px solid rgba(245,158,11,0.2);font-size:11px;font-weight:600;color:var(--accent);font-family:'JetBrains Mono',monospace}
.home-hero{text-align:center;padding-top:72px;margin-bottom:44px}
.home-logo{font-size:48px;font-weight:900;color:var(--accent);font-family:'JetBrains Mono',monospace;letter-spacing:-2px;line-height:1}
.home-logo .sym{font-size:42px;margin-right:4px}
.home-sub{font-size:14px;color:var(--muted);margin-top:10px;letter-spacing:0.3px}
.home-stats{display:flex;gap:16px;justify-content:center;margin-top:16px;font-size:12px;color:var(--muted);font-family:'JetBrains Mono',monospace}
.home-stats .num{font-weight:700}

/* Nav Cards */
.nav-cards{display:flex;gap:16px;margin-bottom:44px;flex-wrap:wrap;justify-content:center;padding:0 24px}
.nav-card{
  width:280px;padding:28px 24px;border-radius:16px;background:var(--card);
  cursor:pointer;transition:all 0.2s;
}
.nav-card:hover{transform:translateY(-4px)}
.nav-card .nc-icon{font-size:36px;margin-bottom:12px}
.nav-card .nc-title{font-size:18px;font-weight:700}
.nav-card .nc-desc{font-size:12px;color:var(--muted);margin-top:6px;line-height:1.5}
.nav-card .nc-tags{margin-top:14px;display:flex;gap:6px;flex-wrap:wrap}

/* Section labels */
.section-label{font-family:'JetBrains Mono',monospace;font-size:11px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--dim);margin-bottom:14px}

/* Assembly Cards */
.assy-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(190px,1fr));gap:10px;max-width:860px;width:100%;padding:0 24px 60px}
.assy-card{
  background:var(--card);border:1px solid var(--border);border-radius:12px;
  padding:16px 18px;cursor:pointer;transition:all 0.15s;
}
.assy-card:hover{transform:translateY(-2px)}
.assy-card .ac-top{display:flex;align-items:center;gap:8px;margin-bottom:8px}
.assy-card .ac-icon{font-size:22px}
.assy-card .ac-name{font-size:14px;font-weight:700}
.assy-card .ac-tags{display:flex;gap:5px;flex-wrap:wrap}
.full-robot-wrap{margin-bottom:40px;padding:0 24px;max-width:860px;width:100%}
.full-robot-card{
  background:var(--card);border:2px solid rgba(34,197,94,0.25);border-radius:14px;
  padding:20px;cursor:pointer;transition:all 0.2s;max-width:320px;
}
.full-robot-card:hover{border-color:var(--green);transform:translateY(-2px);box-shadow:0 8px 24px rgba(34,197,94,0.1)}

/* ====== UNIT SELECT PAGE ====== */
.us-header{display:flex;align-items:center;gap:12px;margin-bottom:20px}
.us-back{background:none;border:1px solid var(--border);border-radius:8px;padding:6px 14px;color:var(--muted);cursor:pointer;font-size:12px}
.us-back:hover{border-color:var(--muted);color:var(--text)}
.us-filters{display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap;align-items:center}
.us-filter{padding:5px 12px;border-radius:8px;font-size:11px;font-weight:600;cursor:pointer;border:1px solid var(--border);background:transparent;color:var(--muted);text-transform:capitalize}
.us-filter.active{border:none}
.us-filter[data-f="all"].active{background:rgba(245,158,11,0.15);color:var(--accent)}
.us-filter[data-f="outdated"].active{background:rgba(239,68,68,0.15);color:var(--red)}
.us-filter[data-f="current"].active{background:rgba(34,197,94,0.15);color:var(--green)}
.unit-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:5px;max-height:420px;overflow-y:auto;padding:2px}
.unit-card{padding:8px 10px;border-radius:8px;cursor:pointer;border:1px solid var(--border);background:var(--card);transition:all 0.1s;position:relative}
.unit-card.selected{border:2px solid var(--accent);background:rgba(245,158,11,0.03)}
.proceed-bar{margin-top:14px;padding:10px 16px;border-radius:12px;display:flex;align-items:center;justify-content:space-between}
.proceed-btn{padding:8px 22px;border-radius:10px;font-size:13px;font-weight:700;border:none;color:#000;cursor:pointer}

/* ====== ASSEMBLY VIEW PAGE ====== */
.av-header{display:flex;align-items:center;gap:10px;padding:8px 16px;border-bottom:1px solid var(--border);background:#0e0f15;position:sticky;top:0;z-index:10;flex-wrap:wrap}
.av-tabs{display:flex;align-items:center;gap:0;padding:0 16px;border-bottom:1px solid var(--border);background:#0e0f15}
.av-tab{display:flex;align-items:center;gap:5px;padding:9px 16px;font-size:12px;font-weight:500;color:var(--muted);background:transparent;border:none;cursor:pointer;border-bottom:2px solid transparent}
.av-tab.active{font-weight:700;color:var(--accent);border-bottom-color:var(--accent)}
.av-tab .count{font-size:8px;font-weight:700;padding:1px 5px;border-radius:6px;background:rgba(239,68,68,0.15);color:var(--red);font-family:'JetBrains Mono',monospace}
.av-tab .soon{font-size:7px;font-weight:700;padding:1px 5px;border-radius:4px;background:rgba(58,61,77,0.2);color:var(--dim);font-family:'JetBrains Mono',monospace}

/* ECN Banner */
.ecn-banner{margin:10px 16px 0;padding:10px 14px;border-radius:10px;background:rgba(239,68,68,0.04);border:1px solid rgba(239,68,68,0.1)}
.ecn-progress{height:3px;border-radius:2px;background:rgba(239,68,68,0.1);overflow:hidden;margin:6px 0 8px}
.ecn-progress-fill{height:100%;border-radius:2px;transition:width 0.3s}
.ecn-item{display:flex;align-items:center;gap:7px;padding:6px 9px;border-radius:6px;cursor:pointer;margin-bottom:3px;border:1px solid var(--border);background:var(--card);transition:all 0.15s}
.ecn-item:hover{border-color:var(--muted)}
.ecn-item.done{background:rgba(34,197,94,0.05);border-color:rgba(34,197,94,0.12)}
.ecn-item.blocked{opacity:0.55;cursor:not-allowed}
.ecn-tag{font-size:10px;font-weight:700;font-family:'JetBrains Mono',monospace;min-width:28px;text-align:center;padding:2px 5px;border-radius:4px}
.ecn-all-done{margin-top:10px;padding:12px 14px;border-radius:9px;background:rgba(34,197,94,0.06);border:2px solid rgba(34,197,94,0.25);display:flex;align-items:center;justify-content:space-between}

/* Assembly tree list in assembly view */
.tree-list{padding:10px 16px}
.grp-block{margin-bottom:8px}
.grp-hdr{display:flex;align-items:center;gap:6px;padding:7px 10px;border-radius:8px;cursor:pointer}
.grp-hdr:hover{background:rgba(255,255,255,0.02)}
.step-row{display:flex;align-items:center;gap:6px;padding:5px 8px 5px 28px;cursor:pointer;border-radius:5px;font-size:11px}
.step-row:hover{background:rgba(255,255,255,0.02)}
.step-row .sn-tag{font-weight:700;min-width:26px;text-align:center;font-size:10px;padding:1px 4px;border-radius:3px}
.step-row .s-type{font-size:9px;font-weight:600}
.step-row .s-name{flex:1;font-size:10px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}

/* ====== TREE EDITOR PAGE ====== */
.te-wrap{display:flex;height:100vh;overflow:hidden}
.te-left{flex:1;display:flex;flex-direction:column;overflow:hidden}
.te-right{width:360px;border-left:1px solid var(--border);background:var(--card);overflow-y:auto;padding:12px 14px}
.te-verbar{padding:8px 12px;border-bottom:1px solid var(--border);background:#0e0f15;display:flex;align-items:center;gap:6px;flex-wrap:wrap}
.te-ver-pill{padding:3px 10px;border-radius:6px;font-size:10px;font-weight:700;cursor:pointer;font-family:'JetBrains Mono',monospace}
.te-frozen-banner{padding:6px 12px;background:rgba(239,68,68,0.06);border-bottom:1px solid rgba(239,68,68,0.1);font-size:10px;color:var(--red);font-weight:700;text-align:center}
.te-tree{flex:1;overflow-y:auto;padding:8px 10px}
.te-grp-hdr{display:flex;align-items:center;gap:6px;padding:6px 10px;border-radius:8px}
.te-step{display:flex;align-items:center;gap:5px;padding:5px 8px 5px 24px;cursor:pointer;border-radius:6px;margin:1px 0}
.te-step.sel{background:rgba(139,92,246,0.08);border:1px solid rgba(139,92,246,0.2)}

/* Detail panel sections */
.dp-section{margin-bottom:12px}
.dp-label{font-size:8px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px}
.dp-ecn-box{padding:7px 9px;border-radius:7px;margin-bottom:10px}
.disp-btn{flex:1;padding:4px;border-radius:4px;font-size:9px;font-weight:700;cursor:pointer;font-family:'JetBrains Mono',monospace}
.dp-row{display:flex;gap:3px;align-items:center;margin-bottom:3px;padding:4px 6px;border-radius:5px;border:1px solid var(--border)}

/* ====== CHANGE MODAL ====== */
.cm-overlay{position:fixed;inset:0;z-index:100;background:rgba(0,0,0,0.65);backdrop-filter:blur(6px);display:flex;align-items:center;justify-content:center}
.cm-box{background:var(--modal);border-radius:14px;width:min(460px,92vw);max-height:80vh;box-shadow:0 12px 40px rgba(0,0,0,0.6);border:1px solid var(--border);overflow:hidden;display:flex;flex-direction:column}
.cm-header{padding:12px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px}
.cm-body{padding:16px;overflow-y:auto;flex:1;display:flex;flex-direction:column;gap:12px}
.cm-footer{padding:10px 16px;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:8px;align-items:center}
.cm-box-pair{display:flex;gap:8px}
.cm-box-pair>div{flex:1;padding:10px;border-radius:8px}

/* ====== DUP MODAL ====== */
.dup-overlay{position:fixed;inset:0;z-index:100;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center}
.dup-box{background:var(--modal);border-radius:12px;width:320px;padding:20px;border:1px solid var(--border)}

/* Placeholder tabs */
.placeholder-tab{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:80px 20px;color:var(--dim)}
.placeholder-tab .ph-icon{font-size:40px;margin-bottom:12px;opacity:0.3}
.placeholder-tab .ph-title{font-size:22px;font-weight:700;margin-bottom:6px}
.placeholder-tab .ph-desc{font-size:12px;max-width:380px;text-align:center;line-height:1.6}
</style>
</head>
<body>

<div id="app"></div>

<script>
// ============================================================
// DATA
// ============================================================
const MASTER = {
  "GPMP-050":"DC Motor assy","GPMP-051":"Motor bracket","GPMP-010":"Drive shaft",
  "GPMP-011":"Worm gear","GPMP-012":"Spur gear A","GPMP-013":"Spur gear B",
  "GPMP-014":"Dowel pin 3x12","GPMP-015":"Bearing inner race","GPMP-016":"Cam follower shaft",
  "GPMP-020":"Ball bearing 6x10","GPMP-030":"Encoder magnet","GPMP-100":"Galina plate (top)",
  "GPMP-103":"Middle frame plate","GPMP-103-R1":"Middle frame plate (Stainless)",
  "GPMP-106":"Arm joint plate","GPMP-107":"Hook arm","GPMP-108":"Galina bottom cover",
  "GPMP-110":"Wifi antenna plate","GPMP-112":"FFC Cable 24pin","GPMP-200":"Encoder board",
  "GPMP-201":"Gear set assy","GPMP-201-R2":"Gear set assy (helical)","GPMP-202":"Positioning pin",
  "GPMP-203":"Gearbox cover plate","GPMP-300":"Main PCB","GPMP-300-R2":"Main PCB Rev C",
  "GPMP-301":"Head mount plate","GPMP-302":"LED ring holder","GPMP-303":"CAM follower bearing",
  "GPMP-401":"Camera module","GPMP-401-R1":"Camera module 5MP","GPMP-402":"LED ring board",
  "GPMP-403":"Camera FFC","GPMP-404":"LED harness",
  "CBBTS2-5":"Button head M2Ã—5","BSB-315CE":"Bind screw M3Ã—15",
  "CSH-M3-5":"Cap screw hex M3Ã—5","CSH-M4-8":"Cap screw hex M4Ã—8",
  "CBE3-6":"Cap bolt M3Ã—6","CBE6-30":"Cap bolt M6Ã—30",
};

const DISP = {
  reuse:{label:"REUSE",color:"#3b82f6",icon:"â™»ï¸",bg:"rgba(59,130,246,0.12)"},
  scrap:{label:"SCRAP",color:"#ef4444",icon:"ğŸ—‘ï¸",bg:"rgba(239,68,68,0.12)"},
  rework:{label:"REWORK",color:"#f59e0b",icon:"ğŸ”§",bg:"rgba(245,158,11,0.12)"},
};

const ASSEMBLIES = [
  {id:"ghost",name:"Ghost (Full Robot)",icon:"ğŸ¤–",units:115,color:"#22c55e",ver:"1.0",section:"full"},
  {id:"MB",name:"Mobile Base",icon:"ğŸ—ï¸",units:110,color:"#22c55e",ver:"1.0"},
  {id:"PIL",name:"Pillar",icon:"ğŸ—¼",units:110,color:"#ec4899",ver:"1.0"},
  {id:"HBD",name:"Head & Body",icon:"ğŸ¤–",units:120,color:"#f97316",ver:"5.0"},
  {id:"GRP",name:"Gripper",icon:"ğŸ¤",units:115,color:"#06b6d4",ver:"1.0"},
  {id:"ARM",name:"Arm",icon:"ğŸ’ª",units:110,color:"#3b82f6",ver:"1.0"},
  {id:"PKG",name:"Packaging",icon:"ğŸ“¦",units:90,color:"#8b5cf6",ver:"1.0"},
];

const MOCK_TREE = [
  {id:"g1",name:"Prep (Loctite)",icon:"ğŸ§ª",color:"#a855f7",level:null,steps:[
    {id:"s1",sn:"1",name:"Motor assy",type:"STEP",parts:2,fasteners:1},
    {id:"s2",sn:"2",name:"Loctite 648 parts",type:"PREP",parts:7,fasteners:0},
    {id:"s3",sn:"3",name:"Ball bearing in Dovel pin",type:"STEP",parts:2,fasteners:0},
    {id:"s4",sn:"4",name:"Loctite 425 parts",type:"PREP",parts:1,fasteners:0},
  ]},
  {id:"g2",name:"å®Œäº†: Body",icon:"ğŸ—",color:"#22c55e",level:1,steps:[
    {id:"s5",sn:"1a",name:"Frame galina plate çµ„ç«‹",type:"STEP",parts:1,fasteners:3},
    {id:"s6",sn:"1b",name:"Frame side plate çµ„ç«‹",type:"STEP",parts:0,fasteners:1},
    {id:"s7",sn:"1c",name:"Middle frame çµ„ç«‹",type:"STEP",parts:1,fasteners:1},
    {id:"s8",sn:"1d",name:"Body çµ„ç«‹",type:"STEP",parts:0,fasteners:1},
    {id:"s9",sn:"1e",name:"Arm joint plate",type:"STEP",parts:1,fasteners:1},
    {id:"s10",sn:"1da",name:"Hook arm çµ„ç«‹",type:"STEP",parts:1,fasteners:1},
    {id:"s11",sn:"1e'",name:"Galina bot cover",type:"STEP",parts:1,fasteners:1},
    {id:"s12",sn:"1f",name:"Galina çµ„ç«‹",type:"STEP",parts:0,fasteners:2},
    {id:"s13",sn:"1g",name:"Wifi plate çµ„ç«‹",type:"STEP",parts:1,fasteners:1},
    {id:"s14",sn:"1h",name:"Galina back cover",type:"STEP",parts:1,fasteners:1},
    {id:"s15",sn:"1i",name:"Body",type:"STEP",parts:1,fasteners:0},
  ]},
  {id:"g3",name:"å®Œäº†: Gearbox",icon:"âš™ï¸",color:"#f97316",level:2,steps:[
    {id:"s16",sn:"2a",name:"Encoder shaft çµ„ç«‹",type:"STEP",parts:1,fasteners:1},
    {id:"s17",sn:"2b",name:"White gears çµ„ç«‹",type:"STEP",parts:4,fasteners:0},
    {id:"s18",sn:"2c",name:"Hex and round pins",type:"STEP",parts:2,fasteners:0},
    {id:"s19",sn:"2d",name:"Gearbox cover çµ„ç«‹",type:"STEP",parts:1,fasteners:2},
  ]},
  {id:"g4",name:"å®Œäº†: Head",icon:"ğŸ¦´",color:"#ef4444",level:3,steps:[
    {id:"s20",sn:"3a",name:"Base ring sheet metal",type:"STEP",parts:2,fasteners:2},
    {id:"s21",sn:"3b",name:"Attaching the ring holder",type:"STEP",parts:4,fasteners:1},
    {id:"s22",sn:"3c",name:"Mounting the CAM follower",type:"STEP",parts:2,fasteners:1},
    {id:"s23",sn:"3d",name:"Mount the head on body",type:"STEP",parts:0,fasteners:2},
  ]},
  {id:"g5",name:"å®Œäº†: Final",icon:"âœ…",color:"#ec4899",level:5,steps:[
    {id:"s24",sn:"4a",name:"Camera assy",type:"STEP",parts:1,fasteners:1},
    {id:"s25",sn:"4b",name:"LED mounting",type:"STEP",parts:1,fasteners:1},
    {id:"s26",sn:"4c",name:"Cable guide bracket",type:"STEP",parts:1,fasteners:1},
    {id:"s27",sn:"4d",name:"Wire strap",type:"STEP",parts:0,fasteners:0},
    {id:"s28",sn:"4e",name:"Final inspection",type:"CHECK",parts:0,fasteners:0},
  ]},
];

const UNITS_HBD = [
  {sn:"HBD-001",ver:"4.0",latestVer:"5.0",status:"outdated",line:"Line A"},
  {sn:"HBD-002",ver:"5.0",latestVer:"5.0",status:"current",line:"Line A"},
  {sn:"HBD-003",ver:"4.0",latestVer:"5.0",status:"outdated",line:"Line B"},
  {sn:"HBD-004",ver:"5.0",latestVer:"5.0",status:"current",line:"Line B"},
  {sn:"HBD-005",ver:"3.0",latestVer:"5.0",status:"outdated",line:"Line A"},
  {sn:"HBD-006",ver:"5.0",latestVer:"5.0",status:"current",line:"Line C"},
  {sn:"HBD-007",ver:"4.0",latestVer:"5.0",status:"outdated",line:"Line C"},
  ...Array.from({length:30},(_,i)=>({
    sn:`HBD-${String(i+8).padStart(3,"0")}`,ver:i%3===0?"4.0":"5.0",
    latestVer:"5.0",status:i%3===0?"outdated":"current",line:["Line A","Line B","Line C"][i%3],
  })),
];

const VER_CHANGES = {
  "4.0â†’5.0":[
    {step:"1c",stepName:"Middle frame çµ„ç«‹",type:"part_changed",field:"Part Number",old:"GPMP-103",new:"GPMP-103-R1",reason:"Upgraded to stainless frame for corrosion resistance",group:"å®Œäº†: Body"},
    {step:"1f",stepName:"Galina çµ„ç«‹",type:"fastener_changed",field:"Fastener",old:"CSH-M3-5 (1.14Nm)",new:"CSH-M4-8 (2.70Nm)",reason:"Higher torque spec per stress analysis",group:"å®Œäº†: Body"},
    {step:"2d",stepName:"Gearbox cover çµ„ç«‹",type:"part_changed",field:"Gasket",old:"GK-200-A",new:"GK-200-B",reason:"Heat-resistant material upgrade",group:"å®Œäº†: Gearbox"},
    {step:"3b",stepName:"Attaching the ring holder",type:"step_modified",field:"Torque spec",old:"1.14 Nm",new:"1.50 Nm",reason:"Updated per vibration test results",group:"å®Œäº†: Head"},
  ],
  "3.0â†’5.0":[
    {step:"1c",stepName:"Middle frame çµ„ç«‹",type:"part_changed",field:"Part Number",old:"GPMP-103",new:"GPMP-103-R1",reason:"Upgraded to stainless frame",group:"å®Œäº†: Body"},
    {step:"1e",stepName:"Arm joint plate",type:"part_changed",field:"Part Number",old:"GPMP-106",new:"GPMP-106-R1",reason:"Redesigned for better fit",group:"å®Œäº†: Body"},
    {step:"1f",stepName:"Galina çµ„ç«‹",type:"fastener_changed",field:"Fastener",old:"CSH-M3-5 (1.14Nm)",new:"CSH-M4-8 (2.70Nm)",reason:"Higher torque spec",group:"å®Œäº†: Body"},
    {step:"2d",stepName:"Gearbox cover çµ„ç«‹",type:"part_changed",field:"Gasket",old:"GK-200-A",new:"GK-200-B",reason:"Heat-resistant material",group:"å®Œäº†: Gearbox"},
    {step:"3b",stepName:"Attaching the ring holder",type:"step_modified",field:"Torque spec",old:"1.14 Nm",new:"1.50 Nm",reason:"Updated per vibration test",group:"å®Œäº†: Head"},
  ],
};

function getUnits(assyId){
  if(assyId==='HBD') return UNITS_HBD;
  const a=ASSEMBLIES.find(x=>x.id===assyId);
  if(!a) return [];
  return Array.from({length:a.units},(_,i)=>({
    sn:`${assyId}-${String(i+1).padStart(3,"0")}`,ver:i%3===0?"1.0":a.ver,
    latestVer:a.ver,status:i%3===0&&a.ver!=="1.0"?"outdated":"current",line:["Line A","Line B","Line C"][i%3],
  }));
}

// Cascade engine
function chainOf(sn){const m=sn.match(/^(\d+)/);return m?m[1]:sn;}
function buildFlat(tree){const f=[];tree.forEach(g=>g.steps.forEach(s=>f.push({...s,gid:g.id,gname:g.name,gcol:g.color,chain:chainOf(s.sn)})));return f;}
function computeCascade(tree,changes,applied,unitSn){
  const flat=buildFlat(tree),ecnSet=new Set(changes.map(c=>c.step)),r=new Map();
  changes.forEach(ch=>{
    const cc=chainOf(ch.step);if(applied.has(`${unitSn}-${ch.step}`))return;
    const ci=flat.findIndex(s=>s.sn===ch.step);if(ci===-1)return;
    for(let i=ci+1;i<flat.length;i++){
      if(flat[i].chain!==cc)continue;
      const e=r.get(flat[i].sn)||{isCascade:false,from:[],isBlocked:false};
      e.isCascade=true;if(!e.from.includes(ch.step))e.from.push(ch.step);r.set(flat[i].sn,e);
    }
  });
  changes.forEach(ch=>{
    const cc=chainOf(ch.step),ci=flat.findIndex(s=>s.sn===ch.step);
    for(let i=0;i<ci;i++){
      if(flat[i].chain!==cc)continue;
      if(ecnSet.has(flat[i].sn)&&!applied.has(`${unitSn}-${flat[i].sn}`)){
        const e=r.get(ch.step)||{isCascade:false,from:[],isBlocked:false};
        e.isBlocked=true;if(!e.from.includes(flat[i].sn))e.from.push(flat[i].sn);r.set(ch.step,e);
      }
    }
  });
  return r;
}

// ============================================================
// APP STATE & RENDERING
// ============================================================
const STATE = {
  page:'home', assembly:null, selectedUnits:[], avTab:'list',
  unitFilter:'all', unitSearch:'', unitSel:new Set(),
  applied:new Set(), modal:null,
  // Tree editor
  teVersions:{}, teActiveVer:'5.0', teProdVer:'5.0', teSel:null, dupModal:false, dupVer:'',
};

let ID=()=>Math.random().toString(36).slice(2,9);

function mkEditorTree(){
  return [
    {id:ID(),name:"Prep (Loctite)",icon:"ğŸ§ª",color:"#a855f7",level:null,steps:[
      {id:ID(),sn:"1",type:"PREP",nameOverride:"",parts:[{id:ID(),pn:"GPMP-050",name:"DC Motor assy",qty:1}],fasteners:[]},
      {id:ID(),sn:"2",type:"PREP",nameOverride:"Loctite 648 parts",parts:[],fasteners:[]},
    ]},
    {id:ID(),name:"å®Œäº†: Body",icon:"ğŸ—",color:"#22c55e",level:1,steps:[
      {id:ID(),sn:"1a",type:"STEP",nameOverride:"",parts:[{id:ID(),pn:"GPMP-100",name:"Galina plate (top)",qty:1}],fasteners:[{id:ID(),code:"CSH-M3-5",torque:"1.14Nm",loctite:"222",qty:2}]},
      {id:ID(),sn:"1b",type:"STEP",nameOverride:"Frame side plate çµ„ç«‹",parts:[],fasteners:[{id:ID(),code:"CBBTS2-5",torque:"0.315Nm",loctite:"222",qty:3}]},
      {id:ID(),sn:"1c",type:"STEP",nameOverride:"",parts:[{id:ID(),pn:"GPMP-103",name:"Middle frame plate",qty:1}],fasteners:[{id:ID(),code:"CSH-M4-8",torque:"2.7Nm",loctite:"222",qty:2}]},
      {id:ID(),sn:"1f",type:"STEP",nameOverride:"Galina çµ„ç«‹",parts:[],fasteners:[{id:ID(),code:"CSH-M3-5",torque:"1.14Nm",loctite:"222",qty:2},{id:ID(),code:"CBBTS2-5",torque:"0.315Nm",loctite:"222",qty:1}]},
    ]},
    {id:ID(),name:"å®Œäº†: Gearbox",icon:"âš™ï¸",color:"#f97316",level:2,steps:[
      {id:ID(),sn:"2a",type:"STEP",nameOverride:"",parts:[{id:ID(),pn:"GPMP-200",name:"Encoder board",qty:1}],fasteners:[{id:ID(),code:"CBE3-6",torque:"1.14Nm",loctite:"425",qty:2}]},
      {id:ID(),sn:"2d",type:"STEP",nameOverride:"",parts:[{id:ID(),pn:"GPMP-203",name:"Gearbox cover plate",qty:1}],fasteners:[{id:ID(),code:"CSH-M4-8",torque:"2.7Nm",loctite:"222",qty:4}]},
    ]},
    {id:ID(),name:"å®Œäº†: Head",icon:"ğŸ¦´",color:"#ef4444",level:3,steps:[
      {id:ID(),sn:"3a",type:"STEP",nameOverride:"",parts:[{id:ID(),pn:"GPMP-301",name:"Head mount plate",qty:1}],fasteners:[{id:ID(),code:"CSH-M3-5",torque:"1.14Nm",loctite:"222",qty:4}]},
      {id:ID(),sn:"3b",type:"STEP",nameOverride:"",parts:[{id:ID(),pn:"GPMP-302",name:"LED ring holder",qty:1},{id:ID(),pn:"GPMP-303",name:"CAM follower bearing",qty:2}],fasteners:[]},
    ]},
  ];
}

function initEditor(){
  STATE.teVersions = {"5.0":{tree:mkEditorTree(),ecn:{"1c":{note:"Frame upgrade",disposition:"scrap"}},status:"frozen",frozenAt:Date.now()}};
  STATE.teActiveVer = "5.0";
  STATE.teProdVer = "5.0";
  STATE.teSel = null;
}
initEditor();

function getStepName(s){
  if(s.nameOverride) return s.nameOverride;
  if(s.parts.length===1&&s.parts[0].name) return s.parts[0].name;
  if(s.parts.length>1) return s.parts.map(p=>p.name||p.pn).filter(Boolean).join(" + ");
  return "";
}

function toast(msg){
  const c=document.createElement('div');c.style.cssText='position:fixed;bottom:20px;left:50%;transform:translateX(-50%);padding:8px 20px;border-radius:8px;background:#22c55e;color:#000;font-weight:700;font-size:11px;z-index:999;font-family:"JetBrains Mono",monospace';
  c.textContent=msg;document.body.appendChild(c);setTimeout(()=>c.remove(),2000);
}

// ============================================================
// RENDER
// ============================================================
function render(){
  const app=document.getElementById('app');
  if(STATE.page==='home') app.innerHTML=renderHome();
  else if(STATE.page==='unitSelect') app.innerHTML=renderUnitSelect();
  else if(STATE.page==='assembly') app.innerHTML=renderAssemblyView();
  else if(STATE.page==='editor') app.innerHTML=renderTreeEditor();
  attachEvents();
}

// ---------- HOME ----------
function renderHome(){
  const totalUnits=ASSEMBLIES.reduce((s,a)=>s+a.units,0);
  const outdated=37+8+5+3;
  const full=ASSEMBLIES.filter(a=>a.section==='full');
  const majors=ASSEMBLIES.filter(a=>a.section!=='full');
  return `
  <div class="home-wrap">
    <div class="home-admin">
      <div class="admin-pill">ğŸ”§ Admin Â· Aniket</div>
      <button class="btn-sm" style="background:rgba(139,92,246,0.12);color:#8b5cf6;border:1px solid rgba(139,92,246,0.25);cursor:pointer;padding:5px 12px;font-size:11px" data-action="editor"
        onmouseenter="this.style.background='rgba(139,92,246,0.22)';this.style.borderColor='#8b5cf6'"
        onmouseleave="this.style.background='rgba(139,92,246,0.12)';this.style.borderColor='rgba(139,92,246,0.25)'">ğŸ”§ Tree Editor</button>
      <button class="btn-sm" style="background:transparent;color:var(--muted)" onclick="toast('Logout mock')">Logout</button>
      <div style="width:24px;height:24px;border-radius:50%;background:linear-gradient(135deg,#f59e0b,#e8952e);border:2px solid var(--border)"></div>
    </div>

    <div class="home-hero">
      <div class="home-logo"><span class="sym">â—ˆ</span>EagleEye</div>
      <div class="home-sub">Assembly version tracking & ECN management</div>
    </div>

    <div style="max-width:860px;width:100%;padding:0 24px">
      <div class="section-label">FULL ROBOT</div>
    </div>
    <div class="full-robot-wrap">
      ${full.map(a=>`
        <div class="full-robot-card" data-action="assy" data-id="${a.id}">
          <div style="font-size:36px;margin-bottom:8px">${a.icon}</div>
          <div style="font-size:18px;font-weight:700;display:flex;align-items:center;gap:10px">
            ${a.name} <span class="badge" style="background:rgba(34,197,94,0.12);color:#22c55e">v${a.ver}</span>
          </div>
          <div style="margin-top:8px"><span class="badge" style="background:rgba(34,197,94,0.12);color:#22c55e">${a.units} units</span></div>
        </div>
      `).join('')}
    </div>

    <div style="max-width:860px;width:100%;padding:0 24px">
      <div class="section-label">MAJOR ASSEMBLIES</div>
    </div>
    <div class="assy-grid">
      ${majors.map(a=>{
        const out=a.id==='HBD'?37:Math.floor(a.units*0.15);
        return `
        <div class="assy-card" style="border-left:3px solid ${a.color}" data-action="assy" data-id="${a.id}"
          onmouseenter="this.style.boxShadow='0 4px 16px ${a.color}15'"
          onmouseleave="this.style.boxShadow='none'">
          <div class="ac-top">
            <span class="ac-icon">${a.icon}</span>
            <span class="ac-name">${a.name}</span>
          </div>
          <div class="ac-tags">
            <span class="badge" style="background:${a.color}15;color:${a.color}">${a.units} units</span>
            ${out>0?`<span class="badge" style="background:rgba(239,68,68,0.1);color:#ef4444">${out} outdated</span>`:''}
            <span class="badge" style="background:${a.color}10;color:${a.color}">v${a.ver}</span>
          </div>
        </div>`;
      }).join('')}
    </div>
  </div>`;
}

// ---------- UNIT SELECT ----------
function renderUnitSelect(){
  const a=STATE.assembly;
  const units=getUnits(a.id);
  const outCount=units.filter(u=>u.status==='outdated').length;
  let filtered=units;
  if(STATE.unitFilter==='outdated') filtered=filtered.filter(u=>u.status==='outdated');
  if(STATE.unitFilter==='current') filtered=filtered.filter(u=>u.status==='current');
  if(STATE.unitSearch) filtered=filtered.filter(u=>u.sn.toLowerCase().includes(STATE.unitSearch.toLowerCase()));

  return `
  <div style="min-height:100vh;background:var(--bg);padding:24px">
    <div style="max-width:900px;margin:0 auto">
      <div class="us-header">
        <button class="us-back" data-action="goHome">â† Back</button>
        <span style="font-size:28px">${a.icon}</span>
        <div>
          <div style="font-size:20px;font-weight:700">${a.name}</div>
          <div style="font-size:11px;color:var(--muted)" class="mono">${units.length} total Â· <span style="color:#ef4444;font-weight:700">${outCount} need updates</span> Â· prod v${a.ver}</div>
        </div>
      </div>

      <div class="us-filters">
        <input class="inp" style="width:170px;font-size:12px" placeholder="Search S/N..." data-role="unitSearch" value="${STATE.unitSearch}">
        ${['all','outdated','current'].map(f=>`<button class="us-filter ${STATE.unitFilter===f?'active':''}" data-f="${f}" data-action="setFilter">${f}</button>`).join('')}
        <button class="btn-sm" style="margin-left:auto;background:transparent;color:var(--muted)" data-action="selectAll">Select all (${filtered.length})</button>
      </div>

      <div class="unit-grid">
        ${filtered.map(u=>{
          const sel=STATE.unitSel.has(u.sn);
          const out=u.status==='outdated';
          return `<div class="unit-card ${sel?'selected':''}" data-action="toggleUnit" data-sn="${u.sn}">
            ${sel?`<div style="position:absolute;top:5px;right:7px;font-size:12px;color:var(--accent)">âœ“</div>`:''}
            <div style="font-size:12px;font-weight:700" class="mono">${u.sn}</div>
            <div style="display:flex;gap:4px;margin-top:3px">
              <span class="badge" style="background:${out?'rgba(239,68,68,0.12)':'rgba(34,197,94,0.12)'};color:${out?'#ef4444':'#22c55e'}">v${u.ver}</span>
              ${out?`<span style="font-size:8px;color:#ef4444">â†’ v${u.latestVer}</span>`:''}
            </div>
          </div>`;
        }).join('')}
      </div>

      ${STATE.unitSel.size>0?`
      <div class="proceed-bar" style="background:rgba(245,158,11,0.04);border:1px solid rgba(245,158,11,0.15)">
        <span style="font-weight:700;font-size:13px">${STATE.unitSel.size} selected</span>
        <button class="proceed-btn" style="background:${a.color}" data-action="proceed">Open Assembly View â†’</button>
      </div>`:''}
    </div>
  </div>`;
}

// ---------- ASSEMBLY VIEW ----------
function renderAssemblyView(){
  const a=STATE.assembly;
  const unit=STATE.selectedUnits[0];
  if(!unit) return '';
  const isOut=unit.status==='outdated';
  const changes=VER_CHANGES[`${unit.ver}â†’${unit.latestVer}`]||[];
  const cascade=computeCascade(MOCK_TREE,changes,STATE.applied,unit.sn);
  const appliedCount=[...STATE.applied].filter(k=>k.startsWith(unit.sn)).length;
  const allDone=changes.length>0&&changes.every(c=>STATE.applied.has(`${unit.sn}-${c.step}`));
  const totalParts=MOCK_TREE.reduce((s,g)=>s+g.steps.reduce((a,st)=>a+st.parts,0),0);
  const totalFast=MOCK_TREE.reduce((s,g)=>s+g.steps.reduce((a,st)=>a+st.fasteners,0),0);
  const totalSteps=MOCK_TREE.reduce((s,g)=>s+g.steps.length,0);
  const tab=STATE.avTab;

  let tabContent='';
  if(tab==='list'){
    // ECN Banner + Tree
    let banner='';
    if(isOut&&changes.length>0){
      const cascadeCount=[...cascade.values()].filter(v=>v.isCascade).length;
      banner=`<div class="ecn-banner">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px">
          <span style="font-size:12px;font-weight:700;color:#ef4444">âš  ${changes.length} ECN changes Â· ${cascadeCount} cascade</span>
          <span style="font-size:10px;color:var(--muted)" class="mono">${appliedCount}/${changes.length}</span>
        </div>
        <div class="ecn-progress"><div class="ecn-progress-fill" style="width:${(appliedCount/changes.length)*100}%;background:${allDone?'#22c55e':'#f59e0b'}"></div></div>
        ${changes.map((c,i)=>{
          const done=STATE.applied.has(`${unit.sn}-${c.step}`);
          const info=cascade.get(c.step);
          const blocked=info?.isBlocked&&!done;
          return `<div class="ecn-item ${done?'done':''} ${blocked?'blocked':''}" data-action="openChange" data-idx="${i}">
            <span class="ecn-tag" style="color:${done?'#22c55e':blocked?'var(--dim)':'#ef4444'};background:${done?'rgba(34,197,94,0.12)':'rgba(239,68,68,0.1)'}">${c.step}</span>
            <span style="flex:1;font-size:11px;font-weight:500;${done?'opacity:0.5;text-decoration:line-through':''}">${c.stepName}</span>
            <span style="font-size:9px;color:var(--muted)" class="mono">${c.field}</span>
            ${blocked?'<span style="font-size:10px">ğŸ”’</span>':''}
            <span style="font-size:12px;color:${done?'#22c55e':'var(--dim)'}">${done?'âœ“':'â—‹'}</span>
          </div>`;
        }).join('')}
        ${allDone?`<div class="ecn-all-done">
          <div><div style="font-size:13px;font-weight:700;color:#22c55e">âœ… All changes applied</div><div style="font-size:10px;color:var(--muted);margin-top:2px">Ready to upgrade ${unit.sn}</div></div>
          <button style="padding:8px 22px;border-radius:9px;font-size:12px;font-weight:700;background:#22c55e;border:none;color:#000;cursor:pointer;box-shadow:0 4px 16px rgba(34,197,94,0.3)">âœ“ Upgrade to v${unit.latestVer}</button>
        </div>`:''}
      </div>`;
    }
    // Tree list
    let treeHtml='<div class="tree-list">';
    MOCK_TREE.forEach(g=>{
      treeHtml+=`<div class="grp-block"><div class="grp-hdr" style="background:${g.color}08;border-left:3px solid ${g.color}">
        <span style="font-size:13px">${g.icon}</span>
        <span style="font-weight:700;color:${g.color};flex:1;font-size:12px">${g.name}</span>
        ${g.level!==null?`<span class="badge" style="background:${g.color}15;color:${g.color}">L${g.level}</span>`:''}
        <span style="color:var(--muted);font-size:9px" class="mono">${g.steps.length}</span>
      </div>`;
      g.steps.forEach(s=>{
        const hasEcn=changes.some(c=>c.step===s.sn);
        const done=STATE.applied.has(`${unit.sn}-${s.sn}`);
        treeHtml+=`<div class="step-row" style="${done?'opacity:0.4':''}">
          ${hasEcn?`<span style="font-size:9px">${done?'âœ…':'ğŸ”´'}</span>`:'<span style="width:14px"></span>'}
          <span class="sn-tag" style="background:${g.color}12;color:${g.color}">${s.sn}</span>
          <span class="s-type" style="color:${s.type==='PREP'?'#a855f7':s.type==='CHECK'?'#ec4899':'#3b82f6'}">${s.type}</span>
          <span class="s-name" style="color:var(--text)">${s.name}</span>
          ${s.parts>0?`<span style="font-size:8px;color:#22c55e" class="mono">${s.parts}P</span>`:''}
          ${s.fasteners>0?`<span style="font-size:8px;color:#ef4444" class="mono">${s.fasteners}F</span>`:''}
        </div>`;
      });
      treeHtml+='</div>';
    });
    treeHtml+='</div>';
    tabContent=banner+treeHtml;
  } else {
    tabContent=`<div class="placeholder-tab"><div class="ph-icon">ğŸ”§</div><div class="ph-title">${tab==='graph'?'Graph View':'Kanban View'}</div><div class="ph-desc">Coming soon â€” visual ${tab} layout for assembly steps.</div></div>`;
  }

  return `
  <div style="min-height:100vh;background:var(--bg)">
    <div class="av-header">
      <button class="us-back" data-action="backToUnits">â† Units</button>
      <span style="font-size:18px;font-weight:800;color:var(--accent)" class="mono">â—ˆ</span>
      <select class="inp" style="padding:5px 10px;font-size:12px;font-weight:600" data-role="unitPicker">
        ${STATE.selectedUnits.map(u=>`<option value="${u.sn}" ${u.sn===unit.sn?'selected':''}>${u.sn} â€” v${u.ver} ${u.status==='outdated'?'âš ':'âœ“'}</option>`).join('')}
      </select>
      <div style="display:flex;align-items:center;gap:4px;padding:3px 10px;background:${isOut?'rgba(239,68,68,0.1)':'rgba(34,197,94,0.1)'};border:1px solid ${isOut?'rgba(239,68,68,0.25)':'rgba(34,197,94,0.25)'};border-radius:16px;font-size:10px;font-weight:700;color:${isOut?'#ef4444':'#22c55e'}" class="mono">
        <span style="width:5px;height:5px;border-radius:50%;background:${isOut?'#ef4444':'#22c55e'}"></span>
        v${unit.ver}${isOut?` <span style="font-weight:400;opacity:0.7">â†’ v${unit.latestVer}</span>`:''}
      </div>
    </div>
    <div class="av-tabs">
      <button class="av-tab ${tab==='list'?'active':''}" data-action="avTab" data-tab="list">
        <span style="font-size:13px;opacity:${tab==='list'?1:0.5}">â˜°</span> List View
        ${changes.length-appliedCount>0?`<span class="count">${changes.length-appliedCount}</span>`:''}
      </button>
      <button class="av-tab ${tab==='graph'?'active':''}" data-action="avTab" data-tab="graph">
        <span style="font-size:13px;opacity:${tab==='graph'?1:0.5}">â—ˆ</span> Graph <span class="soon">SOON</span>
      </button>
      <button class="av-tab ${tab==='kanban'?'active':''}" data-action="avTab" data-tab="kanban">
        <span style="font-size:13px;opacity:${tab==='kanban'?1:0.5}">â–¦</span> Kanban <span class="soon">SOON</span>
      </button>
      <div style="margin-left:auto;display:flex;gap:10px;font-size:10px;color:var(--muted)" class="mono">
        <span><span style="color:#22c55e;font-weight:700">${totalParts}</span>P</span>
        <span><span style="color:#ef4444;font-weight:700">${totalFast}</span>F</span>
        <span><span style="font-weight:700">${totalSteps}</span> steps</span>
      </div>
    </div>
    ${tabContent}
  </div>
  ${STATE.modal!==null?renderChangeModal():''}`;
}

function renderChangeModal(){
  const unit=STATE.selectedUnits[0];
  const changes=VER_CHANGES[`${unit.ver}â†’${unit.latestVer}`]||[];
  const ch=changes[STATE.modal];if(!ch) return '';
  const cascade=computeCascade(MOCK_TREE,changes,STATE.applied,unit.sn);
  const isDone=STATE.applied.has(`${unit.sn}-${ch.step}`);
  const info=cascade.get(ch.step);
  const blocked=info?.isBlocked&&!isDone;
  const tc={part_changed:{bg:"rgba(59,130,246,0.08)",c:"#3b82f6",l:"Part Changed"},fastener_changed:{bg:"rgba(239,68,68,0.08)",c:"#ef4444",l:"Fastener Changed"},step_modified:{bg:"rgba(168,85,247,0.08)",c:"#a855f7",l:"Step Modified"}}[ch.type]||{bg:"rgba(168,85,247,0.08)",c:"#a855f7",l:"Modified"};

  return `<div class="cm-overlay" data-action="closeModal">
    <div class="cm-box" onclick="event.stopPropagation()">
      <div class="cm-header">
        <span class="mono" style="font-size:12px;font-weight:700;color:${tc.c};background:${tc.bg};padding:3px 8px;border-radius:5px">${ch.step}</span>
        <div style="flex:1"><div style="font-size:14px;font-weight:700">${ch.stepName}</div><div style="font-size:10px;color:var(--muted)">${ch.group} Â· ${unit.sn}</div></div>
        <button style="background:none;border:none;color:var(--muted);font-size:16px;cursor:pointer" data-action="closeModal">âœ•</button>
      </div>
      <div class="cm-body">
        <span class="badge" style="background:${tc.bg};color:${tc.c};align-self:flex-start">${tc.l}</span>
        <div class="cm-box-pair">
          ${ch.old?`<div style="background:rgba(239,68,68,0.04);border:1px solid rgba(239,68,68,0.08)"><div style="font-size:8px;font-weight:700;color:#ef4444;text-transform:uppercase;letter-spacing:1px;margin-bottom:4px">Before</div><div style="font-size:12px;font-weight:600" class="mono">${ch.old}</div></div>`:''}
          <div style="background:rgba(34,197,94,0.04);border:1px solid rgba(34,197,94,0.08)"><div style="font-size:8px;font-weight:700;color:#22c55e;text-transform:uppercase;letter-spacing:1px;margin-bottom:4px">${ch.old?'After':'New'}</div><div style="font-size:12px;font-weight:600" class="mono">${ch.new}</div></div>
        </div>
        <div style="padding:10px;border-radius:8px;background:rgba(245,158,11,0.04);border:1px solid rgba(245,158,11,0.08)"><div style="font-size:8px;font-weight:700;color:var(--accent);text-transform:uppercase;letter-spacing:1px;margin-bottom:3px">Reason</div><div style="font-size:11px">${ch.reason}</div></div>
      </div>
      <div class="cm-footer">
        ${isDone?'<span style="font-size:10px;color:#22c55e;margin-right:auto">âœ… Applied</span>':''}
        ${blocked?'<span style="font-size:10px;color:var(--dim);margin-right:auto">ğŸ”’ Resolve upstream first</span>':''}
        <button class="btn-sm" style="background:transparent;color:var(--muted);padding:6px 14px" data-action="closeModal">Close</button>
        <button style="padding:6px 18px;border-radius:6px;font-size:11px;font-weight:700;border:none;cursor:${blocked?'not-allowed':'pointer'};background:${isDone?'rgba(239,68,68,0.12)':blocked?'var(--card-hover)':'#22c55e'};color:${isDone?'#ef4444':blocked?'var(--dim)':'#000'};opacity:${blocked?0.5:1}" data-action="toggleApply" data-step="${ch.step}" ${blocked?'disabled':''}>${isDone?'â†© Undo':blocked?'ğŸ”’ Blocked':'âœ“ Mark Applied'}</button>
      </div>
    </div>
  </div>`;
}

// ---------- TREE EDITOR ----------
function renderTreeEditor(){
  const v=STATE.teVersions[STATE.teActiveVer];
  if(!v) return '<div>No version data</div>';
  const tree=v.tree||[];
  const ecn=v.ecn||{};
  const locked=v.status==='frozen';
  const sel=STATE.teSel;

  // Find selected step
  let selStep=null;
  if(sel){for(const g of tree){const s=g.steps.find(x=>x.id===sel.sid);if(s){selStep={g,s,gi:tree.indexOf(g),si:g.steps.indexOf(s)};break;}}}

  let rightPanel='';
  if(selStep){
    const{g,s,si}=selStep;
    const hasE=!!ecn[s.sn];
    const ec=ecn[s.sn];
    const lDim=locked?'opacity:0.5':'';
    rightPanel=`
      <div style="font-size:14px;font-weight:700;margin-bottom:10px">${getStepName(s)||'Untitled Step'}</div>
      <div style="display:flex;gap:8px;align-items:center;margin-bottom:10px">
        <div><div class="dp-label">TAG</div><input class="inp" style="width:50px;font-weight:700;${lDim}" value="${s.sn}" ${locked?'disabled':''} data-role="teStepSn"></div>
        <div><div class="dp-label">TYPE</div><select class="inp" style="${lDim}" ${locked?'disabled':''} data-role="teStepType"><option ${s.type==='STEP'?'selected':''}>STEP</option><option ${s.type==='PREP'?'selected':''}>PREP</option><option ${s.type==='CHECK'?'selected':''}>CHECK</option></select></div>
      </div>
      <div class="dp-ecn-box" style="background:${hasE?'rgba(239,68,68,0.04)':'rgba(139,92,246,0.02)'};border:1px solid ${hasE?'rgba(239,68,68,0.12)':'var(--border)'}">
        <div style="display:flex;align-items:center;gap:6px;${hasE?'margin-bottom:6px':''}">
          <span style="font-size:10px;font-weight:700;color:${hasE?'#ef4444':'var(--muted)'}">${hasE?'ğŸ”´ ECN Marked':'No ECN'}</span>
          ${!locked?`<button class="btn-sm" style="margin-left:auto;background:${hasE?'rgba(239,68,68,0.12)':'rgba(34,197,94,0.12)'};color:${hasE?'#ef4444':'#22c55e'};border:none;font-size:9px;padding:2px 8px" data-action="toggleEcn">${hasE?'âœ• Remove':'+ Mark ECN'}</button>`:''}
        </div>
        ${hasE?`
          <div class="dp-label">DISPOSITION</div>
          <div style="display:flex;gap:3px;margin-bottom:6px">
            ${Object.entries(DISP).map(([k,d])=>`<button class="disp-btn" style="border:${ec?.disposition===k?`2px solid ${d.color}`:`1px solid var(--border)`};background:${ec?.disposition===k?d.bg:'transparent'};color:${d.color};${locked&&ec?.disposition!==k?'opacity:0.3':''}" data-action="setDisp" data-disp="${k}" ${locked?'disabled':''}>${d.icon} ${d.label}</button>`).join('')}
          </div>
          ${!locked?`<textarea class="inp" style="width:100%;resize:vertical;line-height:1.3;min-height:40px" placeholder="ECN note..." data-role="teEcnNote">${ec?.note||''}</textarea>`:''}
        `:''}
      </div>
      <div class="dp-section">
        <div style="display:flex;align-items:center;margin-bottom:5px"><span class="dp-label" style="flex:1;margin:0">PARTS (${s.parts.length})</span>${!locked?`<button class="btn-sm" style="background:rgba(34,197,94,0.12);color:#22c55e;border:none;font-size:9px;padding:2px 8px" data-action="addPart">+ Part</button>`:''}</div>
        ${s.parts.map((p,pi)=>`
          <div class="dp-row" style="${s.parts.length===1?'background:rgba(14,165,233,0.03)':''}">
            <input class="inp" style="width:76px;font-weight:700;color:#0ea5e9;${lDim}" value="${p.pn}" ${locked?'disabled':''} placeholder="P/N" data-role="partPn" data-pi="${pi}">
            <input class="inp" style="flex:1;${lDim}" value="${p.name}" ${locked?'disabled':''} placeholder="name" data-role="partName" data-pi="${pi}">
            <input class="inp" type="number" style="width:28px;text-align:center;${lDim}" value="${p.qty}" ${locked?'disabled':''} data-role="partQty" data-pi="${pi}">
            ${!locked?`<button style="background:none;border:none;color:#ef4444;font-size:9px;cursor:pointer" data-action="delPart" data-pi="${pi}">âœ•</button>`:''}
          </div>`).join('')}
        ${s.parts.length===0?'<div style="font-size:9px;color:var(--dim);font-style:italic;margin-bottom:6px">Add a part â†’ its name becomes the step name</div>':''}
      </div>
      <div class="dp-section">
        <div style="display:flex;align-items:center;margin-bottom:5px"><span class="dp-label" style="flex:1;margin:0">FASTENERS (${s.fasteners.length})</span>${!locked?`<button class="btn-sm" style="background:rgba(245,158,11,0.12);color:#f59e0b;border:none;font-size:9px;padding:2px 8px" data-action="addFastener">+ Fastener</button>`:''}</div>
        ${s.fasteners.map((f,fi)=>`
          <div style="display:flex;gap:3px;align-items:center;margin-bottom:2px">
            <input class="inp" style="width:70px;font-weight:700;color:#f59e0b;${lDim}" value="${f.code}" ${locked?'disabled':''} placeholder="Code" data-role="fastCode" data-fi="${fi}">
            <input class="inp" style="flex:1;${lDim}" value="${f.torque}" ${locked?'disabled':''} placeholder="Torque" data-role="fastTorque" data-fi="${fi}">
            <input class="inp" style="width:32px;${lDim}" value="${f.loctite}" ${locked?'disabled':''} placeholder="Loc" data-role="fastLoc" data-fi="${fi}">
            <input class="inp" type="number" style="width:28px;text-align:center;${lDim}" value="${f.qty}" ${locked?'disabled':''} data-role="fastQty" data-fi="${fi}">
            ${!locked?`<button style="background:none;border:none;color:#ef4444;font-size:9px;cursor:pointer" data-action="delFast" data-fi="${fi}">âœ•</button>`:''}
          </div>`).join('')}
      </div>
    `;
  } else {
    rightPanel='<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;color:var(--dim);font-size:12px"><div style="font-size:28px;margin-bottom:10px;opacity:0.3">ğŸ”§</div><div>Select a step to edit</div></div>';
  }

  return `
  <div class="te-wrap">
    <div class="te-left">
      <div class="te-verbar">
        <button class="us-back" data-action="goHome" style="padding:3px 10px;font-size:10px">â† Home</button>
        <span style="font-size:14px;font-weight:800;color:#8b5cf6">ğŸ”§</span>
        <span style="font-weight:700;color:#8b5cf6;font-size:12px" class="mono">Tree Editor</span>
        <div style="width:1px;height:16px;background:var(--border);margin:0 4px"></div>
        ${Object.entries(STATE.teVersions).map(([vn,vd])=>`
          <button class="te-ver-pill" style="border:${vn===STATE.teActiveVer?`2px solid ${vd.status==='frozen'?'#ef4444':'#8b5cf6'}`:`1px solid var(--border)`};background:${vn===STATE.teActiveVer?(vd.status==='frozen'?'rgba(239,68,68,0.08)':'rgba(139,92,246,0.08)'):'transparent'};color:${vn===STATE.teActiveVer?(vd.status==='frozen'?'#ef4444':'#8b5cf6'):'var(--muted)'}" data-action="switchVer" data-ver="${vn}">
            ${vd.status==='frozen'?'ğŸ”’':'âœï¸'} v${vn} ${vn===STATE.teProdVer?'<span style="font-size:8px;padding:0 4px;border-radius:3px;background:rgba(34,197,94,0.15);color:#22c55e;margin-left:3px">PROD</span>':''}
          </button>`).join('')}
        <button class="btn-sm" style="background:rgba(139,92,246,0.12);color:#8b5cf6;border:none" data-action="openDup">ğŸ“‹ Duplicate</button>
        <div style="margin-left:auto;display:flex;gap:6px">
          <button class="btn-sm" style="background:${locked?'rgba(34,197,94,0.12)':'rgba(239,68,68,0.12)'};color:${locked?'#22c55e':'#ef4444'};border:none" data-action="toggleFreeze">${locked?'âœï¸ Mark draft':'ğŸ”’ Freeze'}</button>
          ${locked&&STATE.teActiveVer!==STATE.teProdVer?`<button class="btn-sm" style="background:rgba(34,197,94,0.12);color:#22c55e;border:none" data-action="setProd">ğŸš€ Set as PROD</button>`:''}
        </div>
      </div>
      ${locked?'<div class="te-frozen-banner">ğŸ”’ Tree locked â€” mark draft to edit</div>':''}
      <div class="te-tree">
        ${tree.map((g,gi)=>`
          <div style="margin-bottom:6px">
            <div class="te-grp-hdr" style="background:${g.color}08;border-left:3px solid ${g.color}">
              <span style="font-size:13px">${g.icon}</span>
              <span style="font-weight:700;color:${g.color};flex:1;font-size:11px" class="mono">${g.name}</span>
              ${g.level!==null?`<span class="badge" style="background:${g.color}15;color:${g.color}">L${g.level}</span>`:''}
              <span style="color:var(--muted);font-size:9px">${g.steps.length}</span>
              ${!locked?`<button style="background:none;border:none;color:#22c55e;cursor:pointer;font-size:12px;padding:0" data-action="addStep" data-gi="${gi}">+</button>`:''}
            </div>
            ${g.steps.map(s=>{
              const sn=getStepName(s);
              const hasEcn=!!ecn[s.sn];
              const isSel=sel?.sid===s.id;
              return `<div class="te-step ${isSel?'sel':''}" data-action="selStep" data-gid="${g.id}" data-sid="${s.id}" style="${isSel?'':'border:1px solid transparent'}">
                ${hasEcn?'<span style="font-size:9px">ğŸ”´</span>':''}
                <span style="font-weight:700;color:${g.color};min-width:24px;text-align:center;font-size:10px;background:${g.color}12;padding:1px 4px;border-radius:3px" class="mono">${s.sn||'â€”'}</span>
                <span style="font-size:9px;font-weight:600;color:${s.type==='PREP'?'#a855f7':s.type==='CHECK'?'#ec4899':'#3b82f6'}">${s.type}</span>
                <span style="flex:1;color:${sn?'var(--text)':'var(--dim)'};font-size:10px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${sn||'untitled'}</span>
                ${s.parts.length>0?`<span style="font-size:8px;color:#22c55e">${s.parts.length}P</span>`:''}
                ${s.fasteners.length>0?`<span style="font-size:8px;color:#ef4444">${s.fasteners.length}F</span>`:''}
              </div>`;
            }).join('')}
          </div>`).join('')}
        ${!locked?`<button class="btn-sm" style="width:100%;margin-top:8px;padding:8px;background:rgba(99,102,241,0.12);color:#6366f1;border:none" data-action="addGroup">+ Add Group</button>`:''}
      </div>
    </div>
    <div class="te-right">${rightPanel}</div>
  </div>
  ${STATE.dupModal?renderDupModal():''}`;
}

function renderDupModal(){
  return `<div class="dup-overlay" data-action="closeDup">
    <div class="dup-box" onclick="event.stopPropagation()">
      <div style="font-size:14px;font-weight:700;margin-bottom:10px" class="mono">ğŸ“‹ Duplicate v${STATE.teActiveVer}</div>
      <div style="font-size:10px;color:var(--muted);margin-bottom:12px">New version number:</div>
      <input class="inp" style="width:100%;margin-bottom:12px;font-size:14px;padding:8px 10px" placeholder="e.g. 6.0" data-role="dupVerInput" value="${STATE.dupVer}" autofocus>
      <div style="display:flex;gap:8px;justify-content:flex-end">
        <button class="btn-sm" style="background:transparent;color:var(--muted)" data-action="closeDup">Cancel</button>
        <button style="padding:6px 16px;border-radius:6px;font-size:11px;font-weight:700;background:#8b5cf6;border:none;color:#fff;cursor:pointer" data-action="doDuplicate">Create v${STATE.dupVer||'?'}</button>
      </div>
    </div>
  </div>`;
}

// ============================================================
// EVENT HANDLING
// ============================================================
function attachEvents(){
  document.querySelectorAll('[data-action]').forEach(el=>{
    el.onclick=e=>{
      const action=el.dataset.action;
      if(action==='editor'){STATE.page='editor';render();}
      else if(action==='assy'){const id=el.dataset.id;STATE.assembly=ASSEMBLIES.find(a=>a.id===id);STATE.page='unitSelect';STATE.unitSel=new Set();STATE.unitFilter='all';STATE.unitSearch='';render();}
      else if(action==='goHome'){STATE.page='home';render();}
      else if(action==='setFilter'){STATE.unitFilter=el.dataset.f;render();}
      else if(action==='selectAll'){const units=getUnits(STATE.assembly.id);let filtered=units;if(STATE.unitFilter==='outdated')filtered=filtered.filter(u=>u.status==='outdated');if(STATE.unitFilter==='current')filtered=filtered.filter(u=>u.status==='current');filtered.forEach(u=>STATE.unitSel.add(u.sn));render();}
      else if(action==='toggleUnit'){const sn=el.dataset.sn;STATE.unitSel.has(sn)?STATE.unitSel.delete(sn):STATE.unitSel.add(sn);render();}
      else if(action==='proceed'){const units=getUnits(STATE.assembly.id);STATE.selectedUnits=[...STATE.unitSel].map(sn=>units.find(u=>u.sn===sn)).filter(Boolean);STATE.applied=new Set();STATE.avTab='list';STATE.page='assembly';render();}
      else if(action==='backToUnits'){STATE.page='unitSelect';render();}
      else if(action==='avTab'){STATE.avTab=el.dataset.tab;render();}
      else if(action==='openChange'){STATE.modal=parseInt(el.dataset.idx);render();}
      else if(action==='closeModal'){STATE.modal=null;render();}
      else if(action==='toggleApply'){
        const unit=STATE.selectedUnits[0];const step=el.dataset.step;
        const k=`${unit.sn}-${step}`;STATE.applied.has(k)?STATE.applied.delete(k):STATE.applied.add(k);
        STATE.modal=null;render();
      }
      // Tree editor actions
      else if(action==='switchVer'){STATE.teActiveVer=el.dataset.ver;STATE.teSel=null;render();}
      else if(action==='toggleFreeze'){
        const v=STATE.teVersions[STATE.teActiveVer];
        v.status=v.status==='frozen'?'draft':'frozen';
        v.frozenAt=v.status==='frozen'?Date.now():null;
        toast(v.status==='frozen'?'ğŸ”’ Frozen':'âœï¸ Unlocked');render();
      }
      else if(action==='setProd'){STATE.teProdVer=STATE.teActiveVer;toast(`ğŸš€ Production â†’ v${STATE.teActiveVer}`);render();}
      else if(action==='openDup'){STATE.dupModal=true;STATE.dupVer='';render();}
      else if(action==='closeDup'){STATE.dupModal=false;render();}
      else if(action==='doDuplicate'){
        if(!STATE.dupVer||STATE.teVersions[STATE.dupVer])return;
        const cloned=JSON.parse(JSON.stringify(STATE.teVersions[STATE.teActiveVer]));
        const reID=t=>t.forEach(g=>{g.id=ID();g.steps.forEach(s=>{s.id=ID();s.parts.forEach(p=>p.id=ID());s.fasteners.forEach(f=>f.id=ID());});});
        reID(cloned.tree);
        STATE.teVersions[STATE.dupVer]={...cloned,status:'draft',frozenAt:null,createdFrom:STATE.teActiveVer};
        STATE.teActiveVer=STATE.dupVer;STATE.dupModal=false;STATE.teSel=null;
        toast(`ğŸ“‹ Created v${STATE.dupVer}`);render();
      }
      else if(action==='selStep'){STATE.teSel={gid:el.dataset.gid,sid:el.dataset.sid};render();}
      else if(action==='addStep'){
        const gi=parseInt(el.dataset.gi);
        STATE.teVersions[STATE.teActiveVer].tree[gi].steps.push({id:ID(),sn:'',type:'STEP',nameOverride:'',parts:[],fasteners:[]});render();
      }
      else if(action==='addGroup'){
        STATE.teVersions[STATE.teActiveVer].tree.push({id:ID(),name:'New Group',icon:'ğŸ“¦',color:'#6366f1',level:null,steps:[]});render();
      }
      else if(action==='toggleEcn'){
        const v=STATE.teVersions[STATE.teActiveVer];const sel=STATE.teSel;if(!sel)return;
        for(const g of v.tree){const s=g.steps.find(x=>x.id===sel.sid);if(s){
          const e={...v.ecn};if(e[s.sn])delete e[s.sn];else e[s.sn]={note:'',disposition:'scrap'};v.ecn=e;break;
        }}render();
      }
      else if(action==='setDisp'){
        const v=STATE.teVersions[STATE.teActiveVer];const sel=STATE.teSel;if(!sel)return;
        for(const g of v.tree){const s=g.steps.find(x=>x.id===sel.sid);if(s&&v.ecn[s.sn]){v.ecn[s.sn]={...v.ecn[s.sn],disposition:el.dataset.disp};break;}}render();
      }
      else if(action==='addPart'){
        const v=STATE.teVersions[STATE.teActiveVer];const sel=STATE.teSel;if(!sel)return;
        for(const g of v.tree){const s=g.steps.find(x=>x.id===sel.sid);if(s){s.parts.push({id:ID(),pn:'',name:'',qty:1});break;}}render();
      }
      else if(action==='delPart'){
        const pi=parseInt(el.dataset.pi);const v=STATE.teVersions[STATE.teActiveVer];const sel=STATE.teSel;if(!sel)return;
        for(const g of v.tree){const s=g.steps.find(x=>x.id===sel.sid);if(s){s.parts.splice(pi,1);break;}}render();
      }
      else if(action==='addFastener'){
        const v=STATE.teVersions[STATE.teActiveVer];const sel=STATE.teSel;if(!sel)return;
        for(const g of v.tree){const s=g.steps.find(x=>x.id===sel.sid);if(s){s.fasteners.push({id:ID(),code:'',torque:'',loctite:'',qty:1});break;}}render();
      }
      else if(action==='delFast'){
        const fi=parseInt(el.dataset.fi);const v=STATE.teVersions[STATE.teActiveVer];const sel=STATE.teSel;if(!sel)return;
        for(const g of v.tree){const s=g.steps.find(x=>x.id===sel.sid);if(s){s.fasteners.splice(fi,1);break;}}render();
      }
      e.stopPropagation();
    };
  });

  // Input handlers
  document.querySelectorAll('[data-role]').forEach(el=>{
    const role=el.dataset.role;
    if(role==='unitSearch'){el.oninput=()=>{STATE.unitSearch=el.value;render();};}
    if(role==='unitPicker'){el.onchange=()=>{const u=STATE.selectedUnits.find(x=>x.sn===el.value);if(u)STATE.selectedUnits=[u,...STATE.selectedUnits.filter(x=>x.sn!==u.sn)];render();};}
    if(role==='dupVerInput'){el.oninput=()=>{STATE.dupVer=el.value;/* Don't re-render fully, just update button text */};}
    // Tree editor inputs
    if(role==='teStepSn'){el.oninput=()=>{const v=STATE.teVersions[STATE.teActiveVer];const sel=STATE.teSel;if(!sel)return;for(const g of v.tree){const s=g.steps.find(x=>x.id===sel.sid);if(s){s.sn=el.value;break;}}};}
    if(role==='teStepType'){el.onchange=()=>{const v=STATE.teVersions[STATE.teActiveVer];const sel=STATE.teSel;if(!sel)return;for(const g of v.tree){const s=g.steps.find(x=>x.id===sel.sid);if(s){s.type=el.value;break;}}};}
    if(role==='teEcnNote'){el.oninput=()=>{const v=STATE.teVersions[STATE.teActiveVer];const sel=STATE.teSel;if(!sel)return;for(const g of v.tree){const s=g.steps.find(x=>x.id===sel.sid);if(s&&v.ecn[s.sn]){v.ecn[s.sn]={...v.ecn[s.sn],note:el.value};break;}}};}
    // Part/fastener inline edits
    if(role?.startsWith('part')||role?.startsWith('fast')){
      el.oninput=()=>{
        const v=STATE.teVersions[STATE.teActiveVer];const sel=STATE.teSel;if(!sel)return;
        for(const g of v.tree){const s=g.steps.find(x=>x.id===sel.sid);if(s){
          if(role==='partPn'){const pi=parseInt(el.dataset.pi);s.parts[pi].pn=el.value;const n=MASTER[el.value.toUpperCase().trim()];if(n)s.parts[pi].name=n;}
          if(role==='partName'){s.parts[parseInt(el.dataset.pi)].name=el.value;}
          if(role==='partQty'){s.parts[parseInt(el.dataset.pi)].qty=parseInt(el.value)||1;}
          if(role==='fastCode'){s.fasteners[parseInt(el.dataset.fi)].code=el.value;}
          if(role==='fastTorque'){s.fasteners[parseInt(el.dataset.fi)].torque=el.value;}
          if(role==='fastLoc'){s.fasteners[parseInt(el.dataset.fi)].loctite=el.value;}
          if(role==='fastQty'){s.fasteners[parseInt(el.dataset.fi)].qty=parseInt(el.value)||1;}
          break;
        }}
      };
    }
  });
}

// Initial render
render();
</script>
</body>
</html>

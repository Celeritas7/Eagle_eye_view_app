<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EagleEye ‚Äî Assembly Tracking</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700;800&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#0a0b0f;--card:#12131a;--hover:#1a1c24;--modal:#15161e;
  --border:#1e2030;--text:#d1d5e4;--muted:#6b7080;--dim:#3a3d4d;
  --accent:#f59e0b;--purple:#8b5cf6;
  --red:#ef4444;--green:#22c55e;--blue:#3b82f6;--orange:#f97316;--pink:#ec4899;--cyan:#06b6d4;
}
body{font-family:'DM Sans',system-ui,sans-serif;background:var(--bg);color:var(--text);min-height:100vh;font-size:12px}
::-webkit-scrollbar{width:4px}::-webkit-scrollbar-track{background:var(--bg)}::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px}
select option{background:var(--card);color:var(--text)}
input[type=number]::-webkit-inner-spin-button,input[type=number]::-webkit-outer-spin-button{-webkit-appearance:none}
.mono{font-family:'JetBrains Mono',monospace}
.badge{padding:1px 6px;border-radius:6px;font-size:9px;font-weight:700;font-family:'JetBrains Mono',monospace;display:inline-block}
.btn-sm{padding:3px 10px;border-radius:6px;font-size:10px;font-weight:700;border:1px solid var(--border);cursor:pointer;font-family:'JetBrains Mono',monospace}
.btn-sm:hover{background:var(--hover)}
.inp{background:#0d0e14;border:1px solid var(--border);border-radius:5px;padding:4px 7px;color:var(--text);font-size:11px;font-family:'JetBrains Mono',monospace;outline:none}
.inp:focus{border-color:var(--accent)}
.loading-wrap{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:200px;color:var(--muted)}
.spinner{width:24px;height:24px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin 0.8s linear infinite;margin-bottom:12px}
@keyframes spin{to{transform:rotate(360deg)}}
.error-banner{margin:16px 24px;padding:12px 16px;border-radius:8px;background:rgba(239,68,68,0.08);border:1px solid rgba(239,68,68,0.15);color:var(--red);font-size:12px;max-width:780px;width:100%}

/* HOME */
.home-wrap{min-height:100vh;display:flex;flex-direction:column;align-items:center}
.home-admin{position:fixed;top:10px;right:14px;display:flex;align-items:center;gap:6px;z-index:10}
.admin-pill{display:flex;align-items:center;gap:4px;padding:4px 10px;border-radius:6px;background:rgba(245,158,11,0.08);border:1px solid rgba(245,158,11,0.2);font-size:10px;font-weight:600;color:var(--accent);font-family:'JetBrains Mono',monospace}
.home-hero{text-align:center;padding-top:50px;margin-bottom:28px}
.home-logo{font-size:42px;font-weight:900;color:var(--accent);font-family:'JetBrains Mono',monospace;letter-spacing:-2px;line-height:1}
.home-sub{font-size:13px;color:var(--muted);margin-top:8px}
.section-label{font-family:'JetBrains Mono',monospace;font-size:10px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--dim);margin-bottom:10px}
.assy-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(170px,1fr));gap:8px;max-width:780px;width:100%;padding:0 20px 40px}
.assy-card{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:12px 14px;cursor:pointer;transition:all 0.15s}
.assy-card:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,0.3)}
.full-robot-card{background:var(--card);border:2px solid rgba(34,197,94,0.25);border-radius:10px;padding:14px 16px;cursor:pointer;transition:all 0.2s;max-width:280px}
.full-robot-card:hover{border-color:var(--green);transform:translateY(-2px)}

/* UNIT SELECT */
.us-filter{padding:4px 10px;border-radius:6px;font-size:10px;font-weight:600;cursor:pointer;border:1px solid var(--border);background:transparent;color:var(--muted);text-transform:capitalize;font-family:'DM Sans',sans-serif}
.us-filter.active{border:none}
.us-filter[data-f="all"].active{background:rgba(245,158,11,0.15);color:var(--accent)}
.us-filter[data-f="outdated"].active{background:rgba(239,68,68,0.15);color:var(--red)}
.us-filter[data-f="current"].active{background:rgba(34,197,94,0.15);color:var(--green)}
.unit-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(125px,1fr));gap:4px;max-height:380px;overflow-y:auto;padding:2px}
.unit-card{padding:6px 8px;border-radius:6px;cursor:pointer;border:1px solid var(--border);background:var(--card);transition:all 0.1s;position:relative}
.unit-card.selected{border:2px solid var(--accent);background:rgba(245,158,11,0.03)}

/* ASSEMBLY VIEW */
.av-header{display:flex;align-items:center;gap:12px;padding:12px 24px;border-bottom:1px solid var(--border);background:#0e0f15;position:sticky;top:0;z-index:10;flex-wrap:wrap}
.av-tabs{display:flex;align-items:center;gap:0;padding:0 24px;border-bottom:1px solid var(--border);background:#0e0f15}
.av-tab{display:flex;align-items:center;gap:6px;padding:14px 22px;font-size:16px;font-weight:500;color:var(--muted);background:transparent;border:none;cursor:pointer;border-bottom:2px solid transparent;font-family:'DM Sans',sans-serif}
.av-tab.active{font-weight:700;color:var(--accent);border-bottom-color:var(--accent)}
.av-tab .count{font-size:11px;font-weight:700;padding:2px 7px;border-radius:6px;background:rgba(239,68,68,0.15);color:var(--red);font-family:'JetBrains Mono',monospace}
.av-tab .soon{font-size:10px;font-weight:700;padding:2px 7px;border-radius:4px;background:rgba(58,61,77,0.25);color:var(--dim);font-family:'JetBrains Mono',monospace}
.ecn-banner{margin:16px 24px 0;padding:14px 18px;border-radius:10px;background:rgba(239,68,68,0.04);border:1px solid rgba(239,68,68,0.1)}
.ecn-item{display:flex;align-items:center;gap:12px;padding:12px 16px;border-radius:8px;cursor:pointer;margin-bottom:5px;border:1px solid var(--border);background:var(--card);transition:all 0.1s;font-size:15px}
.ecn-item:hover{border-color:var(--muted)}
.ecn-item.done{background:rgba(34,197,94,0.04);border-color:rgba(34,197,94,0.1)}
.tree-list{padding:0 24px 24px}
.grp-hdr{display:flex;align-items:center;gap:10px;padding:12px 14px;border-radius:8px;cursor:pointer;margin-top:8px}
.grp-hdr:hover{background:rgba(255,255,255,0.02)}
.step-row{display:flex;align-items:center;gap:14px;padding:10px 14px 10px 28px;cursor:pointer;border-radius:6px;font-size:15px}
.step-row:hover{background:rgba(255,255,255,0.02)}

/* TREE EDITOR */
.te-wrap{display:flex;height:100vh;overflow:hidden}
.te-left{flex:1;display:flex;flex-direction:column;overflow:hidden}
.te-right{width:400px;border-left:1px solid var(--border);background:var(--card);overflow-y:auto;padding:16px}
.te-topbar{padding:10px 16px;border-bottom:1px solid var(--border);background:#0e0f15;display:flex;align-items:center;gap:10px;flex-wrap:wrap}
.te-verbar{padding:8px 16px;border-bottom:1px solid var(--border);background:#0c0d12;display:flex;align-items:center;gap:6px;flex-wrap:wrap}
.te-ver-pill{padding:4px 12px;border-radius:6px;font-size:11px;font-weight:700;cursor:pointer;font-family:'JetBrains Mono',monospace;border:1px solid var(--border);background:transparent;color:var(--muted);transition:all 0.15s}
.te-ver-pill:hover{border-color:var(--muted)}
.te-ver-pill.active{background:rgba(139,92,246,0.15);border-color:rgba(139,92,246,0.4);color:#a78bfa}
.te-ver-pill.frozen{opacity:0.6}
.te-frozen-bar{padding:6px 16px;background:rgba(239,68,68,0.06);border-bottom:1px solid rgba(239,68,68,0.1);font-size:11px;color:var(--red);font-weight:700;text-align:center;display:flex;align-items:center;justify-content:center;gap:8px}
.te-pick-wrap{min-height:100vh;display:flex;flex-direction:column;align-items:center;padding:50px 24px}
.te-pick-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:14px;max-width:760px;width:100%}
.te-pick-card{background:var(--card);border:2px solid var(--border);border-radius:14px;padding:24px;cursor:pointer;transition:all 0.2s;text-align:center}
.te-pick-card:hover{transform:translateY(-3px);border-color:var(--purple);box-shadow:0 8px 24px rgba(139,92,246,0.12)}
.te-tree{flex:1;overflow-y:auto;padding:8px 12px}
.te-grp{display:flex;align-items:center;gap:8px;padding:10px 12px;border-radius:8px;margin-top:4px}
.te-grp:hover{background:rgba(255,255,255,0.015)}
.te-step{display:flex;align-items:center;gap:8px;padding:8px 10px 8px 28px;cursor:pointer;border-radius:6px;margin:2px 0;font-size:14px}
.te-step.sel{background:rgba(139,92,246,0.08);border:1px solid rgba(139,92,246,0.2)}
.dp-label{font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px}
.dp-row{display:flex;gap:4px;align-items:center;margin-bottom:4px;padding:6px 8px;border-radius:6px;border:1px solid var(--border)}
.dp-section{margin-bottom:16px;padding-bottom:14px;border-bottom:1px solid var(--border)}
.dp-section:last-child{border-bottom:none}

/* ECN Controls */
.ecn-disp-btn{padding:5px 10px;border-radius:5px;font-size:10px;font-weight:700;cursor:pointer;font-family:'JetBrains Mono',monospace;border:1px solid var(--border);background:transparent;color:var(--muted);transition:all 0.15s}
.ecn-disp-btn:hover{opacity:0.8}
.ecn-disp-btn.active{border-color:transparent}

/* MODAL */
.cm-overlay{position:fixed;inset:0;z-index:100;background:rgba(0,0,0,0.65);backdrop-filter:blur(4px);display:flex;align-items:center;justify-content:center}
.cm-box{background:var(--modal);border-radius:14px;width:min(520px,92vw);max-height:80vh;box-shadow:0 12px 40px rgba(0,0,0,0.6);border:1px solid var(--border);overflow:hidden;display:flex;flex-direction:column}
.confirm-overlay{position:fixed;inset:0;z-index:110;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center}
.confirm-box{background:var(--modal);border-radius:12px;width:380px;padding:24px;border:1px solid var(--border)}
.db-status{display:flex;align-items:center;gap:4px;padding:3px 8px;border-radius:5px;font-size:9px;font-weight:600;font-family:'JetBrains Mono',monospace}
.db-status.ok{background:rgba(34,197,94,0.1);color:#22c55e}
.db-status.err{background:rgba(239,68,68,0.1);color:#ef4444}
.db-status.load{background:rgba(245,158,11,0.1);color:#f59e0b}
</style>
</head>
<body>
<div id="app"></div>
<script>
// ============================================================
// CONFIG
// ============================================================
const SUPABASE_URL = 'https://wylxvmkcrexwfpjpbhyy.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind5bHh2bWtjcmV4d2ZwanBiaHl5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg2MzkxMDYsImV4cCI6MjA4NDIxNTEwNn0.6Bxo42hx4jwlJGWnfjiTpiDUsYfc1QLTN3YtrU1efak';
const GSHEET_ID = '1mUhNDzucbHpS2y-IYu3A5ML1x5I_opUeNnqqyOtg95M';

const ASSY_META = {
  'GST_assy':  {icon:'ü§ñ',color:'#22c55e',section:'full',  name:'Ghost (Full Robot)'},
  'MBB_assy':  {icon:'üèóÔ∏è',color:'#22c55e',                 name:'Mobile Base'},
  'PLR_assy':  {icon:'üóº',color:'#ec4899',                  name:'Pillar'},
  'HBD_assy':  {icon:'ü§ñ',color:'#f97316',                  name:'Head & Body'},
  'GPR_assy':  {icon:'ü§è',color:'#06b6d4',                  name:'Gripper'},
  'ARM_assy':  {icon:'üí™',color:'#3b82f6',                  name:'Arm'},
  'LAC_assy':  {icon:'‚ö°',color:'#eab308',                  name:'L-Motor'},
  'A12_assy':  {icon:'üî©',color:'#a855f7',                  name:'A12-Motor'},
  'A35_assy':  {icon:'üîß',color:'#f43f5e',                  name:'A35-Motor'},
  'A4A_assy':  {icon:'‚öôÔ∏è',color:'#14b8a6',                  name:'A4-Motor'},
};

const GS_SHEET_MAP = {
  'GST_assy':'00_GHOST','MBB_assy':'05_Mobile Base','PLR_assy':'06_Pillar',
  'HBD_assy':'07_Head & Body','GPR_assy':'08_Gripper','ARM_assy':'09_Arm',
  'LAC_assy':'01_L-motor','A12_assy':'02_A12-motor','A35_assy':'03_A35-motor','A4A_assy':'04_A4-motor',
};
const GS_COL = {
  'GST_assy':{sn:1,done:6},'MBB_assy':{sn:1,done:8},'PLR_assy':{sn:1,done:7},
  'HBD_assy':{sn:1,done:8},'GPR_assy':{sn:1,done:8},'ARM_assy':{sn:1,done:9},
  'LAC_assy':{sn:1,done:8},'A12_assy':{sn:1,done:8},'A35_assy':{sn:1,done:8},'A4A_assy':{sn:1,done:8},
};

const ECN_DISPOSITIONS = {
  reuse:   {label:'REUSE',   color:'#3b82f6', icon:'‚ôªÔ∏è', bg:'rgba(59,130,246,0.12)'},
  scrap:   {label:'SCRAP',   color:'#ef4444', icon:'üóëÔ∏è', bg:'rgba(239,68,68,0.12)'},
  rework:  {label:'REWORK',  color:'#f59e0b', icon:'üîß', bg:'rgba(245,158,11,0.12)'},
};

const GROUP_COLORS = ['#8b5cf6','#10b981','#f59e0b','#ef4444','#06b6d4','#ec4899','#6366f1','#f97316','#a855f7','#14b8a6'];
const GROUP_ICONS = ['üì¶','üîß','‚ö°','üî©','‚öôÔ∏è','üîå','üõ°Ô∏è','üèóÔ∏è','üéØ','üî¨','üí°','üîã','üß≤','üîó','üìê'];

// ============================================================
// SUPABASE REST
// ============================================================
const hdrs=()=>({'apikey':SUPABASE_KEY,'Authorization':`Bearer ${SUPABASE_KEY}`,'Content-Type':'application/json','Prefer':'return=representation'});
async function sbGet(t,q=''){const r=await fetch(`${SUPABASE_URL}/rest/v1/${t}?${q}`,{headers:hdrs()});if(!r.ok)throw new Error(`GET ${t}: ${r.status}`);return r.json();}
async function sbPost(t,d){const r=await fetch(`${SUPABASE_URL}/rest/v1/${t}`,{method:'POST',headers:hdrs(),body:JSON.stringify(d)});if(!r.ok)throw new Error(`POST ${t}: ${r.status} ${await r.text()}`);return r.json();}
async function sbPatch(t,q,d){const r=await fetch(`${SUPABASE_URL}/rest/v1/${t}?${q}`,{method:'PATCH',headers:hdrs(),body:JSON.stringify(d)});if(!r.ok)throw new Error(`PATCH ${t}: ${r.status}`);return r.json();}
async function sbDelete(t,q){const r=await fetch(`${SUPABASE_URL}/rest/v1/${t}?${q}`,{method:'DELETE',headers:hdrs()});if(!r.ok)throw new Error(`DELETE ${t}: ${r.status}`);}

// ============================================================
// GOOGLE SHEETS (fallback)
// ============================================================
function gsCsvUrl(s){return `https://docs.google.com/spreadsheets/d/${GSHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(s)}`;}
function parseCSV(t){const rows=[];let cur='',inQ=false;for(let i=0;i<t.length;i++){const c=t[i];if(c==='"'){if(inQ&&t[i+1]==='"'){cur+='"';i++;}else inQ=!inQ;}else if(c===','&&!inQ){rows.length===0?rows.push([cur]):rows[rows.length-1].push(cur);cur='';}else if((c==='\n'||c==='\r')&&!inQ){if(cur||rows[rows.length-1]){rows.length===0?rows.push([cur]):rows[rows.length-1].push(cur);}cur='';if(c==='\r'&&t[i+1]==='\n')i++;rows.push([]);}else cur+=c;}if(cur){if(!rows.length)rows.push([]);rows[rows.length-1].push(cur);}return rows.filter(r=>r.length>0&&r.some(c=>c.trim()));}
async function fetchGSheetUnits(tag){const sheet=GS_SHEET_MAP[tag],cols=GS_COL[tag];if(!sheet||!cols)return null;try{const res=await fetch(gsCsvUrl(sheet));if(!res.ok)throw new Error(res.status);const rows=parseCSV(await res.text()),units=[];for(let i=3;i<rows.length;i++){const r=rows[i],sn=(r[cols.sn]||'').trim().replace(/^"|"$/g,'');if(!sn||sn.startsWith('FXCN')||sn.startsWith('Á§æÂÜÖ'))continue;const done=cols.done!==null?(r[cols.done]||'').trim().replace(/^"|"$/g,''):'';units.push({sn,completed:done&&done!=='FALSE'?done:null,status:done&&done!=='FALSE'?'current':'pending'});}return units;}catch(e){console.warn('GSheet:',e);return null;}}

// ============================================================
// DATA STORE
// ============================================================
const DB = {
  assemblies:[], units:{}, tree:{}, ecnChanges:{}, ecnApplied:{}, versions:{},
  masterParts:new Map(),
  status:'loading', gsStatus:'unknown', errors:[],

  async init(){
    this.status='loading';render();
    try{
      const[assemblies]=await Promise.all([
        sbGet('eagle_eye_app_assemblies','order=id'),
        this.loadMasterParts(),
      ]);
      this.assemblies=assemblies;
      this.assemblies.forEach(a=>{const m=ASSY_META[a.tag]||{icon:'üì¶',color:'#6366f1',name:a.tag};a.icon=m.icon;a.color=m.color;a.section=m.section||null;a.name=m.name||a.tag;});
      this.status='ok';
    }catch(e){console.error('Init:',e);this.status='err';this.errors.push(e.message);}
    render();
  },

  async loadMasterParts(){
    try{
      const rows=await sbGet('master_parts_list_all','select=pn,name,category&limit=10000');
      rows.forEach(r=>{if(r.pn)this.masterParts.set(r.pn.trim(),{name:(r.name||'').trim(),category:(r.category||'').trim()});});
      console.log(`Master parts: ${this.masterParts.size} loaded`);
    }catch(e){console.warn('Master parts load:',e);}
  },

  lookupPN(pn){
    if(!pn)return null;
    const hit=this.masterParts.get(pn.trim());
    return hit?hit.name:null;
  },

  async loadUnits(assemblyId,assyTag){
    if(this.units[assemblyId])return this.units[assemblyId];
    try{
      const rows=await sbGet('eagle_eye_app_production_units',`assembly_id=eq.${assemblyId}&order=sn`);
      if(rows.length>0){this.units[assemblyId]=rows.map(r=>({sn:r.sn,version:r.version,latestVer:r.latest_version,status:r.status||'current',notes:r.notes,assignedTo:r.assigned_to,completed:r.status==='current'?'yes':null}));this.gsStatus='db';return this.units[assemblyId];}
    }catch(e){console.error('DB units:',e);}
    try{const gs=await fetchGSheetUnits(assyTag);if(gs&&gs.length>0){this.gsStatus='gs';this.units[assemblyId]=gs;return this.units[assemblyId];}}catch(e){}
    this.gsStatus='err';this.units[assemblyId]=[];return[];
  },

  async loadTree(assemblyId){
    const key=`${assemblyId}`;
    if(this.tree[key])return this.tree[key];
    try{
      const groups=await sbGet('eagle_eye_app_groups',`assembly_id=eq.${assemblyId}&order=sort_order`);
      if(groups.length===0){this.tree[key]={groups:[],steps:[],partsMap:{},fastMap:{}};return this.tree[key];}
      const gids=groups.map(g=>g.id);
      const steps=await sbGet('eagle_eye_app_steps',`group_id=in.(${gids.join(',')})&order=sort_order`);
      steps.forEach(s=>{if(s.type)s.type=s.type.toUpperCase();});
      const sids=steps.map(s=>s.id);
      let parts=[],fasteners=[];
      if(sids.length>0)[parts,fasteners]=await Promise.all([sbGet('eagle_eye_app_parts',`step_id=in.(${sids.join(',')})&order=sort_order`),sbGet('eagle_eye_app_fasteners',`step_id=in.(${sids.join(',')})&order=sort_order`)]);
      const partsMap={},fastMap={};
      parts.forEach(p=>{if(!partsMap[p.step_id])partsMap[p.step_id]=[];partsMap[p.step_id].push(p);});
      fasteners.forEach(f=>{if(!fastMap[f.step_id])fastMap[f.step_id]=[];fastMap[f.step_id].push(f);});
      this.tree[key]={groups,steps,partsMap,fastMap};
    }catch(e){console.error('Tree:',e);this.tree[key]={groups:[],steps:[],partsMap:{},fastMap:{}};}
    return this.tree[key];
  },

  invalidateTree(aid){delete this.tree[`${aid}`];},

  async loadEcnChanges(aid){
    if(this.ecnChanges[aid])return this.ecnChanges[aid];
    try{
      const groups=await sbGet('eagle_eye_app_groups',`assembly_id=eq.${aid}&select=id`);if(groups.length===0){this.ecnChanges[aid]=[];return[];}
      const steps=await sbGet('eagle_eye_app_steps',`group_id=in.(${groups.map(g=>g.id).join(',')})&select=id`);if(steps.length===0){this.ecnChanges[aid]=[];return[];}
      this.ecnChanges[aid]=await sbGet('eagle_eye_app_ecn_change_records',`step_id=in.(${steps.map(s=>s.id).join(',')})&order=created_at`);
    }catch(e){console.error('ECN:',e);this.ecnChanges[aid]=[];}
    return this.ecnChanges[aid];
  },

  async loadEcnApplied(sn){try{(await sbGet('eagle_eye_app_ecn_applications',`unit_sn=eq.${sn}`)).forEach(r=>{this.ecnApplied[`${r.unit_sn}-${r.seq_tag}`]=r;});}catch(e){}},
  isApplied(sn,seq){return this.ecnApplied[`${sn}-${seq}`]?.applied===true;},

  async toggleApplied(sn,seq,sid){
    const k=`${sn}-${seq}`,ex=this.ecnApplied[k];
    if(ex?.applied){await sbPatch('eagle_eye_app_ecn_applications',`id=eq.${ex.id}`,{applied:false,applied_at:null});ex.applied=false;}
    else if(ex){await sbPatch('eagle_eye_app_ecn_applications',`id=eq.${ex.id}`,{applied:true,applied_at:new Date().toISOString(),applied_by:'Aniket'});ex.applied=true;}
    else{const[row]=await sbPost('eagle_eye_app_ecn_applications',[{unit_sn:sn,step_id:sid,seq_tag:seq,applied:true,applied_by:'Aniket',applied_at:new Date().toISOString()}]);this.ecnApplied[k]=row;}
  },

  async loadVersions(aid){
    if(this.versions[aid])return this.versions[aid];
    try{this.versions[aid]=await sbGet('eagle_eye_app_version_history',`assembly_id=eq.${aid}&order=created_at`);}catch(e){this.versions[aid]=[];}
    return this.versions[aid];
  },

  // --- WRITES ---
  async addStep(gid,d){const[r]=await sbPost('eagle_eye_app_steps',[{group_id:gid,...d}]);return r;},
  async updateStep(sid,d){return(await sbPatch('eagle_eye_app_steps',`id=eq.${sid}`,d))[0];},
  async deleteStep(sid){
    // Delete parts, fasteners, then step
    await sbDelete('eagle_eye_app_parts',`step_id=eq.${sid}`);
    await sbDelete('eagle_eye_app_fasteners',`step_id=eq.${sid}`);
    await sbDelete('eagle_eye_app_steps',`id=eq.${sid}`);
  },
  async addGroup(aid,ver,d){const[r]=await sbPost('eagle_eye_app_groups',[{assembly_id:aid,version:ver,...d}]);return r;},
  async updateGroup(gid,d){return(await sbPatch('eagle_eye_app_groups',`id=eq.${gid}`,d))[0];},
  async deleteGroup(gid){
    // Delete all steps in group (and their parts/fasteners)
    const steps=await sbGet('eagle_eye_app_steps',`group_id=eq.${gid}&select=id`);
    for(const s of steps){await this.deleteStep(s.id);}
    await sbDelete('eagle_eye_app_groups',`id=eq.${gid}`);
  },
  async addPart(sid,d){const[r]=await sbPost('eagle_eye_app_parts',[{step_id:sid,...d}]);return r;},
  async deletePart(pid){await sbDelete('eagle_eye_app_parts',`id=eq.${pid}`);},
  async addFastener(sid,d){const[r]=await sbPost('eagle_eye_app_fasteners',[{step_id:sid,...d}]);return r;},
  async deleteFastener(fid){await sbDelete('eagle_eye_app_fasteners',`id=eq.${fid}`);},
  async updatePart(pid,d){await sbPatch('eagle_eye_app_parts',`id=eq.${pid}`,d);},
  async updateFastener(fid,d){await sbPatch('eagle_eye_app_fasteners',`id=eq.${fid}`,d);},

  // --- ECN WRITES ---
  async createEcnChangeRecord(d){const[r]=await sbPost('eagle_eye_app_ecn_change_records',[d]);return r;},
  async updateEcnChangeRecord(id,d){await sbPatch('eagle_eye_app_ecn_change_records',`id=eq.${id}`,d);},
  async deleteEcnChangeRecord(id){await sbDelete('eagle_eye_app_ecn_change_records',`id=eq.${id}`);},
  async createEcnLog(d){const[r]=await sbPost('eagle_eye_app_ecn_log',[d]);return r;},

  // --- VERSION WRITES ---
  async createVersion(aid,ver,notes){
    const[r]=await sbPost('eagle_eye_app_version_history',[{assembly_id:aid,version:ver,notes:notes||null,created_by:'Aniket'}]);
    delete this.versions[aid];
    return r;
  },
  async updateAssemblyVersion(aid,ver){
    await sbPatch('eagle_eye_app_assemblies',`id=eq.${aid}`,{version:ver,updated_at:new Date().toISOString()});
    const a=this.assemblies.find(x=>x.id===aid);if(a)a.version=ver;
  },
};

// ============================================================
// HELPERS
// ============================================================
function toast(msg,err){const c=document.createElement('div');c.style.cssText=`position:fixed;bottom:16px;left:50%;transform:translateX(-50%);padding:6px 16px;border-radius:6px;background:${err?'#ef4444':'#22c55e'};color:${err?'#fff':'#000'};font-weight:700;font-size:10px;z-index:999;font-family:'JetBrains Mono',monospace;max-width:400px;text-align:center`;c.textContent=msg;document.body.appendChild(c);setTimeout(()=>c.remove(),2500);}
function stepsForGroup(tree,gid){return tree.steps.filter(s=>s.group_id===gid);}
function partsForStep(tree,sid){return tree.partsMap[sid]||[];}
function fastenersForStep(tree,sid){return tree.fastMap[sid]||[];}
function dbStatus(){
  const s=DB.status,g=DB.gsStatus,m=DB.masterParts.size;
  return `<div style="display:flex;gap:4px">
    <div class="db-status ${s==='ok'?'ok':s==='err'?'err':'load'}" title="Supabase: ${s}">${s==='ok'?'‚óè':'‚óã'} DB</div>
    ${g==='db'?'<div class="db-status ok" title="Units from DB">‚óè Units</div>':g==='gs'?'<div class="db-status ok" title="Units from GSheets">‚óè GS</div>':''}
    ${m>0?`<div class="db-status ok" title="${m} master parts loaded">‚óè ${m} Parts</div>`:''}
  </div>`;
}

// ============================================================
// STATE
// ============================================================
const S = {
  page:'home', assy:null, unitSel:new Set(), unitFilter:'all', unitSearch:'',
  selectedUnits:[], avTab:'list', modal:null, loadingUnits:false,
  // Tree editor
  teAssy:null, teVer:null, teSel:null, teSelGroup:null,
  teVersions:[], teFrozen:false,
  // Modals
  confirmAction:null, confirmMsg:'', confirmData:null,
  newVerModal:false, newVerStr:'', newVerNotes:'',
  // ECN marks: { [stepId]: { note:'', disposition:'scrap' } }
  teEcnMarks:{},
  // Manual part/fastener names: { [id]: 'name' }
  partNames:{}, fastNames:{},
};

// ============================================================
// RENDER ENGINE
// ============================================================
function render(){
  const app=document.getElementById('app');
  if(S.page==='home') app.innerHTML=renderHome();
  else if(S.page==='unitSelect') app.innerHTML=renderUnitSelect();
  else if(S.page==='assembly') app.innerHTML=renderAssembly();
  else if(S.page==='editor') app.innerHTML=renderEditor();
  // Overlays
  if(S.confirmAction) app.innerHTML+=renderConfirmModal();
  if(S.newVerModal) app.innerHTML+=renderNewVersionModal();
  attachEvents();
}

// ============================================================
// HOME
// ============================================================
function renderHome(){
  const full=DB.assemblies.filter(a=>a.section==='full'), majors=DB.assemblies.filter(a=>a.section!=='full');
  return `<div class="home-wrap">
    <div class="home-admin">${dbStatus()}<div class="admin-pill">üîß Admin ¬∑ Aniket</div>
      <button class="btn-sm" style="background:rgba(139,92,246,0.12);color:#8b5cf6;border:1px solid rgba(139,92,246,0.25)" data-action="editor">üîß Tree Editor</button>
      <div style="width:20px;height:20px;border-radius:50%;background:linear-gradient(135deg,#f59e0b,#e8952e);border:2px solid var(--border)"></div>
    </div>
    <div class="home-hero"><div class="home-logo">‚óà EagleEye</div><div class="home-sub">Assembly version tracking & ECN management</div></div>
    ${DB.errors.length?`<div class="error-banner">${DB.errors.map(e=>`‚ö† ${e}`).join('<br>')}</div>`:''}
    ${DB.status==='loading'?'<div class="loading-wrap"><div class="spinner"></div>Connecting to database...</div>':`
    ${full.length?`<div style="max-width:780px;width:100%;padding:0 20px"><div class="section-label">FULL ROBOT</div></div>
    <div style="max-width:780px;width:100%;padding:0 20px;margin-bottom:28px">${full.map(a=>`<div class="full-robot-card" data-action="assy" data-id="${a.id}"><div style="font-size:28px;margin-bottom:6px">${a.icon}</div><div style="font-size:15px;font-weight:700;display:flex;align-items:center;gap:8px">${a.name} <span class="badge" style="background:rgba(34,197,94,0.12);color:#22c55e">v${a.version}</span></div></div>`).join('')}</div>`:''}
    <div style="max-width:780px;width:100%;padding:0 20px"><div class="section-label">MAJOR ASSEMBLIES</div></div>
    <div class="assy-grid">${majors.map(a=>`<div class="assy-card" style="border-left:3px solid ${a.color}" data-action="assy" data-id="${a.id}"><div style="display:flex;align-items:center;gap:6px;margin-bottom:6px"><span style="font-size:18px">${a.icon}</span><span style="font-size:13px;font-weight:700">${a.name}</span></div><span class="badge" style="background:${a.color}15;color:${a.color}">v${a.version}</span></div>`).join('')}</div>`}
  </div>`;
}

// ============================================================
// UNIT SELECT
// ============================================================
function renderUnitSelect(){
  const a=S.assy, units=DB.units[a.id]||[];
  let filtered=units;
  if(S.unitFilter==='outdated')filtered=filtered.filter(u=>u.status==='outdated');
  if(S.unitFilter==='current')filtered=filtered.filter(u=>u.status==='current'||u.status==='pending');
  if(S.unitSearch)filtered=filtered.filter(u=>u.sn.toLowerCase().includes(S.unitSearch.toLowerCase()));
  return `<div style="min-height:100vh;background:var(--bg);padding:16px"><div style="max-width:800px;margin:0 auto">
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:14px">
      <button class="btn-sm" style="background:transparent;color:var(--muted)" data-action="goHome">‚Üê Back</button>
      <span style="font-size:22px">${a.icon}</span>
      <div><div style="font-size:16px;font-weight:700">${a.name}</div><div style="font-size:10px;color:var(--muted)" class="mono">${units.length} units ¬∑ v${a.version} ${DB.gsStatus==='gs'?'<span style="color:#22c55e">‚óè Live from Google Sheets</span>':DB.gsStatus==='db'?'<span style="color:#22c55e">‚óè From Database</span>':DB.gsStatus==='err'?'<span style="color:#ef4444">‚óè No unit data found</span>':''}</div></div>
    </div>
    ${S.loadingUnits?'<div class="loading-wrap"><div class="spinner"></div>Loading units...</div>':`
    <div style="display:flex;gap:6px;margin-bottom:10px;flex-wrap:wrap;align-items:center">
      <input class="inp" style="width:150px" placeholder="Search S/N..." data-role="unitSearch" value="${S.unitSearch}">
      ${['all','outdated','current'].map(f=>`<button class="us-filter ${S.unitFilter===f?'active':''}" data-f="${f}" data-action="setFilter">${f}</button>`).join('')}
      <button class="btn-sm" style="margin-left:auto;background:transparent;color:var(--muted);font-size:9px" data-action="selectAll">Select all (${filtered.length})</button>
    </div>
    <div class="unit-grid">${filtered.map(u=>{const sel=S.unitSel.has(u.sn),out=u.status==='outdated';const needsUpgrade=u.version&&u.latestVer&&u.version!==u.latestVer;
      return `<div class="unit-card ${sel?'selected':''}" data-action="toggleUnit" data-sn="${u.sn}">
        ${sel?'<div style="position:absolute;top:4px;right:6px;font-size:10px;color:var(--accent)">‚úì</div>':''}
        <div style="font-size:11px;font-weight:700" class="mono">${u.sn}</div>
        <div style="display:flex;gap:3px;margin-top:2px;flex-wrap:wrap">
          <span class="badge" style="background:${out?'rgba(239,68,68,0.12)':u.completed?'rgba(34,197,94,0.12)':'rgba(245,158,11,0.12)'};color:${out?'#ef4444':u.completed?'#22c55e':'#f59e0b'}">${out?'outdated':u.completed?'done':'pending'}</span>
          ${u.version?`<span class="badge" style="background:${needsUpgrade?'rgba(239,68,68,0.12)':'rgba(107,112,128,0.08)'};color:${needsUpgrade?'#ef4444':'var(--muted)'}">v${u.version}</span>`:''}
        </div></div>`;}).join('')}</div>
    ${S.unitSel.size?`<div style="margin-top:10px;padding:8px 14px;border-radius:10px;background:rgba(245,158,11,0.04);border:1px solid rgba(245,158,11,0.15);display:flex;align-items:center;justify-content:space-between">
      <span style="font-weight:700;font-size:12px">${S.unitSel.size} selected</span>
      <button style="padding:6px 18px;border-radius:8px;font-size:12px;font-weight:700;border:none;color:#000;cursor:pointer;background:${a.color}" data-action="proceed">Open Assembly View ‚Üí</button>
    </div>`:''}`}
  </div></div>`;
}

// ============================================================
// ASSEMBLY VIEW
// ============================================================
function renderAssembly(){
  const a=S.assy, unit=S.selectedUnits[0]; if(!unit) return '';
  const tree=DB.tree[`${a.id}`];
  if(!tree) return '<div class="loading-wrap"><div class="spinner"></div>Loading tree...</div>';
  const ecnRecords=DB.ecnChanges[a.id]||[];
  const appliedCount=ecnRecords.filter(c=>DB.isApplied(unit.sn,c.seq_tag)).length;
  const allDone=ecnRecords.length>0&&ecnRecords.every(c=>DB.isApplied(unit.sn,c.seq_tag));
  const tab=S.avTab;
  const totalP=tree.steps.reduce((s,st)=>partsForStep(tree,st.id).length+s,0);
  const totalF=tree.steps.reduce((s,st)=>fastenersForStep(tree,st.id).length+s,0);

  let tabContent='';
  if(tab==='list'){
    let banner='';
    if(ecnRecords.length>0){
      banner=`<div class="ecn-banner">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px"><span style="font-size:15px;font-weight:700;color:#ef4444">‚ö† ${ecnRecords.length} ECN changes</span><span style="font-size:13px;color:var(--muted)" class="mono">${appliedCount}/${ecnRecords.length}</span></div>
        <div style="height:3px;border-radius:2px;background:rgba(239,68,68,0.1);overflow:hidden;margin-bottom:8px"><div style="height:100%;border-radius:2px;width:${ecnRecords.length?(appliedCount/ecnRecords.length)*100:0}%;background:${allDone?'#22c55e':'#f59e0b'}"></div></div>
        ${ecnRecords.map((c,i)=>{const done=DB.isApplied(unit.sn,c.seq_tag);const disp=ECN_DISPOSITIONS[c.disposition]||{};
          return `<div class="ecn-item ${done?'done':''}" data-action="openChange" data-idx="${i}">
            <span style="font-size:13px;font-weight:700;min-width:34px;text-align:center;padding:4px 8px;border-radius:6px;color:${done?'#22c55e':'#ef4444'};background:${done?'rgba(34,197,94,0.12)':'rgba(239,68,68,0.1)'}" class="mono">${c.seq_tag||'‚Äî'}</span>
            <span style="flex:1;font-size:14px;font-weight:500;${done?'opacity:0.5;text-decoration:line-through':''}">${c.step_name||''}</span>
            ${c.disposition?`<span style="font-size:10px;font-weight:700;padding:2px 8px;border-radius:4px;background:${disp.bg||'rgba(107,112,128,0.1)'};color:${disp.color||'var(--muted)'}">${(c.disposition||'').toUpperCase()}</span>`:''}
            <span style="font-size:13px;color:var(--muted)" class="mono">${c.field||c.change_type}</span>
            <span style="font-size:14px;color:${done?'#22c55e':'var(--dim)'}">${done?'‚úì':'‚óã'}</span>
          </div>`;}).join('')}
        ${allDone?`<div style="margin-top:10px;padding:14px;border-radius:10px;background:rgba(34,197,94,0.06);border:2px solid rgba(34,197,94,0.25);text-align:center"><div style="font-size:15px;font-weight:700;color:#22c55e">‚úÖ All changes applied for ${unit.sn}</div></div>`:''}
      </div>`;
    }
    let treeHtml='<div class="tree-list">';
    tree.groups.forEach(g=>{const gSteps=stepsForGroup(tree,g.id);
      treeHtml+=`<div style="margin-bottom:6px"><div class="grp-hdr" style="background:${g.color||'#666'}08;border-left:4px solid ${g.color||'#666'}"><span style="font-size:11px;color:var(--muted)">‚ñº</span><span style="font-size:16px">${g.icon||'üì¶'}</span><span style="font-weight:700;color:${g.color||'#666'};flex:1;font-size:15px">${g.label}</span><span style="color:var(--muted);font-size:13px" class="mono">${gSteps.length}</span></div>`;
      gSteps.forEach(s=>{const pts=partsForStep(tree,s.id),fts=fastenersForStep(tree,s.id),hasEcn=s.ecn_status==='changed'||ecnRecords.some(c=>c.step_id===s.id),done=DB.isApplied(unit.sn,s.seq_tag);
        treeHtml+=`<div class="step-row" style="${done?'opacity:0.4':''}"><span style="color:var(--dim);font-size:12px">‚†ø</span>${hasEcn?`<span style="font-size:10px">${done?'‚úÖ':'üî¥'}</span>`:''}
          <span style="font-weight:700;min-width:32px;text-align:center;font-size:13px;padding:3px 8px;border-radius:5px;background:${g.color||'#666'}15;color:${g.color||'#666'}" class="mono">${s.seq_tag||'‚Äî'}</span>
          <span style="font-size:12px;font-weight:600;padding:2px 8px;border-radius:4px;color:${s.type==='PREP'?'#a855f7':s.type==='CHECK'?'#ec4899':'#22c55e'};background:${s.type==='PREP'?'rgba(168,85,247,0.1)':s.type==='CHECK'?'rgba(236,72,153,0.1)':'rgba(34,197,94,0.1)'}">${s.type||'STEP'}</span>
          <span style="flex:1;font-size:14px">${s.label||s.pn||''}</span>
          ${pts.length?`<span style="font-size:12px;color:#22c55e;font-weight:600" class="mono">${pts.length}P</span>`:''}
          ${fts.length?`<span style="font-size:12px;color:#ef4444;font-weight:600" class="mono">${fts.length}F</span>`:''}
        </div>`;});
      treeHtml+='</div>';});
    treeHtml+='</div>';
    tabContent=banner+treeHtml;
  } else tabContent=`<div style="display:flex;flex-direction:column;align-items:center;padding:80px 20px;color:var(--dim)"><div style="font-size:40px;margin-bottom:12px;opacity:0.3">üîß</div><div style="font-size:20px;font-weight:700">${tab==='graph'?'Graph':'Kanban'} View</div><div style="font-size:13px;margin-top:6px">Coming soon</div></div>`;

  return `<div style="min-height:100vh;background:var(--bg)">
    <div class="av-header">
      <button style="background:none;border:1px solid var(--border);border-radius:8px;padding:6px 14px;color:var(--muted);cursor:pointer;font-size:13px" data-action="backToUnits">‚Üê Units</button>
      <span style="font-size:18px;font-weight:800;color:var(--accent)" class="mono">‚óà</span>
      <select class="inp" style="padding:6px 12px;font-size:14px;font-weight:600;min-width:200px" data-role="unitPicker">${S.selectedUnits.map(u=>`<option value="${u.sn}" ${u.sn===unit.sn?'selected':''}>${u.sn}</option>`).join('')}</select>
      <div style="margin-left:auto;display:flex;align-items:center;gap:8px">${dbStatus()}<div class="admin-pill">üîß Admin ¬∑ Aniket</div></div>
    </div>
    <div class="av-tabs">
      <button class="av-tab ${tab==='list'?'active':''}" data-action="avTab" data-tab="list">‚â° List ${ecnRecords.length-appliedCount>0?`<span class="count">${ecnRecords.length-appliedCount}</span>`:''}</button>
      <button class="av-tab ${tab==='graph'?'active':''}" data-action="avTab" data-tab="graph">‚óà Graph <span class="soon">SOON</span></button>
      <button class="av-tab ${tab==='kanban'?'active':''}" data-action="avTab" data-tab="kanban">‚ñ¶ Kanban <span class="soon">SOON</span></button>
      <div style="margin-left:auto;display:flex;gap:12px;font-size:13px;color:var(--muted)" class="mono"><span><span style="color:#22c55e;font-weight:700">${totalP}</span> parts</span><span><span style="color:#ef4444;font-weight:700">${totalF}</span> fasteners</span><span><span style="font-weight:700">${tree.steps.length}</span> steps</span></div>
    </div>
    ${tabContent}
  </div>${S.modal!==null?renderChangeModal():''}`;
}

function renderChangeModal(){
  const unit=S.selectedUnits[0],ecn=DB.ecnChanges[S.assy.id]||[],ch=ecn[S.modal];if(!ch)return'';
  const isDone=DB.isApplied(unit.sn,ch.seq_tag),disp=ECN_DISPOSITIONS[ch.disposition]||{};
  return `<div class="cm-overlay" data-action="closeModal"><div class="cm-box" onclick="event.stopPropagation()">
    <div style="padding:14px 18px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px">
      <span class="mono" style="font-size:14px;font-weight:700;padding:4px 10px;border-radius:6px;background:rgba(239,68,68,0.1);color:#ef4444">${ch.seq_tag||'‚Äî'}</span>
      <div style="flex:1"><div style="font-size:16px;font-weight:700">${ch.step_name||''}</div><div style="font-size:12px;color:var(--muted)">${ch.group_name||''} ¬∑ ${unit.sn}</div></div>
      <button style="background:none;border:none;color:var(--muted);font-size:18px;cursor:pointer" data-action="closeModal">‚úï</button>
    </div>
    <div style="padding:18px;overflow-y:auto;flex:1;display:flex;flex-direction:column;gap:14px">
      <div style="display:flex;gap:6px;flex-wrap:wrap">
        <span class="badge" style="background:rgba(139,92,246,0.1);color:#a78bfa;font-size:11px;padding:3px 10px">${ch.change_type||'modified'}</span>
        ${ch.disposition?`<span class="badge" style="background:${disp.bg||''};color:${disp.color||''};font-size:11px;padding:3px 10px">${disp.icon||''} ${(ch.disposition||'').toUpperCase()}</span>`:''}
      </div>
      <div style="display:flex;gap:8px">
        ${ch.old_value?`<div style="flex:1;padding:12px;border-radius:8px;background:rgba(239,68,68,0.04);border:1px solid rgba(239,68,68,0.08)"><div style="font-size:9px;font-weight:700;color:#ef4444;text-transform:uppercase;letter-spacing:1px;margin-bottom:4px">Before</div><div style="font-size:14px;font-weight:600" class="mono">${ch.old_value}</div></div>`:''}
        <div style="flex:1;padding:12px;border-radius:8px;background:rgba(34,197,94,0.04);border:1px solid rgba(34,197,94,0.08)"><div style="font-size:9px;font-weight:700;color:#22c55e;text-transform:uppercase;letter-spacing:1px;margin-bottom:4px">${ch.old_value?'After':'New'}</div><div style="font-size:14px;font-weight:600" class="mono">${ch.new_value||''}</div></div>
      </div>
      ${ch.reason?`<div style="padding:12px;border-radius:8px;background:rgba(245,158,11,0.04);border:1px solid rgba(245,158,11,0.08)"><div style="font-size:9px;font-weight:700;color:var(--accent);text-transform:uppercase;letter-spacing:1px;margin-bottom:3px">Reason</div><div style="font-size:13px">${ch.reason}</div></div>`:''}
    </div>
    <div style="padding:12px 18px;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:8px;align-items:center">
      ${isDone?'<span style="font-size:12px;color:#22c55e;margin-right:auto">‚úÖ Applied</span>':''}
      <button style="background:transparent;border:1px solid var(--border);border-radius:8px;padding:8px 16px;color:var(--muted);cursor:pointer;font-size:13px" data-action="closeModal">Close</button>
      <button style="padding:8px 20px;border-radius:8px;font-size:13px;font-weight:700;border:none;cursor:pointer;background:${isDone?'rgba(239,68,68,0.12)':'#22c55e'};color:${isDone?'#ef4444':'#000'}" data-action="toggleApply" data-seq="${ch.seq_tag}" data-sid="${ch.step_id}">${isDone?'‚Ü© Undo':'‚úì Mark Applied'}</button>
    </div>
  </div></div>`;
}

// ============================================================
// TREE EDITOR
// ============================================================
function renderEditor(){
  if(!S.teAssy) return renderEditorPicker();
  const a=DB.assemblies.find(x=>x.id===S.teAssy);if(!a)return'';
  const tree=DB.tree[`${a.id}`];
  if(!tree) return '<div class="loading-wrap"><div class="spinner"></div>Loading tree...</div>';

  const versions=S.teVersions||[];
  const currentVer=S.teVer||a.version;
  const isFrozen=versions.some(v=>v.version===currentVer);
  const sel=S.teSel;
  const selGrp=S.teSelGroup;

  // Find selected step
  let selStep=null,selParts=[],selFast=[];
  if(sel){selStep=tree.steps.find(s=>s.id===sel);if(selStep){selParts=partsForStep(tree,selStep.id);selFast=fastenersForStep(tree,selStep.id);}}

  // --- RIGHT PANEL ---
  let rightPanel='';
  if(selStep){
    const ro=isFrozen?'readonly disabled':'';
    const roStyle=isFrozen?'opacity:0.6;pointer-events:none':'';
    const hasEcn=!!S.teEcnMarks[selStep.id];
    const ecm=S.teEcnMarks[selStep.id]||{};
    rightPanel=`
      ${isFrozen?'<div style="padding:8px 12px;border-radius:8px;margin-bottom:12px;background:rgba(59,130,246,0.06);border:1px solid rgba(59,130,246,0.15);font-size:11px;font-weight:700;color:#3b82f6;text-align:center">üîí Frozen ‚Äî unfreeze to edit</div>':''}
      <div class="dp-section" style="${roStyle}">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px">
          <div style="font-size:18px;font-weight:800;flex:1">${selStep.label||selStep.pn||'Untitled'}</div>
          ${!isFrozen?`<button class="btn-sm" style="background:rgba(239,68,68,0.1);color:#ef4444;border-color:rgba(239,68,68,0.2);font-size:9px" data-action="deleteStep" data-sid="${selStep.id}">üóë Delete</button>`:''}
        </div>
        <div style="display:flex;gap:8px;align-items:flex-start;margin-bottom:12px;flex-wrap:wrap">
          <div><div class="dp-label">SEQ TAG</div><input class="inp" style="width:56px;font-weight:700;font-size:13px;padding:6px 8px" value="${selStep.seq_tag||''}" data-role="teSeqTag" data-sid="${selStep.id}"></div>
          <div><div class="dp-label">TYPE</div><select class="inp" style="font-size:13px;padding:6px 8px" data-role="teType" data-sid="${selStep.id}"><option value="step" ${selStep.type==='STEP'?'selected':''}>STEP</option><option value="prep" ${selStep.type==='PREP'?'selected':''}>PREP</option><option value="check" ${selStep.type==='CHECK'?'selected':''}>CHECK</option></select></div>
          <div style="flex:1"><div class="dp-label">LABEL</div><input class="inp" style="width:100%;font-size:13px;padding:6px 8px" value="${selStep.label||''}" data-role="teLabel" data-sid="${selStep.id}"></div>
        </div>
        <div><div class="dp-label">PART NUMBER (PN)</div><input class="inp" style="width:100%;font-size:12px;padding:6px 8px;margin-bottom:6px" value="${selStep.pn||''}" data-role="teStepPn" data-sid="${selStep.id}"></div>
        <div style="display:flex;gap:8px">
          <div><div class="dp-label">SORT ORDER</div><input class="inp" type="number" style="width:60px;font-size:12px;padding:6px 8px" value="${selStep.sort_order||0}" data-role="teSortOrder" data-sid="${selStep.id}"></div>
        </div>
      </div>

      <div class="dp-section">
        <div style="padding:7px 9px;border-radius:7px;background:${hasEcn?'rgba(239,68,68,0.04)':'rgba(139,92,246,0.02)'};border:1px solid ${hasEcn?'rgba(239,68,68,0.12)':'var(--border)'}">
          <div style="display:flex;align-items:center;gap:6px;${hasEcn?'margin-bottom:6px':''}">
            <span style="font-size:10px;font-weight:700;color:${hasEcn?'#ef4444':'var(--muted)'}">${hasEcn?'üî¥ ECN Marked':'No ECN'}</span>
            ${!isFrozen?`<button class="btn-sm" style="margin-left:auto;font-size:9px;padding:2px 8px;background:${hasEcn?'rgba(239,68,68,0.12)':'rgba(34,197,94,0.12)'};color:${hasEcn?'#ef4444':'#22c55e'};border-color:${hasEcn?'rgba(239,68,68,0.2)':'rgba(34,197,94,0.2)'}" data-action="toggleEcnMark" data-sid="${selStep.id}">${hasEcn?'‚úï Remove':'+ Mark ECN'}</button>`:''}
          </div>
          ${hasEcn?`
            <div style="font-size:8px;color:var(--muted);margin-bottom:2px;font-weight:700">DISPOSITION</div>
            <div style="display:flex;gap:3px;margin-bottom:6px">
              ${Object.entries(ECN_DISPOSITIONS).map(([k,d])=>`<button class="ecn-disp-btn ${ecm.disposition===k?'active':''}" style="flex:1;padding:4px;border-radius:4px;font-size:9px;${ecm.disposition===k?`border:2px solid ${d.color};background:${d.bg};color:${d.color}`:`border:1px solid var(--border);color:${d.color}`};${isFrozen&&ecm.disposition!==k?'opacity:0.3':''}" data-action="setEcnDisp" data-sid="${selStep.id}" data-d="${k}">${d.icon} ${d.label}</button>`).join('')}
            </div>
            ${!isFrozen?`<textarea class="inp" style="width:100%;resize:vertical;line-height:1.3;font-size:11px;padding:6px 8px" rows="2" placeholder="ECN note..." data-role="ecnNote" data-sid="${selStep.id}">${ecm.note||''}</textarea>`
            :(ecm.note?`<div style="font-size:11px;color:var(--text);opacity:0.6;padding:4px 0">${ecm.note}</div>`:'')}
          `:''}
        </div>
      </div>

      <div class="dp-section" style="${roStyle}">
        <div style="display:flex;align-items:center;margin-bottom:6px"><span class="dp-label" style="flex:1;margin:0">PARTS (${selParts.length})</span>${!isFrozen?`<button class="btn-sm" style="background:rgba(34,197,94,0.12);color:#22c55e;border:none;font-size:11px;padding:4px 10px" data-action="addPart" data-sid="${selStep.id}">+ Part</button>`:''}</div>
        ${selParts.map(p=>{const resolved=DB.lookupPN(p.pn);const manName=S.partNames[p.id];const dispName=manName||resolved||'';const isFromMaster=!!resolved&&!manName;
          return `<div style="margin-bottom:5px;padding:6px 8px;border-radius:6px;border:1px solid var(--border)">
          <div style="display:flex;gap:4px;align-items:center">
            <input class="inp" style="width:100px;font-weight:700;color:#0ea5e9;font-size:11px" value="${p.pn||''}" data-role="partPn" data-pid="${p.id}" placeholder="PN">
            <input class="inp" type="number" style="width:40px;text-align:center;font-size:11px" value="${p.qty||1}" data-role="partQty" data-pid="${p.id}">
            <button style="background:none;border:none;color:#ef4444;font-size:12px;cursor:pointer;padding:2px 4px" data-action="delPart" data-pid="${p.id}">‚úï</button>
          </div>
          ${resolved?`<div style="display:flex;align-items:center;gap:4px;margin-top:3px"><span style="font-size:9px;color:#22c55e;font-weight:600">üì¶ ${resolved}</span><span style="font-size:7px;color:var(--dim);background:rgba(34,197,94,0.08);padding:1px 4px;border-radius:3px">MASTER</span></div>`
          :(p.pn?`<div style="font-size:9px;color:var(--dim);margin-top:2px">‚ö† Not in master list</div>`:'')}
          <input class="inp" style="width:100%;font-size:10px;margin-top:3px;padding:3px 6px;color:${isFromMaster?'rgba(34,197,94,0.5)':'var(--text)'}" value="${dispName}" data-role="partName" data-pid="${p.id}" placeholder="${resolved?'Custom name override...':'Part name (manual entry)'}">
        </div>`;}).join('')}
      </div>

      <div class="dp-section" style="${roStyle}">
        <div style="display:flex;align-items:center;margin-bottom:6px"><span class="dp-label" style="flex:1;margin:0">FASTENERS (${selFast.length})</span>${!isFrozen?`<button class="btn-sm" style="background:rgba(245,158,11,0.12);color:#f59e0b;border:none;font-size:11px;padding:4px 10px" data-action="addFastener" data-sid="${selStep.id}">+ Fastener</button>`:''}</div>
        ${selFast.map(f=>{const resolved=DB.lookupPN(f.pn);const manName=S.fastNames[f.id];const dispName=manName||resolved||'';const isFromMaster=!!resolved&&!manName;
          return `<div style="margin-bottom:5px;padding:6px 8px;border-radius:6px;border:1px solid var(--border)">
          <div style="display:flex;gap:4px;align-items:center">
            <input class="inp" style="width:90px;font-weight:700;color:#f59e0b;font-size:11px" value="${f.pn||''}" data-role="fastPn" data-fid="${f.id}" placeholder="PN">
            <input class="inp" style="width:50px;font-size:11px" value="${f.torque||''}" placeholder="Torque" data-role="fastTorque" data-fid="${f.id}">
            <input class="inp" style="width:30px;font-size:11px" value="${f.loctite||''}" placeholder="Loc" data-role="fastLoc" data-fid="${f.id}">
            <input class="inp" type="number" style="width:32px;text-align:center;font-size:11px" value="${f.qty||1}" data-role="fastQty" data-fid="${f.id}">
            <button style="background:none;border:none;color:#ef4444;font-size:12px;cursor:pointer" data-action="delFast" data-fid="${f.id}">‚úï</button>
          </div>
          ${resolved?`<div style="display:flex;align-items:center;gap:4px;margin-top:3px"><span style="font-size:9px;color:#f59e0b;font-weight:600">üî© ${resolved}</span><span style="font-size:7px;color:var(--dim);background:rgba(245,158,11,0.08);padding:1px 4px;border-radius:3px">MASTER</span></div>`
          :(f.pn?`<div style="font-size:9px;color:var(--dim);margin-top:2px">‚ö† Not in master list</div>`:'')}
          <input class="inp" style="width:100%;font-size:10px;margin-top:3px;padding:3px 6px;color:${isFromMaster?'rgba(245,158,11,0.5)':'var(--text)'}" value="${dispName}" data-role="fastName" data-fid="${f.id}" placeholder="${resolved?'Custom name override...':'Fastener name (manual entry)'}">
        </div>`;}).join('')}
      </div>`;
  } else if(selGrp){
    const grp=tree.groups.find(g=>g.id===selGrp);
    if(grp){
      const roStyle=isFrozen?'opacity:0.6;pointer-events:none':'';
      rightPanel=`
      ${isFrozen?'<div style="padding:8px 12px;border-radius:8px;margin-bottom:12px;background:rgba(59,130,246,0.06);border:1px solid rgba(59,130,246,0.15);font-size:11px;font-weight:700;color:#3b82f6;text-align:center">üîí Frozen ‚Äî unfreeze to edit</div>':''}
      <div class="dp-section" style="${roStyle}">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:14px">
          <span style="font-size:24px">${grp.icon||'üì¶'}</span>
          <div style="font-size:18px;font-weight:800;flex:1;color:${grp.color||'#666'}">${grp.label}</div>
          ${!isFrozen?`<button class="btn-sm" style="background:rgba(239,68,68,0.1);color:#ef4444;border-color:rgba(239,68,68,0.2);font-size:9px" data-action="deleteGroup" data-gid="${grp.id}">üóë Delete Group</button>`:''}
        </div>
        <div style="margin-bottom:10px"><div class="dp-label">GROUP NAME</div><input class="inp" style="width:100%;font-size:13px;padding:6px 8px" value="${grp.label||''}" data-role="grpLabel" data-gid="${grp.id}"></div>
        <div style="margin-bottom:10px"><div class="dp-label">COLOR</div>
          <div style="display:flex;gap:4px;flex-wrap:wrap">${GROUP_COLORS.map(c=>`<div style="width:24px;height:24px;border-radius:6px;background:${c};cursor:pointer;border:2px solid ${c===grp.color?'#fff':'transparent'};opacity:${c===grp.color?1:0.5}" data-action="setGrpColor" data-gid="${grp.id}" data-color="${c}"></div>`).join('')}</div>
        </div>
        <div style="margin-bottom:10px"><div class="dp-label">ICON</div>
          <div style="display:flex;gap:4px;flex-wrap:wrap">${GROUP_ICONS.map(ic=>`<div style="width:28px;height:28px;border-radius:6px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:16px;background:${ic===grp.icon?'rgba(255,255,255,0.1)':'transparent'};border:1px solid ${ic===grp.icon?'var(--muted)':'transparent'}" data-action="setGrpIcon" data-gid="${grp.id}" data-icon="${ic}">${ic}</div>`).join('')}</div>
        </div>
        <div style="display:flex;gap:8px">
          <div><div class="dp-label">SORT ORDER</div><input class="inp" type="number" style="width:60px;font-size:12px;padding:6px 8px" value="${grp.sort_order||0}" data-role="grpSort" data-gid="${grp.id}"></div>
          <div><div class="dp-label">VERSION</div><input class="inp" style="width:60px;font-size:12px;padding:6px 8px" value="${grp.version||''}" data-role="grpVersion" data-gid="${grp.id}"></div>
        </div>
      </div>
      <div class="dp-section"><div class="dp-label">STEPS IN GROUP</div><div style="font-size:13px;color:var(--muted)">${stepsForGroup(tree,grp.id).length} steps</div></div>`;
    }
  } else {
    rightPanel=`<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;color:var(--dim);font-size:14px"><div style="font-size:36px;margin-bottom:12px;opacity:0.3">üîß</div><div>Select a step or group to edit</div><div style="font-size:11px;color:var(--dim);margin-top:6px">Click a group header to edit group properties</div></div>`;
  }

  // --- VERSION BAR ---
  const verBar=`<div class="te-verbar">
    <span style="font-size:10px;font-weight:700;color:var(--dim);letter-spacing:1px;margin-right:4px">VERSIONS</span>
    ${versions.map(v=>`<button class="te-ver-pill ${v.version===currentVer?'active':''}" data-action="switchVer" data-ver="${v.version}" title="${v.notes||''}">v${v.version} üîí</button>`).join('')}
    ${!versions.some(v=>v.version===currentVer)?`<button class="te-ver-pill active" style="border-color:rgba(245,158,11,0.4);background:rgba(245,158,11,0.1);color:#f59e0b">v${currentVer} <span style="font-size:8px">DRAFT</span></button>`:''}
    <button class="btn-sm" style="background:rgba(139,92,246,0.12);color:#8b5cf6;border:none;font-size:10px;padding:4px 10px;margin-left:4px" data-action="openNewVer">+ New Version</button>
    <div style="margin-left:auto;display:flex;gap:6px">
      ${isFrozen?`<button class="btn-sm" style="background:rgba(245,158,11,0.1);color:#f59e0b;border-color:rgba(245,158,11,0.2);font-size:10px" data-action="unfreezeVer">üîì Unfreeze to Draft</button>`
      :`<button class="btn-sm" style="background:rgba(59,130,246,0.1);color:#3b82f6;border-color:rgba(59,130,246,0.2);font-size:10px" data-action="freezeVer">üîí Freeze v${currentVer}</button>`}
      <button class="btn-sm" style="background:rgba(34,197,94,0.1);color:#22c55e;border-color:rgba(34,197,94,0.2);font-size:10px" data-action="setProduction">üè≠ Set as Production</button>
    </div>
  </div>
  ${isFrozen?`<div class="te-frozen-bar">üîí Version v${currentVer} is frozen. Unfreeze to make edits.</div>`:''}`;

  return `<div class="te-wrap">
    <div class="te-left">
      <div class="te-topbar">
        <button style="background:none;border:1px solid var(--border);border-radius:8px;padding:6px 14px;color:var(--muted);cursor:pointer;font-size:13px" data-action="teBack">‚Üê Assemblies</button>
        <span style="font-size:16px;font-weight:800;color:#8b5cf6">üîß</span>
        <span style="font-weight:700;color:#8b5cf6;font-size:16px" class="mono">Tree Editor</span>
        <div style="width:1px;height:18px;background:var(--border);margin:0 4px"></div>
        <span style="font-size:18px">${a.icon}</span>
        <span style="font-weight:700;font-size:16px;color:${a.color}">${a.name}</span>
        <span class="badge" style="background:${a.color}15;color:${a.color}">v${currentVer}</span>
        <div style="margin-left:auto;display:flex;gap:6px">${dbStatus()}</div>
      </div>
      ${verBar}
      <div class="te-tree">
        ${tree.groups.map(g=>{const gSteps=stepsForGroup(tree,g.id);const isGSel=selGrp===g.id;
          return `<div style="margin-bottom:6px">
          <div class="te-grp" style="background:${g.color||'#666'}08;border-left:4px solid ${g.color||'#666'};cursor:pointer;${isGSel?'outline:1px solid rgba(139,92,246,0.3);outline-offset:-1px;border-radius:8px':''}" data-action="selGroup" data-gid="${g.id}">
            <span style="font-size:16px">${g.icon||'üì¶'}</span>
            <span style="font-weight:700;color:${g.color||'#666'};flex:1;font-size:15px" class="mono">${g.label}</span>
            <span style="color:var(--muted);font-size:13px">${gSteps.length}</span>
            ${!isFrozen?`<button style="background:none;border:none;color:#22c55e;cursor:pointer;font-size:16px;padding:0 4px" data-action="addStep" data-gid="${g.id}" onclick="event.stopPropagation()">+</button>`:''}
          </div>
          ${gSteps.map(s=>{const isSel=sel===s.id;const hasEcn=!!S.teEcnMarks[s.id];
            return `<div class="te-step ${isSel?'sel':''}" data-action="selStep" data-sid="${s.id}" style="${isSel?'':'border:1px solid transparent'}">
              ${hasEcn?'<span style="font-size:11px">üî¥</span>':''}
              <span style="font-weight:700;color:${g.color||'#666'};min-width:30px;text-align:center;font-size:13px;background:${g.color||'#666'}15;padding:3px 8px;border-radius:5px" class="mono">${s.seq_tag||'‚Äî'}</span>
              <span style="font-size:11px;font-weight:600;padding:2px 8px;border-radius:4px;color:${s.type==='PREP'?'#a855f7':s.type==='CHECK'?'#ec4899':'#22c55e'};background:${s.type==='PREP'?'rgba(168,85,247,0.1)':s.type==='CHECK'?'rgba(236,72,153,0.1)':'rgba(34,197,94,0.1)'}">${s.type||'STEP'}</span>
              <span style="flex:1;color:${s.label?'var(--text)':'var(--dim)'};font-size:14px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${s.label||s.pn||'untitled'}</span>
              ${partsForStep(tree,s.id).length?`<span style="font-size:11px;color:#22c55e;font-weight:600" class="mono">${partsForStep(tree,s.id).length}P</span>`:''}
              ${fastenersForStep(tree,s.id).length?`<span style="font-size:11px;color:#ef4444;font-weight:600" class="mono">${fastenersForStep(tree,s.id).length}F</span>`:''}
            </div>`;}).join('')}
        </div>`;}).join('')}
        ${!isFrozen?`<button class="btn-sm" style="width:100%;margin-top:8px;padding:10px;background:rgba(99,102,241,0.12);color:#6366f1;border:none;font-size:12px" data-action="addGroup">+ Add Group</button>`:''}
      </div>
    </div>
    <div class="te-right">${rightPanel}</div>
  </div>`;
}

function renderEditorPicker(){
  const all=DB.assemblies;
  return `<div class="te-pick-wrap">
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:36px;width:100%;max-width:760px">
      <button style="background:none;border:1px solid var(--border);border-radius:8px;padding:6px 14px;color:var(--muted);cursor:pointer;font-size:13px" data-action="goHome">‚Üê Home</button>
      <span style="font-size:20px;font-weight:800;color:#8b5cf6">üîß</span><span style="font-weight:700;color:#8b5cf6;font-size:20px" class="mono">Tree Editor</span>
      <div style="margin-left:auto">${dbStatus()}</div>
    </div>
    <div class="te-pick-grid">${all.map(a=>`<div class="te-pick-card" data-action="pickAssy" data-id="${a.id}" style="border-color:${a.color}40" onmouseenter="this.style.borderColor='${a.color}'" onmouseleave="this.style.borderColor='${a.color}40'">
      <div style="font-size:48px;margin-bottom:12px">${a.icon}</div><div style="font-size:17px;font-weight:700;margin-bottom:8px">${a.name}</div>
      <span class="badge" style="background:${a.color}15;color:${a.color};font-size:11px;padding:3px 8px">v${a.version}</span>
    </div>`).join('')}</div>
  </div>`;
}

// ============================================================
// MODALS
// ============================================================
function renderConfirmModal(){
  return `<div class="confirm-overlay"><div class="confirm-box">
    <div style="font-size:16px;font-weight:700;margin-bottom:10px">‚ö†Ô∏è Confirm Action</div>
    <div style="font-size:13px;color:var(--muted);margin-bottom:18px;line-height:1.5">${S.confirmMsg}</div>
    <div style="display:flex;gap:8px;justify-content:flex-end">
      <button class="btn-sm" style="padding:8px 16px;font-size:12px" data-action="confirmCancel">Cancel</button>
      <button class="btn-sm" style="padding:8px 16px;font-size:12px;background:#ef4444;color:#fff;border-color:#ef4444" data-action="confirmYes">Confirm</button>
    </div>
  </div></div>`;
}

function renderNewVersionModal(){
  return `<div class="confirm-overlay"><div class="confirm-box" style="width:400px">
    <div style="font-size:16px;font-weight:700;margin-bottom:14px">üìã Create New Version</div>
    <div style="margin-bottom:10px"><div class="dp-label">VERSION NUMBER</div><input class="inp" style="width:100%;font-size:14px;padding:8px 10px" placeholder="e.g. 6.0" data-role="newVerStr" value="${S.newVerStr}"></div>
    <div style="margin-bottom:14px"><div class="dp-label">NOTES (optional)</div><input class="inp" style="width:100%;font-size:12px;padding:8px 10px" placeholder="ECN description, changes made..." data-role="newVerNotes" value="${S.newVerNotes}"></div>
    <div style="display:flex;gap:8px;justify-content:flex-end">
      <button class="btn-sm" style="padding:8px 16px;font-size:12px" data-action="cancelNewVer">Cancel</button>
      <button class="btn-sm" style="padding:8px 16px;font-size:12px;background:#8b5cf6;color:#fff;border-color:#8b5cf6" data-action="createNewVer">Create Version</button>
    </div>
  </div></div>`;
}

// ============================================================
// EVENT HANDLERS
// ============================================================
function attachEvents(){
  document.querySelectorAll('[data-action]').forEach(el=>{
    el.onclick=async(e)=>{
      const a=el.dataset.action;
      e.stopPropagation();

      // --- NAV ---
      if(a==='editor'){S.page='editor';S.teAssy=null;S.teSel=null;S.teSelGroup=null;render();}
      else if(a==='goHome'){S.page='home';render();}
      else if(a==='assy'){
        const assy=DB.assemblies.find(x=>x.id===parseInt(el.dataset.id));
        S.assy=assy;S.page='unitSelect';S.unitSel=new Set();S.unitFilter='all';S.unitSearch='';S.loadingUnits=true;render();
        await DB.loadUnits(assy.id,assy.tag);await DB.loadEcnChanges(assy.id);S.loadingUnits=false;render();
      }
      else if(a==='setFilter'){S.unitFilter=el.dataset.f;render();}
      else if(a==='selectAll'){const units=DB.units[S.assy.id]||[];let f=units;if(S.unitFilter==='outdated')f=f.filter(u=>u.status==='outdated');if(S.unitFilter==='current')f=f.filter(u=>u.status==='current'||u.status==='pending');f.forEach(u=>S.unitSel.add(u.sn));render();}
      else if(a==='toggleUnit'){const sn=el.dataset.sn;S.unitSel.has(sn)?S.unitSel.delete(sn):S.unitSel.add(sn);render();}
      else if(a==='proceed'){
        const units=DB.units[S.assy.id]||[];S.selectedUnits=[...S.unitSel].map(sn=>units.find(u=>u.sn===sn)).filter(Boolean);
        S.avTab='list';S.page='assembly';render();await DB.loadTree(S.assy.id);if(S.selectedUnits[0])await DB.loadEcnApplied(S.selectedUnits[0].sn);render();
      }
      else if(a==='backToUnits'){S.page='unitSelect';render();}
      else if(a==='avTab'){S.avTab=el.dataset.tab;render();}
      else if(a==='openChange'){S.modal=parseInt(el.dataset.idx);render();}
      else if(a==='closeModal'){S.modal=null;render();}
      else if(a==='toggleApply'){try{await DB.toggleApplied(S.selectedUnits[0].sn,el.dataset.seq,parseInt(el.dataset.sid));S.modal=null;toast('üíæ Saved');render();}catch(err){toast('‚ùå '+err.message,true);}}

      // --- TREE EDITOR ---
      else if(a==='pickAssy'){
        S.teAssy=parseInt(el.dataset.id);S.teSel=null;S.teSelGroup=null;
        const assy=DB.assemblies.find(x=>x.id===S.teAssy);S.teVer=assy?.version;
        await Promise.all([DB.loadTree(S.teAssy),DB.loadVersions(S.teAssy),DB.loadEcnChanges(S.teAssy)]);
        S.teVersions=DB.versions[S.teAssy]||[];render();
      }
      else if(a==='teBack'){S.teAssy=null;S.teSel=null;S.teSelGroup=null;render();}
      else if(a==='selStep'){S.teSel=parseInt(el.dataset.sid);S.teSelGroup=null;render();}
      else if(a==='selGroup'){S.teSelGroup=parseInt(el.dataset.gid);S.teSel=null;render();}

      // Add step
      else if(a==='addStep'){
        try{const gid=parseInt(el.dataset.gid);await DB.addStep(gid,{seq_tag:'',type:'step',label:'New step',sort_order:999});DB.invalidateTree(S.teAssy);await DB.loadTree(S.teAssy);toast('‚úÖ Step added');render();}catch(err){toast('‚ùå '+err.message,true);}
      }
      // Delete step (confirm)
      else if(a==='deleteStep'){
        S.confirmMsg=`Delete step <strong>${el.dataset.sid}</strong>? This will also delete all its parts and fasteners. This cannot be undone.`;
        S.confirmData={type:'deleteStep',sid:parseInt(el.dataset.sid)};S.confirmAction=true;render();
      }
      // Add group
      else if(a==='addGroup'){
        try{const assy=DB.assemblies.find(x=>x.id===S.teAssy);await DB.addGroup(S.teAssy,S.teVer||assy?.version,{label:'New Group',icon:'üì¶',color:GROUP_COLORS[Math.floor(Math.random()*GROUP_COLORS.length)],sort_order:999});DB.invalidateTree(S.teAssy);await DB.loadTree(S.teAssy);toast('‚úÖ Group added');render();}catch(err){toast('‚ùå '+err.message,true);}
      }
      // Delete group (confirm)
      else if(a==='deleteGroup'){
        const gid=parseInt(el.dataset.gid);const tree=DB.tree[`${S.teAssy}`];const cnt=tree?stepsForGroup(tree,gid).length:0;
        S.confirmMsg=`Delete this group and <strong>${cnt} steps</strong> inside it? All parts and fasteners will also be deleted. This cannot be undone.`;
        S.confirmData={type:'deleteGroup',gid};S.confirmAction=true;render();
      }
      // Parts/fasteners
      else if(a==='addPart'){try{await DB.addPart(parseInt(el.dataset.sid),{pn:'',qty:1,sort_order:999});DB.invalidateTree(S.teAssy);await DB.loadTree(S.teAssy);toast('‚úÖ');render();}catch(err){toast('‚ùå '+err.message,true);}}
      else if(a==='delPart'){try{await DB.deletePart(parseInt(el.dataset.pid));DB.invalidateTree(S.teAssy);await DB.loadTree(S.teAssy);render();}catch(err){toast('‚ùå '+err.message,true);}}
      else if(a==='addFastener'){try{await DB.addFastener(parseInt(el.dataset.sid),{pn:'',qty:1,torque:'',loctite:'',sort_order:999});DB.invalidateTree(S.teAssy);await DB.loadTree(S.teAssy);toast('‚úÖ');render();}catch(err){toast('‚ùå '+err.message,true);}}
      else if(a==='delFast'){try{await DB.deleteFastener(parseInt(el.dataset.fid));DB.invalidateTree(S.teAssy);await DB.loadTree(S.teAssy);render();}catch(err){toast('‚ùå '+err.message,true);}}

      // Group editing
      else if(a==='setGrpColor'){try{await DB.updateGroup(parseInt(el.dataset.gid),{color:el.dataset.color});DB.invalidateTree(S.teAssy);await DB.loadTree(S.teAssy);render();}catch(err){toast('‚ùå '+err.message,true);}}
      else if(a==='setGrpIcon'){try{await DB.updateGroup(parseInt(el.dataset.gid),{icon:el.dataset.icon});DB.invalidateTree(S.teAssy);await DB.loadTree(S.teAssy);render();}catch(err){toast('‚ùå '+err.message,true);}}

      // --- CONFIRM MODAL ---
      else if(a==='confirmCancel'){S.confirmAction=null;S.confirmData=null;render();}
      else if(a==='confirmYes'){
        const d=S.confirmData;S.confirmAction=null;S.confirmData=null;
        try{
          if(d.type==='deleteStep'){await DB.deleteStep(d.sid);S.teSel=null;DB.invalidateTree(S.teAssy);await DB.loadTree(S.teAssy);toast('üóë Step deleted');}
          else if(d.type==='deleteGroup'){await DB.deleteGroup(d.gid);S.teSelGroup=null;DB.invalidateTree(S.teAssy);await DB.loadTree(S.teAssy);toast('üóë Group deleted');}
          else if(d.type==='unfreezeVer'){
            // Delete the version_history entry to unfreeze
            await sbDelete('eagle_eye_app_version_history',`assembly_id=eq.${S.teAssy}&version=eq.${d.ver}`);
            delete DB.versions[S.teAssy];S.teVersions=await DB.loadVersions(S.teAssy);
            toast(`üîì v${d.ver} is now a draft`);
          }
          render();
        }catch(err){toast('‚ùå '+err.message,true);render();}
      }

      // --- VERSION MANAGEMENT ---
      else if(a==='switchVer'){S.teVer=el.dataset.ver;render();}
      else if(a==='openNewVer'){S.newVerModal=true;S.newVerStr='';S.newVerNotes='';render();}
      else if(a==='cancelNewVer'){S.newVerModal=false;render();}
      else if(a==='createNewVer'){
        if(!S.newVerStr.trim()){toast('Enter a version number',true);return;}
        try{
          await DB.createVersion(S.teAssy,S.newVerStr.trim(),S.newVerNotes.trim());
          S.teVersions=await DB.loadVersions(S.teAssy);delete DB.versions[S.teAssy];S.teVersions=await DB.loadVersions(S.teAssy);
          S.teVer=S.newVerStr.trim();S.newVerModal=false;toast('‚úÖ Version created');render();
        }catch(err){toast('‚ùå '+err.message,true);}
      }
      else if(a==='setProduction'){
        try{await DB.updateAssemblyVersion(S.teAssy,S.teVer);toast(`üè≠ v${S.teVer} is now production`);render();}catch(err){toast('‚ùå '+err.message,true);}
      }
      else if(a==='freezeVer'){
        const exists=S.teVersions.some(v=>v.version===S.teVer);
        if(!exists){
          try{
            await DB.createVersion(S.teAssy,S.teVer,`Frozen by Aniket`);
            delete DB.versions[S.teAssy];S.teVersions=await DB.loadVersions(S.teAssy);
            toast(`üîí v${S.teVer} frozen`);render();
          }catch(err){toast('‚ùå '+err.message,true);}
        } else { toast('Already frozen',true); }
      }
      else if(a==='unfreezeVer'){
        S.confirmMsg=`Unfreeze <strong>v${S.teVer}</strong> and make it a draft? This allows editing the tree.`;
        S.confirmData={type:'unfreezeVer',ver:S.teVer};S.confirmAction=true;render();
      }

      // --- ECN MARKING ---
      else if(a==='toggleEcnMark'){
        const sid=parseInt(el.dataset.sid);
        if(S.teEcnMarks[sid]){delete S.teEcnMarks[sid];toast('‚úï ECN removed');}
        else{S.teEcnMarks[sid]={note:'',disposition:'scrap'};toast('üî¥ ECN marked');}
        render();
      }
      else if(a==='setEcnDisp'){
        const sid=parseInt(el.dataset.sid),d=el.dataset.d;
        if(S.teEcnMarks[sid]){S.teEcnMarks[sid].disposition=d;render();}
      }
    };
  });

  // --- DEBOUNCED INPUTS ---
  let saveTimer=null;
  function ds(fn){clearTimeout(saveTimer);saveTimer=setTimeout(async()=>{try{await fn();toast('üíæ');}catch(err){toast('‚ùå '+err.message,true);}},800);}
  document.querySelectorAll('[data-role]').forEach(el=>{
    const r=el.dataset.role;
    if(r==='unitSearch'){el.oninput=()=>{S.unitSearch=el.value;render();};}
    if(r==='unitPicker'){el.onchange=async()=>{const u=S.selectedUnits.find(x=>x.sn===el.value);if(u){S.selectedUnits=[u,...S.selectedUnits.filter(x=>x.sn!==u.sn)];await DB.loadEcnApplied(u.sn);render();}};}
    // Step fields
    if(r==='teSeqTag') el.oninput=()=>ds(()=>DB.updateStep(parseInt(el.dataset.sid),{seq_tag:el.value}));
    if(r==='teType') el.onchange=()=>ds(()=>DB.updateStep(parseInt(el.dataset.sid),{type:el.value}));
    if(r==='teLabel') el.oninput=()=>ds(()=>DB.updateStep(parseInt(el.dataset.sid),{label:el.value}));
    if(r==='teStepPn') el.oninput=()=>ds(()=>DB.updateStep(parseInt(el.dataset.sid),{pn:el.value}));
    if(r==='teSortOrder') el.oninput=()=>ds(()=>DB.updateStep(parseInt(el.dataset.sid),{sort_order:parseInt(el.value)||0}));
    // ECN note (local only)
    if(r==='ecnNote'){el.oninput=()=>{const sid=parseInt(el.dataset.sid);if(S.teEcnMarks[sid])S.teEcnMarks[sid].note=el.value;};}
    // Part fields
    if(r==='partPn') el.oninput=()=>{
      const pid=parseInt(el.dataset.pid);
      const resolved=DB.lookupPN(el.value);
      // Auto-fill name from master (clear manual override if PN changed)
      if(resolved){delete S.partNames[pid];}
      // Update the name input visually if it exists
      const nameEl=document.querySelector(`[data-role="partName"][data-pid="${pid}"]`);
      if(nameEl&&!S.partNames[pid]){nameEl.value=resolved||'';}
      ds(()=>DB.updatePart(pid,{pn:el.value}));
    };
    if(r==='partQty') el.oninput=()=>ds(()=>DB.updatePart(parseInt(el.dataset.pid),{qty:parseInt(el.value)||1}));
    if(r==='partName') el.oninput=()=>{
      const pid=parseInt(el.dataset.pid);
      const resolved=DB.lookupPN(document.querySelector(`[data-role="partPn"][data-pid="${pid}"]`)?.value||'');
      // If user types something different from master ‚Üí store as manual override
      if(el.value&&el.value!==resolved) S.partNames[pid]=el.value;
      else delete S.partNames[pid];
    };
    // Fastener fields
    if(r==='fastPn') el.oninput=()=>{
      const fid=parseInt(el.dataset.fid);
      const resolved=DB.lookupPN(el.value);
      if(resolved){delete S.fastNames[fid];}
      const nameEl=document.querySelector(`[data-role="fastName"][data-fid="${fid}"]`);
      if(nameEl&&!S.fastNames[fid]){nameEl.value=resolved||'';}
      ds(()=>DB.updateFastener(fid,{pn:el.value}));
    };
    if(r==='fastTorque') el.oninput=()=>ds(()=>DB.updateFastener(parseInt(el.dataset.fid),{torque:el.value}));
    if(r==='fastLoc') el.oninput=()=>ds(()=>DB.updateFastener(parseInt(el.dataset.fid),{loctite:el.value}));
    if(r==='fastQty') el.oninput=()=>ds(()=>DB.updateFastener(parseInt(el.dataset.fid),{qty:parseInt(el.value)||1}));
    if(r==='fastName') el.oninput=()=>{
      const fid=parseInt(el.dataset.fid);
      const resolved=DB.lookupPN(document.querySelector(`[data-role="fastPn"][data-fid="${fid}"]`)?.value||'');
      if(el.value&&el.value!==resolved) S.fastNames[fid]=el.value;
      else delete S.fastNames[fid];
    };
    // Group fields
    if(r==='grpLabel') el.oninput=()=>ds(async()=>{await DB.updateGroup(parseInt(el.dataset.gid),{label:el.value});DB.invalidateTree(S.teAssy);await DB.loadTree(S.teAssy);render();});
    if(r==='grpSort') el.oninput=()=>ds(async()=>{await DB.updateGroup(parseInt(el.dataset.gid),{sort_order:parseInt(el.value)||0});DB.invalidateTree(S.teAssy);await DB.loadTree(S.teAssy);render();});
    if(r==='grpVersion') el.oninput=()=>ds(()=>DB.updateGroup(parseInt(el.dataset.gid),{version:el.value}));
    // Modal fields
    if(r==='newVerStr'){el.oninput=()=>{S.newVerStr=el.value;};}
    if(r==='newVerNotes'){el.oninput=()=>{S.newVerNotes=el.value;};}
  });
}

// ============================================================
// BOOT
// ============================================================
DB.init();
</script>
</body>
</html>
